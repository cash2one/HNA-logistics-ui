easySpa.use(["widget/select","widget/prompt","widget/slides"]),function(e,a,t,r){function i(a,t){var r=this;r.$elm=e(a),r.param=e.extend({},t),r.init()}var l=[],d=!1;i.prototype={init:function(){var a=this;a.loadHTMLCss(),a.param.edit||e(".addButton").hide(),a.param.edit?(a.fileTypes=a.getFileType(),a.fileTypeCode=a.fileTypes.data[0].code,e("#clickBtn").attr("disabled",!0),e("#clickBtn").css("background-color","#ccc"),e("#clickBtn").css("border-color","#ccc"),a.checkUpload(!0),e("#fileNameInp").val(""),e("#projectFile").val(""),e("#upload_fileType").val(a.fileTypes.data[0].name),e("#fileDescribeInp").val(""),e("#addDataTr").show()):e("#addDataTr").hide(),a.orderFileData=a.getOrderFile(),a.getForEachData(a.orderFileData),a.handle()},loadHTMLCss:function(){var e=this;e.use({url:"public/common/uploadFile/uploadFile.css",type:"css"}),e.use({url:"public/common/uploadFile/uploadFile.html",type:"html",append:e.param.append})},getOrderFile:function(){var e=this,a={url:e.param.getOrderFile.url,type:e.param.getOrderFile.type,data:e.param.getOrderFile.param};return JSON.parse(e.useHttp(a)).data},getForEachData:function(a){var t,r=this,i=r.getResetDataFormat(a);e("#tableContainerId tbody .add-data").remove(),i.length>0&&(l.splice(0,l.length),i.forEach(function(a,i){!a.fileUrl&&a.path&&(a.fileUrl=a.path),!a.fileId&&a.id&&(a.fileId=a.id);var d,o;if(o="tradeOrder"===r.param.system?{type:a.code,remark:a.desciption,name:a.fileName,fileId:a.id,orderNo:a.orderNo}:{code:a.code,desciption:a.desciption,fileName:a.fileName,fileId:a.id,orderNo:a.orderNo},l.push(o),a.fileRandomName){var p=a.fileRandomName.lastIndexOf(".");d=a.fileRandomName.substring(p+1,a.fileRandomName.length).toUpperCase()}if(a.name){var p=a.name.lastIndexOf(".");d=a.name.substring(p+1,a.name.length).toUpperCase()}if("DOC"===d||"DOCX"==d||"DOT"===d||"DOTX"===d?a.type="application/msword":"XLS"===d||"XLT"===d||"XLSX"===d||"XLTX"===d?a.type="application/vnd.ms-excel":"JPG"===d||"JPEG"===d||"PNG"===d||"BMP"===d||"TIFF"===d?a.type="image":"PDF"===d&&(a.type="pdf"),!a.fileType&&a.type&&(a.fileType=a.type),a.fileName.indexOf(".")<0){var p=a.fileRandomName.lastIndexOf(".");t=a.fileName+"."+a.fileRandomName.substring(p+1,a.fileRandomName.length)}else t=a.fileRandomName;var n='<tr class="add-data"><td >'+a.fileName+"</td><td>"+a.fileTypeName+"</td><td>"+a.desciption+'</td><td data-fileUrl="'+a.fileUrl.toString()+'"  data-fileId="'+a.fileId.toString()+'"  data-fileType="'+a.fileType+'"  data-name="'+a.fileRandomName+'" ';a.type&&a.type.includes("image")?n+='><img class="imgFilePic" style="margin-top: 10px" src="'+a.fileUrl+'" width="50">':a.type&&a.type.includes("pdf")?n+='><img style="margin-top: 10px;" src="../public/img/PDF.svg" width="50">':a.type&&a.type.includes("tiff")?n+='><img style="margin-top: 10px;" src="../public/img/tiff.svg" width="50">':a.type&&a.type.includes("vnd")?n+='><img style="margin-top: 10px;" src="../public/img/excel.svg" width="50">':a.type&&a.type.includes("msword")&&(n+='><img style="margin-top: 10px;" src="../public/img/word.svg" width="50">'),n+='<p style="margin-top: -14px"><span class="textPreview">预览</span>',r.param.edit&&(n+='<span class="textDelete" data-status="'+a.orderStatus+'" id='+a.id+">删除</span>"),n+='<a href="'+r.getThumbnail(a.fileUrl)+"?filename="+t+'" class="textDownload" download>下载</a></p></td></tr>',e("#tableContainerId tbody #addDataTr").before(n)}))},getResetDataFormat:function(e){var a=this,t=[];return"tradeOrder"===a.param.system&&a.param.orderNo?e.forEach(function(e){var a={id:"",code:"",desciption:"",fileName:"",orderNo:"",fileId:"",fileRandomName:"",type:"",orderStatus:"",fileUrl:"",fileType:"",fileTypeName:""};a.id=e.id,a.code=e.type,!e.remark&&e.desciption?a.desciption=e.desciption:e.remark&&(a.desciption=e.remark),!e.fileName&&e.name?a.fileName=e.name:a.fileName=e.fileName,a.fileId=e.fileId,a.fileRandomName=e.fileRandomName,a.fileType=e.fileType,a.orderStatus=e.orderStatus,!e.fileUrl&&e.path?a.fileUrl=e.path:a.fileUrl=e.fileUrl,a.fileTypeName=e.fileTypeName,t.push(a)}):t=e,t},getThumbnail:function(e){if(-1!=e.indexOf("150x150")){var a=e.lastIndexOf("."),t=e.substring(a,e.length);if(".doc"!==t&&".docx"!==t&&".dot"!==t&&".dotx"!==t&&".xls"!==t&&".xlsx"!==t&&".xlt"!==t&&".xltx"!==t&&".pdf"!==t){var r=e.substring(0,a),i=r.lastIndexOf("_");e=e.substring(0,i)+t}}return e},handle:function(){var a=this;e("#clickBtn").on("click",function(){a.param.edit?(a.fileTypes=a.getFileType(),a.fileTypeCode=a.fileTypes.data[0].code,e("#clickBtn").attr("disabled",!0),e("#clickBtn").css("background-color","#ccc"),e("#clickBtn").css("border-color","#ccc"),a.checkUpload(!0),e("#fileNameInp").val(""),e("#projectFile").val(""),e("#upload_fileType").val(a.fileTypes.data[0].name),e("#fileDescribeInp").val(""),e("#addDataTr").show()):e("#addDataTr").hide()}),e("#upload_fileType").on("click",function(t){Select.sharePool.upload_fileType=null,e("#upload_fileType").unbind(),selectFactory({data:[],id:"upload_fileType",defaultText:"",onSearchValueChange:function(e,t){var r=a.getCurrentFileType(t);e.setData(r)},attrTextModel:function(t,r){a.fileTypeCode=a.getCodeByName(t,r),e("#upload_fileType").val(t)}}).open()}),e("#fileNameInp").on("blur",function(t){d=!1;var r=e("#fileNameInp").val();if(/^([\w\u4E00-\u9FA5_\-\s]+)+$/.test(r))a.param.orderNo?a.checkFileName(r,function(t){if(!t.data)return d=!0,a.checkUpload(!1),e("#inputNameErrorVal").val("已有该文件名！");e("#inputNameErrorVal").val(""),a.checkUpload(!0)}):(e("#inputNameErrorVal").val(""),a.checkUpload(!0));else{if(r)return d=!0,a.checkUpload(!1),e("#inputNameErrorVal").val("请输入中英文、数字、“-_”、空格");e("#inputNameErrorVal").val(""),a.checkUpload(!0)}}),e("#projectFile").on("change",function(r){var i=e("#fileNameInp").val().trim(),l=e("#fileDescribeInp").val(),o=e("#upload_fileType").val(),p={maxSize:10485760},n=(r.srcElement||r.target).files[0];if(e("#projectFile").val(""),d)return void e("#fileNameInp").focus();if(!o&&!a.fileTypeCode)return e("#upload_fileType").focus(),e(t).promptBox({isDelay:!0,contentDelay:"类型不能为空",type:"errer",time:3e3});if(void 0==n)return!1;if(n.size>p.maxSize)return e(t).promptBox({isDelay:!0,contentDelay:"单个文件最大支持10M!",type:"errer",manualClose:!0,time:3e3});if(0==n.size)return e(t).promptBox({isDelay:!0,contentDelay:"文件不能为空！",type:"errer",manualClose:!0,time:3e3});var s,c;s=-1!=n.type.indexOf("image")?"/api/v1/sys/files/upload/pic":"/api/v1/sys/files/upload/file",c=new FormData,c.append("file",n),e("#progress").text("0%"),e("progress").attr({value:0,max:100}),e.ajax({type:"POST",url:s,data:c,processData:!1,contentType:!1,xhr:function(){e(".uploadBtn").css("display","none"),e(".proDiv").css("display","block");var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",a.progressHandlingFunction,!1),t},success:function(r){if(e("#clickBtn").attr("disabled",!1),e("#clickBtn").css("background-color","#3BAFDA"),e("#clickBtn").css("border-color","#3BAFDA"),0===r.errorCode){e(".uploadBtn").css("display","block"),e(".proDiv").css("display","none"),i||(i=r.data.name),r.data.fileName=i,r.data.fileRandomName=r.data.name,r.data.desciption=l,r.data.code=a.fileTypeCode,r.data.fileTypeName=o,r.data.orderStatus=a.param.orderStatus,r.data.orderNo=a.param.orderNo;var d;d="tradeOrder"===a.param.system?{type:r.data.code,fileId:r.data.id,name:r.data.fileName,remark:r.data.desciption,orderNo:r.data.orderNo}:{code:r.data.code,fileId:r.data.id,fileName:r.data.fileName,desciption:r.data.desciption,orderNo:r.data.orderNo},a.param.orderNo?a.addOrderFile(JSON.stringify(d),function(i){0===i.errorCode?(e(t).promptBox({isDelay:!0,contentDelay:"添加成功！",type:"success"}),a.orderFileData.push(r.data),a.getForEachData(a.orderFileData)):e(t).promptBox({isDelay:!0,contentDelay:i.msg,type:"errer",time:3e3})}):(a.orderFileData.push(r.data),a.getForEachData(a.orderFileData)),e("#addDataTr").hide()}else e(t).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",time:3e3})}})}),e("#tableContainerId tbody").delegate(".textDelete","click",function(r){var i=e(this).parents("td").parent("tr").index();if(e(this).attr("data-status")!==a.param.orderStatus&&"tradeOrder"!==a.param.system)return e(t).promptBox({isDelay:!0,contentDelay:"该附件在之前状态下上传，不能删除！",type:"errer",time:3e3});e(t).promptBox({title:"提示",type:"warning",content:{tip:"确认删除选中文件?"},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){a.delOrderFile(r.target.id,function(r){a.orderFileData&&a.orderFileData.splice(i,1),a.getForEachData(a.orderFileData),e(t).promptBox("closePrompt"),e(t).promptBox({isDelay:!0,contentDelay:"删除成功！",type:"success"})})}}]})}),e("#tableContainerId tbody").delegate(".textPreview","click",function(a){var r,i,l=e(this).parents("td"),d=l.attr("data-name"),o=l.attr("data-fileUrl"),p=l.attr("data-fileId"),n=l.attr("data-fileType"),s=[];if(n.includes("image"))r=!0,i=!1;else{if(!n.includes("pdf"))return e(t).promptBox({isDelay:!0,contentDelay:"该文件暂不支持预览！",type:"errer",time:3e3});r=!1,i=!0}var c={name:d,picUrl:o,picUrlID:{id:p,name:d,path:o,type:n},typeImage:r,typePdf:i};s.push(c),e("#slides").picturePreview({pictureId:p},s)}),e("#tableContainerId tbody").delegate(".imgFilePic","click",function(a){var t=e(this).parents("td"),r=t.attr("data-name"),i=t.attr("data-fileUrl"),l=t.attr("data-fileId"),d=t.attr("data-fileType"),o=[],p={name:r,picUrl:i,picUrlID:{id:l,name:r,path:i,type:d},typeImage:!0,typePdf:!1};o.push(p),e("#slides").picturePreview({pictureId:l},o)})},getCurrentFileType:function(e){var a=this;e=e||"";var t={q:e,orderStatus:a.param.orderStatus};return a.getFileType(t)},getCodeByName:function(a,t){var r=this;if(t||(t=r.getFileType()),a){t=t.data;for(var i=0;i<t.length;i++){var l=t[i].name;if(e.trim(l)==e.trim(a)||e.trim(t[i].name)==e.trim(a))return t[i].code}return"无匹配结果"}},progressHandlingFunction:function(a){for(var t=a.loaded,r=a.total,i=0;i<t;i+=10){e("progress").attr({value:i,max:r});var l=i/r*100;e("#progress").text(l.toFixed(1)+"%")}},checkUpload:function(a){a?(e("#fileNameInp").css("border","1px solid #BDBDBD"),e(".uploadBtn").css("background-color","#3BAFDA"),e(".uploadBtn").css("border","1px solid #3BAFDA"),e(".uploadBtn").css("cursor","pointer"),e("#projectFile").css("cursor","pointer"),e("#projectFile").attr("disabled",!1)):(e("#fileNameInp").css("border","1px solid #f00"),e(".uploadBtn").css("background-color","#ccc"),e(".uploadBtn").css("border","#ccc"),e(".uploadBtn").css("cursor","not-allowed"),e("#projectFile").css("cursor","not-allowed"),e("#projectFile").attr("disabled",!0))},checkFileName:function(e,a){var t=this,r={orderNo:t.param.ckeckFileName.param.orderNo,fileName:e},i={url:t.param.ckeckFileName.url,type:t.param.ckeckFileName.type,data:r},l=t.useHttp(i);a(JSON.parse(l))},delOrderFile:function(e,a){var t,r=this;t="tradeOrder"===r.param.system?"/api/v1/trd/order/files/"+r.param.orderNo+"/"+e+"/delete":"/api/v1/order/files/"+r.param.orderNo+"/"+e+"/delete";var i={url:t,type:r.param.delOrderFile.type,data:r.param.delOrderFile.param},l=r.useHttp(i);a(JSON.parse(l))},addOrderFile:function(e,a){var t=this,r={url:t.param.addOrderFile.url,type:t.param.addOrderFile.type,data:e},i=t.useHttp(r);a(JSON.parse(i))},getFileType:function(e){var a=this;e||(e={q:"",orderStatus:a.param.orderStatus});var t={url:a.param.orderFileType.url,type:a.param.orderFileType.type,data:e};return JSON.parse(a.useHttp(t))},use:function(a,r){e.ajax({url:a.url,type:"get",dataType:"html",async:!1,success:function(r){if(a.type&&"css"==a.type.toLowerCase()){var i=t.createElement("style");i.innerHTML=r,e("head")[0].append(i)}else a.type&&"html"==a.type.toLowerCase()&&e(a.append).html(r)}})},useHttp:function(a){return e.ajax({url:a.url,datatype:"json",data:a.data,contentType:"application/json; charset=utf-8",type:a.type,cache:!1,async:!1}).responseText}},e.fn.uploadBox=function(e){return new i(this,e),l}}(jQuery,window,document);