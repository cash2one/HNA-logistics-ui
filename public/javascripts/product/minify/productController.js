easySpa.require(["widget/slimscroll","widget/select","public/javascripts/product/20161224/productRoute.js","public/common/tableController.js","widget/prompt","widget/select"],function(){app.controller("productCtrl",["$scope","productService","productView","tableService","$timeout",function(t,e,a,o,r){function d(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-250})}function n(){void 0===t.tableModel.restData.status&&(t.tableModel.restData.status=1);var e={urlParams:t.tableModel.restData};t.q=t.productName,o.getTable(t.tableModel.restURL,e,function(r){t.q=t.tableModel.restData.q,0===r.errorCode&&(t.tableModel=o.table(t.tableModel,e,r),setTimeout(function(){d(),$(window).on("resize",d),t.$apply(),$(".table-box").focus(),a.unlockBtn()},100))})}var l;t.states={data:[{id:-1,name:Lang.getValByKey("product","product_state_all")},{id:1,name:Lang.getValByKey("product","product_state_draft")},{id:2,name:Lang.getValByKey("product","product_state_unAudit")},{id:3,name:Lang.getValByKey("product","product_state_audit")},{id:4,name:Lang.getValByKey("product","product_status_online")},{id:5,name:Lang.getValByKey("product","product_status_offline")}]},t.viewButton={isTabList:!1,isShowOperAreaLine:!1,isShowCheckBox:!0},t.getTabType=function(){var t=-1,e=$(".tab-active");return"none"!=$(".tab-list").css("display")&&e.length>0&&(t=e.attr("data-type")),t},t.initTable=function(){t.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("product","product_product_name"),Lang.getValByKey("product","product_code"),Lang.getValByKey("product","product_group"),Lang.getValByKey("product","product_good_type"),Lang.getValByKey("product","product_introduce"),Lang.getValByKey("product","product_service_state")],tableHeaderSize:["5%","15%","15%","15%","15%","15%","15%"],tableBody:[],restURL:"logistics.queryProductList",restData:{q:"",pageIndex:1,pageSize:10,orderby:"createtime"},selectNumber:0,selectFlag:!1},n(),t.$watch("tableModel.tableBody",function(t,e){for(var a=0;a<t.length;a++){for(var o=t[a].cargos,r=[],d=0;d<o.length;d++)o[d].cargoTypeName&&r.push(o[d].cargoTypeName);t[a].goodsType=r.join(",")}})},t.bindEvent=function(){t.add=function(){var e=easySpa.queryUrlValByKey("module"),a=t.getTabType();location.href="#/addProduct?&from="+e+"&type="+a},t.search=function(){if(-1==t.statusId){var e=easySpa.queryUrlValByKey("module");t.tableModel.restData.status="approval"==e?3:-1,t.tableModel.restData.includeAllAudit=!0}else t.tableModel.restData.includeAllAudit=!1,t.tableModel.restData.status=t.statusId;t.tableModel.restData.cargoType=t.goodsTypeId,t.tableModel.restData.topGrade=t.productGroup1Id,t.tableModel.restData.secondGrade=t.productGroup2Id,t.tableModel.restData.q=t.productName,t.tableModel.restData.pageIndex=1,n()},t.editProduct=function(e,a){var o=t.getTabType(),r=easySpa.queryUrlValByKey("module");location.href="#/addProduct?uid="+e+"&id="+a+"&type="+o+"&from="+r},t.resetData=function(){var e=t.getTabType();t.tableModel.restData.status="",t.tableModel.restData.cargoType="",t.tableModel.restData.topGrade="",t.tableModel.restData.secondGrade="",t.tableModel.restData.q="",t.goodsType="",t.goodsTypeId="",t.productGroup1Id="",t.productGroup2Id="",t.productGroup1="",t.productGroup2="",t.productName="",t.state=Lang.getValByKey("product","product_state_draft"),t.statusId=1,1==e?(t.state=Lang.getValByKey("product","product_state_unAudit"),t.statusId=2):2==e&&(t.state=Lang.getValByKey("product","product_state_audit"),t.statusId=3),t.search()},t.delete=function(){if(0!=t.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var a=[],r=o.getSelectTable(t.tableModel.tableBody);if(!r.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("product","product_prompt_delay_tip"),type:"errer",manualClose:!0}),!1;angular.forEach(r,function(t){a.push(t.uid)}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("product","product_prompt_delete_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){e.deleteProduct(a,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),n()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("product","product_prompt_delay_tip"),type:"errer",manualClose:!0})},t.showConfirmWindow=function(e,a){0!=t.tableModel.selectNumber&&0!=$(".table-box tbody tr").length?(a||(a=Lang.getValByKey("common","common_pagination_confirm")),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:a},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){$(document).promptBox("closePrompt"),e()}}]})):$(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("product","product_prompt_delay_tip"),type:"errer",manualClose:!0})},t.verify=function(){t.showConfirmWindow(function(){var a=[],r=o.getSelectTable(t.tableModel.tableBody);if(!r.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("product","product_prompt_delay_tip"),type:"errer",manualClose:!0}),!1;angular.forEach(r,function(t){a.push(t.uid)}),e.submitProducts(a,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),n()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},"确定提交已选产品？")},t.showCheckStream=function(e,a){var o=easySpa.queryUrlValByKey("module"),r=t.getTabType();window.location.href="#/checkStream?uid="+e+"&page=product&from="+o+"&name="+a+"&type="+r}},t.initSelect=function(){e.getGoods(function(e){selectFactory({data:e,id:"goods-type",attrTextModel:function(e,a,o){t.goodsTypeId=e?o.id:"",t.goodsType=e,t.$apply()}})}),e.queryProductGroup({async:!0},function(a){selectFactory({data:a,id:"product-group1",defaultText:"全部",attrTextModel:function(a,o,r){if($("#product-group2").val(""),delete t.productGroup2,delete t.productGroup2Id,l.clearData(),!a)return delete t.productGroup1,void delete t.productGroup1Id;var d=r.id;t.productGroup1=a,t.productGroup1Id=r.id,e.queryProductGroup({parentId:d},function(t){l.setData(t)}),t.$apply()}})}),l=selectFactory({data:[],id:"product-group2",defaultText:"全部",attrTextModel:function(e,a,o){t.productGroup2=e,t.productGroup2Id=o.id,t.$apply()}}),t.states.data.forEach(function(e){"草稿"===e.name&&(t.state=e.name,t.statusId=e.id)}),r(function(){t.viewButton.isTabList&&(t.states.data=t.states.data.filter(function(t){if(1!=t.id&&2!=t.id)return t})),selectFactory({data:t.states,id:"service-state",defaultText:"",attrTextModel:function(e,a,o){t.state=e,t.statusId=o.id,t.$apply()}})},0)},t.initPageData=function(){var e=easySpa.queryUrlValByKey("module");t.showSelectStatus="new"==e};var u=easySpa.queryUrlValByKey("id"),c=easySpa.queryUrlValByKey("uid");if(u){t.initPageData(),t.initTable(),controller.init(t,e,o);var p=t.getTabType(),i=easySpa.queryUrlValByKey("module"),s=easySpa.queryUrlValByKey("orderNo");location.href="#/addProduct?uid="+c+"&id="+u+"&type="+p+"&from="+i+"&orderNo="+s}!function(){t.initPageData(),t.initTable(),t.bindEvent(),t.initSelect(),a.bindEvent()}(),controller.init(t,e,o)}])});