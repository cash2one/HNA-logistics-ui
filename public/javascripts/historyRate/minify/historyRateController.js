easySpa.use(["widget/slimscroll","widget/prompt","widget/select","widget/calander","public/common/tableController.js"]),app.controller("historyRateCtrl",["$scope","historyRateService","historyRateView","tableService",function(e,t,r,a){function o(e){t.deleteRateList(e,function(e){0===e.errorCode?($(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),i()):$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})}function n(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-250})}function i(){var t={urlParams:e.tableModel.restData};a.getTable(e.tableModel.restURL,t,function(r){e.q=e.tableModel.restData.q,0===r.errorCode&&(e.tableModel=a.table(e.tableModel,t,r),setTimeout(function(){n(),$(window).on("resize",n),e.$apply(),$(".table-box").focus()},100))})}e.goBack=function(){window.location.href="#/rate"},e.sourceCurrency=easySpa.queryUrlValByKey("sourceCurrency"),e.destCurrency=easySpa.queryUrlValByKey("destCurrency"),e.sourceName=easySpa.queryUrlValByKey("sourceName"),e.destName=easySpa.queryUrlValByKey("destName"),e.title=e.sourceName+"-"+e.destName,e.clearSearchCondition=function(){$("#begin-time").val(""),$("#finish-time").val(""),delete e.tableModel.restData.beginTime,delete e.tableModel.restData.endTime,i()},e.endTime="2100-01-01 00:00:00",e.add=function(){e.isEdit=!1,e.promptTitle=Lang.getValByKey("historyRate","history_rate_create_title"),e.nestRateFrom=!0,e.isCreateNewRate=!0,e.rateCurrent=e.sourceCurrency,e.exchange=e.destCurrency,e.rateVal="",e.id="",$("#nest-rateFrom").css("display","table"),$(".errors").addClass("ng-hide"),e.startTime=(new Date).format("yyyy-MM-dd hh:mm:ss"),$(".input-text").removeClass("ng-dirty")},e.editRate=function(t){e.isEdit=!0,$("#nest-rateFrom").css("display","table"),e.isCreateNewRate=!1,e.promptTitle=Lang.getValByKey("historyRate","history_rate_update_title"),e.nestRateFrom=!0,e.rateCurrent=t.sourceCurrency,e.exchange=t.destCurrency,e.srouceName=t.sourceName,e.destName=t.destName,e.rateVal=t.rate,e.startTime=t.beginTime,e.endTime=t.endTime,e.id=t.id,$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.search=function(){e.tableModel.restData.beginTime=$("#begin-time").val(),e.tableModel.restData.endTime=$("#finish-time").val(),i()},e.delete=function(){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var t=[],r=a.getSelectTable(e.tableModel.tableBody);if(!r.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("historyRate","history_rate_prompt_delay_tip"),type:"errer",manualClose:!0}),!1;angular.forEach(r,function(e){t.push(e.id)}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("historyRate","history_rate_prompt_delete_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){o(t)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("historyRate","history_rate_prompt_delay_tip"),type:"errer",manualClose:!0})},e.closePrompt=function(){e.nestRateFrom=!1},e.savePrompt=function(r){if(r||(confrim=!1),e.rateCurrent||e.rateFrom.rateCurrent.$setDirty(),e.exchange||e.rateFrom.exchange.$setDirty(),e.rateVal||e.rateFrom.rateVal.$setDirty(),e.rateFrom.$valid){for(var a=$(".errors"),o=0;o<a.length;o++)if(!$(a[o]).hasClass("ng-hide"))return;e.isCreateNewRate?t.createNewRate({sourceCurrency:e.rateCurrent,destCurrency:e.exchange,sourceName:e.sourceName,destName:e.destName,rate:e.rateVal,beginTime:e.startTime,endTime:e.endTime,confirm:r},function(t){0!=t.errorCode&&202051!=t.errorCode&&202052!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):202051==t.errorCode||202052==t.errorCode?$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:t.msg},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){$(document).promptBox("closePrompt"),e.savePrompt(!0)}}]}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("historyRate","rate_create_rate_tips"),type:"success",time:3e3}),i())}):t.updateRate({sourceCurrency:e.rateCurrent,destCurrency:e.exchange,sourceName:e.sourceName,destName:e.destName,rate:e.rateVal,beginTime:e.startTime,endTime:e.endTime,id:e.id,confirm:r},function(t){0!=t.errorCode&&202051!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):202051==t.errorCode?$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:t.msg},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){$(document).promptBox("closePrompt"),e.savePrompt(!0)}}]}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("historyRate","history_rate_update_rate_tips"),type:"success",time:3e3}),i())})}},e.limit4Data=function(){var t=e.rateVal.split(".");t.length>1&&t[1].length>4&&(e.rateVal=e.rateVal.substring(0,e.rateVal.length-1))},e.verifyRateFormat=function(){/^([1-9]\d{0,15}|0)(\.\d{1,4})?$/.test(e.rateVal)?($("#rate-val-msg").addClass("ng-hide"),e.rateFrom.rateVal.errorTips=""):(e.rateFrom.rateVal.$setDirty(),e.rateFrom.rateVal.errorTips=Lang.getValByKey("historyRate","rate_input_rate_val_limit"),$("#rate-val-msg").removeClass("ng-hide"))},r.initCalander(e),function(){e.tableModel={tableHeader:[Lang.getValByKey("historyRate","rate_history_id"),Lang.getValByKey("historyRate","rate_history_rate"),Lang.getValByKey("historyRate","rate_history_begin_time"),Lang.getValByKey("historyRate","rate_history_finish_time")],tableHeaderSize:["23.75%","23.75%","23.75%","23.75%"],tableBody:[],restURL:"logistics.getRateList",restData:{sourceCurrency:e.sourceCurrency,destCurrency:e.destCurrency,pageIndex:1,pageSize:10,isAsc:!1,unfilled:!0,sortName:"beginTime"},selectNumber:0,selectFlag:!1},i()}()}]);