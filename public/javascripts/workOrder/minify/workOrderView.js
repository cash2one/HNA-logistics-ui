app.factory("workOrderView",["tableService","workOrderService",function(e,t){var a,r,o=function(e,a){var r={urlParams:{q:e||"",pageIndex:a||1,pageSize:10}},o=t.getStaffList(r);return angular.forEach(o.data,function(e,t){e.fullName+="("+e.code+")"}),o};return{setScroll:function(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-300})},initStateSelect:function(e){function r(e,a){a||(a=1);var r={urlParams:{q:e||"",pageIndex:a,pageSize:10}};return t.getCustomerFullNameList(r)}selectFactory({data:{data:[{id:"0",name:Lang.getValByKey("workOrder","workOrder_created_state")},{id:"1",name:Lang.getValByKey("workOrder","workOrder_dealing_state")},{id:"2",name:Lang.getValByKey("workOrder","workOrder_dealed_state")},{id:"3",name:Lang.getValByKey("workOrder","workOrder_closed_state")}]},id:"state",defaultText:Lang.getValByKey("common","common_all_tips"),attrTextModel:function(t,a,r){t?(e.state=t,e.stateId=r.id):e.stateId=-1,e.$apply()}});var o=t.getCustomerList();a=selectFactory({data:o,id:"user-name",showTextField:"fullName",isSearch:!0,isSaveInputVal:!0,closeLocalSearch:!0,defaultText:Lang.getValByKey("common","common_select_tips"),pagination:!0,searchPlaceHoder:Lang.getValByKey("common","common_select_search_client_name_tips"),onSearchValueChange:function(e,t,o){var n=r(t,o);a.setData(n)},attrTextModel:function(t,a,r){t?(e.usernameId=r.id,e.username=t):(e.usernameId="",e.username=""),e.$apply()}})},initStaffSelect:function(e){r||(r=selectFactory({data:[],id:"creator",isSearch:!0,showTextField:"fullName",defaultText:Lang.getValByKey("common","common_select_tips"),searchPlaceHoder:"请输入姓名或工号",maxHeight:160,isNotUseFilter:!0,closeLocalSearch:!0,isSaveInputVal:!0,defaultCount:10,pagination:!0,onSearchValueChange:function(e,t){var a=o(t);e.setData(a)},attrTextModel:function(t,a){if(t){var r=a.data.find(function(e){return e.fullName==t});e.creator=r.id,e.creatorName=r.fullName}else e.creator="",e.creatorName="";e.$apply()}}),r.open())},initTable:function(e){var t=this;e.beginTime=getBeforeDate(6)+" 00:00:00",e.finishTime=(new Date).format("yyyy-MM-dd 23:59:59"),e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("workOrder","workOrder_code"),Lang.getValByKey("workOrder","workOrder_level"),Lang.getValByKey("workOrder","workOrder_problem_type"),Lang.getValByKey("workOrder","workOrder_title"),Lang.getValByKey("workOrder","workOrder_customer"),Lang.getValByKey("workOrder","workOrder_creator"),Lang.getValByKey("workOrder","workOrder_current_dealer"),Lang.getValByKey("workOrder","workOrder_update_time"),Lang.getValByKey("workOrder","workOrder_last_deal_time"),Lang.getValByKey("workOrder","workOrder_state")],tableHeaderSize:["5%","8%","7%","7%","11%","9%","9%","9%","12%","12%","6%"],tableBody:[],restURL:"logistics.getWorkOrderList",restData:{sortName:"createTime",beginTime:getBeforeDate(6)+" 00:00:00",endTime:(new Date).format("yyyy-MM-dd 23:59:59"),blockOrder:!1,q:"",pageIndex:1,pageSize:10,isAsc:!1,unfilled:!0},selectNumber:0,selectFlag:!1},e.$watch("tableModel.tableBody",function(e,a,r){for(var o=0;o<e.length;o++)e[o].creatorName=e[o].creatorFullName+"("+e[o].creatorUserName+")";t.unlockBtn()}),e.loadData()},initCalander:function(){Calander.init({ele:["#begin-time","#finish-time"]})},lockBtn:function(){$("#delete").attr("disabled","true"),$("#delete").addClass("disabled")},unlockBtn:function(){$("#delete").removeAttr("disabled"),$("#delete").removeClass("disabled")},check:function(){for(var e=!1,t=$(".checkbox"),a=0;a<t.length;a++)if(t[a].checked){var r=$(t[a]).attr("data-status");if(r!=Lang.getValByKey("workOrder","workOrder_closed_state")){e=!0,this.lockBtn();break}}e||this.unlockBtn()},bindEvent:function(r){var o=this;r.showCustomerList=function(){if(!a){var e=t.getCustomerList();a.setData(e)}},r.resetCreator=function(){o.initStaffSelect(r)},r.clearDate=function(){r.workId=void 0,r.creator=void 0,r.creatorName=void 0,r.username=void 0,r.title=void 0,r.state=Lang.getValByKey("workOrder","workOrder_created_state"),r.stateId="0",r.usernameId=void 0,r.username=void 0,r.beginTime=getBeforeDate(6)+" 00:00:00",r.finishTime=(new Date).format("yyyy-MM-dd 23:59:59"),$("#state").val(r.state),r.search()},r.search=function(){r.tableModel.restData.beginTime=r.beginTime,r.tableModel.restData.endTime=r.finishTime,r.tableModel.restData.workOrderCode=r.workId,r.tableModel.restData.title=r.title,r.tableModel.restData.creator=r.creator,r.tableModel.restData.customerUserId=r.usernameId,r.tableModel.restData.customerName=r.username,r.tableModel.restData.status=r.stateId,r.tableModel.restData.blockOrder=r.blockOrder,r.loadData()},r.createWorkId=function(){window.location.href="#/workOrderDetail"},r.isBlockOrder=function(){r.blockOrder=!r.blockOrder},r.delete=function(){if(0!=r.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var a=[],o=e.getSelectTable(r.tableModel.tableBody);if(!o.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("workOrder","workOrder_prompt_delay_tip"),type:"errer",manualClose:!0}),!1;angular.forEach(o,function(e){a.push(e.id)}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("workOrder","workOrder_prompt_delete_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){t.deleteWorkOrder(a,function(e){0===e.errorCode?($(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),r.loadData()):$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("workOrder","workOrder_prompt_delay_tip"),type:"errer",manualClose:!0})};var n=setInterval(function(){$(".tbody").length>0&&(clearInterval(n),n=null,$(".tbody").delegate(".checkbox","change",function(){o.check()}),$("#select-all").on("change",function(){o.check()}))},100)}}}]);