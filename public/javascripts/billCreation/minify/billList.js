easySpa.require(["public/common/tableController.js","widget/parseUrl","widget/select"],function(){function e(e,t,a){function r(){var t=a.getSelectTable(e.tableModel.tableBody);return t=t.map(function(e){return e.billNo})}e.paramter=window.parseUrl.getParams(),e.userType=1,e.paramter&&"trade"==e.paramter.module&&(e.userType=2),e.search={},t.nowScope=e,e.unwatcher=[],e.num=Math.random().toString(36).substring(3,8),e.initBillingStatus=function(){e.billingStatus||t.billingStatus({seatParams:{interType:"",subInterType:1}},function(t){e.billingStatus=t})};var s=t.getLastMonth();e.search.startEffectTime=s.start,e.search.endEffectTime=s.end,e.search.status="DRAFT",e.statusName=e.lang.draft,e.unwatcher.push(e.$watch("billingStatus",function(a,r){a&&t.createSelect("billingStatus_"+e.num,a,function(t,a,r){"全部"==t&&(delete e.search.status,delete e.statusName,delete e.tableModel.restData.status),e.search.status=r.code,e.statusName=t})})),e.deleteBillByNumber=function(){var a,s=r();if(!t.checkData(s)){a="trade"==e.paramter.module?s:{billNos:s,customers:n};var l={urlParams:a,seatParams:{interType:"",subInterType:""}};"trade"==e.module&&(l.seatParams.interType=e.interType),l.seatParams.subInterType=e.subInterType,t.promptMidBox("",{msg:"确定删除已选账单？"},"",function(){t.deleteBillByNumber(l,function(a){t.promptBox(a),0===a.errorCode&&(e.loadListData(),e.$apply())})})}},e.submitBillInBilllist=function(){var a=r();if(!t.checkData(a)){var s={urlParams:a,seatParams:{interType:"",subInterType:""}};"trade"==e.module&&(s.seatParams.interType=e.interType),"logistics"==e.module&&(s.seatParams.interType=""),s.seatParams.subInterType=e.subInterType,t.promptMidBox("",{msg:"确定提交已选账单？"},"",function(){t.submitBillInBilllist(s,function(a){t.promptBox(a),0===a.errorCode&&(e.loadListData(),e.$apply())})})}},e.canHanle=function(t){var r=a.getSelectTable(e.tableModel.tableBody),s=0,l=0;return 0!==r.length&&(r.forEach(function(e){e.status!=t?l++:s++}),!(0===l&&s>0))},e.tableModel={tableHeader:[],tableHeaderSize:[],tableBody:[],restURL:"logistics.getAllBillList",restData:{q:"",refCombos:"",isAsc:!1,pageIndex:1,pageSize:10},selectNumber:0,selectFlag:!1};var l=["status","billNo","orderNo","waybillNo","customerId","startEffectTime","endEffectTime"];e.loadListData=function(){var r=angular.copy(e.tableModel.restData);l.forEach(function(e){delete r[e]}),angular.extend(r,t.getSearchData(e)),"trade"==e.module?(r.platformIds=e.platformValue,"pay"==e.submodule?r.bizCompanyIds=e.customerValue:r.bizCompanyIds=r.customerId):(r.settlement=e.payWay,"pay"==e.submodule?r.customerId=e.customerValue:r.customerId=r.customerId),r.status=e.search.status;var s={urlParams:r,seatParams:{interType:e.interType,subInterType:e.subInterType}};a.getTable(e.tableModel.restURL,s,function(t){e.q=e.tableModel.restData.q,0===t.errorCode&&(e.count+=1,e.tableModel=a.table(e.tableModel,s,t))})};var i=null;e.initUserList=function(){if(!e.userList){var a={urlParams:{q:"",pageIndex:1,pageSize:10,isAsc:!1,sortName:"",userType:e.userType}};t.getCurrentUserVisibleUserList(a,function(t){t.data.forEach(function(e){e.name=e.userName+" ("+e.code+")"}),e.userList=t,i||(i=t)})}};var n=[];e.resetUserList=function(){t["userList2_"+e.num]&&i&&t["userList2_"+e.num].setData(i)},e.unwatcher.push(e.$watch("userList",function(a,r){a&&(t["userList2_"+e.num]?t["userList2_"+e.num].setData(a):t.createSelect("userList2_"+e.num,a,function(t,a,r){if(t){var s=t.split("，");a.data.forEach(function(e){s.forEach(function(t){t==e.name&&-1===n.indexOf(e.id)&&n.push(e.id)})}),e.search.customerId=n.join(",")}else delete e.search.customerId,n.length=0;e.$apply()},"mutile",function(a,r,s){s||(s=1),r=r||"";var l={urlParams:{q:r?r.trim():"",pageIndex:s,pageSize:10,isAsc:!1,sortName:"",userType:e.userType}};t.getCurrentUserVisibleUserList(function(t){t.data.forEach(function(e){e.name=e.userName+" ("+e.code+")"}),e.userList=t,e.$apply()},l)}))})),e.clearSearch=function(){e.$parent.clear(),t.clearSearch(e),e.search.startEffectTime=s.start,e.search.endEffectTime=s.end,e.search.status="DRAFT",e.statusName=e.lang.draft,e.payWay="",$("#billingStatus_"+e.num).val(e.lang.draft),e.loadListData()},e.billsDetail=function(t,a,r,s){window.location.href="#/billDetail?billNo="+t+"&customerId="+a+"&from=billCreation&status="+r+"&currency="+s+"&module="+e.module+"&submodule="+e.submodule},e.flowProcess=function(t){window.location.href="#/billStream?billNo="+t+"&from=billCreation&module="+e.module+"&submodule="+e.submodule};var o;e.showPayWay=function(){if(!o){var a={urlParams:{q:"",pageIndex:1,pageSize:100}};e.payWayData=t.getPayWayData(a),o=selectFactory({data:e.payWayData,defaultText:Lang.getValByKey("common","common_all_tips"),id:"select-payWay",attrTextModel:function(t,a,r){e.payWay=t||"",e.$apply()}}),o.open()}},e.loadListData(),function(){var e=[["#begin-time","#finish-time"]];setTimeout(function(){e.forEach(function(e){Calander.init({ele:e,isClear:!0})})},0)}()}app.controller("billList",["$scope","billCreationService","tableService",e])});