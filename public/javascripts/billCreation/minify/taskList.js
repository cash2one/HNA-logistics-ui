easySpa.require(["public/common/tableController.js","widget/select"],function(){function e(e,t,a){function r(t){t.forEach(function(t){var a=0;["completeOrderQuantity","skippedOrderQuantity","orderQuantity"].forEach(function(e){null==t[e]&&(t[e]=0)}),a="trade"==e.module?(t.completeOrderQty+t.skippedOrderQty)/t.orderQty:(t.completeOrderQuantity+t.skippedOrderQuantity)/t.orderQuantity,a=isNaN(a)?0:parseInt(100*a),t.quantityTxt=a})}function s(){var t=a.getSelectTable(e.tableModel.tableBody);return t=t.map(function(e){return e.taskCode})}e.search={},t.nowScope=e,e.unwatcher=[];var n=t.getLastMonth();e.startEffectTime=n.start,e.endEffectTime=n.end;var i=t.initTaskListTime();e.search.taskStartTime=i.start,e.search.taskEndTime=i.end,e.num=Math.random().toString(36).substring(3,8),e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("billCreation","billCreation_task_code"),e.lang.bill_out_start,e.lang.bill_out_end,e.lang.process,e.lang.task_start_time,e.lang.task_end_time,e.lang.status],tableHeaderSize:["5%","13%","13%","13%","13%","13%","13%","12%"],tableBody:[],restURL:"logistics.getTaskList",restData:{q:"",refCombos:"",isAsc:!1,pageIndex:1,pageSize:10},selectNumber:0,selectFlag:!1},e.getTaskDetail=function(a){var r={urlParams:{taskCode:a},seatParams:{interType:e.interType,subInterType:e.subInterType}};t.getBillTaskDetail(r,function(r){var s={};0==r.errorCode&&("trade"==e.module?(s.msg="<p>"+e.lang.completeOrderQuantity+": "+(r.data.completeOrderQty?r.data.completeOrderQty:0)+"</p>",s.msg+="<p>"+e.lang.skippedOrderQuantity+": "+(r.data.skippedOrderQty?r.data.skippedOrderQty:0)+"</p>"):(s.msg="<p>"+e.lang.completeOrderQuantity+": "+(r.data.completeOrderQuantity?r.data.completeOrderQuantity:0)+"</p>",s.msg+="<p>"+e.lang.skippedOrderQuantity+": "+(r.data.skippedOrderQuantity?r.data.skippedOrderQuantity:0)+"</p>")),t.promptMidBox(a+e.lang.task_detail,s,"",angular.noop)})};var o=["taskStartTime","taskEndTime","taskStatus","startEffectTime","endEffectTime","taskCode"];if(e.loadListData=function(){var s=angular.copy(e.tableModel.restData),n=t.getSearchData(e);o.forEach(function(e){delete s[e]}),angular.extend(s,n);var i={urlParams:s,seatParams:{interType:"",subInterType:""}};"trade"==e.module&&(i.seatParams.interType=e.interType),"logistics"==e.module&&(i.seatParams.interType=""),i.seatParams.subInterType=e.subInterType,e.showTable=!1,a.getTable(e.tableModel.restURL,i,function(t){r(t.data),e.q=e.tableModel.restData.q,0==t.errorCode&&(e.count+=1,e.tableModel=a.table(e.tableModel,i,t)),e.$apply()})},e.unwatcher.push(e.$watch("tableModel.pagination.currentPage",function(t,a){t!=a&&r(e.tableModel.tableBody)})),e.unwatcher.push(e.$watch("tableModel.restData.pageSize",function(t,a){t!=a&&r(e.tableModel.tableBody)})),e.$watch("count",function(a,r){t.setScroll("#taskTable",e)}),e.generateBills=function(){var a={msg:e.lang.confirm_effect+" "+e.startEffectTime+" - "+e.endEffectTime+" 的账单？"},r={urlParams:{startEffectTime:e.startEffectTime,endEffectTime:e.endEffectTime},seatParams:{interType:"",subInterType:""}};"trade"==e.module?(r.urlParams.platformIds=e.platformValue,r.seatParams.interType=e.interType,"pay"==e.submodule?r.urlParams.bizCompanyIds=e.customerValue:r.urlParams.bizCompanyIds=e.userListCode):"pay"==e.submodule?r.urlParams.customerIds=e.customerValue:r.urlParams.customerIds=e.userListCode,r.seatParams.subInterType=e.subInterType,t.promptMidBox("",a,e.lang.confirm_effect,function(){t.generateBills(r,function(a){t.promptBox(a),0===a.errorCode&&e.loadListData()})})},e.searchTaskList=function(){e.loadListData()},e.clearSearch=function(){t.clearSearch(e),e.search.taskStartTime=i.start,e.search.taskEndTime=i.end,e.taskStatusName="全部",e.search.taskStatus="",e.loadListData()},e.deleteTask=function(){var a=s();if(!t.checkData(a)){var r={urlParams:a,seatParams:{interType:"",subInterType:""}};"trade"==e.module&&(r.seatParams.interType=e.interType),"logistics"==e.module&&(r.seatParams.interType=""),r.seatParams.subInterType=e.subInterType,t.promptMidBox("",{msg:"确定删除已选任务？"},"",function(){t.deleteTask(r,function(a){t.promptBox(a),0==a.errorCode&&e.loadListData()})})}},e.repeatGenerateBills=function(){var a,r=s();if(!t.checkData(r)){a="trade"==e.module?r:{taskCodes:r,customers:d};var n={urlParams:a,seatParams:{interType:"",subInterType:""}};"trade"==e.module&&(n.seatParams.interType=e.interType),"logistics"==e.module&&(n.seatParams.interType=""),n.seatParams.subInterType=e.subInterType,t.repeatGenerateBills(n,function(a){t.promptBox(a),0==a.errorCode&&e.loadListData()})}},e.canDel=function(t){var r=a.getSelectTable(e.tableModel.tableBody),s=0,n=0;return 0!==r.length&&(r.forEach(function(e){e.taskStatus!=t?n++:s++}),!(0===n&&s>0))},t.statusList)e.statusList=t.statusList;else{var u={seatParams:{subInterType:e.subInterType}};t.getTaskStatus(u,function(a){e.statusList=a,a.data.unshift({name:"全部",code:""}),t.statusList=a})}var l=null;e.initUserList=function(){if(!e.userList){var a={urlParams:{q:"",pageIndex:1,pageSize:10,isAsc:!1,sortName:"",userType:e.userType}};t.getCurrentUserVisibleUserList(a,function(t){t.data.forEach(function(e){e.name=e.userName+" ("+e.code+")"}),e.userList=t,l||(l=t)})}},e.resetUserList=function(){t["userList_"+e.num]&&l&&t["userList_"+e.num].setData(l)},e.unwatcher.push(e.$watch("statusList",function(t,a){t.data.forEach(function(t){"全部"===t.name&&(e.taskStatusName=t.name,e.search.taskStatus=t.code)}),t&&setTimeout(function(){selectFactory({data:t,id:"task_status_"+e.num,offset:-300,attrTextModel:function(t,a,r){"全部"==t&&(delete e.taskStatusName,delete e.search.taskStatus,delete e.tableModel.restData.taskStatus),e.taskStatusName=t,e.search.taskStatus=r.code,e.$apply()}})},200),e.loadListData()}));var d=[];e.unwatcher.push(e.$watch("userList",function(a,r){a&&(t["userList_"+e.num]?t["userList_"+e.num].setData(a):t.createSelect("userList_"+e.num,a,function(t,a,r){if(t){var s=t.split("，");a.data.forEach(function(e){s.forEach(function(t){t==e.name&&-1===d.indexOf(e.id)&&d.push(e.id)})}),e.userListCode=d}else delete e.userListCode,d=[];e.$apply()},"mutile",function(a,r,s){s||(s=1),r=r||"";var n={urlParams:{q:r?r.trim():"",pageIndex:s,pageSize:10,isAsc:!1,sortName:"",userType:e.userType}};t.getCurrentUserVisibleUserList(function(t){t.data.forEach(function(e){e.name=e.userName+" ("+e.code+")"}),e.userList=t,e.$apply()},n)}))})),function(){var e=[["#begin-time","#finish-time"],["#taskStartTime","#taskEndTime"],["#startEffectTime","#endEffectTime"]];setTimeout(function(){e.forEach(function(e,t){var a=!1;t>0&&(a=!0),Calander.init({ele:e,isClear:a})})},0)}()}app.controller("taskList",["$scope","billCreationService","tableService",e])});