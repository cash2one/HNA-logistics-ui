app.controller("customerMessageDetailCtrl",["$scope","$route","customerMessageDetailService","customerMessageDetailView","$route",function(e,a,r,t,a){function s(){if(e.id){var a={seatParams:{pageSize:10,pageIndex:1,refAskBoardId:e.id}};r.getMsgHistoryList(a,function(a){if(0==a.errorCode&&a.data){e.totalPage=a.pagination.totalPage;for(var r=0;r<a.data.length;r++)if(a.data[r].isModerator)a.data[r].avatarFilePath||(a.data[r].avatarFilePath="/public/img/avatar-client.png"),t.insertCustomerDialogPre(a.data[r]);else{if(!a.data[r].avatarFilePath){var s=cookie.get("sex");a.data[r].avatarFilePath="f"==s?"/public/img/avatar2.png":"/public/img/avatar1.png"}a.data[r].refReplyerFullName.length>3?a.data[r].name=a.data[r].refReplyerFullName.substring(0,3)+"...":a.data[r].name=a.data[r].refReplyerFullName,t.insertServiceDialogPre(a.data[r])}}else $(document).promptBox({isDelay:!0,contentDelay:data.msg,type:"errer",manualClose:!0})});var s=document.getElementById("messageList");s.scrollTop=s.scrollHeight}}function o(){if(e.id=a.current.params.id,e.showDialog=!("true"===a.current.params.status),e.isJustShow=a.current.params.isJustShow||!1,0==e.showDialog&&$("#main").css("height","100%"),e.userName=a.current.params.userName,e.customerType=a.current.params.customerType,"anony"==e.customerType)e.anonyTel=""==a.current.params.anonyTel||"null"==a.current.params.anonyTel?"无":a.current.params.anonyTel,e.anonymity=""==a.current.params.anonymity||"null"==a.current.params.anonymity?"无":a.current.params.anonymity;else{e.refCustomerId=a.current.params.refCustomerId;var t={seatParams:{id:e.refCustomerId}};r.getCustomerDetailInfo(t,function(a){e.loginCustomerInfo=a.data})}}e.Solved=function(){var a={seatParams:{id:e.id}};r.closeLeaveMsg(a,function(a){0!=a.errorCode?$(document).promptBox({isDelay:!0,contentDelay:data.msg,type:"errer",manualClose:!0}):(e.showDialog=!1,$("#main").css("height","100%"),$(document).promptBox({isDelay:!0,contentDelay:data.msg,type:"success",time:3e3}))})},e.loadMore=function(){if(e.id){var a={seatParams:{pageSize:10,pageIndex:e.index,refAskBoardId:e.id}},s=document.getElementById("messageList");e.showLoding=!0,r.getMsgHistoryList(a,function(a){if(e.showLoding=!1,0==a.errorCode&&a.data&&e.index<=e.totalPage){e.totalPage=a.pagination.totalPage;for(var r=0;r<a.data.length;r++)a.data[r].isModerator?t.insertCustomerDialogPre(a.data[r]):t.insertServiceDialogPre(a.data[r]);e.index++,s.scrollTop=75}else $(document).promptBox({isDelay:!0,contentDelay:data.msg,type:"errer",manualClose:!0}),s.scrollTop=0})}},e.goBack=function(){a.current.params&&a.current.params.fromMenu?top.location.href="http://"+location.host+"/#/workOrderDetail?id="+a.current.params.workOrderId:top.location.href="http://"+location.host+"/#/customerMessage"},e.summit=function(){if(e.message){var a={urlParams:{messageBody:e.message,refAskBoardId:e.id}};r.leaveMsg(a,function(a){if(0!=a.errorCode)$(document).promptBox({isDelay:!0,contentDelay:data.msg,type:"errer",manualClose:!0});else{var r={time:a.data.createTime,content:e.message,pic:a.data.avatarFilePath,refReplyerFullName:a.data.refReplyerFullName,name:""};if(r.refReplyerFullName.length>3?r.name=r.refReplyerFullName.substring(0,3)+"...":r.name=r.refReplyerFullName,!r.pic){var s=cookie.get("sex");r.pic="f"==s?"/public/img/avatar2.png":"/public/img/avatar1.png"}t.summitMsg(r),e.message=""}})}},e.inputKeyUp=function(a){var r=window.event?a.keyCode:a.which;if(a.ctrlKey&&13==a.keyCode)return e.message=e.message+"\r",void console.log(e.message,"message");13==r&&(e.summit(),$(".text-legth").css("display","none"))},e.CreatOrder=function(){var e="http://"+location.host+"/#/workOrderDetail?fromMenu=customerMessageDetail&askboradid="+a.current.params.id+"&status="+a.current.params.status+"&refCustomerCode="+a.current.params.refCustomerCode+"&customerType="+a.current.params.customerType+"&refCustomerId="+a.current.params.refCustomerId+"&userName="+a.current.params.userName;a.current.params.anonyTel&&(e+="&anonyTel="+a.current.params.anonyTel),a.current.params.anonymity&&(e+="&anonymity="+a.current.params.anonymity),top.location.href=e},function(){o(),s(),e.index=2,$("#messageList").scroll(function(){console.log($("#messageList").scrollTop()),0==$("#messageList").scrollTop()&&e.loadMore()}),reSetMenuCssStatus("#/customerMessage")}()}]);