easySpa.require(["public/common/tableController.js","widget/select","widget/prompt","public/common/calander.js","public/javascripts/tradeOrders/20161224/tradeOrdersService.js","public/javascripts/tradeOrders/20161224/tradeOrdersView.js","public/javascripts/tradeOrders/20161224/detailController.js","public/javascripts/tradeOrders/20161224/sdetailController.js"],function(){app.controller("tradeOrderSearchCtrl",["$scope","$route","tradeOrdersService","tradeOrdersView","tradeOrderSearchService","tradeOrderSearchView","tableService","$compile",function(e,a,t,r,o,s,i,d){"cockpit"===a.current.params.orderFrom&&(e.fromCockpit=!0),e.search={},e.orderType="SALE",s.initCalander(e);var c=null;if(e.tableModel={tableHeader:["序号","订单号","业务单号","商品信息","销售方","采购方","创建时间","订单状态"],tableHeaderSize:["5%","15%","15%","20%","10%","10%","15%","10%"],tableBody:[],restURL:"logistics.getTrdOrderList",restData:{q:"",refCombos:"",isAsc:!1,pageIndex:1,pageSize:10,customerId:e.search.customerId,goodsId:e.goodsId,orderType:e.orderType,startTime:e.search.startTime,endTime:e.search.endTime},selectNumber:0,selectFlag:!1},e.orderGoodsMsg=function(e){var a=[];return e.forEach(function(e){a.push(e.goodsName)}),a.join(",")},e.loadListData=function(){if(void 0!==e.search.orderNo&&""!==e.search.orderNo){var a=e.search.orderNo;for(var t in e.search)e.search[t]="",e[t]="";e.isEnabled="全部",e.purchaserLimit="全部",e.projectLimit="全部",e.goods="",$("#goods").val(""),$("#supplierName").val(""),$("#likedusernamelist").val(""),e.search.orderStatus=void 0,e.ordersStatusName="",e.tableModel.restData.pageIndex=1,$("#startTime").val(""),$("#endTime").val(""),e.search.orderNo=a}var r=angular.copy(e.tableModel.restData);s.resetKeys(r,e.search),$.extend(r,e.search),r.startTime=$("#startTime").val(),r.endTime=$("#endTime").val(),r.orderType=e.orderType;for(var t in r)""===r[t]&&delete r[t];r={urlParams:r},i.getTable(e.tableModel.restURL,r,function(a){e.tableModel=i.table(e.tableModel,r,a),e.$apply()})},setTimeout(function(){e.loadListData()},0),e.searchBtn=function(){e.tableModel.restData.pageIndex=1,e.loadListData()},e.clearSearch=function(){for(var a in e.search)e.search[a]="",e[a]="";e.isEnabled="全部",e.purchaserLimit="全部",e.projectLimit="全部",e.goods="",$("#goods").val(""),$("#supplierName").val(""),$("#likedusernamelist").val(""),e.search.orderStatus=void 0,e.ordersStatusName="",e.tableModel.restData.pageIndex=1,s.initCalander(e),e.loadListData()},e.getDetail=function(a,t){s.getTpl(a).then(function(a){e.child=e.$new(),e.child.orderNo=t,e.presentOrderNo=t,$("#detail").html(d(a)(e.child))})},"cockpit"===a.current.params.orderFrom){var n=a.current.params.cockpitPage,l=a.current.params.orderNo;e.getDetail(n,l)}e.goBack=function(t){"cockpit"===a.current.params.orderFrom?"sale"===a.current.params.cockpitType?window.location.href="#/cockpit?from=saleOrder":window.location.href="#/cockpit?from=purchaseOrder":(e.child.$destroy(),$("#detail").html(""),t&&e.loadListData())},e.getSalesGoods=function(a,r){a=a||"";var o={q:a?a.trim():"",pageIndex:r||1,pageSize:10,isAsc:!1,orderType:e.orderType,sellId:"SALE"===e.orderType?void 0:e.search.customerId};return t.getTrdGoodsShortList(o)},e.initGoods=function(){c=selectFactory({data:[],isSearch:!0,isSaveInputVal:!0,pagination:!0,isUsePinyin:!0,id:"goods",showTextField:"userName",defaultText:"请选择",searchPlaceHoder:"请输入名称或编码",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(a,t,r){e.Goods=e.getSalesGoods(t,r),angular.forEach(e.Goods.data,function(e,a){e.userName=e.name+"("+e.code+")"}),a.setData(e.Goods),e.$apply()},attrTextId:function(a){e.search.goodsId=a||"",e.$apply()},attrTextModel:function(a){e.goods=a,e.$apply()}}),c.open(),$("#goods").val(e.goods)},e.clearGoods=function(){c.allData&&(c.setData({}),$("#goods").val(""),e.goods="")},e.getProjectShortData=function(e,a){e=e||"";var t={project:e?e.trim():"",pageIndex:a||1,pageSize:10,isAsc:!1,includeClosed:!0};return o.trdProjectsShort(t)},e.initProjectShort=function(){e.projectData=e.getProjectShortData(),angular.forEach(e.projectData.data,function(e,a){e.userName=e.name+"("+e.code+")"}),selectFactory({data:[],isSearch:!0,isSaveInputVal:!0,pagination:!0,isUsePinyin:!0,id:"projectId",showTextField:"userName",defaultText:"请选择",searchPlaceHoder:"请输入名称或编码",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(a,t,r){e.customerData=e.getProjectShortData(t,r),angular.forEach(e.customerData.data,function(e,a){e.userName=e.name+"("+e.code+")"}),a.setData(e.customerData),e.$apply()},attrTextId:function(a){e.search.projectId=a||"",e.$apply()},attrTextModel:function(a){e.projectId=a,e.$apply()}}).open(),$("#projectId").val(e.projectId)},e.getCustomerIdData=function(e,a){e=e||"";var t={q:e?e.trim():"",pageIndex:a||1,pageSize:10,isAsc:!1,sortName:"",userType:"2"};return o.getEnterpriseNameTradeCustomer(t)},e.initCustomerId=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,pagination:!0,id:"customerId",showTextField:"userName",defaultText:"请选择",searchPlaceHoder:"请输入账户名或编码",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(a,t,r){e.customerData=e.getCustomerIdData(t,r),angular.forEach(e.customerData.data,function(e,a){e.userName=e.name+"("+e.code+")"}),a.setData(e.customerData),e.$apply()},attrTextId:function(a){e.search.customerId=a||"",e.$apply()},attrTextModel:function(a){e.customerId!==a&&($("#likedusernamelist").val(""),e.likedusernamelist=""),e.customerId=a,e.$apply()}}).open(),$("#customerId").val(e.customerId)};var u;e.initBusinessType=function(){u||(e.goodsTypeData=o.trdGoodTypeList(),u=selectFactory({data:e.goodsTypeData,id:"goodsType",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(a){e.statusValue=a||"AUDITING",e.$apply()},attrTextModel:function(a){e.status=a,e.$apply()}}))},e.getSuppelierData=function(e,a){e=e||"";var t={q:e?e.trim():"",pageIndex:a||1,pageSize:10,isAsc:!1,sortName:""};return o.trdSuppelyList(t)},e.initSupplier=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:"请选择",pagination:!0,id:"supplierName",showTextField:"userName",attrTextField:{"ng-value":"id"},searchPlaceHoder:"请输入名称或编码",closeLocalSearch:!0,onSearchValueChange:function(a,t,r){e.suppelierData=e.getSuppelierData(t,r),angular.forEach(e.suppelierData.data,function(e,a){e.userName=e.name+" ("+e.code+")"}),a.setData(e.suppelierData),e.$apply()},attrTextId:function(a){e.search.customerId=a||"",e.clearGoods(),e.$apply()},attrTextModel:function(a,t,r){e.supplierName=a,e.$apply()}}).open(),$("#supplierName").val(e.supplierName)},e.getLikedusernamelistData=function(a,t){a=a||"";var r={q:a?a.trim():"",pageIndex:t||1,pageSize:10,isAsc:!1,sortName:"",userType:2,refCustomerId:e.search.customerId};return o.trdLikedusernamelist(r)},e.initLikedusernamelist=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,pagination:!0,defaultText:"请选择",searchPlaceHoder:"请输入姓名或用户名",id:"likedusernamelist",showTextField:"name",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(a,t,r){e.suppelierData=e.getLikedusernamelistData(t,r),angular.forEach(e.suppelierData.data,function(e,a){e.name=e.fullName+" ("+e.userName+")"}),a.setData(e.suppelierData),e.$apply()},attrTextId:function(a){e.search.cusUserId=a||"",e.$apply()},attrTextModel:function(a,t,r){e.likedusernamelist=a,e.$apply()}}).open(),$("#likedusernamelist").val(e.likedusernamelist)},e.showOrderStatus=function(){if(!e.orderStatusData){e.orderStatusData=o.getTradeOrderStatus();var a=selectFactory({data:e.orderStatusData,defaultText:Lang.getValByKey("common","common_all_tips"),id:"select-orders-status",showTextField:"name",isSaveInputVal:!0,attrTextField:{"ng-value":"code"},attrTextId:function(a){e.search.orderStatus=a,e.$apply()},attrTextModel:function(a){e.ordersStatusName=a,e.$apply()}});a.setData(e.orderStatusData),a.open()}}}])});