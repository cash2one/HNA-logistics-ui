easySpa.require(["widget/slimscroll","widget/prompt","widget/select","public/common/tableController.js","public/common/calander.js"],function(){app.controller("customerMessageCtrl",["$scope","customerMessageService","customerMessageView","tableService",function(e,t,a,s){function o(){Calander.init({ele:["#start-time","#end-time"]})}function r(e,a){a||(a=1);var s={urlParams:{q:e||"",pageIndex:a,pageSize:10}},e=t.getCustomerFullNameList(s);return e}function l(){e.userNameFirstpage=r(""),d=selectFactory({data:e.userNameFirstpage,id:"user-name",showTextField:"fullName",isSearch:!0,closeLocalSearch:!0,searchPlaceHoder:"请输入用户名或姓名",isSaveInputVal:!0,pagination:!0,onSearchValueChange:function(e,t,a){var s=r(t,a);d.setData(s)},defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(t,a,s){t?(e.userNameId=s.id,e.userName=t):(e.userNameId="",e.userName=""),e.$apply()}})}function n(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-330})}function i(){var t={urlParams:e.tableModel.restData};s.getTable(e.tableModel.restURL,t,function(a){e.q=e.tableModel.restData.q,$(".table-box").css("zoom","1.0000001"),0===a.errorCode&&(e.tableModel=s.table(e.tableModel,t,a),setTimeout(function(){n(),$(window).on("resize",n),$(".table-box").focus(),resizeTable(),e.$apply(),$(".table-box").css("zoom","1")},400))})}function m(){e.tableModel={tableHeader:["序号","编码","用户姓名","最后回复内容","最后更新时间","状态"],tableHeaderSize:["5%","20%","20%","20%","25%","5%"],tableBody:[],restURL:"logistics.getMessageBookList",restData:{q:"",customerName:"",sortName:"",beginTime:getBeforeDate(6)+" 00:00:00",endTime:(new Date).format("yyyy-MM-dd 23:59:59"),status:2,isAsc:!1,pageIndex:1,pageSize:10},selectNumber:0,selectFlag:!1},i()}function u(){var t={data:[{name:"全部",code:0},{name:"已解决",code:1},{name:"未解决",code:2}],errorCode:0,msg:""};selectFactory({data:t,id:"state",defaultText:null,attrTextModel:function(t,a,s){t?(e.status=s.code,e.stateName=t):(e.status=0,e.stateName=""),e.$apply()}})}function c(){for(var t=s.getSelectTable(e.tableModel.tableBody),a=0;a<t.length;a++)if(0==t[a].status)return void(e.disableDelBtn=!0);e.disableDelBtn=!1}var d={};!function(){m(),l(),u(),o(),e.disableDelBtn=!1,e.stateName="未解决",e.status=2,e.userName="",e.startTime=getBeforeDate(6)+" 00:00:00",e.endTime=(new Date).format("yyyy-MM-dd 23:59:59")}(),e.reSetUserNameList=function(){d.setData(e.userNameFirstpage)},e.resetData=function(){e.filterUser="",e.userName="",e.userNameId="",e.messageContent="",e.stateName="未解决",e.status=2,e.startTime="",e.endTime="",e.tableModel.restData.q="",e.startTime=getBeforeDate(6)+" 00:00:00",e.endTime=(new Date).format("yyyy-MM-dd 23:59:59"),e.search()},e.search=function(){e.filterUser=e.tableModel.restData.customerName=e.userName,e.tableModel.restData.status=e.status,e.tableModel.restData.q=e.messageContent,e.tableModel.restData.beginTime=e.startTime,e.tableModel.restData.endTime=e.endTime,i()},e.jumpToCustomMesDetail=function(e){e.refCustomerId<1?top.location.href="http://"+location.host+"/#/customerMessageDetail?id="+e.id+"&status="+e.status+"&userName="+e.customerFullName+"&customerType=anony&anonyTel="+e.anonyTel+"&anonymity="+e.anonymity+"&refCustomerCode="+e.code:top.location.href="http://"+location.host+"/#/customerMessageDetail?id="+e.id+"&status="+e.status+"&userName="+e.customerFullName+"&customerType=login&refCustomerId="+e.refCustomerId+"&refCustomerCode="+e.code},e.$watch("tableModel",function(e,t){e!==t&&c()},!0),e.deleteMsg=function(){s.delTableListById(e.tableModel,"是否确认删除所选留言？",t.delCustomerMsg,i)}}])});