easySpa.require(["widget/slimscroll","widget/prompt","widget/select","public/common/tableController.js","widget/slides"],function(){app.controller("carrierMaritimeCtrl",["$scope","carrierMaritimeService","carrierMaritimeView","tableService",function(e,r,a,t){function i(e){var r=e?e.length:0;$("#globalization").children("li").each(function(){$(this).children("input").removeClass("lang-invalid ng-invalid ng-dirty").next(".verification").children("span").html("");for(var a=$(this).children("input").val("").attr("data-code"),t=0;t<r;t++)e[t].language.toLowerCase()==a.toLowerCase()&&$(this).children("input").val(e[t].localName)})}function o(e,a){if(a||(a=r.getCountry()),e){a=a.data;for(var t=0;t<a.length;t++){var i=a[t].name;if($.trim(i)==$.trim(e)||$.trim(a[t].name)==$.trim(e))return a[t].code}return"无匹配结果"}}e.carrierMaritimeId={id:0},e.getLanguage=function(){r.getLanguage(function(r){0===r.errorCode&&(e.language=r.data)})},e.getLanguage(),e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("carrierMaritime","carrierMaritime_page_name"),Lang.getValByKey("carrierMaritime","carrierMaritime_page_country"),Lang.getValByKey("carrierMaritime","carrierMaritime_page_code"),Lang.getValByKey("common","common_page_remarks")],tableBody:[],restURL:"logistics.getShippingCompanyTable",restData:{q:"",countryId:"",pageIndex:1,pageSize:10,sort:"code"},selectNumber:0,selectFlag:!1},e.getTable=function(r){e.q=e.tableModel.restData.q,e.tableModel.restData.countryId=e.searchCountryCode,r&&(e.tableModel.restData.pageIndex=1);var a={urlParams:e.tableModel.restData};t.getTable(e.tableModel.restURL,a,function(r){if(0===r.errorCode){e.tableModel=t.table(e.tableModel,a,r);var i=$(".carrierMaritime-table-page").height()-255;setTimeout(function(){$(".table-container tbody").slimscroll({height:i}),$(window).resize(function(){i=$(".carrierMaritime-table-page").height()-255,$(".table-container tbody").slimscroll({height:i})})},10)}})},e.getTable();var n=$("#nest-carrierMaritimeForm .label-text");a.propmtCostEvent(n),e.add=function(){e.carrierMaritimeForm.$setPristine(),e.carrierMaritimeForm.$setUntouched(),e.nestCarrierMaritimeForm=!0,$("#nest-carrierMaritimeForm").attr("style","").find(".title").text(Lang.getValByKey("carrierMaritime","carrierMaritime_page_add")),$(".remote-invalid").removeClass("remote-invalid"),e.carrierMaritimeName="",e.carrierMaritimeCode="",e.addCountry="",e.addCountryCode="",e.remark="",e.textareaNumber=140,$("#globalization").find(".input-text").each(function(){$(this).val("").removeClass("lang-invalid ng-invalid ng-dirty"),$(this).next(".verification").children("span").html("")}),a.loadBarEvent(n),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.edit=function(t){e.carrierMaritimeId.id=t,$(".remote-invalid").removeClass("remote-invalid"),$("#nest-carrierMaritimeForm").attr("style","").find(".title").text(Lang.getValByKey("carrierMaritime","carrierMaritime_code_modelDetail")),e.nestCarrierMaritimeForm=!0,a.loadBarEvent(n),$('button[name="prompt-save"]').addClass("save").removeClass("edit"),r.getDetail({seatParams:{id:t}},function(r){r&&0===r.errorCode&&(e.carrierMaritimeName=r.data.name,$("#carrierMaritimeName_id").val(r.data.name),e.carrierMaritimeCode=r.data.code,$("#carrierMaritimeCode_id").val(r.data.code),e.addCountry=r.data.countryName+"("+r.data.countryId+")",e.addCountryCode=r.data.countryId,e.remark=r.data.description,e.textareaNumber=140-(e.remark?e.remark.length:0),i(r.data.i18n))})},e.save=function(){if(e.carrierMaritimeName.trim()||e.carrierMaritimeForm.carrierMaritimeName.$setDirty(),e.carrierMaritimeCode.trim()||e.carrierMaritimeForm.carrierMaritimeCode.$setDirty(),e.addCountry||e.carrierMaritimeForm.addCountry.$setDirty(),!e.enNameError){var t=[];if($("#globalization").children("li").each(function(){var r=$.trim($(this).children("input").val()),a={};a.language=$(this).children("input").attr("data-code"),"en-us"===a.language&&(r=e.carrierEnName),r&&(a.localName=r,t.push(a))}),$("#code-msg-name").hasClass("remote-invalid")||!e.carrierMaritimeForm.$valid)return void a.displayErrorBox(n);if($("#code-msg-code").hasClass("remote-invalid")||!e.carrierMaritimeForm.$valid)return void a.displayErrorBox(n);var i={urlParams:{name:e.carrierMaritimeName,code:e.carrierMaritimeCode,countryId:e.addCountryCode,description:e.remark,i18n:t}};e.carrierMaritimeId.id?(i.seatParams={id:e.carrierMaritimeId.id},r.saveEdit(i,function(r){r&&0===r.errorCode?(a.promptBox({isDelay:!0,contentDelay:r.msg,type:"success"}),e.nestCarrierMaritimeForm=!1,e.getTable(),e.carrierMaritimeId.id&&(e.carrierMaritimeId.id=0)):a.promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})):r.save(i,function(r){r&&0===r.errorCode?(a.promptBox({isDelay:!0,contentDelay:r.msg,type:"success"}),e.nestCarrierMaritimeForm=!1,e.getTable()):a.promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})}},e.del=function(){var i={},o=[],n=t.getSelectTable(e.tableModel.tableBody);if(!n.length)return a.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;angular.forEach(n,function(e){o.push(e.id)}),i={urlParams:o};var c={title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("carrierMaritime","carrierMaritime_code_modelDelTips")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){r.del(i,function(r){a.promptBox("closePrompt"),0===r.errorCode?(a.promptBox({isDelay:!0,contentDelay:r.msg,type:"success"}),e.getTable(),e.$apply()):a.promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})}}]};a.promptBox(c)},e.clearData=function(){e.q="",e.tableModel.restData.q="",e.tableModel.restData.countryId="",e.searchCountry="",e.searchCountryCode="",e.getTable()},e.showTextNumber=function(){e.textareaNumber=140-e.remark.length},e.checkShippingCompanyCode=function(){var a={urlParams:{code:e.carrierMaritimeCode,id:e.carrierMaritimeId.id}};e.carrierMaritimeCode&&r.checkShippingCompanyCode(a,function(r){0!=r.errorCode?(e.carrierMaritimeForm.carrierMaritimeCode.errorTips="编码已存在",$("#code-msg-code").removeClass("ng-hide").addClass("remote-invalid")):($("#code-msg-code").addClass("ng-hide").removeClass("remote-invalid"),e.carrierMaritimeForm.carrierMaritimeCode.errorTips="")})},e.checkEnName=function(){var r=/^([A-Za-z\d\-\&\.\,\(\)\s]+)+$/;e.carrierEnName&&!r.test(e.carrierEnName)?(e.enNameError=!0,e.enNameErrorTips="请输入英文、数字、空格和符号 “-”、“&”、“(”、“)”、“.”、“,”",$('input[name="$parent.carrierEnName"]').css("border-color","#FA787E")):(e.enNameError=!1,e.enNameErrorTips="",$('input[name="$parent.carrierEnName"]').css("border-color","#BDBDBD"))},e.cancel=function(){e.nestCarrierMaritimeForm=!1,e.carrierMaritimeForm.carrierMaritimeCode.errorTips="",e.carrierMaritimeId.id&&(e.carrierMaritimeId.id=0),e.enNameError=!1,e.enNameErrorTips="",$('input[name="$parent.carrierEnName"]').css("border-color","#BDBDBD")},e.international=function(){window.location.href="#/international?q=carrierMaritime"};var c,m;e.initSelectList=function(){var a={urlParams:{q:"",pageIndex:1,pageSize:10},isAsync:!0};e.searchCountrys=e.addCountrys=r.getCountry(a),c=selectFactory({data:e.searchCountrys,isSearch:!0,id:"search-country",pagination:!0,searchPlaceHoder:"请输入国家名称或二字码",defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(r,a,t){e.searchCountrys=e.getCountryData(a,t),r.setData(e.searchCountrys)},attrTextModel:function(r,a){e.searchCountryCode=o(r,a),e.searchCountry=r,e.$apply()}}),m=selectFactory({data:e.addCountrys,isSearch:!0,id:"add-country",pagination:!0,height:240,searchPlaceHoder:"请输入国家名称或二字码",defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(r,a,t){e.addCountrys=e.getCountryData(a,t),r.setData(e.addCountrys)},attrTextModel:function(r,a){e.addCountryCode=o(r,a),e.addCountry=r,e.$apply()}})},e.getCountryData=function(e,a){a||(a=1),e=e||"";var t={urlParams:{q:e,pageIndex:a,pageSize:10,includeAllAudit:!0},isAsync:!0},i=r.getCountry(t);return angular.forEach(i.data,function(e,r){e.name+="("+e.code+")"}),i}}])});