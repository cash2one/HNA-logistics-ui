easySpa.require(["widget/slimscroll","public/common/tableController.js","widget/select","widget/prompt"],function(){app.controller("weightCtrl",["$scope","weightService","weightView","tableService",function(e,t,i,o){function n(e){for(var t=$(".point"),i=0;i<t.length;i++)if(t[i]==e[0])return i}function r(t,i){for(var o=[],n=0;n<e.weightSectionList.length;n++)o.push(e.weightSectionList[n].startPoint),o.push(e.weightSectionList[n].endPoint);for(var n=t-1;n>=0;n--)if(o[n]+""&&$.trim(o[n]))return parseFloat(o[n]);return Number.NEGATIVE_INFINITY}function a(t,i){for(var o=[],n=0;n<e.weightSectionList.length;n++)o.push(e.weightSectionList[n].startPoint),o.push(e.weightSectionList[n].endPoint);for(var n=t+1;n<o.length;n++)if(o[n]+""&&$.trim(o[n]))return parseFloat(o[n]);return Number.POSITIVE_INFINITY}function g(e){t.deleteWeightList(e,function(e){0===e.errorCode?($(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),l()):($(document).promptBox("closePrompt"),$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0}))})}function s(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-250})}function l(){var t={urlParams:e.tableModel.restData};o.getTable(e.tableModel.restURL,t,function(i){e.q=e.tableModel.restData.q,0===i.errorCode&&(e.tableModel=o.table(e.tableModel,t,i),setTimeout(function(){s(),$(window).on("resize",s),e.$apply(),$(".table-box").focus()},100))})}e.wordCount=140,e.weightSectionList=[{startPoint:"0",endPoint:""}],e.deleteSection=function(){e.weightSectionList.splice(e.weightSectionList.length-1,1),setTimeout(function(){0==$(".error").length&&($("#weight-msg").addClass("ng-hide"),$("#weight-msg").html(""))},10)},e.initSelectList=function(){e.unit="kg"},e.verifyMark=function(){e.wordCount=140-$("#mark").val().length,e.wordCount<0&&(e.wordCount=0,e.mark=e.mark.substring(0,140))},e.limit3Data=function(t,i){if($.trim($(t.target).val())){var o=$(t.target).val(),n=o.split(".");n.length>1&&n[1].length>3&&e.weightSectionList[i]&&($(t.target).hasClass("start-point")?e.weightSectionList[i].startPoint=o.substring(0,o.length-1):e.weightSectionList[i].endPoint=o.substring(0,o.length-1))}},e.isExistedCode=function(){if(e.oldWeightCode!=e.weightCode&&!e.weightFrom.weightCode.$error.defined){var i=t.isExistedCode({code:e.weightCode});i&&i.data?(e.weightFrom.weightCode.errorTips=Lang.getValByKey("weight","weight_input_weight_code_repeat"),$("#code-msg").removeClass("ng-hide")):(e.weightFrom.weightCode.errorTips="",$("#code-msg").addClass("ng-hide"))}},e.verifyWeightFormat=function(t){var i=parseFloat($(t.target).val());/^([1-9]\d{0,15}|0)(\.\d{1,4})?$/.test($(t.target).val())?($(t.target).removeClass("error"),0==$(".error").length&&($("#weight-msg").addClass("ng-hide"),$("#weight-msg").html(""))):($("#weight-msg").html(Lang.getValByKey("weight","weight_input_weight_limit")),$("#weight-msg").removeClass("ng-hide"),$(t.target).addClass("error"));var o=n($(t.target)),g=r(o,i),s=a(o,i);o%2==0?(i<g||i>=s)&&(e.weightSectionList[parseInt(o/2)].startPoint="",$("#weight-msg").html(Lang.getValByKey("weight","weight_input_weight_nouse")),$("#weight-msg").removeClass("ng-hide"),$(t.target).addClass("error")):(i<=g||i>s)&&(e.weightSectionList[parseInt(o/2)].endPoint="",$("#weight-msg").html(Lang.getValByKey("weight","weight_input_weight_nouse")),$("#weight-msg").removeClass("ng-hide"),$(t.target).addClass("error"))},e.addSection=function(){if(100!=e.weightSectionList.length){for(var t=!0,i=0;i<e.weightSectionList.length;i++)""==$.trim(e.weightSectionList[i].startPoint)&&(e.weightFrom["startPoint"+i].$setDirty(),t=!1),""==$.trim(e.weightSectionList[i].endPoint)&&(e.weightFrom["endPoint"+i].$setDirty(),t=!1);if(t){var o=$("#weight-msg");$(o).hasClass("ng-hide")&&e.weightSectionList.push({startPoint:e.weightSectionList[e.weightSectionList.length-1].endPoint,endPoint:""})}}},e.add=function(){e.wordCount=140,e.weightName="",e.weightCode="",e.oldWeightCode="",e.mark="",e.unit="kg",e.weightSectionList=[{startPoint:"0",endPoint:""}],e.promptTitle=Lang.getValByKey("weight","weight_create_title"),e.isCreateNewWeight=!0,e.nestWeightFrom=!0,$("#nest-weightFrom").css("display","table"),$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.edit=function(t){e.weightSectionList=[];var i=t.weightSectionList;$("#nest-weightFrom").css("display","table"),e.isCreateNewWeight=!1,e.promptTitle=Lang.getValByKey("weight","weight_detail_title"),e.nestWeightFrom=!0,e.weightName=t.name,e.weightCode=t.code,e.unit=t.unit,e.oldWeightCode=t.code,e.mark=$.trim(t.remark),$("#mark").val(t.remark),e.id=t.id,e.wordCount=140-e.mark.length;for(var o=0;o<i.length;o++)e.weightSectionList.push({startPoint:i[o].startPoint,endPoint:i[o].endPoint,refId:i[o].refId});$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.searchWeight=function(){e.tableModel.restData.pageIndex=1,l()},e.delete=function(){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var t=[],i=o.getSelectTable(e.tableModel.tableBody);if(!i.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("weight","weight_prompt_delay_tip"),type:"errer",manualClose:!0}),!1;angular.forEach(i,function(e){t.push(e.id)}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("weight","weight_prompt_delete_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){g(t)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("weight","weight_prompt_delay_tip"),type:"errer",manualClose:!0})},e.getUnitCodeByName=function(t){for(var i=e.unitList.data,o=0;o<i.length;o++)if(t==i[o].name)return i[o].code;return""},e.closePrompt=function(){e.nestWeightFrom=!1},e.savePrompt=function(){e.weightName||e.weightFrom.weightName.$setDirty(),e.weightCode||e.weightFrom.weightCode.$setDirty();for(var i=0;i<e.weightSectionList.length;i++)e.weightSectionList[i].startPoint||e.weightFrom["startPoint"+i].$setDirty(),e.weightSectionList[i].endPoint||e.weightFrom["endPoint"+i].$setDirty();if(!e.weightFrom.$valid)return void scrollToErrorView($(".switch-list"));for(var o=$(".errors"),i=0;i<o.length;i++)if(!$(o[i]).hasClass("ng-hide"))return;if(e.isCreateNewWeight)t.addWeight({name:e.weightName,code:e.weightCode,weightSectionList:e.weightSectionList,remark:e.mark,unit:e.unit},function(t){0!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),l())});else{for(var i=0;i<e.weightSectionList.length;i++)delete e.weightSectionList[i].$$hashKey;t.updateWeight({id:e.id,name:e.weightName,code:e.weightCode,weightSectionList:e.weightSectionList,remark:e.mark,unit:e.unit},function(t){0!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),l())})}},e.$watch("tableModel.tableBody",function(e,t,i){for(var o=0;o<e.length;o++){var n=e[o].weightSectionList,r="";for(jndex=0;jndex<n.length;jndex++)jndex!=n.length-1?r+=n[jndex].startPoint+"-"+n[jndex].endPoint+",":r+=n[jndex].startPoint+"-"+n[jndex].endPoint;e[o].weightSectionArray=r}}),function(){e.tableModel={tableHeader:[Lang.getValByKey("weight","weight_id"),Lang.getValByKey("weight","weight_name"),Lang.getValByKey("weight","weight_code"),Lang.getValByKey("weight","weight_detail"),Lang.getValByKey("weight","weight_creator"),Lang.getValByKey("weight","weight_date"),Lang.getValByKey("weight","weight_mark")],tableHeaderSize:["6%","15%","10%","10%","12%","13%","15%","15%"],tableBody:[],restURL:"logistics.getWeightList",restData:{language:"zh-CN",q:"",pageIndex:1,pageSize:10,asc:!1,unfilled:!0,sort:"createTime"},selectNumber:0,selectFlag:!1},l()}()}])});