easySpa.require(["widget/slimscroll","widget/nestable","widget/prompt"],function(){app.controller("organizationCtrl",["$scope","organizationService","organizationView",function(e,o,a){function r(){function a(a){e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,0!=e.show&&void 0!=e.show||(e.validate=!0,e.validateRequired=!1,e.show=!e.show,e.visible=!e.visible),e.orgId=a,e.organizationId=a,o.getOrganization(a,function(o){0===o.errorCode&&(e.parentId=o.data.parentId,e.newParentId=o.data.parentId)}),e.orgNameInfo="",e.orgShortNameInfo="",e.orgCodeInfo="",e.descriptionInfo="",$('button[name="save-org"]').removeClass("detail-save").addClass("add-save"),e.textNumber=140,e.form.$setPristine(),e.form.$setUntouched(),e.$apply()}function r(e,o,a,r){n(e),0!=a?$(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("organization","group_prompt_tip"),type:"errer",manualClose:!0}):0==o?($(".new-nodes").remove(),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("organization","group_prompt_box_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){t(e,r)}}]})):$(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("organization","group_prompt_delete_tip"),type:"errer",manualClose:!0})}function t(e,a){o.deleteOrganization(e,function(r){if(0===r.errorCode){if($(document).promptBox("closePrompt"),1==a.find("li.dd-item").length){var t=$(".dd-item[data-uid="+r.data+"]").parent().parent().data("uid");$('input[name="newOrganizationId"]').data("value",t),$("#tree").nestable("resetDeleteGroup")}$('li[data-uid="'+e+'"]').remove(),o.getOrganization(e,function(e){0==e.errorCode&&($('.dd-item[data-uid="'+e.data.parentId+'"]').children(".dd3-content").addClass("active"),n(e.data.parentId))}),$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success"})}else $(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})}function n(a){$('button[name="save-org"]').addClass("detail-save").removeClass("add-save"),o.getOrganization(a,function(o){if(0==o.errorCode){1!=e.show&&1!=e.visible||(e.validate=!1,e.validateRequired=!1,e.show=!e.show,e.visible=!e.visible),$(".new-nodes").remove();var a=o.data;e.organizationId=a.id,e.orgId=a.parentId,e.orgName=a.name,e.orgShortName=a.shortName,e.orgCode=a.code,e.parentId=a.parentId,e.description=a.description}else $(document).promptBox({isDelay:!0,contentDelay:o.msg,type:"errer",manualClose:!0})}),e.$apply()}function i(e,a,r){var t={seatParams:{orgId:e},urlParams:{targetparentid:a,targetpreid:r}};o.moveOrganization(t,function(o){0==o.errorCode?$(document).promptBox({isDelay:!0,contentDelay:o.msg,type:"success"}):($('input[name="newOrganizationId"]').data("value",e),$("#tree").nestable("resetSearchNode"),$(document).promptBox({isDelay:!0,contentDelay:o.msg,type:"errer",manualClose:!0}))})}$("#tree").nestable({isRoot:!0,iconOpen:"icon-organization-Open",iconClose:"icon-organization-Close",iconSeat:"icon-organization",addChildNodes:function(e){a(e)},deleteNodes:function(e,o,a,t){r(e,o,a,t)},childUrl:Interface.getUrlById("logistics.treeChildUrl"),resetNode:Interface.getUrlById("logistics.getOrganizationNode"),newItemUid:$("input[name=newOrganizationId]"),searchUrl:Interface.getUrlById("logistics.searchTreeUrl"),searchInput:$("input[name=organization]"),searchTip:Lang.getValByKey("organization","group_tree_search"),searchKeyNodes:function(e){n(e)},clickNode:function(e){n(e)},loadFirstNode:function(e){n(e)},collapseAllNode:function(e){n(e)},treeScrollHeight:$(".tree-scroll-box"),newNodeText:Lang.getValByKey("organization","organization_nestable_seat_tip")}).on("change",function(){var e=0==$(".moving").prev().length?0:$(".moving").prev().data("uid"),o=$(".moving").data("uid"),a=$("li[data-uid="+o+"]").parent().parent(".dd-item").data("uid");a=void 0==a?0:a,i(o,a,e)})}e.$on("$viewContentLoaded",function(){r()}),e.cancelOrg=function(){if(0!=$(".new-nodes").length){var a=$(".new-nodes").parent().parent().data("uid");o.getOrganization(a,function(o){if(0==o.errorCode){var a=o.data;e.orgName=a.name,e.orgShortName=a.shortName,e.orgCode=a.code,e.parentId=a.parentId,e.description=a.description}else $(document).promptBox({isDelay:!0,contentDelay:o.msg,type:"errer",manualClose:!0})})}else e.orgNameInfo=e.orgName,e.orgShortNameInfo=e.orgShortName,e.orgCodeInfo=e.orgCode,e.parentIdInfo=e.parentId,e.descriptionInfo=e.description;e.validate=!1,e.validateRequired=!1,e.show=!e.show,e.visible=!e.visible,$(".new-nodes").parent().parent().children(".dd3-content").addClass("active"),$(".new-nodes").remove(),$('button[name="save-org"]').removeClass("detail-save, add-save").addClass("detail-save")},e.editOrg=function(){e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,e.validate=!0,e.validateRequired=!1,e.show=!e.show,e.visible=!e.visible,e.orgNameInfo=e.orgName,e.orgShortNameInfo=e.orgShortName,e.orgCodeInfo=e.orgCode,e.parentNameInfo=e.parentName,e.isEdit=!0,e.descriptionInfo=e.description,e.textNumber=140-e.descriptionInfo.length},e.saveOrgInfo=function(){e.orgNameInfo||e.form.orgNameInfo.$setDirty(),e.orgShortNameInfo||e.form.orgShortNameInfo.$setDirty(),e.orgCodeInfo||e.form.orgCodeInfo.$setDirty();var a=$('button[name="save-org"]').hasClass("detail-save")?e.parentId:e.orgId;a||(a=e.newParentId),e.descriptionInfo=$.trim(e.descriptionInfo);var r=$.extend({},{parentId:a},{name:e.orgNameInfo},{shortName:e.orgShortNameInfo},{code:e.orgCodeInfo},{description:e.descriptionInfo});if(e.validateRequired=!0,e.form.$valid&&1!=e.validateOrgError&&1!=e.validateOrgShortError&&1!=e.validateCodeError&&e.form.$valid)if($('button[name="save-org"]').hasClass("detail-save")){var t=$(".dd3-content.active").parent().data("uid"),n={seatParams:{orgId:t},urlParams:r};o.editOrganization(n,function(a){if(0==a.errorCode){var r=a.data;$(".dd3-content.active .item-text").text(e.orgShortNameInfo).parent().data("uid",r),e.validate=!1,e.validateRequired=!1,e.show=!e.show,e.visible=!e.visible,e.orgName=e.orgNameInfo,e.orgShortName=e.orgShortNameInfo,e.orgCode=e.orgCodeInfo,o.getOrganization(r,function(o){0===o.errorCode&&(e.parentId=o.data.parentId)}),e.description=e.descriptionInfo,e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,$('button[name="save-org"]').removeClass("detail-save, add-save").addClass("detail-save"),$(document).promptBox({isDelay:!0,contentDelay:a.msg,type:"success"})}else $(document).promptBox({isDelay:!0,contentDelay:a.msg,type:"errer",manualClose:!0})})}else if($('button[name="save-org"]').hasClass("add-save")){var n={urlParams:r};o.saveOrganization(n,function(o){if(0==o.errorCode){if($('button[name="save-org"]').hasClass("detail-save")){var a=o.data;$(".dd3-content.active").text(e.orgShortNameInfo).parent().data("uid",a)}$('button[name="save-org"]').hasClass("add-save")&&($('input[name="newOrganizationId"]').data("value",o.data),$("#tree").nestable("resetGroup")),e.validate=!1,e.validateRequired=!1,e.show=!e.show,e.visible=!e.visible,e.orgName=e.orgNameInfo,e.orgShortName=e.orgShortNameInfo,e.orgCode=e.orgCodeInfo,e.parentId=e.orgId,e.organizationId=o.data,e.description=e.descriptionInfo,e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,$('button[name="save-org"]').removeClass("detail-save, add-save").addClass("detail-save"),$(document).promptBox({isDelay:!0,contentDelay:o.msg,type:"success"})}else $(document).promptBox({isDelay:!0,contentDelay:o.msg,type:"errer",manualClose:!0})})}},e.focusOrgName=function(){e.validateOrgError=!1},e.validateOrgName=function(){var a,r,t;if(a=e.orgNameInfo||""){0==$(".new-nodes").length?(t=e.organizationId,r=e.parentId):(t="",r=e.organizationId);var n={urlParams:{name:a,parentId:r,orgId:t}};o.validateName(n,function(o){0!=o.errorCode?e.validateOrgError=!0:e.validateOrgError=!1})}},e.focusOrgShortName=function(){e.validateOrgShortError=!1},e.validateOrgShortName=function(){var a,r,t;if(a=e.orgShortNameInfo||""){0==$(".new-nodes").length?(t=e.organizationId,r=e.parentId,console.log(e.parentId)):(t="",r=e.orgId,console.log(e.orgId));var n={urlParams:{shortName:a,parentId:r,orgId:t}};o.validateShortName(n,function(o){0!=o.errorCode?e.validateOrgShortError=!0:e.validateOrgShortError=!1})}},e.focusOrgCode=function(){e.validateCodeError=!1},e.validateOrgCode=function(){var a,r;if(a=e.orgCodeInfo){r=0==$(".new-nodes").length?e.organizationId:"";var t={urlParams:{code:a,orgId:r}};o.validateCode(t,function(o){0!=o.errorCode?e.validateCodeError=!0:e.validateCodeError=!1})}},e.textNumber=140,e.showTextNumber=function(){e.textNumber=140-e.descriptionInfo.length},e.visibleTextNumber=function(){e.textCountVisible=!0},e.hiddenTextNumber=function(){e.textCountVisible=!1}}])});