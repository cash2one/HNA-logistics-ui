easySpa.require(["widget/slimscroll","public/common/tableController.js","widget/prompt","widget/select","widget/calander","public/lib/pinyin.js","public/lib/pinyin-util.js"],function(){app.controller("rateCtrl",["$scope","rateService","rateView","tableService",function(e,t,a,r){function n(){e.tableModel.restData.sourceCurrency="",e.tableModel.restData.destCurrency="",e.searchCurrentRate&&(e.tableModel.restData.sourceCurrency=s(e.searchCurrentRate,e.searchCurrencyList)),e.searchExchangeRate&&(e.tableModel.restData.destCurrency=s(e.searchExchangeRate,e.searchExchangeList)),e.tableModel.restData.beginTime=$("#begin-time").val(),e.tableModel.restData.endTime=$("#finish-time").val()}function i(){e.tableModel.restData.sourceCurrency="",e.tableModel.restData.destCurrency="",e.tableModel.restData.beginTime="",e.tableModel.restData.endTime=""}function o(e){return e}function s(e,a){if(a||(a=o(t.getCurrencyList())),e){a=a.data;for(var r=0;r<a.length;r++)if(-1!=a[r].name.indexOf("(")){var n=a[r].name.split("(")[0],i=a[r].name.split("(")[1].substring(0,a[r].name.split("(")[1].length-1);if($.trim(n)==$.trim(e)||$.trim(a[r].name)==$.trim(e)||$.trim(i.toLowerCase())==$.trim(e.toLowerCase()))return a[r].code}return"无匹配结果"}}function c(e){t.deleteRateList(e,function(e){0===e.errorCode?($(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),m()):$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})}function l(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-250})}function m(){var t={urlParams:e.tableModel.restData};r.getTable(e.tableModel.restURL,t,function(a){e.q=e.tableModel.restData.q,0===a.errorCode&&(e.tableModel=r.table(e.tableModel,t,a),setTimeout(function(){l(),$(window).on("resize",l),e.$apply(),$(".table-box").focus()},100))})}var u=($("#nest-rateFrom .label-text"),null),d=null,g=null,p=null;e.currentList=null,e.exchangeList=null,e.searchCurrencyList=null,e.searchExchangeList=null,e.endTime="2100-01-01 00:00:00",e.serverTime=t.getServerTime().data,$("#begin-time").val(e.serverTime),$("#finish-time").val(e.serverTime),e.serverTime||(e.serverTime=(new Date).format("yyyy-MM-dd hh:mm:ss")),e.add=function(){e.serverTime=t.getServerTime().data,e.isEdit=!1,e.promptTitle=Lang.getValByKey("rate","rate_create_title"),e.isCreateNewRate=!0,e.nestRateFrom=!0,e.rateCurrent="",e.exchange="",e.rateVal="",e.id="",$("#nest-rateFrom").css("display","table"),e.startTime=e.serverTime,e.endTime="2100-01-01 00:00:00",standardEndTime="",standardStartTime="",$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.clearDate=function(){e.serverTime=t.getServerTime().data,$("#begin-time").val(e.serverTime),$("#finish-time").val(e.serverTime),e.searchCurrentRate||e.searchExchangeRate?(n(),e.tableModel.restURL="logistics.getRateList"):(i(),e.tableModel.restURL="logistics.getLatestRate"),m()},e.search=function(){e.tableModel.restData.pageIndex=1,e.searchCurrentRate||e.searchExchangeRate||$("#begin-time").val()||$("#finish-time").val()?n():i(),e.tableModel.restURL="logistics.getRateList",m()},e.verifySame=function(t){e.rateCurrent==e.exchange&&("rate-current"==t?e.rateCurrent="":e.exchange="")},e.closePrompt=function(){e.nestRateFrom=!1},e.initSelectList=function(){e.searchCurrencyList=o(t.getCurrencyList()),g=selectFactory({data:e.searchCurrencyList,isSearch:!0,searchPlaceHoder:"货币名称或三字码",id:"search-currency",pagination:!0,onSearchValueChange:function(t,a,r){e.searchCurrencyList=e.getCurrencyData(a,r),t.setData(e.searchCurrencyList)},attrTextModel:function(t,a){e.searchRateCurrentCode=s(t,a),e.searchCurrentRate=t,e.$apply()}}),e.searchExchangeList=o(t.getCurrencyList()),p=selectFactory({data:e.searchExchangeList,isSearch:!0,searchPlaceHoder:"货币名称或三字码",id:"search-exchange",pagination:!0,onSearchValueChange:function(t,a,r){e.searchExchangeList=e.getCurrencyData(a,r),t.setData(e.searchExchangeList)},attrTextModel:function(t,a){e.searchRateExchangeCode=s(t,a),e.searchExchangeRate=t,e.$apply()}}),e.currentList=o(t.getCurrencyList()),u=selectFactory({data:e.currentList,isSearch:!0,searchPlaceHoder:Lang.getValByKey("rate","rate_current_or_code"),id:"rate-current",pagination:!0,onSearchValueChange:function(t,a,r){e.currentList=e.getCurrencyData(a,r),t.setData(e.currentList)},onBeforeShow:function(t){e.isEdit?t.hide():t.display()},attrTextModel:function(t,a){e.rateCurrentCode=s(t,a),e.rateCurrent=t,e.exchange==e.rateCurrent&&($("#rate-current").val(""),e.rateCurrent=""),e.$apply()}}),e.exchangeList=o(t.getCurrencyList()),d=selectFactory({data:e.exchangeList,id:"exchange-text",isSearch:!0,searchPlaceHoder:Lang.getValByKey("rate","rate_current_or_code"),pagination:!0,onSearchValueChange:function(t,a,r){e.exchangeList=e.getCurrencyData(a,r),t.setData(e.exchangeList)},onBeforeShow:function(t){e.isEdit?t.hide():t.display()},attrTextModel:function(t,a){e.exchangeCode=s(t,a),e.exchange=t,e.exchange==e.rateCurrent&&($("#exchange-text").val(""),e.exchange=""),e.$apply()}})},e.getCurrencyData=function(e,a){a||(a=1),e=e||"";var r={urlParams:{q:e,pageIndex:a,pageSize:10,includeAllAudit:!0},isAsync:!0},n=o(t.getCurrencyList(r));return angular.forEach(n.data,function(e,t){e.name+="("+e.code+")"}),n},e.limit3Data=function(){if(e.rateVal){var t=e.rateVal.split(".");t.length>1&&t[1].length>3&&(e.rateVal=e.rateVal.substring(0,e.rateVal.length-1))}},e.verifyRateFormat=function(){if(!e.rateVal)return $("#rate-val-msg").addClass("ng-hide"),void(e.rateFrom.rateVal.errorTips="");/^([1-9]\d{0,15}|0)(\.\d{1,4})?$/.test(e.rateVal)?($("#rate-val-msg").addClass("ng-hide"),e.rateFrom.rateVal.errorTips="",angular.element($(".verify-rate-format").removeClass("ng-invalid"))):(e.rateFrom.rateVal.$setDirty(),e.rateFrom.rateVal.errorTips=Lang.getValByKey("rate","rate_input_rate_val_limit"),$("#rate-val-msg").removeClass("ng-hide"),angular.element($(".verify-rate-format").addClass("ng-invalid")))},e.delete=function(){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var t=[],a=r.getSelectTable(e.tableModel.tableBody);if(!a.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("rate","rate_prompt_delay_tip"),type:"errer",manualClose:!0}),!1;angular.forEach(a,function(e){t.push(e.id)}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("rate","rate_prompt_delete_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){c(t)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("rate","rate_prompt_delay_tip"),type:"errer",manualClose:!0})},e.editRate=function(t){e.isEdit=!0,$("#nest-rateFrom").css("display","table"),e.isCreateNewRate=!1,e.promptTitle=Lang.getValByKey("rate","rate_detail_title"),e.nestRateFrom=!0,e.rateCurrent=t.sourceName,e.exchange=t.destName,e.sourceCode=t.sourceCurrency,e.destCode=t.destCurrency,e.rateVal=t.rate,standardStartTime=e.startTime=t.beginTime,standardEndTime=e.endTime=t.endTime,e.id=t.id,$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.savePrompt=function(a){if(a||(confrim=!1),(e.currentList&&!s($.trim($("#rate-current").val()),e.currentList)||"无匹配结果"==s($.trim($("#rate-current").val()),e.currentList))&&u.showError(),(e.exchangeList&&!s($.trim($("#exchange-text").val()),e.exchangeList)||"无匹配结果"==s($.trim($("#exchange-text").val()),e.exchangeList))&&d.showError(),e.rateCurrent||e.rateFrom.rateCurrent.$setDirty(),e.exchange||e.rateFrom.exchange.$setDirty(),e.rateVal||e.rateFrom.rateVal.$setDirty(),e.rateFrom.$valid){for(var r=$("#nest-rateFrom .no-result"),n=0;n<r.length;n++){$(r[n]).closest("ul").css("visibility","visible")}if(!(r.length>0)){for(var i=$(".errors"),n=0;n<i.length;n++)if(!$(i[n]).hasClass("ng-hide"))return;e.isCreateNewRate?t.createNewRate({sourceCurrency:s(e.rateCurrent,e.currentList),destCurrency:s(e.exchange,e.exchangeList),sourceName:e.rateCurrent,destName:e.exchange,rate:e.rateVal,beginTime:e.startTime,endTime:e.endTime,confirm:a},function(t){0!=t.errorCode&&202051!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):202051==t.errorCode?$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:t.msg},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){$(document).promptBox("closePrompt"),e.savePrompt(!0)}}]}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),m())}):t.updateRate({sourceCurrency:e.sourceCode,destCurrency:e.destCode,sourceName:e.rateCurrent,destName:e.exchange,rate:e.rateVal,beginTime:e.startTime,endTime:e.endTime,id:e.id,confirm:a},function(t){0!=t.errorCode&&202055!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):202055==t.errorCode?$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:t.msg},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){$(document).promptBox("closePrompt"),e.savePrompt(!0)}}]}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),m())})}}},a.initCalander(e),function(){e.tableModel={tableHeader:[Lang.getValByKey("rate","rate_id"),Lang.getValByKey("rate","rate_currency"),Lang.getValByKey("rate","rate_current_rate"),Lang.getValByKey("rate","rate_start_time"),Lang.getValByKey("rate","rate_end_time")],tableHeaderSize:["5%","25.6%","22.4%","21%","21%"],tableBody:[],restURL:"logistics.getLatestRate",restData:{language:"zh-CN",q:"",pageIndex:1,pageSize:10,isAsc:!0,unfilled:!0},selectNumber:0,selectFlag:!1},m()}()}])});