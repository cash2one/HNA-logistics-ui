easySpa.require(["widget/slimscroll","widget/prompt","widget/tab","widget/parseUrl","widget/select","public/common/tableController.js","public/javascripts/fragment/customer/account.js","public/javascripts/fragment/customer/companyInfo.js","public/javascripts/fragment/customer/bizContacter.js","public/javascripts/fragment/customer/clientContacter.js","public/javascripts/fragment/customer/productSetting.js","public/javascripts/fragment/customer/messageNotify.js","public/javascripts/fragment/customer/userInfo.js"],function(){app.controller("customerCtrl",["$scope","$route","customerService","customerView","tableService",function(e,t,a,o,n){function r(){1==e.showSenior?$(".table-container tbody").slimscroll({height:$(".content-main").height()-314}):$(".table-container tbody").slimscroll({height:$(".content-main").height()-250})}function s(e,t){for(var a=t.data,o=0;o<a.length;o++)if(a[o].name==e)return a[o]}function l(){var t=[],a=n.getSelectTable(e.tableModel.tableBody);return a.length?(angular.forEach(a,function(e){t.push(e.id)}),t):(accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("customer","customer_prompt_delay_tip"),type:"errer",manualClose:!0}),!1)}function c(t){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var a=l();if(!a)return!1;t(a,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),e.loadListData(),e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("customer","customer_prompt_delay_tip"),type:"errer",manualClose:!0})}function m(t){t&&(e.customerId=t.id),e.setSingleCustomerAuditBtn(),userInfoCtrl.init(e,a,t)}e.paramter=window.parseUrl.getParams(),e.pageOfCustomerAudit=window.location.href.indexOf("customerApproval")>-1,e.showBtn=1!=e.pageOfCustomerAudit,e.userType=1,e.paramter&&"trade"==e.paramter.module&&(e.userType=2);var i;i=1===e.userType?[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("customer","customer_account_name"),Lang.getValByKey("customer","customer_code"),Lang.getValByKey("customer","customer_company_name"),Lang.getValByKey("customer","customer_price_meal"),Lang.getValByKey("customer","customer_level"),Lang.getValByKey("customer","customer_audit_state")]:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("customer","customer_account_name"),Lang.getValByKey("customer","customer_code"),Lang.getValByKey("customer","customer_company_name"),Lang.getValByKey("customer","customer_level"),Lang.getValByKey("customer","customer_audit_state")],e.tableModel={tableHeader:i,tableHeaderSize:["5%","10%","10%","15%","15%","15%","15%"],tableBody:[],restURL:"logistics.getCustomerList",restData:{q:"",refCombos:"",isLocked:-1,evaluateLeval:"1",beyondLeval:!1,isAsc:!1,pageIndex:1,pageSize:10,userType:e.userType,authStatus:-1},selectNumber:0,selectFlag:!1},e.seniorText=Lang.getValByKey("common","common_page_advancedFilter"),e.isLockeds={data:[{id:-1,name:"全部"},{id:0,name:Lang.getValByKey("customer","customer_unlock")},{id:1,name:Lang.getValByKey("customer","customer_locked")}]},e.stateName="全部",e.stateId=-1,e.combosName=Lang.getValByKey("customer","common_select_tips"),e.combosId="",e.levals={data:[{id:1,name:Lang.getValByKey("customer","customer_one_star")},{id:2,name:Lang.getValByKey("customer","customer_two_star")},{id:3,name:Lang.getValByKey("customer","customer_three_star")},{id:4,name:Lang.getValByKey("customer","customer_four_star")},{id:5,name:Lang.getValByKey("customer","customer_five_star")}]},e.evaluateLevalName=Lang.getValByKey("customer","customer_one_star"),e.evaluateLevalId="1",e.auditState={data:[{id:-1,name:Lang.getValByKey("customer","customer_state_all")},{id:0,name:Lang.getValByKey("customer","customer_state_writing")},{id:1,name:Lang.getValByKey("customer","customer_state_to_be_submit")},{id:2,name:Lang.getValByKey("customer","customer_state_audit")},{id:4,name:Lang.getValByKey("customer","customer_state_success")},{id:3,name:Lang.getValByKey("customer","customer_state_fail")}]},e.auditStateName=Lang.getValByKey("customer","customer_state_all"),e.auidtMessage="",e.authStatus=0,e.$on("$viewContentLoaded",function(){e.loadListData()}),$(window).on("resize",r),e.setCustomerId=function(t){e.customerId=t},e.loadListData=function(){var t={urlParams:e.tableModel.restData};n.getTable(e.tableModel.restURL,t,function(a){if(0===a.errorCode){var o=a.data;for(var r in o)for(var s in e.levals.data)o[r].evaluateLeval==e.levals.data[s].id&&(o[r].evaluateLevalName=e.levals.data[s].name);a.data=o,e.tableModel=n.table(e.tableModel,t,a)}}),r()},e.seniorFilter=function(){1==e.showSenior?(e.seniorText=Lang.getValByKey("common","common_page_advancedFilter"),e.stateName="全部",e.stateId=-1,e.combosName=Lang.getValByKey("customer","common_select_tips"),e.combosId="",e.evaluateLevalName=Lang.getValByKey("customer","customer_one_star"),e.evaluateLevalId="1",e.seniorChecked=!1,e.tableModel.restData.q="",e.tableModel.restData.refCombos="",e.tableModel.restData.isLocked=-1,e.tableModel.restData.evaluateLeval=1,e.tableModel.restData.beyondLeval=!1,e.tableModel.restData.advancedSeach=!1,e.tableModel.restData.authStatus=-1,e.auditStateName="全部"):(e.tableModel.restData.advancedSeach=!0,e.seniorText=Lang.getValByKey("common","common_page_ordinaryFilter")),e.tableModel.restData.q="",e.q="",e.loadListData(),e.showSenior=!e.showSenior,r()},e.selectCustomerCombos=function(){var t=a.getCombos(),o=[{id:"",name:Lang.getValByKey("customer","common_select_tips")}];angular.forEach(t.data,function(e,t){o.push({code:e.code,preName:e.name,name:e.name+"("+e.code+")"})}),t.data=o,selectFactory({data:t,id:"combos",defaultText:"",defaultCount:100,isCreateNewSelect:!0,isSearch:!0,attrTextModel:function(t,a,o){var n;n=t?s(t,a):{},e.combosName=o.preName,e.combosId=n.code,e.tableModel.restData.refCombos=e.combosId,e.loadListData(),e.$apply()}})},e.initSelectList=function(){var t=e.isLockeds;selectFactory({data:t,id:"state",defaultText:"",attrTextModel:function(t,a){var o;o=t?s(t,a):{},e.stateName=t,e.stateId=o.id,e.tableModel.restData.isLocked=e.stateId,e.loadListData(),e.$apply()}});var o=a.getCombos(),n=[{id:"",name:Lang.getValByKey("customer","common_select_tips")}];angular.forEach(o.data,function(e,t){n.push({code:e.code,preName:e.name,name:e.name+"("+e.code+")"})}),o.data=n,selectFactory({data:o,id:"combos",defaultText:"",defaultCount:100,isCreateNewSelect:!0,isSearch:!0,attrTextModel:function(t,a){var o;o=t?s(t,a):{},e.combosName=t,e.combosId=o.code,e.tableModel.restData.refCombos=e.combosId,e.loadListData(),e.$apply()}});var r=e.levals;selectFactory({data:r,id:"evaluateLeval",defaultText:"",attrTextModel:function(t,a){var o;o=t?s(t,a):{},e.evaluateLevalName=t,e.evaluateLevalId=o.id,e.tableModel.restData.evaluateLeval=e.evaluateLevalId,e.loadListData(),e.$apply()}}),selectFactory({data:e.auditState,id:"auditState",defaultText:"",attrTextModel:function(t,a){var o;o=t?s(t,a):{},e.auditStateName=t,e.authStatus=o.id,e.tableModel.restData.authStatus=e.authStatus,e.loadListData(),e.$apply()}})},e.resetStyle=function(e){$(".from-box .verification .errors").css("padding-left",e+"px")},e.checkEvaluateLeval=function(){e.seniorChecked=!e.seniorChecked,1==e.seniorChecked?(e.tableModel.restData.beyondLeval=!0,e.tableModel.restData.evaluateLeval=e.evaluateLevalId):(e.tableModel.restData.beyondLeval=!1,e.tableModel.restData.evaluateLeval=e.evaluateLevalId,e.rankName=1,e.rankId=1),e.loadListData()},e.retrievalCustomerList=function(){e.q=e.tableModel.restData.q,e.tableModel.restData.pageIndex=1,e.loadListData()},e.goBackCustomer=function(){e.isEdit?e.zjID?top.history.go(-2):(e.main=!1,$(".tip-box").remove(),e.loadListData()):$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("common","common_back_confirm")},cancelDescription:Lang.getValByKey("common","common_back_no"),operation:[{type:"submit",application:"delete",description:Lang.getValByKey("common","common_back_yes"),operationEvent:function(){e.zjID?top.history.go(-2):(e.main=!1,$(".tip-box").remove(),e.loadListData()),e.$apply(),$(document).promptBox("closePrompt")}}]}),o.unlockBtn()},e.addCustomer=function(){e.isAdd=!0,e.isEdit=!1,e.isCanEdit=!0,e.tab.exdisable(0),e.main=!0,e.shipBooking=!1,setTimeout(function(){$(".tab-content").scrollTop(0),$(".from-box").css("top","116px")},100),e.auidtMessage="",m()},e.lockCustomer=function(){c(a.lockCustomer)},e.unLockCustomer=function(){c(a.unlockCustomer)},e.deleteCustomer=function(){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){if(!l())return!1;$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("customer","customer_prompt_delete_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){c(a.deleteCustomer)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("customer","customer_prompt_delay_tip"),type:"errer",manualClose:!0})},e.auditCustomer=function(){var t=[];t.push(e.customerId),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:"确认该客户信息无误并提交审核？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_confirm"),application:"warning",operationEvent:function(){var n={urlParams:t};a.auditCustomers(n,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),e.loadListData(),e.auidtMessage="",e.$apply(),$(".from-box").css("top","116px"),o.disableBtn("singleCustomerAudit")):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]})},e.auditCustomers=function(){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var t=[],o=n.getSelectTable(e.tableModel.tableBody);if(!o.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("customer","customer_prompt_delay_tip"),type:"errer",manualClose:!0}),!1;angular.forEach(o,function(e){t.push(e.id)}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:"确认提交已选客户？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_confirm"),application:"warning",operationEvent:function(){var o={urlParams:t};a.auditCustomers(o,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),e.loadListData(),e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("customer","customer_prompt_delay_tip"),type:"errer",manualClose:!0})},e.resetTabScroll=function(){setTimeout(function(){$(".tab-content").scrollTop(0)},100)},e.editServiceDetail=function(t){e.isEdit=!0,e.main=!0,e.resetTabScroll(),e.tab.selected(0),m(t)},e.setSingleCustomerAuditBtn=function(){if(e.customerId){var t={seatParams:{id:e.customerId}};a.getCustomerAuditStatus(t,function(e){0==e.errorCode&&(1!=e.data?o.disableBtn("singleCustomerAudit"):o.enableBtn("singleCustomerAudit"))})}else o.disableBtn("singleCustomerAudit")},e.swichEvent=function(t){switch(e.resetTabScroll(),t){case 0:$("#userInfo").css({display:"none"}),userInfoCtrl.init(e,a,{id:e.customerId});break;case 1:e.$broadcast("companyEvent",{});break;case 2:e.$broadcast("accountEvent",{});break;case 3:e.$broadcast("bizContacterEvent",{});break;case 4:e.$broadcast("clientContacterEvent",{});break;case 5:e.$broadcast("messageNotifyEvent",{});break;case 6:e.$broadcast("productSettingEvent",{})}},e.tab=o.tab("#m-tab",e.swichEvent),e.paramter.id&&(e.main=!0,$("#userInfo").css({display:"none"}),setTimeout(function(){e.editServiceDetail({id:e.paramter.id})},0));var u=easySpa.queryUrlValByKey("id");e.zjID=u,u&&setTimeout(function(){e.editServiceDetail({id:u})},1),e.$watch("tableModel.tableBody",function(t,a){for(var n in t)for(var r in e.levals.data)t[n].evaluateLeval==e.levals.data[r].id&&(t[n].evaluateLevalName=e.levals.data[r].name);o.bindEvent()})}])});