function unique(e){for(var t=[],o={},a=0;a<e.length;a++){var r=e[a],n=typeof r+r;1!==o[n]&&(t.push(r),o[n]=1)}return t}easySpa.require(["public/common/calander.js","public/common/pictureController.js","widget/prompt","widget/tab","widget/slimscroll/","widget/nestable","widget/select","widget/slides","widget/parseUrl"],function(){app.controller("projectDetailCtrl",["$scope","projectDetailService","projectDetailView","pictureService",function(e,t,o,a){function r(){e.projectStatus&&3==e.addProjectFile&&(e.addProjectFile=0,e.singlecontractFile={fileId:"",filePath:"",thumbnailPath:"",name:"",remark:""},e.$apply())}function n(e,t){var o,a;if(e[t]){var r=Number(e[t].lastIndexOf(".")+1);o=e[t].substr(r).toUpperCase()}return"DOC"!==o&&"DOCX"!=o&&"DOT"!==o&&"DOTX"!==o||(a="application/msword"),"XLS"!==o&&"XLT"!==o&&"XLSX"!==o&&"XLTX"!==o||(a="application/vnd.ms-excel"),"JPG"!==o&&"JPEG"!==o&&"PNG"!==o&&"BMP"!==o&&"TIFF"!==o||(a="image"),"PDF"===o&&(a="pdf"),a}var i={data:[{name:"供应商",code:"1"},{name:"客户",code:"2"},{name:"平台",code:"3"}]},c={legacyBusinessType:window.parseUrl.getParams().module,projectStatus:sessionStorage.getItem("status"),identity:sessionStorage.getItem("identity"),projectId:window.parseUrl.getParams().id,projectAction:sessionStorage.getItem("projectAction"),isFirstCheck:!1,choseEnterprise:!1,addFinalCheck:!1,firstResultContent:"",finalResultContent:"",finalResult:"true",companySelected:{companyRole:"",companyName:""},companyTxt:[],company:{type:"",companyId:""},singleprojectFile:{fileId:"",fileName:"",thumbnailPath:"",filePath:"",remark:"",status:"new"},singlecontractFile:{fileId:"",filePath:"",thumbnailPath:"",name:"",remark:""},bizTypeName:"",orgName:"",createor:"",createTime:"",pictureModel:{edit:!0,uploadShow:!0,picture:[],accept:".doc,.docx,.xls,.xlsx,application/msword,image/jpg,image/jpeg,image/png,image/bmp,image/tiff,application/pdf"},contractFiles:[],projectInfo:{name:"",code:"",bizTypeCode:"",orgId:"",companys:[],files:[],profile:"",value:"",risk:"",summary:""},approvalInfo:{},getLanguage:function(){t.getLanguage(function(t){0===t.errorCode&&(e.language=t.data)})},getApprovalStatus:function(){e.projectId&&t.getApprovalStatus({seatParams:{projectId:e.projectId}},function(t){0===t.errorCode?(e.approvalInfo=t.data,e.projectStatus=t.data.status,sessionStorage.setItem("status",t.data.status)):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},getProjectInfo:function(){if(e.projectId){var o=this;t.getProjectInfo({seatParams:{projectId:e.projectId}},function(e){e.data.files.forEach(function(e){e.contentType=n(e,"fileName"),e.thumbnailPath=o.getThumbnail(e.filePath)+"?filename="+e.fileName}),o.projectInfo=e.data,o.companyTxt=e.data.companys.map(function(e){return{companyId:e.companyId,companyRole:e.type,companyName:3!=e.type?e.companyName+"("+e.companyCode+")":e.companyName}}),o.companyCodes=e.data.companys.map(function(e){return e.companyId+""+e.type}),o.pictureModel.picture=e.data.files.map(function(e){return{name:e.fileName,picUrl:e.filePath,picUrlID:{id:e.fileId,path:e.filePath,type:e.contentType}}}),o.projectStatus=e.data.status,o.firstResultContent=e.data.firstAuditMsg,sessionStorage.setItem("status",e.data.status),sessionStorage.setItem("projectFileNum",o.pictureModel.picture.length),o.orgName=e.data.orgName})}},getBusinessType:function(){t.getBusinessType({urlParams:{catalog:"biz.trade.businesstype"}},function(t){0===t.errorCode&&selectFactory({data:t,id:"businessType",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.projectInfo.bizTypeCode=t,e.$apply()},attrTextModel:function(t){e.bizTypeName=t,e.$apply()}})})},moveUserGroup:function(){function t(){1==$("#userSelectGroup").length&&($("#userSelectGroup").remove(),$("#userSelectGroupBox .slimScrollDiv").length>0&&$("#userSelectGroupBox").find(".slimScrollDiv").remove(),$("#userSelectGroupBox").append('<div id="userSelectGroup"></div>')),$("#userSelectGroup").nestable({iconOpen:"icon-organization-Open",iconClose:"icon-organization-Close",iconSeat:"icon-organization",userCount:"",isMove:!0,isOperate:!0,isRoot:!0,childUrl:Interface.getUrlById("logistics.treeChildUrl"),isSearch:!1,treeScrollHeight:$("#userSelectGroupBox.user-prompt-box")})}$(document).promptBox({title:"选择负责部门",isHidden:!0,isNest:!0,loadData:function(){t()},content:{nest:$("#userSelectGroupBox")},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_confirm"),operationEvent:function(){$("input[name=orgNameInfo]").val($("#userSelectGroup .dd3-content.active").data("orgname")),$("#orgName").val($("#userSelectGroup .dd3-content.active").data("orgname")),e.orgName=$("#userSelectGroup .dd3-content.active").data("orgname"),e.projectInfo.orgId=$("#userSelectGroup .dd3-content.active").parent().data("uid"),$("#orgName").css("borderColor",""),e.orgNameError=!1,$(document).promptBox("closeSlideBox")}}]})},showPrompt:function(o){if(1==o){this.choseEnterprise=!0;var a=this;e.roleEle=selectFactory({data:i,id:"enterpriseRole",showTextField:"name",attrTextField:{"ng-value":"code"},closeLocalSearch:!0,defaultText:"",attrTextId:function(o){a.company.type=o,a.companySelected.companyRole=o,e.roleEle.next.clearData(),e.enterprise.companyName.$viewValue=!1,e.companyCodeRepeat=!1,e.enterprise.companyName.errorTips="";var r={module:e.legacyBusinessType,code:o};e.platCode=o,t.getEnterpriseName(r,function(t){0===t.errorCode?(3!=e.platCode?t.data.forEach(function(e){e.nameCode=e.name+"("+e.code+")"}):t.data.forEach(function(e){e.nameCode=e.name}),e.nameEle.setData(t)):e.nameEle.setData([])}),a.company.companyId="",a.companySelected.companyName="",e.$apply()}}),e.nameEle=selectFactory({data:[],id:"enterpriseName",showTextField:"nameCode",isSearch:!0,closeLocalSearch:!0,pagination:!0,attrTextField:{"ng-value":"id"},defaultText:"请选择",searchPlaceHoder:function(){switch(parseInt(e.platCode,10)){case 1:return"请输入供应商名称或编码";case 2:return"请输入账户名称或编码";default:return"请输入平台名称"}},attrTextId:function(t){var o="";if($.each(e.companyTxt,function(a,r){if(r.companyId==t&&r.companyRole==e.platCode)return void(o=!0)}),e.companyCodes&&-1!==e.companyCodes.indexOf(t+e.platCode)&&(o=!0),o&&t)return e.enterprise.companyName.$viewValue=!0,e.enterprise.companyName.$error.defined=!0,e.enterprise.companyName.$dirty=!0,e.enterprise.companyName.errorTips="所选企业已存在",void(e.companyCodeRepeat=!0);e.enterprise.companyName.$viewValue=!1,e.companyCodeRepeat=!1,delete e.enterprise.companyName.$error.defined,e.enterprise.companyName.$dirty=!1,e.enterprise.companyName.errorTips="",a.company.companyId=t,e.$apply()},attrTextModel:function(t){a.companySelected.companyName=t,e.$apply()},onSearchValueChange:function(o,a,r){if(3!==e.platCode){var n={module:e.legacyBusinessType,code:e.platCode,urlParams:{q:a,pageIndex:r||1}};t.getEnterpriseName(n,function(t){0===t.errorCode?(3!=e.platCode?t.data.forEach(function(e){e.nameCode=e.name+"("+e.code+")"}):t.data.forEach(function(e){e.nameCode=e.name}),e.nameEle.setData(t)):e.nameEle.setData([])}),e.$apply()}}}),e.roleEle.next=e.nameEle}if(3==o){if(1==e.projectAction||!e.identity.includes(1)||e.approvalInfo.finalManId)return;this.addFinalCheck=!0}},closePrompt:function(t){e.companyCodeRepeat=!1,1==t&&(this.choseEnterprise=!1,this.company={type:"",companyId:""},this.companySelected={companyRole:"",companyName:""},e.nameEle.clearData(),e.enterprise.$setPristine(),e.enterprise.$setUntouched()),3==t&&(this.finalResultContent="",this.finalResult="true",this.addFinalCheck=!1,e.FinalCheck.$setPristine(),e.FinalCheck.$setUntouched())},checkProjectCode:function(o){if(!(e.projectBasic.projectCode.$viewValue&&e.projectBasic.projectCode.$error.defined&&e.projectBasic.projectCode.$dirty)){var a={seatParams:{id:"",code:o}};t.checkProjectCode(a,function(t){0!==t.errorCode?(e.projectCodeRepeat=!0,e.projectBasic.projectCode.$viewValue=!0,e.projectBasic.projectCode.$error.defined=!0,e.projectBasic.projectCode.$dirty=!0,e.projectBasic.projectCode.errorTips=t.msg):(e.projectCodeRepeat=!1,e.projectBasic.projectCode.$dirty=!1)})}},savePrompt:function(o){if(1==o){if(e.companySelected.companyRole||e.enterprise.companyRole.$setDirty(),e.companySelected.companyName||e.enterprise.companyName.$setDirty(),!e.enterprise.$valid)return;if(e.companyCodeRepeat)return;this.projectInfo.companys.push(this.company),e.companyCodes=this.projectInfo.companys.map(function(e){return e.companyId+e.type}),this.companyTxt.push(this.companySelected)}if(3==o){if(e.finalResultContent||e.FinalCheck.finalResultContent.$setDirty(),e.finalResult||(e.finalResultError=!0,e.FinalCheck.finalResult.$setDirty()),!e.FinalCheck.$valid)return;if(!e.projectId)return;var a={seatParams:{projectId:e.projectId},urlParams:{finalAuditMsg:e.finalResultContent,isPass:e.finalResult}};t.postFinalApproval(a,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.getApprovalStatus(),e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}this.closePrompt(o)},delCompany:function(t){$(document).promptBox({title:"提示",type:"success",content:{tip:"确认删除选中企业?"},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){e.companyTxt.splice(t,1),e.projectInfo.companys.splice(t,1),e.companyCodes.splice(t,1),$(document).promptBox("closePrompt"),$(document).promptBox({isDelay:!0,contentDelay:"删除成功！",type:"success"}),e.$apply()}}]})},showUploadFile:function(t){e.addProjectFile=t},checkFileName:function(e){var t=this["single"+e+"File"].name;t.length?/^([\w\u4E00-\u9FA5_\\-]+)+$/.test(t)&&/\S+$/g.test(t)?this[e+"FileNameError"]=!1:this[e+"FileNameError"]=!0:this[e+"FileNameError"]=!1},checkFileRemark:function(e,t){this["single"+t+"File"].remark?this[t+"FileRemarkError"]=!1:(e&&e.preventDefault(),this[t+"FileRemarkError"]=!0)},getFile:function(o){var r=this,i=a.uploadFile(e.pictureModel,e[o.target.id]);if(!i)return!1;i.errorlocal?$(document).promptBox({isDelay:!0,contentDelay:i.errorlocal,type:"errer",manualClose:!0}):(e.uploadDisabled=!0,i.then(function(i){0===i.data.errorCode?(e.pictureModel=a.updateModel(e.pictureModel,i.data.data),i.data.data.type=n(i.data.data,"name"),e["single"+o.target.id].fileId=i.data.data.id,e["single"+o.target.id].filePath=i.data.data.path,e["single"+o.target.id].contentType=i.data.data.type,e["single"+o.target.id].name=e["single"+o.target.id].name?e["single"+o.target.id].name:i.data.data.name,"projectFile"==o.target.id&&(e.singleprojectFile.thumbnailPath=r.getThumbnail(e.singleprojectFile.filePath)+"?filename="+i.data.data.name,e.projectInfo.files.push(e.singleprojectFile),e.singleprojectFile={fileId:"",name:"",remark:"",url:"",status:"new"}),"contractFile"==o.target.id&&e.singlecontractFile.fileId&&t.uploadProjectFile({seatParams:{projectId:e.projectId,type:3},urlParams:e.singlecontractFile},function(t){0===t.errorCode?(e.singlecontractFile.thumbnailPath=r.getThumbnail(e.singlecontractFile.filePath),e.contractFiles.push(e.singlecontractFile),e.singlecontractFile={fileId:"",name:"",remark:"",url:""},e.getFileList(3)):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})}),e.addProjectFile=0,e.uploadDisabled=!1,$(document).promptBox({isDelay:!0,contentDelay:i.data.msg,type:"success"})):($(document).promptBox({isDelay:!0,contentDelay:i.data.msg,type:"errer",manualClose:!0}),e.uploadDisabled=!1)}))},getThumbnail:function(e){if(-1!=e.indexOf("150x150")){var t=e.lastIndexOf("."),o=e.substring(0,t),a=e.substring(t,e.length),r=o.lastIndexOf("_");e=e.substring(0,r)+a}return e},getPictureUrl:function(t){$("#slides").picturePreview({pictureId:t},e.pictureModel.picture)},delFile:function(o,a){$(document).promptBox({title:"提示",type:"success",content:{tip:"确认删除选中文件?"},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){if(1==a&&(e.projectInfo.files.splice(o,1),e.pictureModel.picture.splice(o,1),$(document).promptBox("closePrompt"),$(document).promptBox({isDelay:!0,contentDelay:"删除成功！",type:"success"}),e.$apply()),3==a){var r=e.contractFiles[o].id;t.delContractFile({seatParams:{projectId:e.projectId,id:r}},function(t){0===t.errorCode?(e.getFileList(3),$(document).promptBox("closePrompt"),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}}]})},getFileList:function(o){var r=this;e.projectId&&t.getProjectFile({seatParams:{projectId:e.projectId},urlParams:{type:o}},function(t){if(3==o){e.contractFiles=t.data.map(function(e){return{id:e.id,fileId:e.fileId,name:e.name,filename:e.fileName,remark:e.remark,filePath:e.filePath,thumbnailPath:r.getThumbnail(e.filePath),contentType:e.contentType}});for(var n=0,i=t.data.length;n<i;n++)e.pictureModel.picture.push({name:t.data[n].fileName,picUrl:r.getThumbnail(t.data[n].filePath),picUrlID:{id:t.data[n].fileId,path:r.getThumbnail(t.data[n].filePath),type:t.data[n].contentType}});e.pictureModel=a.updateModel(e.pictureModel,t.data)}})},saveProjectInfo:function(o){if(e.projectInfo.name||e.projectBasic.projectName.$setDirty(),e.projectInfo.code||e.projectBasic.projectCode.$setDirty(),e.projectInfo.profile||e.projectBasic.projectProfile.$setDirty(),e.projectInfo.value||e.projectBasic.projectValue.$setDirty(),e.projectInfo.risk||e.projectBasic.projectRisk.$setDirty(),4==e.projectStatus&&(e.projectInfo.summary||e.projectBasic.projectSummary.$setDirty()),!e.projectInfo.orgId)return scrollToErrorView($(".tab-content")),void(e.orgNameError=!0);if(!e.projectBasic.$valid)return void scrollToErrorView($(".tab-content"));var a=this.projectInfo;if(unique(a.companys.map(function(e){return e.type})).length<2)return void $(document).promptBox({isDelay:!0,contentDelay:"至少选择两个干系企业且各个企业角色不相同",type:"errer",manualClose:!0});if(!a.files.length)return void $(document).promptBox({isDelay:!0,contentDelay:"请上传项目文件",type:"errer",manualClose:!0});"string"==typeof a.bizTypeCode&&(a.bizTypeCode="trade"===a.bizTypeCode?2:1);var r;if(4!=e.projectStatus)r=e.projectId?{urlParams:a,seatParams:{projectId:e.projectId,issubmit:o},isNew:!1}:{urlParams:a,seatParams:{issubmit:o},isNew:!0},"true"==o?$(document).promptBox({title:"提示",type:"success",content:{tip:"确定项目内容无误并提交审核？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){t.sendProjectInfo(r,function(t){0===t.errorCode?($(document).promptBox("closePrompt"),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),setTimeout(function(){e.goBack()},1500)):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})}),e.$apply()}}]}):t.sendProjectInfo(r,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),setTimeout(function(){e.goBack()},1500)):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})});else{if(!e.projectId)return;e.contractFiles.length?$(document).promptBox({title:"提示",type:"success",content:{tip:"确定结束此项目吗？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){e.contractFiles.forEach(function(e){e.type=3});var o=[],a=sessionStorage.getItem("projectFileNum");e.projectInfo.files.length>a&&(o=e.projectInfo.files.splice(a)),o.forEach(function(e){e.type=1}),r={seatParams:{projectId:e.projectId},urlParams:{summary:e.projectInfo.summary,files:o.concat(e.contractFiles)}},t.sendsProjectSummary(r,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),setTimeout(function(){e.goBack()},1500)):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})}),e.$apply()}}]}):($(document).promptBox({isDelay:!0,contentDelay:"请上传合同文件",type:"errer",manualClose:!0}),e.tab.toggle(2))}},showFirstReport:function(){this.isFirstCheck=!0,e.tab.toggle(0)},hideFirstReport:function(){this.isFirstCheck=!1,e.tab.toggle(1)},postFirstApproval:function(){if(!e.firstResultContent)return void(e.firstCheckError=!0);$(document).promptBox({title:"提示",type:"success",content:{tip:"确认提交终审?"},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){var o={seatParams:{projectId:e.projectId},urlParams:{firstAuditMsg:e.firstResultContent}};t.postFirstApproval(o,function(t){0===t.errorCode?(e.hideFirstReport(),$(document).promptBox("closePrompt"),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.goBack(),e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]})},jumpTo:function(){e.projectId&&(sessionStorage.setItem("identityName",arguments[1]),sessionStorage.setItem("isPass",+arguments[3]),(1==e.projectAction&&(arguments[2]||arguments[4])||2==e.projectAction&&0!=this.identity)&&(sessionStorage.setItem("detailPath",location.hash.split("&").slice(0,2).join("&")),top.location.href="http://"+location.host+arguments[0]+"?id="+e.projectId))},goSeeSupplier:function(e){sessionStorage.setItem("detailPath",location.hash.split("&").slice(0,2).join("&")),top.location.href="http://"+location.host+"#/supplier?module=trade&id="+e}};e=Object.assign(e,c),e.legacyBusinessType?(e.projectInfo.bizTypeCode=e.legacyBusinessType,e.bizTypeName="logistics"===e.legacyBusinessType?"物流":"贸易"):e.getBusinessType(),e.getLanguage(),e.getProjectInfo(),e.getApprovalStatus(),e.getFileList(3),e.tab=$("#m-tab").tab({callback:r}),e.projectStatus<4&&e.tab.disable(2),!e.isFirstCheck&&window.parseUrl.getParams().tab&&e.tab.toggle(window.parseUrl.getParams().tab),1!=e.projectStatus||e.projectInfo.isReject||e.tab.exdisable(0),e.goBack=function(){var e=sessionStorage.getItem("managePath");top.location.href="http://"+location.host+e}}])}),"function"!=typeof Object.assign&&(Object.assign=function(e,t){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var o=Object(e),a=1;a<arguments.length;a++){var r=arguments[a];if(null!=r)for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(o[n]=r[n])}return o}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var o=Object(this),a=o.length>>>0;if(0===a)return!1;for(var r=0|t,n=Math.max(r>=0?r:a-Math.abs(r),0);n<a;){if(o[n]===e)return!0;n++}return!1}});