function detail(e,t,a,r){function o(a){t.getOneGoods(a).then(function(t){t&&(t.enabled?t.enabled=1:t.enabled=0,t.purchaserCustomer&&t.purchaserCustomer.length>0&&(e.purchaserCustomerCodes=[],t.purchaserCustomerCodes=[],t.purchaserCustomer.forEach(function(a){e.purchaserCustomerCodes.push(a.userName+"("+a.code+")"),t.purchaserCustomerCodes.push(a.code)}),e.purchaserCustomerCodes=e.purchaserCustomerCodes.join(",")),t.project&&t.project.length>0&&(e.projectIds=[],t.projectIds=[],t.project.forEach(function(a){e.projectIds.push(a.name+"("+a.code+")"),t.projectIds.push(a.id)}),e.projectIds=e.projectIds.join(",")),t.image&&(e.fileUrl=t.image),e.data=t,e.unitList&&i())})}function n(){var t=["name","goodsTypeName","supplierName","unitName","price","currencyName"],a=!1;return"1"==e.data.purchaserLimit&&t.push("purchaserCustomerCodes"),"1"==e.data.projectLimit&&t.push("projectIds"),t.forEach(function(t){e.data[t]&&e.data[t].length||"number"==typeof e.data[t]||(e.customerForm[t].$setDirty(),a=!0)}),a}function i(){var t=e.unitList;e.data.unit?t.forEach(function(t){t.code==e.data.unit&&(e.data.unitName=t.name)}):(e.data.unit="kg",e.data.unitName="千克"),selectFactory({data:{data:t},defaultText:"请选择",id:"unitName",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.data.unit="undefined"===t?"":t,e.$apply()},attrTextModel:function(t){t?(e.data.unitName=t,e.$apply()):e.data.unitName=""}})}e.name="detail",e.data={purchaserLimit:0,projectLimit:0,enabled:1,businessType:2},e.isEdit=!0,e.edit=function(){e.isEdit=!0},e.goBack=function(){e.isEdit?$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("common","common_back_confirm")},cancelDescription:Lang.getValByKey("common","common_back_no"),operation:[{type:"submit",application:"delete",description:Lang.getValByKey("common","common_back_yes"),operationEvent:function(){$(document).promptBox("closePrompt"),window.location.reload()}}]}):window.location.reload()},e.cancelEdit=function(){e.isEdit=!1,o(e.id)},e.id&&(e.isEdit=!1,o(e.id)),function(){t.getCurrencyList({q:"",pageSize:10,pageIndex:1},function(t){e.currencyList=t.data,t.data.forEach(function(e){e.nameCode=e.name+"("+e.code+")"}),e.data.currencyType?t.data.forEach(function(t){t.code==e.data.currencyType&&(e.data.currencyName=t.name+"("+t.code+")")}):(e.data.currencyType="CNY",e.data.currencyName="人民币(CNY)")})}(),e.hsCodeError=!1,e.checkLength=function(t){t&&!/^\d+(\.\d+)?$/.test(t)?e.hsCodeError=!0:e.hsCodeError=!1},e.descriptions=[{name:"a1"},{name:"a2"}],["supplierName","purchaserCustomerCodes2","unitName","currencyName","projectIds2"].forEach(function(e){delete Select.sharePool[e]}),e.save=function(){if(n())return void scrollToErrorView($(".detail > div"));if(!e.data.name)return void(e.dataNameError=!0);var r,o=angular.copy(e.data);r=e.data.id?t.updateOneGoods(o):t.saveOneGoods(o),"1"==o.enabled?o.enabled=!0:o.enabled=!1,e.fileUrl&&(o.image=e.fileUrl),r.then(function(t){a.promptBox(t),e.isEdit=!1,e.goBack()})},e.loadGoodsType=function(){t.trdGoodTypeList().then(function(t){a.goodsTypes(t,e,{name:e.data.goodsTypeName,id:e.data.goodsTypeId},function(t,a){e.data.goodsTypeName=t,e.data.goodsTypeId=a})})},e.setClass=function(t){return"pro"===t&&0!=e.data.projectLimit?"show":"pur"===t&&0!=e.data.purchaserLimit?0==e.data.projectLimit?"show ml":"show":void 0},e.getSuppelierData=function(e,a){a||(a=1),e=e.length?e.trim():"";var r={q:e,pageIndex:a,pageSize:10,isAsc:!1,sortName:"",isIncludePlatform:1};return t.trdSuppelyList(r)},e.initSupplier=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:"请选择",id:"supplierName",searchPlaceHoder:"请输入供应商名称或编码",showTextField:"userName",attrTextField:{"ng-value":"id"},pagination:!0,closeLocalSearch:!0,onSearchValueChange:function(t,a,r){e.suppelierData=e.getSuppelierData(a,r),angular.forEach(e.suppelierData.data,function(e,t){e.userName=e.name+" ("+e.code+")"}),t.setData(e.suppelierData),e.$apply()},attrTextId:function(t){e.data.supplierId=t||"",e.$apply()},attrTextModel:function(t,a,r){e.data.supplierName=t,e.data.supplierCode!==r.code&&$("#purchaserCustomerCodes2").val(""),e.data.supplierCode=r.code,e.$apply()}}).open(),e.data.supplierName&&$("#supplierName").val(e.data.supplierName)},e.getPurchaseData=function(a){a=a.length?a.trim():"";var r={q:a,pageIndex:1,pageSize:10,isAsc:!1,sortName:"",userType:2,supplierCode:e.data.supplierCode||""};return t.getCustomerShortGoods(r)},e.initPurchaseCus=function(){function a(){e.purchaserData=t.getCustomerShortGoods({userType:2}),angular.forEach(e.purchaserData.data,function(e,t){e.userName+="("+e.code+")"}),selectFactory({data:e.purchaserData,isSearch:!0,isUsePinyin:!0,multipleSign:",",defaultText:"请选择",id:"purchaserCustomerCodes2",searchPlaceHoder:"请输入企业名称或编码",showTextField:"userName",attrTextField:{"ng-value":"id"},pagination:!0,closeLocalSearch:!0,onSearchValueChange:function(t,a){e.customerData=e.getPurchaseData(a),angular.forEach(e.customerData.data,function(e,t){e.userName+="("+e.code+")"}),t.setData(e.customerData),e.$apply()},attrTextId:function(t){e.$apply()},attrTextModel:function(t){for(var a=t.split("，").map(function(e){return e.substring(e.indexOf("(")+1,e.indexOf(")"))}),r=[],o=0,n=a.length;o<n;o++)for(var i=0,c=e.customerData.data.length;i<c;i++)e.customerData.data[i].code===a[o]&&r.push(e.customerData.data[i].code);e.data.purchaserCustomerCodes=unique(r),e.purchaserCustomerCodes=t,e.$apply()}})}var r=setInterval(function(){$("#purchaserCustomerCodes2").length>0&&(clearInterval(r),r=null,a())},50)},t.weight().then(function(t){e.unitList=t.data,e.data&&i()}),e.manualCurrency=function(){var a=selectFactory({data:[],defaultText:"请选择",id:"currencyName",showTextField:"nameCode",isSearch:!0,closeLocalSearch:!0,pagination:!0,searchPlaceHoder:"请输入货币名称或三字码",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.data.currencyType="undefined"===t?"":t,e.$apply()},attrTextModel:function(t){e.data.currencyName=t||"",e.$apply()},onSearchValueChange:function(a,r,o){t.getCurrencyList({q:r?r.trim():"",pageSize:10,pageIndex:o||1},function(t){e.currencyList=t.data,t.data.forEach(function(e){e.nameCode=e.name+"("+e.code+")"}),a.setData(t)}),e.$apply()}});setTimeout(function(){a.open()},50)},e.getProjectShortData=function(e,a){e=e.length?e.trim():"";var r={project:e,pageIndex:a,pageSize:10,isAsc:!1,sortName:""};return t.trdProjectsShort(r)},e.initProjectShort=function(){function t(){e.projectData=e.getProjectShortData("",1),angular.forEach(e.projectData.data,function(e,t){e.userName=e.name+"("+e.code+")"}),selectFactory({data:e.projectData,isSearch:!0,defaultText:"请选择",multipleSign:",",id:"projectIds2",searchPlaceHoder:"请输入项目名称或编码",showTextField:"userName",attrTextField:{"ng-value":"id"},pagination:!0,closeLocalSearch:!0,onSearchValueChange:function(t,a,r){e.customerData=e.getProjectShortData(a,r),angular.forEach(e.customerData.data,function(e){e.userName=e.name+"("+e.code+")"}),t.setData(e.customerData),e.$apply()},attrTextId:function(t){e.$apply()},attrTextModel:function(t){for(var a=t.split("，").map(function(e){return e.substring(e.indexOf("(")+1,e.indexOf(")"))}),r=[],o=0,n=a.length;o<n;o++)for(var i=0,c=e.customerData.data.length;i<c;i++)e.customerData.data[i].code===a[o]&&r.push(e.customerData.data[i].id);e.data.projectIds=unique(r),e.projectIds=t,e.$apply()}})}var a=setInterval(function(){$("#projectIds2").length>0&&(clearInterval(a),a=null,t())},50)},e.pictureModel={edit:!0,uploadShow:!0,picture:[],accept:"image/jpg,image/jpeg,image/png,image/bmp,image/tiff"},e.getFile=function(t){var a=r.uploadFile(e.pictureModel,e[t.target.id]);if(!a)return!1;a.errorlocal?$(document).promptBox({isDelay:!0,contentDelay:a.errorlocal,type:"errer",manualClose:!1}):a.then(function(t){0===t.data.errorCode?(e.pictureModel=r.updateModel(e.pictureModel,t.data.data),e.fileUrl=t.data.data.path,e.$apply(),$(document).promptBox({isDelay:!0,contentDelay:t.data.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.data.msg,type:"errer",manualClose:!1})})},e.getPictureUrl=function(t){$("#slides").picturePreview({pictureId:t},e.pictureModel.picture)}}function unique(e){for(var t=[],a={},r=0;r<e.length;r++){var o=e[r],n=typeof o+o;1!==a[n]&&(t.push(o),a[n]=1)}return t}easySpa.require(["widget/select","public/common/pictureController.js","widget/slides","public/common/pictureService.js"],function(){app.controller("detail",["$scope","commodityService","commodityView","pictureService",detail])}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var a=Object(this),r=a.length>>>0;if(0===r)return!1;for(var o=0|t,n=Math.max(o>=0?o:r-Math.abs(o),0);n<r;){if(a[n]===e)return!0;n++}return!1}});