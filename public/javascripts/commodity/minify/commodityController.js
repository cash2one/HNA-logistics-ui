easySpa.require(["public/common/tableController.js","widget/select","widget/prompt","public/javascripts/commodity/20161224/detailController.js"],function(){var e=!1;app.controller("commodityCtrl",["$scope","commodityService","commodityView","tableService","$compile",function(t,a,r,o,i){function n(){var e=[];return o.getSelectTable(t.tableModel.tableBody).forEach(function(t){e.push(t.id)}),e}if(!e){e=!0,t.search={name:"",enabled:"",goodsTypeId:"",projectIds:"",projectLimit:"",purchaserCustomerCodes:"",purchaserLimit:"",supplierId:""},t.tableModel={tableHeader:["序号","商品名称","商品类别","商品代码","项目","采购企业","供应商","启用状态"],tableHeaderSize:["5%","5%","8%","8%","8%","8%","8%","8%","8%","13%","13%","8%"],tableBody:[],restURL:"logistics.trdGoodList",restData:{q:"",refCombos:"",isAsc:!1,pageIndex:1,pageSize:10},selectNumber:0,selectFlag:!1},t.loadListData=function(){var e=angular.copy(t.tableModel.restData);r.resetKeys(e,t.search),$.extend(e,t.search),t.searchName=t.search.name;for(var a in e)""===e[a]&&delete e[a];e.purchaserLimit&&"0"!==e.purchaserLimit||delete e.purchaserCustomerCodes,e.projectLimit&&"0"!==e.projectLimit||delete e.projectIds,e={urlParams:e},o.getTable(t.tableModel.restURL,e,function(a){t.tableModel=o.table(t.tableModel,e,a)})},t.goodsTypeIdSelect=function(){a.trdGoodTypeList().then(function(e){r.goodsTypes(e,t,{name:t.goodsTypeId,id:t.search.goodsTypeId},function(e,a){t.goodsTypeId=e,t.search.goodsTypeId=a})})},t.loadListData(),t.searchList=function(){t.tableModel.restData.pageIndex=1,t.loadListData()},t.clearSearch=function(){for(var e in t.search)t.search.hasOwnProperty(e)&&(t.search[e]="",t[e]="");t.searchName="",t.isEnabled="全部",t.purchaserLimit="全部",t.projectLimit="全部",t.tableModel.restData.pageIndex=1,t.loadListData()},t.enabledGoods=function(e){var o=n(),i="确定启用该商品?";if(!o.length)return void r.promptBox({msg:"请先选择数据!"});e||(i="确定停用该商品?"),r.promptMidBox("",{msg:i},"",function(){a.enabledGoods({ids:o,isEnabled:e}).then(function(e){r.promptBox(e),0===e.errorCode&&t.loadListData()})})},t.showMore=function(e,t){if(e){var a=[];return e.forEach(function(e){a.push(e[t])}),a.join(",")}},r.setTableHeight(),t.getDetail=function(e){r.getTpl("detail").then(function(a){t.child=t.$new(),t.child.id=e,$("#detail").html(i(a)(t.child))})},t.goBack=function(){t.child.$destroy(),$("#detail").html(""),t.loadListData()},t.deleteGoods=function(){var e=n();if(!e.length)return void r.promptBox({msg:"请先选择数据!"});r.promptMidBox("",{msg:"确定删除该商品?"},"",function(){a.deleteOneGoods(e,function(e){r.promptBox(e),0===e.errorCode&&(t.loadListData(),t.$apply())})})},t.initEnabledSelect=function(){var e={data:[{name:"已启用",code:!0},{name:"已停用",code:!1}]};selectFactory({data:e,defaultText:"全部",id:"isEnabled",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(e){t.search.isEnabled="true"===e||"false"!==e&&"",t.$apply()},attrTextModel:function(e){e?t.isEnabled=e:$("#isEnabled").val("全部"),t.$apply()}}),t.isEnabled="全部"},t.initEnabledSelect(),t.initPurchaseLimit=function(){var e={data:[{name:"是",code:"1"},{name:"否",code:"0"}]};selectFactory({data:e,defaultText:"全部",id:"purchaserLimit",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(e){t.search.purchaserLimit="undefined"===e?"":e,t.$apply()},attrTextModel:function(e){t.purchaserLimit=e||"全部",t.$apply()}}),t.purchaserLimit="全部"},t.initPurchaseLimit(),t.initProjectLimit=function(){var e={data:[{name:"是",code:"1"},{name:"否",code:"0"}]};selectFactory({data:e,defaultText:"全部",id:"projectLimit",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(e){t.search.projectLimit="undefined"===e?"":e,t.$apply()},attrTextModel:function(e){t.projectLimit=e||"全部",t.$apply()}}),t.projectLimit="全部"},t.initProjectLimit(),t.formatArr=function(e){var t=[];return e.forEach(function(e){t.push(e.name)}),t.join(",")};var s;t.initBusinessType=function(){s||(s=selectFactory({data:[],id:"goodsType",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(e){t.statusValue=e||"AUDITING",t.$apply()},attrTextModel:function(e){t.status=e,t.$apply()}}),s.setData(t.goodsTypeData))},t.getPurchaseData=function(e,t){e=e.length?e.trim():"";var r={q:e,pageIndex:t||1,pageSize:10,isAsc:!1,sortName:"",userType:2,suppelierCode:""};return a.getCustomerShortGoods(r)},t.initPurchaseCus=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,multipleSign:",",defaultText:"请选择",searchPlaceHoder:"请输入企业名称或编码",id:"purchaserCustomerCodes",showTextField:"userName",attrTextField:{"ng-value":"code"},pagination:!0,closeLocalSearch:!0,onSearchValueChange:function(e,a,r){t.customerData=t.getPurchaseData(a,r),angular.forEach(t.customerData.data,function(e){e.userName=e.userName+"("+e.code+")"}),e.setData(t.customerData),t.$apply()},attrTextId:function(e){t.search.purchaserCustomerCodes=e?t.search.purchaserCustomerCodes?t.search.purchaserCustomerCodes+","+e:e:"",t.$apply()},attrTextModel:function(e){t.purchaserCustomerCodes=e,t.$apply()}}).open(),$("#purchaserCustomerCodes").val(t.purchaserCustomerCodes)},t.getProjectShortData=function(e,t){e=e.length?e.trim():"";var r={project:e,pageIndex:t||1,pageSize:10,isAsc:!1,sortName:""};return a.trdProjectsShort(r)},t.initProjectShort=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:"请选择",multipleSign:",",id:"projectIds",showTextField:"userName",searchPlaceHoder:"请输入项目名称或编码",attrTextField:{"ng-value":"id"},pagination:!0,closeLocalSearch:!0,onSearchValueChange:function(e,a,r){t.customerData=t.getProjectShortData(a,r),t.customerData.data.length?(angular.forEach(t.customerData.data,function(e){e.userName=e.name+"("+e.code+")"}),e.setData(t.customerData)):e.setData({data:[]}),t.$apply()},attrTextId:function(e){e||(t.search.projectIds=""),e&&!t.search.projectIds.includes(e)&&(t.search.projectIds=e+","+t.search.projectIds),t.$apply()},attrTextModel:function(e){for(var a=e.split("，").map(function(e){return e.substring(e.indexOf("(")+1,e.indexOf(")"))}),r=[],o=0,i=a.length;o<i;o++)for(var n=0,s=t.customerData.data.length;n<s;n++)t.customerData.data[n].code===a[o]&&r.push(t.customerData.data[n].id);t.search.projectIds=r.join(","),t.projectIds=e,t.$apply()}}).open(),$("#projectIds").val(t.projectIds)},t.getSellData=function(e,t){e=e.length?e.trim():"";var r={q:e,pageIndex:t||1,pageSize:10,isAsc:!1,sortName:"",isIncludePlatform:1};return a.trdSuppelyList(r)},t.initSupplier=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:"请选择",id:"supplier",showTextField:"userName",searchPlaceHoder:"请输入供应商名称或编码",attrTextField:{"ng-value":"id"},pagination:!0,closeLocalSearch:!0,onSearchValueChange:function(e,a,r){t.suppelierData=t.getSellData(a,r),angular.forEach(t.suppelierData.data,function(e){e.userName=e.name+" ("+e.code+")"}),e.setData(t.suppelierData),t.$apply()},attrTextId:function(e){t.search.supplier=e||"",t.$apply()},attrTextModel:function(e){t.supplier=e,t.$apply()}}).open()}}}])}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var a=Object(this),r=a.length>>>0;if(0===r)return!1;for(var o=0|t,i=Math.max(o>=0?o:r-Math.abs(o),0);i<r;){if(a[i]===e)return!0;i++}return!1}});