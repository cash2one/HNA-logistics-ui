easySpa.require(["widget/prompt","widget/select","widget/searchBox","public/common/uploadFile/uploadFile.js","public/javascripts/fragment/ordersStatus/ordersStatus.js","public/javascripts/fragment/orderLog/orderLog.js","public/javascripts/fragment/orderDetail/payInfo.js","public/javascripts/fragment/orderDetail/serviceInfo.js"],function(){app.controller("confirmOrderCtrl",["$scope","$location","$route","confirmOrderService","confirmOrderView",function($scope,$location,$route,confirmOrderService,confirmOrderView){function rechangeProductData(e){return e.forEach(function(e){e.name+="("+e.code+")"}),e}$scope.seaId=1,$scope.airId=6,$scope.isOrderSearch=!1,$scope.activeTab="ORDERDETAIL",$scope.from=easySpa.queryUrlValByKey("from"),$scope.isOrderSearch="orderSearch"===$scope.from,$scope.switchTab=function(e){e!==$scope.activeTab&&("OPERATIONLOG"===e&&$scope.$broadcast("operatelog",$scope.orderId),$scope.activeTab=e)};var comObj={showMsg:function(e,r){$(document).promptBox({isDelay:!0,contentDelay:e,type:r,time:3e3,manualClose:"errer"===r})},showErrorMsg:function(e){comObj.showMsg(e,"errer")},getSigleDataByName:function(e,r){for(var r=r.data,o=0;o<r.length;o++)if(r[o].name==e)return r[o]},clearNextAddress:function(e){var r=e.next;if(null!=r)return r.clearData(),r.id=null,comObj.clearNextAddress(r)}};$.extend($scope,{submited:"",oPlaceListShow:!0,dPlaceListShow:!0,aPlaceListShow:!0,CNAddress:!0,tableWidth:["12%","12%","12%","12%","12%","12%","12%","12%"],tableItemLength:["30","30","15","9","30","9","30"],resourceTree:{},remainWords:140,orderBaseInfo:{},currentAddress:{},goodsList:[],selectGoods:[],serviceList:[],addAddressFormShowError:!1,orderCustomerMsg:{},oPlaceList:[],dPlaceList:[],aPlaceList:[]}),confirmOrderService.getUnitDictionary("",function(e){0==e.errorCode?($scope.unitList=e,$scope.unitMenu={},e.data.map(function(e){$scope.unitMenu[e.code]=e.name})):$scope.unitMenu=[]}),$scope.orderBaseInfo.cusWeightUnit="kg",$scope.orderBaseInfo.cusWeightUnitName="千克";var createSelectBox=function(e,r){var o=$scope.unitList;unitListEle=selectFactory({data:o,id:"goodsUnitName"+e,maxHeight:160,closeLocalSearch:!0,direction:"up",isCreateNewSelect:!0,defaultCount:50,showTextField:"name",attrTextField:{"ng-value":"code"},defaultText:Lang.getValByKey("common","common_select_tips"),attrTextId:function(r){$scope.goodsList[e].goodsUnit=r},attrTextModel:function(r,s){o=r?s.data.find(function(e){return e.name==r}):{},$scope.goodsList[e].goodsUnitName=o.name,$scope.$apply(),$scope.goodsCheck()}}),unitListEle.inputElement.val($scope.goodsList[e].goodsUnitName)},setSelectBoxList=function(){for(var e=0,r=$scope.goodsList.length;e<r;e++)!function(e){setTimeout(function(){$("#goodsUnit"+e)&&createSelectBox(e)},10)}(e)};$scope.getClientNum=function(){if($scope.checkbox)if($scope.orderBaseInfo.customerName){var e={seatParams:{cusUserId:$scope.orderBaseInfo.customerId}};confirmOrderService.getClientNum(e,function(e){e&&0===e.errorCode?($scope.orderBaseInfo.externalNo=e.data,$("#clientNum").attr("readonly","true")):comObj.showErrorMsg(e.msg)})}else $scope.checkbox=!1,comObj.showErrorMsg("请输入账号名");else $scope.checkbox=!1,$("#clientNum").removeAttr("readonly"),$scope.orderBaseInfo.externalNo=$scope.externalNoOrigin},$scope.goBack=function(e){if($route.current.params&&"cockpit"==$route.current.params.orderFrom)return void(window.location.href="#/cockpit?from=logisticsOrder");"DRAFT"!=$scope.orderStatus&&!$scope.couldEdit||e?$route.current.params&&$route.current.params.id?top.location.href="http://"+location.host+"#/workOrderDetail?id="+$route.current.params.id:$route.current.params&&"orderSearch"==$route.current.params.from?window.location.href="#/orderSearch?from=orderDetail":window.location.href="#/orders?&orderStatus="+$scope.orderStatus:$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("common","common_back_confirm")},cancelDescription:Lang.getValByKey("common","common_back_no"),operation:[{type:"submit",application:"delete",description:Lang.getValByKey("common","common_back_yes"),operationEvent:function(){$(document).promptBox("closePrompt"),$route.current.params&&$route.current.params.id?top.location.href="http://"+location.host+"#/workOrderDetail?id="+$route.current.params.id:$route.current.params&&"orderSearch"==$route.current.params.from?window.location.href="#/orderSearch?from=orderDetail":window.location.href="#/orders?&orderStatus="+$scope.orderStatus}}]})},$scope.tableHeader=[Lang.getValByKey("confirmOrder","confirmOrder_page_goodsInfo_name"),Lang.getValByKey("confirmOrder","confirmOrder_page_goodsInfo_engName"),Lang.getValByKey("confirmOrder","confirmOrder_page_goodsInfo_hsCode"),Lang.getValByKey("confirmOrder","confirmOrder_page_goodsInfo_count"),Lang.getValByKey("confirmOrder","confirmOrder_page_goodsInfo_unit"),Lang.getValByKey("confirmOrder","confirmOrder_page_goodsInfo_price"),Lang.getValByKey("confirmOrder","confirmOrder_page_goodsInfo_describe"),Lang.getValByKey("confirmOrder","confirmOrder_page_goodsInfo_operator")],$scope.detailTableHeader=$scope.tableHeader.slice(0,7),$scope.goodsMenu=["goodsNameCn","goodsNameEn","hsCode","goodsNumber","goodsUnitName","goodsPrice","description"],$scope.addGoods=function(){$scope.goodsList.push({goodsNameCn:"",goodsNameEn:"",goodsNumber:"",goodsPrice:"",goodsUnit:"",goodsUnitName:"",hsCode:"",description:""}),setTimeout(function(){createSelectBox($scope.goodsList.length-1)},10)},$scope.delGoods=function(e){$scope.goodsList.splice(e,1),e<$scope.goodsList.length&&setTimeout(function(){createSelectBox(e)},10)},$scope.initAddWidget=function(){$scope.CNAddress?initCNAddress():initNotCNAddress()},$scope.openAddNewAddress=function(e){if($("#mobile-phone").removeClass("ng-invalid ng-dirty"),$scope.orderBaseInfo.productName){var r=function(){comObj.showMsg(Lang.getValByKey("confirmOrder","confirmOrder_model_max10Address"),"warning")};if(1==e&&$scope.oPlaceList.length>=10)return void r();if(2==e&&$scope.dPlaceList.length>=10)return void r();if(3==e&&$scope.aPlaceList.length>=10)return void r();3==e?$scope.isOrdinary=!0:$scope.productGroupRootId==$scope.seaId||$scope.productGroupRootId==$scope.airId?$scope.isOrdinary=!1:$scope.isOrdinary=!0,$scope.CNAddress=!1,$scope.isOriginAddress=e,$scope.currentAddress={},$scope.airSea=$scope.airSeaValue="",$("#addOrModifyAddress").html(Lang.getValByKey("confirmOrder","confirmOrder_model_addNewAddress")),$scope.AddNewAddressForm.$setPristine(),$("#select-address-type").val($scope.addressType),$scope.showAddressForm=!0}},$scope.cancelAddNewAddress=function(){$scope.currentAddress={},$scope.AddNewAddressForm.addressState.$setPristine(),AddNewAddressForm.reset(),resetFormRawModelValue(),$scope.showAddressForm=!1};var resetFormRawModelValue=function(){for(var e=["addressAddress","addressName","addressPhone","addressPostcode","addressEmail"],r=0,o=e.length;r<o;r++)$scope.AddNewAddressForm[e[r]].$$rawModelValue=""};$scope.saveAddNewAddress=function(){if(flag=!1,$scope.currentAddress.countryName||(flag=!0,$scope.AddNewAddressForm.addressCountry.$setDirty()),$scope.isOrdinary||3==$scope.isOriginAddress?($scope.CNAddress?($scope.AddNewAddressForm.addressState.$setPristine(),$scope.currentAddress.provinceName||(flag=!0,$scope.AddNewAddressForm.addressProvince.$setDirty()),$scope.currentAddress.cityName||(flag=!0,$scope.AddNewAddressForm.addressCity.$setDirty())):($scope.AddNewAddressForm.addressProvince.$setPristine(),$scope.AddNewAddressForm.addressCity.$setPristine(),$scope.AddNewAddressForm.addressArea.$setPristine(),$scope.AddNewAddressForm.addressStreet.$setPristine(),$scope.currentAddress.cityName||(flag=!0,$scope.AddNewAddressForm.addressState.$setDirty())),$scope.currentAddress.address||(flag=!0,$scope.AddNewAddressForm.addressAddress.$setDirty()),$scope.currentAddress.address||(flag=!0,$scope.AddNewAddressForm.addressState.$setDirty())):$scope.airSea||($scope.AddNewAddressForm.airSea.$setDirty(),flag=!0),$scope.currentAddress.name||($scope.AddNewAddressForm.addressName.$setDirty(),flag=!0),$.trim($scope.currentAddress.postcode)||($scope.AddNewAddressForm.addressPostcode.$setDirty(),flag=!0),$scope.currentAddress.phone||$scope.currentAddress.telPhone?$("#mobile-phone").removeClass("ng-invalid ng-dirty"):($("#mobile-phone").addClass("ng-invalid ng-dirty"),flag=!0),flag)return void scrollToErrorView($(".confirmOrderPromptContent"));var e={id:$scope.currentAddress.id||"",customerId:$scope.orderBaseInfo.customerId,name:$scope.currentAddress.name,type:$scope.isOriginAddress,phone:$scope.currentAddress.phone,telPhone:$scope.currentAddress.telPhone,postcode:$scope.currentAddress.postcode,email:$scope.currentAddress.email,transportType:$scope.productGroupRootId,countryCode:$scope.currentAddress.countryId||$scope.currentAddress.countryCode,countryName:$scope.currentAddress.countryName};3==$scope.isOriginAddress&&(e.transportType=11),$scope.isOrdinary||3==$scope.isOriginAddress?(e.provinceId=$scope.currentAddress.provinceId,e.provinceName=$scope.currentAddress.provinceName,e.cityId=$scope.currentAddress.cityId,e.cityName=$scope.currentAddress.cityName,e.districtId=$scope.currentAddress.districtId,e.districtName=$scope.currentAddress.districtName,e.streetId=$scope.currentAddress.streetId,e.streetName=$scope.currentAddress.streetName,e.address=$scope.currentAddress.address):e.transportId=$scope.airSeaValue;var r={urlParams:e};confirmOrderService.saveOrUpdateAddress(r,function(e){0!=e.errorCode?comObj.showErrorMsg(e.msg):(comObj.showMsg(e.msg,"success"),1==$scope.isOriginAddress?getAddressList(1,e.data):2==$scope.isOriginAddress?getAddressList(2,e.data):3==$scope.isOriginAddress&&getAddressList(3,e.data),$scope.resourceTree.addRootMap={},$scope.cancelAddNewAddress())})};var getAddressList=function(e,r){var o={urlParams:{customerId:$scope.orderBaseInfo.customerId,type:e,transportType:$scope.productGroupRootId}};3==e&&(o.urlParams.transportType=11);var s=function(o){1==e?($scope.oPlaceList=o.data,r?($scope.oPlaceList.map(function(e,o){e.isNotAccess=!1,e.isShow=!0,e.id==r&&($scope.oPlaceIndex=o)}),-1==r&&setTimeout(function(){$scope.switchStatus("origin",!0)},10)):($scope.oPlaceList.map(function(e,r){e.isNotAccess=!1,e.isShow=!0,e.isDefault&&($scope.oPlaceIndex=r)}),setTimeout(function(){$scope.switchStatus("origin",!0)},10))):2==e?($scope.dPlaceList=o.data,r?($scope.dPlaceList.map(function(e,o){e.isNotAccess=!1,e.isShow=!0,e.id==r&&($scope.dPlaceIndex=o)}),-1==r&&setTimeout(function(){$scope.switchStatus("destination",!0)},10)):($scope.dPlaceList.map(function(e,r){e.isNotAccess=!1,e.isShow=!0,e.isDefault&&($scope.dPlaceIndex=r)}),setTimeout(function(){$scope.switchStatus("destination",!0)},10))):3==e&&($scope.aPlaceList=o.data,r?($scope.aPlaceList.map(function(e,o){e.isNotAccess=!1,e.isShow=!0,e.id==r&&($scope.aPlaceIndex=o)}),-1==r&&setTimeout(function(){$scope.switchStatus("accept",!0)},10)):($scope.aPlaceList.map(function(e,r){e.isNotAccess=!1,e.isShow=!0,e.isDefault&&($scope.aPlaceIndex=r)}),setTimeout(function(){$scope.switchStatus("accept",!0)},10)),$scope.orderDetail&&!$scope.orderDetail.fetchAddress&&$scope.aPlaceList&&$scope.aPlaceList.length&&angular.forEach($scope.aPlaceList,function(e,r){e.isDefault&&($scope.aPlaceIndex=r)}));var s=$scope.orderBaseInfo.productUid,t=$scope.orderBaseInfo.customerId;delete $scope.resourceTree.addRootMap[s+"$$"+t],$scope.isAddressAccessForCurrentProduce()};confirmOrderService.getAddressList(o,s)};$scope.setDefaultAddress=function(e,r){var o={seatParams:{customerId:$scope.orderBaseInfo.customerId,type:r,newId:e,transportType:$scope.productGroupRootId}};3==r&&(o.seatParams.transportType=11);var s=function(o){0==o.errorCode?(comObj.showMsg(o.msg,"success"),1==r?$scope.oPlaceList.map(function(r){r.isDefault=r.id==e}):2==r?$scope.dPlaceList.map(function(r){r.isDefault=r.id==e}):3==r&&$scope.aPlaceList.map(function(r){r.isDefault=r.id==e})):comObj.showErrorMsg(o.msg)};confirmOrderService.setDefaultAddress(o,s)},$scope.modifyAddress=function(e,r){if($("#mobile-phone").removeClass("ng-invalid ng-dirty"),$scope.isOriginAddress=r,$("#addOrModifyAddress").html(Lang.getValByKey("confirmOrder","confirmOrder_model_modifyNewAddress")),$scope.currentAddress={},1==r){for(var o in $scope.oPlaceList[e])$scope.currentAddress[o]=$scope.oPlaceList[e][o];$scope.currentAddress.countryName=$scope.currentAddress.countryName+"("+$scope.oPlaceList[e].countryCode+")",$scope.currentAddress.transportName=$scope.currentAddress.transportName+"("+$scope.oPlaceList[e].transportCode+")"}else if(2==r){for(var o in $scope.dPlaceList[e])$scope.currentAddress[o]=$scope.dPlaceList[e][o];$scope.currentAddress.countryName=$scope.currentAddress.countryName+"("+$scope.dPlaceList[e].countryCode+")",$scope.currentAddress.transportName=$scope.currentAddress.transportName+"("+$scope.dPlaceList[e].transportCode+")"}else if(3==r){for(var o in $scope.aPlaceList[e])$scope.currentAddress[o]=$scope.aPlaceList[e][o];$scope.currentAddress.countryName=$scope.currentAddress.countryName+"("+$scope.aPlaceList[e].countryCode+")",$scope.currentAddress.transportName=$scope.currentAddress.transportName+"("+$scope.aPlaceList[e].transportCode+")"}$("#select-address-type").val($scope.currentAddress.transportTypeName),$scope.currentAddress.transportType==$scope.seaId||$scope.currentAddress.transportType==$scope.airId?($scope.isOrdinary=!1,$scope.airSea=$scope.currentAddress.transportName,$scope.airSeaValue=$scope.currentAddress.transportId,$("#select-air-sea").val($scope.currentAddress.transportName),$scope.addressDetail=$scope.currentAddress.address,$("#addressDetail").val($scope.currentAddress.address)):($scope.isOrdinary=!0,$scope.currentAddress.provinceName?$scope.CNAddress=!0:$scope.CNAddress=!1),$scope.getCountry(!1),$scope.initAddWidget(),$scope.showAddressForm=!0},$scope.delAddress=function(e,r,o){var s={title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("confirmOrder","confirmOrder_pormpt_deleteAddress")},manualClose:!1,time:1e3,isDelay:!1,operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){var o={seatParams:{cusUserId:$scope.orderBaseInfo.customerId},urlParams:[e+""]},s=function(o){$(document).promptBox("closePrompt"),0==o.errorCode?(comObj.showMsg(o.msg,"success"),1==r?($scope.oPlaceList=$scope.oPlaceList.filter(function(r){return r.id!=e}),$scope.oPlaceList.length>0?($scope.oPlaceList[0].isDefault=!0,$scope.oPlaceIndex=0):$scope.oPlaceIndex=-1):2==r?($scope.dPlaceList=$scope.dPlaceList.filter(function(r){return r.id!=e}),$scope.dPlaceList.length>0?($scope.dPlaceList[0].isDefault=!0,$scope.dPlaceIndex=0):$scope.dPlaceIndex=-1):3==r&&($scope.aPlaceList=$scope.aPlaceList.filter(function(r){return r.id!=e}),$scope.aPlaceList.length>0?($scope.aPlaceList[0].isDefault=!0,$scope.aPlaceIndex=0):$scope.aPlaceIndex=-1),$scope.$apply()):comObj.showErrorMsg(o.msg)};confirmOrderService.delUserAddress(o,s)}}]};$(document).promptBox(s)};var clearObjValueByKey=function(e){for(var r=["countryName","countryCode","countryId","addressName","addressId","provinceName","provinceId","cityName","cityId","districtName","districtId","streetName","streetId"],o=r.indexOf(e),s=r.length;o<s;o++)$scope.currentAddress[r[o]]=""},resetProductAndCargo=function(e,r){"DRAFT"==$scope.orderStatus&&setSelectBoxList()},resetFormInfo=function(e){$scope.orderBaseInfo={cargoTypeId:e.cargoType,cargoTypeName:e.cargoTypeName,cusWeight:e.cusWeight,cusWeightUnit:e.cusWeightUnit,cusWeightUnitName:e.cusWeightUnitName,customerId:e.cusUserId,customerName:e.customerName+"("+e.cusUserName+")",productName:e.productName+"("+e.productCode+")",productUid:e.productUid,productId:e.productId,packageNum:e.packageNum,externalNo:e.externalNo,cusUserId:e.customerId},$scope.orderCustomerMsg.msg=e.customerNote,getAddressList(1,-1),getAddressList(2,-1),getAddressList(3,-1),$scope.isAddressAccessForCurrentProduce(),$scope.goodsList=e.orderCargoDtos,resetProductAndCargo(e.productName,e.productId),getServersList(e.orderAdditionalDtos)},getOrderInfoByOrderId=function(e){var r={seatParams:{orderNo:e}},o=function(e){var r=e.data;if($scope.orderId=e.data.id,setTimeout(function(){$scope.$broadcast("payInfoEvent",r.orderNo,r.orderStatus),$scope.$broadcast("serviceInfoEvent",r.orderNo,r.orderStatus)},0),r.productId){var o={seatParams:{productId:r.productId}};confirmOrderService.getProductGroupRootId(o,function(e){0===e.errorCode&&($scope.accountCurrency=e.data.currencyCode,$scope.productGroupRootId=e.data.productGroupRootId,$scope.productGroupRootId==$scope.seaId||$scope.productGroupRootId==$scope.airId?$scope.isOrdinary=!1:($scope.isOrdinary=!0,$scope.productGroupRootId=11))})}$scope.filterProductAddress(r.productUid),$scope.orderStatus=r.orderStatus,$scope.couldEdit="DRAFT"==r.orderStatus,$route.current.params.isJustShow?($scope.couldEdit=!1,$scope.isJustShow=!0):$scope.isJustShow=!1,$route.current.params.from?$scope.canEdit=!1:$scope.canEdit=!0,$scope.ordSubOrderDtos=r.ordSubOrderDtos,$scope.orderNo=r.orderNo,$scope.orderBaseInfo.externalNo=r.externalNo,$scope.externalNoOrigin=r.externalNo,$scope.orderDetail=r,$("#orderDetailOrModify").html(r.waybillNo);var s="";r.orderAdditionalDtos.map(function(e){s+=e.serviceTypeName+"，"}),$scope.serviceStr=s.slice(0,s.length-1),"DRAFT"!=r.orderStatus&&setSubOrderLogistics(r.orderStatus,r.orderNo,r.waybillNo),resetFormInfo(r)};confirmOrderService.getOrderInfoByOrderId(r,o)},countryEle;$scope.getCountryData=function(e,r){var o=1==$scope.isOriginAddress?"s":2==$scope.isOriginAddress?"e":"l",s={urlParams:{q:e||"",pageIndex:r||1,pageSize:10,id:$scope.orderBaseInfo.productId,type:o}},t=confirmOrderService.getCountryList(s);return angular.forEach(t.data,function(e,r){e.name+="("+e.figureCode+")"}),t},$scope.getCountry=function(e){countryEle=selectFactory({data:[],id:"country",isSearch:!0,closeLocalSearch:!0,defaultCount:11,isNotUseFilter:!0,searchPlaceHoder:"请输入名称或二字码",defaultText:Lang.getValByKey("common","common_select_tips"),pagination:!0,onSearchValueChange:function(e,r,o){e.setData($scope.getCountryData(r,o)),$scope.$apply()},attrTextModel:function(e,r,o){countryEle&&comObj.clearNextAddress(countryEle),clearObjValueByKey("countryName"),$scope.airSeaValue="",$scope.airSea="",$scope.addressDetail="",e?$("#select-air-sea").removeAttr("disabled"):$("#select-air-sea").attr("disabled","disabled"),$scope.currentAddress.countryName=e,$scope.currentAddress.countryId=o.figureCode,$scope.currentAddress.countryCode=o.figureCode,$scope.currentAddress.figureCode=o.figureCode,countryEle.id=o.id,$scope.CNAddress="CN"==o.figureCode,$scope.initAddWidget(),$scope.$apply()}}),e&&countryEle.open()};var initNotCNAddress=function(){var e=1==$scope.isOriginAddress?"s":2==$scope.isOriginAddress?"e":"l",r=function(r,o){var s={urlParams:{id:$scope.orderBaseInfo.productId,countryCode:$scope.currentAddress.countryCode,parentId:"",type:e,q:r||"",pageIndex:o||1,pageSize:10}};return confirmOrderService.getAddressData(s)},o=r();stateEle=selectFactory({data:[],id:"state",showTextField:"cityName",isSearch:!0,isUsePinyin:!0,isCreateNewSelect:!0,pagination:!0,closeLocalSearch:!0,defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(e,o,s){e.setData(r(o,s)),$scope.$apply()},attrTextModel:function(e,r,o){clearObjValueByKey("addressName"),e&&($scope.currentAddress.cityId=o.id,$scope.currentAddress.cityName=o.cityName),$scope.$apply()}}),stateEle.setData(o),stateEle.hide(),countryEle.next=stateEle},initCNAddress=function(){var e=1==$scope.isOriginAddress?"s":2==$scope.isOriginAddress?"e":"l",r={urlParams:{id:$scope.orderBaseInfo.productId,countryCode:"CN",parentId:"",type:e,pageIndex:1,pageSize:1e3}},o=confirmOrderService.getAddressData(r);provinceEle=selectFactory({data:[],id:"province",showTextField:"cityName",defaultCount:100,isCreateNewSelect:!0,attrTextModel:function(e,o,s){if(clearObjValueByKey("provinceName"),comObj.clearNextAddress(provinceEle),e){$scope.currentAddress.provinceName=s.cityName,$scope.currentAddress.provinceId=s.id,cityEle.setData([]);var t=1==$scope.isOriginAddress?"s":2==$scope.isOriginAddress?"e":"l";r.urlParams.id=$scope.orderBaseInfo.productId,r.urlParams.type=t,r.urlParams.parentId=s.id;var c=confirmOrderService.getAddressData(r);if(c&&c.data.length?cityEle.setData(c):cityEle.setData([]),c.data.length>1)cityEle.open();else if(1===c.data.length){clearObjValueByKey("cityName"),comObj.clearNextAddress(cityEle),$scope.currentAddress.cityName=c.data[0].cityName,$scope.currentAddress.cityId=c.data[0].id,r.urlParams.parentId=c.data[0].id;var d=confirmOrderService.getAddressData(r);d.data.length?areaEle.setData(d):areaEle.setData([]),d.data.length>0&&areaEle.open()}}$scope.$apply()}}),provinceEle.setData(o),countryEle.next=provinceEle,$scope.currentAddress.provinceId?(r.urlParams.parentId=$scope.currentAddress.provinceId,o=confirmOrderService.getAddressData(r)):o={data:[]},cityEle=selectFactory({data:[],id:"city",showTextField:"cityName",defaultCount:100,isCreateNewSelect:!1,attrTextModel:function(e,o,s){if(clearObjValueByKey("cityName"),comObj.clearNextAddress(cityEle),e){$scope.currentAddress.cityName=s.cityName,$scope.currentAddress.cityId=s.id;var t=1==$scope.isOriginAddress?"s":2==$scope.isOriginAddress?"e":"l";r.urlParams.id=$scope.orderBaseInfo.productId,r.urlParams.type=t,r.urlParams.parentId=s.id;var c=confirmOrderService.getAddressData(r);c.data.length?areaEle.setData(c):areaEle.setData([]),c.data.length>0&&areaEle.open()}$scope.$apply()}}),cityEle.setData(o),provinceEle.next=cityEle,$scope.currentAddress.cityId?(r.urlParams.parentId=$scope.currentAddress.cityId,o=confirmOrderService.getAddressData(r)):o={data:[]},areaEle=selectFactory({data:[],id:"area",showTextField:"cityName",defaultCount:100,isCreateNewSelect:!1,attrTextModel:function(e,o,s){if(clearObjValueByKey("districtName"),comObj.clearNextAddress(areaEle),e){$scope.currentAddress.districtName=s.cityName,$scope.currentAddress.districtId=s.id;var t=1==$scope.isOriginAddress?"s":2==$scope.isOriginAddress?"e":"l";r.urlParams.id=$scope.orderBaseInfo.productId,r.urlParams.type=t,r.urlParams.parentId=s.id;var c=confirmOrderService.getAddressData(r);c.data.length?streetEle.setData(c):streetEle.setData([]),c.data.length>0&&streetEle.open()}$scope.$apply()}}),areaEle.setData(o),cityEle.next=areaEle,$scope.currentAddress.districtId?(r.urlParams.parentId=$scope.currentAddress.districtId,o=confirmOrderService.getAddressData(r)):o={data:[]},streetEle=selectFactory({data:[],id:"street",showTextField:"cityName",defaultCount:100,isCreateNewSelect:!1,attrTextModel:function(e,r,o){clearObjValueByKey("streetName"),e&&($scope.currentAddress.streetName=o.cityName,$scope.currentAddress.streetId=o.id,streetEle.id=o.id),$scope.$apply()}}),streetEle.setData(o),areaEle.next=streetEle},getServersList=function(e){if(!$scope.resourceTree.serviceList){$scope.resourceTree.serviceList=e;var r={seatParams:{uid:$scope.orderBaseInfo.productUid,type:"optional"}};confirmOrderService.getServiceList(r,function(e){0==e.errorCode&&($scope.resourceTree.serviceList=e.data)})}var o=$scope.resourceTree.serviceList;if(e){var s=[];e.map(function(e){s.push(e.serviceTypeCode)}),o.map(function(e){s.indexOf(e.serviceTypeCode)>-1&&(e.isChecked=!0)})}angular.forEach(o,function(e){e.serviceReceive="ST001"==e.serviceTypeCode}),$scope.productReceived||angular.forEach(o,function(e){if(e.isChecked&&e.serviceReceive)return void($scope.productReceived=!0)}),$scope.isShowOptionalService=!1,angular.forEach(o,function(e){e.isChecked&&($scope.isShowOptionalService=!0)}),$scope.orderDetail&&(!$scope.orderDetail||"COMMITED"!=$scope.orderDetail.orderStatus&&"DRAFT"!=$scope.orderDetail.orderStatus)||($scope.isShowOptionalService=!0),$scope.serviceList=o},getClientData=function(e,r){r||(r=1);var o={urlParams:{q:e?e.trim():"",pageIndex:r,pageSize:10,sortName:"",isAsc:!1}},e=confirmOrderService.getUserList(o);return angular.forEach(e.data,function(e,r){e.userName=e.fullName+"("+e.userName+")"}),e};$scope.clientEle=function(){clientEle=selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),searchPlaceHoder:"请输入姓名或用户名",id:"userList",showTextField:"userName",closeLocalSearch:!0,isSaveInputVal:"true",pagination:!0,attrTextField:{"ng-value":"id"},onSearchValueChange:function(e,r,o){var s=getClientData(r,o);e.setData(s)},attrTextId:function(e){e?($scope.orderBaseInfo.customerId=e,$scope.getProduct()):($scope.orderBaseInfo.cusUserId="",productBox.destroy()),$scope.orderBaseInfo.productUid="",$scope.orderBaseInfo.productName="",$scope.oPlaceList=[],$scope.dPlaceList=[],$scope.aPlaceList=[],$scope.$apply()},attrTextModel:function(e,r,o){e!=$scope.orderBaseInfo.customerName&&($scope.orderBaseInfo.externalNo="",$scope.orderBaseInfo.cargoTypeName="",$scope.checkbox=!1),$scope.orderBaseInfo.customerName=e,$scope.orderBaseInfo.cusUserId=o.customerId,$scope.$apply()}}).open()};var productBox;$scope.getProduct=function(){$scope.contentList=confirmOrderService.getProductAllData({urlParams:{isHot:!0}}),$scope.navItem=confirmOrderService.getProductNavItem(),productBox=new SearchBox.init({inputId:"productList",searchData:[],defaultText:"请选择",tip:"请输入名称或编码",navItem:$scope.navItem.data,tabIndex:"热门",contentList:rechangeProductData($scope.contentList.data),toggleTab:function(e,r){this.tabIndex=r;var o={urlParams:{isHot:!1,pageIndex:e||1,pageSize:10,customerId:$scope.orderBaseInfo.cusUserId,capital:r}};"热门"==r&&(o.urlParams.isHot=!0,o.urlParams.capital=""),"其他"==r&&(o.urlParams.isHot=!1,o.urlParams.capital="_");var s=confirmOrderService.getProductAllData(o);return{data:rechangeProductData(s.data),pagination:s.pagination}},onSearchValueChange:function(e,r){var o={urlParams:{q:e,isHot:!1,pageIndex:r||1,pageSize:10,customerId:$scope.orderBaseInfo.cusUserId,capital:""}},s=confirmOrderService.getProductAllData(o);return{data:rechangeProductData(s.data),pagination:s.pagination}},attrTextModel:function(e,r){if(!e)return $scope.orderBaseInfo.cargoTypeName="",$scope.orderBaseInfo.cargoTypeId="",$scope.orderBaseInfo.cusWeight="",$scope.orderBaseInfo.cusWeightUnit="",$scope.orderBaseInfo.cusWeightUnitName="",$scope.orderBaseInfo.productName="",$scope.oPlaceList=[],$scope.dPlaceList=[],$scope.aPlaceList=[],$scope.serviceList=[],void $scope.$apply();$scope.productGroupRootId=r.productGroupRootId,confirmOrderService.getProductGroupRootId({seatParams:{productId:r.id}},function(e){0===e.errorCode&&($scope.accountCurrency=e.data.currencyCode)}),$scope.productGroupRootId==$scope.seaId||$scope.productGroupRootId==$scope.airId?$scope.isOrdinary=!1:($scope.isOrdinary=!0,$scope.productGroupRootId=11),$scope.filterProductAddress(r.uid),$scope.orderBaseInfo.productName=e,$scope.orderBaseInfo.productUid=r.uid,$scope.orderBaseInfo.productId=r.id,getAddressList(1),getAddressList(2),getAddressList(3),$scope.orderBaseInfo.cargoTypeName="",$scope.orderBaseInfo.cargoTypeId="",cargoEle&&cargoEle.clearData();var o=confirmOrderService.getProductCargoData({seatParams:{id:$scope.orderBaseInfo.productId}});$scope.orderBaseInfo.cusWeight="",$scope.resourceTree.serviceList=r.services,getServersList(),$scope.isAddressAccessForCurrentProduce(),airSeaEle&&airSeaEle.clearData(),Select.sharePool["select-air-sea"]=null,0===o.errorCode&&o.data.length>0&&($scope.orderBaseInfo.cargoTypeName=o.data[0].cargoTypeName,$scope.orderBaseInfo.cargoTypeId=o.data[0].cargoTypeCode),$scope.$apply()}})},$scope.filterProductAddress=function(e){e&&confirmOrderService.getProductReceived({urlParams:{uid:e}},function(e){0===e.errorCode?($scope.productReceivedData=e.data,$scope.productReceived=e.data.productReceive):($scope.productReceivedData={},$scope.productReceived=!1)})};var cargoEle;$scope.cargoEle=function(){if(!$scope.orderBaseInfo.productId)return!1;var e={seatParams:{id:$scope.orderBaseInfo.productId}},r=confirmOrderService.getProductCargoData(e);cargoEle=selectFactory({data:[],isUsePinyin:!0,id:"cargoTypeList",isSaveInputVal:!0,maxHeight:160,showTextField:"cargoTypeName",defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(e,r,o){e?($scope.orderBaseInfo.cargoTypeName=e,$scope.orderBaseInfo.cargoTypeId=o.cargoTypeCode):$scope.orderBaseInfo.cargoTypeName=$scope.orderBaseInfo.cargoTypeId="",$scope.$apply()}}),cargoEle.setData(r),cargoEle.open()};var getCargoUnitList=function(e){var r={urlParams:{q:e?e.trim():"",pageIndex:1,pageSize:100}};return confirmOrderService.getCargoUnitList(r)};$scope.unitEle=function(){var e=getCargoUnitList();unitEle=selectFactory({data:e,id:"cargoUnitList",isUsePinyin:!0,isSaveInputVal:!0,showTextField:"code",maxHeight:160,defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(e,r){var o;o=e?r.data.find(function(r){return r.code==e}):{},$scope.orderBaseInfo.cusWeightUnit=o.code,$scope.orderBaseInfo.cusWeightUnitName=o.name,$scope.checkWeight(),$scope.$apply()}}).open()},$scope.selectAddress=function(e,r){1==r?$scope.oPlaceIndex=e:2==r?$scope.dPlaceIndex=e:3==r&&($scope.aPlaceIndex=e)};var setSubOrderLogistics=function(e,r,o){var s=function(r){0!=r.errorCode?comObj.showErrorMsg(r.msg):$scope.processList=ordersStatusDataHandle.setStatus(r.data,e)};confirmOrderService.getOrderStatus("",s);var t={seatParams:{waybillNo:o}},s=function(e){0!=e.errorCode?comObj.showErrorMsg(e.msg):($scope.orderInfo={packageNum:ordersStatusDataHandle.countObjLength(e.data),orderLogistics:ordersStatusDataHandle.setTransInfo(e.data)},console.log($scope.orderDetail),console.log($scope.orderInfo))};confirmOrderService.getOrderInfoByorderNo(t,s)},addressFilter=function(e){$scope.oPlaceList.map(function(r,o){r.isNotAccess=!e[r.id],r.isDefault&&r.isNotAccess&&$scope.oPlaceIndex==o&&($scope.oPlaceIndex=-1)}),$scope.dPlaceList.map(function(r,o){r.isNotAccess=!e[r.id],r.isDefault&&r.isNotAccess&&$scope.dPlaceIndex==o&&($scope.dPlaceIndex=-1)}),$scope.aPlaceList.map(function(r,o){r.isNotAccess=!e[r.id],r.isDefault&&r.isNotAccess&&$scope.aPlaceIndex==o&&($scope.aPlaceIndex=-1)})};$scope.isAddressAccessForCurrentProduce=function(){var e=$scope.orderBaseInfo.productUid,r=$scope.orderBaseInfo.customerId;if(e&&r){if($scope.resourceTree.addRootMap&&$scope.resourceTree.addRootMap[e+"$$"+r])return void addressFilter($scope.resourceTree.addRootMap[e+"$$"+r]);var o={seatParams:{uid:e,customerId:r,transportType:$scope.productGroupRootId}},s=function(o){0==o.errorCode?($scope.resourceTree.addRootMap||($scope.resourceTree.addRootMap={}),$scope.resourceTree.addRootMap[e+"$$"+r]=o.data,addressFilter(o.data)):comObj.showErrorMsg(o.msg)};confirmOrderService.isAddressAccessForCurrentProduce(o,s)}},$scope.checkWeight=function(){if($scope.orderBaseInfo.cusWeight){if(!$scope.orderBaseInfo.cusWeight)return;if(0==$scope.orderBaseInfo.cusWeight||!$scope.orderBaseInfo.cusWeight.indexOf(".")||($scope.orderBaseInfo.cusWeight+"").split(".").length>2)return $scope.ConformOrderForm.cusWeight.invalidNum=Lang.getValByKey("confirmOrder","confirmOrder_model_invalidNum"),void $("#cusWeight").addClass("error");$scope.ConformOrderForm.cusWeight.invalidNum="",$("#cusWeight").removeClass("error")}if($scope.orderBaseInfo.productUid&&$scope.orderBaseInfo.cusWeight&&$scope.orderBaseInfo.cusWeightUnit){var e={urlParams:{weight:$scope.orderBaseInfo.cusWeight,weightUnitCode:$scope.orderBaseInfo.cusWeightUnit},seatParams:{uid:$scope.orderBaseInfo.productUid}},r=function(e){if(0==e.errorCode){e.data?($("input[name='cusWeight']").removeClass("error"),$("input[name='cusWeightUnit']").removeClass("error"),$scope.ConformOrderForm.cusWeight.errorTips=""):($("input[name='cusWeight']").addClass("error"),$("input[name='cusWeightUnit']").addClass("error"),$scope.ConformOrderForm.cusWeight.errorTips=e.msg)}else comObj.showErrorMsg(e.msg)};confirmOrderService.isWeightInRange(e,r)}},$scope.baseInfoCheck=function(){
for(var e=!1,r=["customerName","externalNo","productName","cargoTypeName","packageNum","cusWeight","cusWeightUnit"],o=0,s=r.length;o<s;o++)$scope.orderBaseInfo[r[o]]&&!$("#"+r[o]).hasClass("error")||($scope.ConformOrderForm[r[o]].$setDirty(),e=!0);return e},$scope.addressCheck=function(){var e=$scope.oPlaceList[$scope.oPlaceIndex],r=$scope.dPlaceList[$scope.dPlaceIndex],o=$scope.aPlaceList[$scope.aPlaceIndex];return e||$scope.orderDetail?r||$scope.orderDetail?!(!$scope.productReceived||o||$scope.orderDetail)&&($(".cm-main").scrollTop($(".cm-main").offset().top-$("#acceptAddress").offset().top),comObj.showErrorMsg("揽收地地址不能为空"),!0):($(".cm-main").scrollTop($(".cm-main").offset().top-$("#toAddress").offset().top),comObj.showErrorMsg("目的地地址不能为空"),!0):($(".cm-main").scrollTop($(".cm-main").offset().top-$("#fromAddress").offset().top),comObj.showErrorMsg("始发地址不能为空"),!0)},$scope.goodsCheck=function(){if($scope.submited){var testRule=[{reg:"/^[\\u4E00-\\u9FA5_\\w_\\-]{1,30}$/",tips:Lang.getValByKey("common","common_validate_name")},{reg:"/^([\\w_\\-]+)+$/",tips:Lang.getValByKey("common","common_validate_code")},{reg:"/^[0-9]{1}[0-9.]{0,14}$/",tips:Lang.getValByKey("common","common_validate_number")},{reg:"/^\\d{1,9}$/",tips:Lang.getValByKey("common","common_validate_number")},{reg:"/^[\\u4E00-\\u9FA5A-Za-z0-9]{1,30}$/",tips:""},{reg:"/^-?\\d+(\\.\\d{1,3})?$/",tips:Lang.getValByKey("confirmOrder","confirmOrder_validation_price")},{reg:"/^[\\u4E00-\\u9FA5_\\w_\\-]{1,30}$/",tips:Lang.getValByKey("common","common_validate_name")}];$scope.selectGoods=[];for(var selectId=[],flag=!1,s=0,len1=$scope.goodsList.length;s<len1;s++)for(k in $scope.goodsList[s])if($scope.goodsList[s][k]&&"id"!=k){selectId.push(s),$scope.selectGoods.push($scope.goodsList[s]);break}var oInput=$(".goodsItem");oInput.removeClass("error"),$scope.goodsListRule="";for(var s=0;s<selectId.length;s++)for(var k=0;k<7;k++)eval(testRule[k].reg).test(oInput[7*selectId[s]+k].value)||(oInput[7*selectId[s]+k].value&&($scope.goodsListRule=$scope.goodsListRule?$scope.goodsListRule:testRule[k].tips),$(oInput[7*s+k]).addClass("error"),flag=!0);return flag}},$scope.submitOrder=function(e){if($scope.existExternalNo)return void $(".cm-main").scrollTop($(".errors").eq(0).offset().top-30);$route.current.params.orderStatus=e;if($scope.submited=!0,$scope.baseInfoCheck())return void scrollToErrorView($(".cm-main"));if(!$scope.addressCheck()||$scope.orderDetail){if(void 0!=$scope.oPlaceIndex&&-1!=$scope.oPlaceIndex)var r=$scope.oPlaceList[$scope.oPlaceIndex];else var r={countryCode:$scope.orderDetail.fromAddress.countryCode,countryName:$scope.orderDetail.fromAddress.countryName,provinceId:$scope.orderDetail.fromAddress.provinceId,provinceName:$scope.orderDetail.fromAddress.provinceName,cityId:$scope.orderDetail.fromAddress.cityId,cityName:$scope.orderDetail.fromAddress.cityName,districtId:$scope.orderDetail.fromAddress.districtId,districtName:$scope.orderDetail.fromAddress.districtName,streetId:$scope.orderDetail.fromAddress.streetId,streetName:$scope.orderDetail.fromAddress.streetName,address:$scope.orderDetail.fromAddress.address,id:$scope.orderDetail.fromAddress.id,name:$scope.orderDetail.fromName,phone:$scope.orderDetail.fromPhone,telPhone:$scope.orderDetail.fromTelephone,postcode:$scope.orderDetail.fromAddress.postcode,email:$scope.orderDetail.fromAddress.email,type:1,transportName:$scope.orderDetail.fromAddress.transportName,transportType:$scope.orderDetail.fromAddress.transportType,transportId:$scope.orderDetail.fromAddress.transportId};if(void 0!=$scope.dPlaceIndex&&-1!=$scope.dPlaceIndex)var o=$scope.dPlaceList[$scope.dPlaceIndex];else var o={countryCode:$scope.orderDetail.toAddress.countryCode,countryName:$scope.orderDetail.toAddress.countryName,provinceId:$scope.orderDetail.toAddress.provinceId,provinceName:$scope.orderDetail.toAddress.provinceName,cityId:$scope.orderDetail.toAddress.cityId,cityName:$scope.orderDetail.toAddress.cityName,districtId:$scope.orderDetail.toAddress.districtId,districtName:$scope.orderDetail.toAddress.districtName,streetId:$scope.orderDetail.toAddress.streetId,streetName:$scope.orderDetail.toAddress.streetName,address:$scope.orderDetail.toAddress.address,id:$scope.orderDetail.toAddress.id,name:$scope.orderDetail.toName,phone:$scope.orderDetail.toPhone,telPhone:$scope.orderDetail.toTelephone,postcode:$scope.orderDetail.toAddress.postcode,email:$scope.orderDetail.toAddress.email,type:2,transportName:$scope.orderDetail.toAddress.transportName,transportType:$scope.orderDetail.toAddress.transportType,transportId:$scope.orderDetail.toAddress.transportId};if(void 0!=$scope.aPlaceIndex&&-1!=$scope.aPlaceIndex&&$scope.productReceived)var s=$scope.aPlaceList[$scope.aPlaceIndex];else if($scope.orderDetail&&$scope.orderDetail.fetchAddress)var s={countryCode:$scope.orderDetail.fetchAddress.countryCode,countryName:$scope.orderDetail.fetchAddress.countryName,provinceId:$scope.orderDetail.fetchAddress.provinceId,provinceName:$scope.orderDetail.fetchAddress.provinceName,cityId:$scope.orderDetail.fetchAddress.cityId,cityName:$scope.orderDetail.fetchAddress.cityName,districtId:$scope.orderDetail.fetchAddress.districtId,districtName:$scope.orderDetail.fetchAddress.districtName,streetId:$scope.orderDetail.fetchAddress.streetId,streetName:$scope.orderDetail.fetchAddress.streetName,address:$scope.orderDetail.fetchAddress.address,id:$scope.orderDetail.fetchAddress.id,name:$scope.orderDetail.fetchName,phone:$scope.orderDetail.fetchPhone,telPhone:$scope.orderDetail.fetchTelephone,postcode:$scope.orderDetail.fetchAddress.postcode,email:$scope.orderDetail.fetchAddress.email,type:3,transportName:$scope.orderDetail.fetchAddress.transportName,transportType:$scope.orderDetail.fetchAddress.transportType,transportId:$scope.orderDetail.fetchAddress.transportId};else s={};if(!$scope.goodsList.length)return void comObj.showErrorMsg("请添加物品明细");if($scope.goodsCheck())return void comObj.showErrorMsg("物品明细校验失败");if(!$scope.selectGoods.length)return void comObj.showErrorMsg("请添加物品明细");var t="",c="";"COMMITED"==e?(c="DRAFT"==$scope.orderStatus?"COMMITED":$scope.orderStatus,t=$scope.orderNo&&"DRAFT"!=$scope.orderStatus?Lang.getValByKey("confirmOrder","confirmOrder_pormpt_updateOrder"):Lang.getValByKey("confirmOrder","confirmOrder_pormpt_saveOrder")):(c="DRAFT",t=$scope.orderNo?Lang.getValByKey("confirmOrder","confirmOrder_pormpt_updateDraft"):Lang.getValByKey("confirmOrder","confirmOrder_pormpt_saveDraft"));var d=$scope.serviceList.filter(function(e){return e.isChecked}),a={title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:t},manualClose:!1,time:1e3,isDelay:!1,cancelEvent:function(){$(document).promptBox("closePrompt")},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),operationEvent:function(){var e={id:"",orderNo:$scope.orderNo||"",createUserName:$scope.orderDetail?$scope.orderDetail.createUserName:"",createFullName:$scope.orderDetail?$scope.orderDetail.createFullName:"",cusUserId:$scope.orderBaseInfo.customerId,cusUserName:$scope.orderBaseInfo.customerName,cargoType:$scope.orderBaseInfo.cargoTypeId,customerId:$scope.orderBaseInfo.cusUserId||$scope.orderDetail.customerId,cargoTypeName:$scope.orderBaseInfo.cargoTypeName,productUid:$scope.orderBaseInfo.productUid,productName:$scope.orderBaseInfo.productName,orderStatus:c,cusWeight:$scope.orderBaseInfo.cusWeight,cusWeightUnit:$scope.orderBaseInfo.cusWeightUnit,cusWeightUnitName:$scope.orderBaseInfo.cusWeightUnitName,packageNum:$scope.orderBaseInfo.packageNum,fromName:r.name,fromPhone:r.phone,fromTelephone:r.telPhone,toName:o.name,toPhone:o.phone,toTelephone:o.telPhone,externalNo:$scope.orderBaseInfo.externalNo,customerNote:$scope.orderCustomerMsg.msg,orderCargoDtos:$scope.selectGoods,ordSubOrderDtos:$scope.ordSubOrderDtos,orderAdditionalDtos:d,fromAddress:r,toAddress:o,fileDtos:$scope.result};$scope.productReceived&&(e.fetchAddress=s,e.fetchName=s.name,e.fetchPhone=s.phone,e.fetchTelephone=s.telPhone);var t=function(e){$(document).promptBox("closePrompt"),0!=e.errorCode?comObj.showErrorMsg(e.msg):($(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success",time:3e3}),setTimeout(function(){$scope.goBack(!0)},1e3))};if($scope.orderNo){var a={urlParams:e,seatParams:{orderNo:$scope.orderNo}};confirmOrderService.updateOrder(a,t)}else{var a={urlParams:e};confirmOrderService.submitOrder(a,t)}}}]};$(document).promptBox(a)}},confirmOrderView.bindEvent(),$scope.switchStatus=function(e,r){confirmOrderView.switchStatus($scope,e,r)};var flag=window.location.href.indexOf("?")>-1;flag&&($scope.orderNo=easySpa.queryUrlValByKey("orderNum")),flag&&$scope.orderNo?getOrderInfoByOrderId($scope.orderNo):($scope.couldEdit=!0,$scope.orderStatus="DRAFT"),$scope.resetInput=function(e){var r=e.target.value;e.target.value=r.toUpperCase(),$scope.currentAddress.postcode=r.toUpperCase()},$scope.toggleList=function(e){confirmOrderView.toggleList($scope,e)},$scope.remainWord=function(e){confirmOrderView.remainWord($scope)},$scope.edit=function(){$scope.couldEdit=!0,$scope.confirmOrderAddFile(!1,"#confirmOrderFileContent"),setSelectBoxList()},$scope.cancelEdit=function(){$scope.couldEdit=!1,$scope.oPlaceIndex=-1,$scope.dPlaceIndex=-1,$scope.aPlaceIndex=-1,$(".cm-main").scrollTop(0),getOrderInfoByOrderId($scope.orderNo)},$scope.jumpTo=function(e,r,o){var s=$route.current.params.id||"",t=$route.current.params.isJustShow||!1,c=$scope.from||"",d={1:"customer?id={id}",2:"product?module=new&id={id}&uid={uid}&orderNo={$orderNo}&workId={workId}&isJustShow={isJustShow}&origin={origin}",3:"workOrderDetail?orderNo={$orderNo}&waybillNo={$waybillNo}"};top.location.href="http://"+location.host+"/#/"+d[e].replace("{id}",r).replace("{workId}",s).replace("{isJustShow}",t).replace("{origin}",c).replace("{uid}",o).replace("{$orderNo}",$scope.orderNo).replace("{$waybillNo}",$scope.orderDetail.waybillNo)+"&isEdit=false"},$scope.noCustomerName=!0,$scope.existExternalNo=!1,$scope.$watch("orderBaseInfo.customerName",function(e){e&&($scope.noCustomerName=!1)}),$scope.checkExternalNo=function(e){var r=$scope.orderDetail?$scope.orderDetail.id:0,o={urlParams:{},seatParams:{cusUserId:$scope.orderBaseInfo.customerId,externalNo:e,id:r}};e&&confirmOrderService.checkExternalNo(o,function(e){e.data?$scope.existExternalNo=!0:$scope.existExternalNo=!1})};var airSeaEle;$scope.getAirSeaListData=function(e,r){var o=1==$scope.isOriginAddress?"s":2==$scope.isOriginAddress?"e":"l",s={urlParams:{q:e||"",type:o,id:$scope.orderBaseInfo.productId,countryCode:$scope.currentAddress.countryCode,pageIndex:r||1,pageSize:10}},t=confirmOrderService.getAirSeaData(s);return angular.forEach(t.data,function(e,r){$scope.productGroupRootId==$scope.seaId?e.name+="("+e.enName+")":$scope.productGroupRootId==$scope.airId&&(e.name+="("+e.code+")")}),t},$scope.getAirSeaList=function(){if($scope.productGroupRootId==$scope.seaId)var e="请输入港口名称";else if($scope.productGroupRootId==$scope.airId)var e="请输入名称或三字码";airSeaEle=selectFactory({data:[],isSearch:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-air-sea",showTextField:"name",searchPlaceHoder:e,isSaveInputVal:!0,closeLocalSearch:!0,pagination:!0,attrTextField:{"ng-value":"id"},onSearchValueChange:function(e,r,o){$scope.airSeaData=$scope.getAirSeaListData(r,o),e.setData($scope.airSeaData)},attrTextId:function(e){$scope.airSeaValue=e,$scope.$apply()},attrTextModel:function(e,r,o){$scope.airSea=e,$scope.addressDetail=o.address,$scope.$apply()}}),airSeaEle.open()},$scope.changeProductReceived=function(){$scope.productReceivedData.productReceive||($scope.productReceived=!1,angular.forEach($scope.serviceList,function(e){if(e.isChecked&&"ST001"==e.serviceTypeCode)return void($scope.productReceived=!0)}))},$scope.confirmOrderAddFile=function(e,r){var o={system:"operation",edit:e,btnHandle:!1,orderStatus:$scope.orderStatus||"DRAFT",append:r,orderNo:$scope.orderNo||"",orderFileType:{url:"/api/v1/order/files/fileTypes",type:"GET"},getOrderFile:{url:"/api/v1/order/files",type:"GET",param:{pageIndex:1,pageSize:20,orderNo:$scope.orderNo||""}},delOrderFile:{url:"",type:"POST",param:{orderNo:$scope.orderNo||"",orderFileId:""}},addOrderFile:{url:"/api/v1/order/files/"+$scope.orderNo+"/orderFiles",type:"POST",param:{orderNo:$scope.orderNo||"",orderFileId:""}},ckeckFileName:{url:"/api/v1/order/files/files/name/check",type:"GET",param:{orderNo:$scope.orderNo||"",orderFileId:""}}};$scope.result=$(document).uploadBox(o)},$scope.couldEdit&&!$scope.orderNo?$scope.confirmOrderAddFile(!0,"#confirmOrderFileContent"):$scope.couldEdit&&$scope.orderNo?$scope.confirmOrderAddFile(!1,"#confirmOrderFileContent"):$scope.confirmOrderAddFile(!1,"#confirmOrderFileContentInfo"),$scope.changePhone=function(){$.trim($("#mobile-phone").val())||$.trim($("#tel-phone").val())?$("#mobile-phone").removeClass("ng-invalid ng-dirty"):$("#mobile-phone").addClass("ng-invalid ng-dirty")}}])});