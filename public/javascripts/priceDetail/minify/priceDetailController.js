easySpa.require(["widget/tab","widget/parseUrl","widget/select","widget/searchBox","widget/prompt","widget/htable","widget/tootips","public/common/tableController.js","public/common/areaController.js","public/common/areaService.js","public/common/calander.js","public/javascripts/priceDetail/20161224/priceDetailRoute.js"],function(){app.controller("priceDetailCtrl",["$scope","priceDetailService","service","areaService","tableService","priceDetailView",function(e,t,i,a,n,r){function c(e){return e.forEach(function(e){e.name+="("+e.code+")"}),e}function o(){angular.forEach(e.tableModel.tableBody,function(t,i){if(t.areas&&t.areas.length){e.tableModel.tableBody[i].type=Lang.getValByKey("priceDetail","priceDetail_code_regionAndCountry"),e.tableModel.tableBody[i].typeValue="";for(var a=0,n=t.areas.length;a<n;a++)e.tableModel.tableBody[i].typeValue?e.tableModel.tableBody[i].typeValue+="，"+g(t.areas[a].name):e.tableModel.tableBody[i].typeValue+=g(t.areas[a].name)}else if(t.postcodes&&t.postcodes.length){e.tableModel.tableBody[i].type=Lang.getValByKey("priceDetail","priceDetail_code_postCode"),e.tableModel.tableBody[i].typeValue="";for(var a=0,n=t.postcodes.length;a<n;a++)e.tableModel.tableBody[i].typeValue?e.tableModel.tableBody[i].typeValue+="，"+t.postcodes[a].startPostcode+"-"+t.postcodes[a].endPostcode:e.tableModel.tableBody[i].typeValue+=t.postcodes[a].startPostcode+"-"+t.postcodes[a].endPostcode}})}function l(t){e.priceForm.$setPristine(),e.priceForm.$setUntouched(),e.weightName="",e.regionName="",e.priceMethodModel="",e.priceMethodValue="",e.priceValue="",e.priceBaseUnit="",e.priceUnit="",e.priceUnitValue="",e.ePriceValue=!0,e.$apply(),e.weightName=t.latitude,e.regionName=t.longitude,e.priceMethodModel=t.calcName,e.priceMethodValue=t.calcType,e.priceValue=-1==t.price?"":t.price,e.priceBaseUnit=t.baseValue,e.priceUnit=t.baseUnitName,e.priceUnitValue=t.baseUnitCode,e.priceMethodValue==e.sumPriceMethod.code?e.ePriceTotal=!0:e.ePriceTotal=!1,e.$apply(),$(document).promptBox({title:Lang.getValByKey("priceDetail","priceDetail_code_editPrice"),isMiddle:!0,isNest:!0,content:{nest:$("#cellEdit")},loadData:function(){},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_save"),operationEvent:function(){e.ePriceValue?e.setCellData():e.setRowData(),e.$apply()}}]})}function s(t){e.priceForm.$setPristine(),e.priceForm.$setUntouched(),e.weightName="",e.regionName="",e.priceMethodModel="",e.priceMethodValue="",e.priceBaseUnit="",e.priceUnit="",e.priceUnitValue="",e.ePriceValue=!1,e.$apply(),e.weightName=t.latitude,e.regionName=t.longitude,e.priceMethodModel=t.calcName,e.priceMethodValue=t.calcType,e.priceBaseUnit=t.baseValue,e.priceUnit=t.baseUnitName,e.priceUnitValue=t.baseUnitCode,e.priceMethodValue==e.sumPriceMethod.code?e.ePriceTotal=!0:e.ePriceTotal=!1,e.$apply(),$(document).promptBox({title:Lang.getValByKey("priceDetail","priceDetail_code_editPrice"),isMiddle:!0,isNest:!0,content:{nest:$("#cellEdit")},loadData:function(){},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_save"),operationEvent:function(){e.ePriceValue?e.setCellData():e.setRowData(),e.$apply()}}]})}function p(t){0==t?(e.getInfo(e.uid),e.cancelPrice(),e.$apply()):1==t&&(e.currentServiceTypeIndex=0,e.isEditPrice&&(e.priceDetailForm.$setPristine(),e.priceDetailForm.$setUntouched()),"costPrice"!=e.module&&"costPriceApproval"!=e.module&&e.serviceTypeList.length>0&&(e.allPriceDetailList=[],e.isCreatPrice=!0,$.each(e.serviceTypeList,function(t,i){$.each(i.sets,function(t,i){if(e.allPriceDetailList.push(i),null!=i.id)return void(e.isCreatPrice=!1)})})),e.priceDetailList&&e.priceDetailList.length>0&&(e.priceDetail.id=e.priceDetailList[0]&&e.priceDetailList[0].id),e.getPriceTable(0,e.priceDetail.id),e.$apply())}function u(e,i){var a={seatParams:{quotationUid:e,serviceUid:i}};return t.getRegionByService(a).data}function d(e,t){for(var t=t.data,i=0,a=t.length;i<a;i++)if(t[i].id==e)return t[i]}function g(e){var t=e.lastIndexOf("/");return-1!=t&&(e=e.slice(t+1)),e}e.viewButton={submit:!1,audit:!1,enable:!1,isCopy:!1,isShowCancelBtn:!1,isSalesPrice:!1,isSaveInfoPrompt:!1},e.htable=null,e.jumpTime=1e3,e.copyPriceDetailList=[],r.initCalander(),e.priceTypeData={data:[{name:Lang.getValByKey("priceDetail","priceDetail_code_gradePrice"),id:1},{name:Lang.getValByKey("priceDetail","priceDetail_code_agreementPrice"),id:2}]},e.priceLevelData={data:[{name:Lang.getValByKey("priceDetail","priceDetail_code_level1"),id:"1"},{name:Lang.getValByKey("priceDetail","priceDetail_code_level2"),id:"2"},{name:Lang.getValByKey("priceDetail","priceDetail_code_level3"),id:"3"},{name:Lang.getValByKey("priceDetail","priceDetail_code_level4"),id:"4"},{name:Lang.getValByKey("priceDetail","priceDetail_code_level5"),id:"5"}]},e.defatutPriceMethod={name:Lang.getValByKey("priceDetail","priceDetail_code_unitPrice"),code:"PCT_PRICE"},e.sumPriceMethod={code:"PCT_SUM"},e.priceDetail={},e.priceDetailList=[],e.getProduct=function(){e.contentList=t.getProductAllData({urlParams:{isHot:!0}}),e.navItem=t.getProductNavItem();new SearchBox.init({inputId:"select-product",searchData:[],defaultText:"请选择",tip:"请输入名称或编码",navItem:e.navItem.data,tabIndex:"热门",contentList:c(e.contentList.data),toggleTab:function(e,i){this.tabIndex=i;var a={urlParams:{isHot:!1,pageIndex:e||1,pageSize:10,capital:i}};"热门"==i&&(a.urlParams.isHot=!0,a.urlParams.capital=""),"其他"==i&&(a.urlParams.isHot=!1,a.urlParams.capital="_");var n=t.getProductAllData(a);return{data:c(n.data),pagination:n.pagination}},onSearchValueChange:function(e,i){var a={urlParams:{q:e,isHot:!1,pageIndex:i||1,pageSize:10,capital:""}},n=t.getProductAllData(a);return{data:c(n.data),pagination:n.pagination}},attrTextModel:function(t,i){t!=e.iInputProduct&&(e.copyPriceDetailList=[]),e.iInputProductValue=i.uid||"",e.iInputProduct=t||"",e.$apply()}})},e.init=function(){e.tabBox=$("#m-tabs").tab({callback:p}),e.parameter=window.parseUrl.getParams(),e.module=e.parameter.module,e.currentServiceTypeIndex=0,e.currentDetailIndex=0,e.parameter.uid?(e.uid=e.parameter.uid,e.isEdit=!1):(e.isEdit=!0,e.uid=0,e.tabBox.exdisable(0),"costPrice"==e.module&&(t.getAccountDetail({seatParams:{id:1}},function(t){0===t.errorCode&&(e.iInputAccount=t.data.name+"("+t.data.code+")",e.iInputAccountValue=1)}),t.getCurrencyByCode({seatParams:{code:"CNY"}},function(t){0===t.errorCode&&(e.iInputCurrency=t.data.name+"(CNY)",e.iInputCurrencyValue="CNY")}))),setTimeout(function(){try{e.getProduct(),e.$apply()}catch(e){}},10)},e.init(),e.getInfo=function(){e.viewButton.isSalesPrice?t.getSalesPriceInfo({seatParams:{uid:e.uid}},function(t){0===t.errorCode&&(e.setInfo(t.data),!1===t.data.isOnline&&("salesPrice"==e.parameter.module?e.isOffline=!1:e.isOffline=!0))}):t.getCostPriceInfo({seatParams:{uid:e.uid}},function(t){0===t.errorCode&&(e.setInfo(t.data),!1===t.data.isOnline&&("costPrice"==e.parameter.module?e.isOffline=!1:e.isOffline=!0))})},e.jumpTo=function(){location.href="#/product?module=new&id="+e.productId+"&uid="+e.productUid,sessionStorage.setItem("backPricePath",e.uid);var t=e.parameter.type||"";sessionStorage.setItem("backPriceType",t),sessionStorage.setItem("backPriceModule",e.parameter.module)},e.setInfo=function(i){e.baseInfo=i,e.freightItems=[],e.freightWeightSettings=[],e.title=i.name,e.productId=i.productid,e.productUid=i.productUid,e.uid=i.uid,e.iCode=i.code,e.status=i.status,e.isOnline=i.isOnline,e.creatorUserName=i.creatorUserName,e.createTime=i.createTime,e.iPriceName=e.iInputPriceName=i.name,e.iServices=e.iInputServices=i.serviceName,e.iInputServicesValue=i.bizUid,e.iProduct=e.iInputProduct=i.productName,e.iInputProductValue=i.bizUid;var a=d(i.gradeType,e.priceTypeData);if(e.iPriceType=e.iInputPriceType=a.name,e.iInputPriceTypeValue=a.id,1==i.gradeType){var n=d(i.grade,e.priceLevelData);e.iPriceLevel=e.iInputPriceLevel=n.name,e.iInputPriceLevelValue=n.id}else 2==i.gradeType&&(e.iClient=e.iInputClient=i.customerName,e.iInputClientValue=i.customerId);e.iGoodsType=e.iInputGoodsType=i.cargoTypeName,e.iInputGoodsTypeValue=i.cargoTypeCode,e.iCurrency=i.currencyName,e.iInputCurrency=i.currencyName+"("+i.currencyCode+")",e.iInputCurrencyValue=e.cacheCurrencyCode=i.currencyCode;var r="";if(angular.forEach(i.areas,function(e,t){r+="，"+e.name.split("/")[e.name.split("/").length-1]}),r&&(r=r.slice(1)),e.iDeparture=e.iInputDeparture=r,e.areasData=i.areas,e.iAccount=i.settlementTypeName,e.iInputAccount=i.settlementTypeName?i.settlementTypeName+"("+i.settlementTypeCode+")":"",e.iInputAccountValue=i.settlementTypeId,e.iBeginTime=e.iInputBeginTime=i.startEffectTime,e.iEndTime=e.iInputEndTime=i.endEffectTime,e.iWeight=e.iInputWeight=i.weightName,e.iInputWeightValue=e.cacheWeightUid=i.weightSchemaUid,e.iRegion=e.iInputRegion=i.regionName,e.iInputRegionValue=e.cacheRegionUid=i.regionSchemaUid,e.iRemark=e.iInputRemark=i.description,e.saveReturnCostRegionValue=i.regionSchemaUid,e.saveReturnCostWeightnValue=i.weightSchemaUid,i.costSets.length>0?e.priceDetailList=i.costSets||[]:(e.serviceTypeList=i.saleSets||[],e.serviceTypeList.length>0?e.priceDetailList=e.serviceTypeList[0].sets:e.priceDetailList=[]),"costPrice"!=e.module&&"costPriceApproval"!=e.module&&e.serviceTypeList.length>0&&(e.allPriceDetailList=[],$.each(e.serviceTypeList,function(t,i){$.each(i.sets,function(t,i){e.allPriceDetailList.push(i)})})),e.viewButton.isSalesPrice&&(!e.viewButton.isCopy||!e.copyPriceDetailList.length||"costPrice"==e.module||"costPriceApproval"==e.module)){t.getSalesDetailsByUid({seatParams:{uid:e.uid}},function(t){e.allPrices=t.data||[]}),e.savePriceDetailCache=[];var c=[];$.extend(!0,c,i.saleSets);for(var o=0,l=c.length;o<l;o++){e.savePriceDetailCache.push([]);for(var s=0,p=c[o].sets.length;s<p;s++){for(var u=0,g=e.allPrices.length;u<g;u++)if(c[o].sets[s].id==e.allPrices[u].id){$.extend(!0,c[o].sets[s],e.allPrices[u]);break}c[o].sets[s].freightItems||(c[o].sets[s].freightItems=[]),c[o].sets[s].freightWeightSettings||(c[o].sets[s].freightWeightSettings=[]),e.savePriceDetailCache[o].push(c[o].sets[s])}}for(var o=0,l=e.savePriceDetailCache.length;o<l;o++)for(var s=0,p=e.savePriceDetailCache[o].length;s<p;s++)e.savePriceDetailCache[o][s].id&&(e.currentServiceTypeIndex=o,e.currentDetailIndex=s,e.getPriceTable(s,e.savePriceDetailCache[o][s].id))}},e.editInfo=function(){e.infoForm.$setPristine(),e.infoForm.$setUntouched(),e.viewButton.submitDisabled=!0,e.viewButton.isSaveInfoPrompt=!1,e.isEdit=!0,e.tabBox.exdisable(0)},e.cancelInfo=function(){e.tabBox.enableAll(),e.isEdit=!1,e.viewButton.submitDisabled=!1,e.getInfo()},e.cancelPrice=function(){if(e.isEditPrice=!1,e.viewButton.submitDisabled=!1,e.getInfo(),e.viewButton.isSalesPrice)e.currentServiceTypeIndex=0,e.currentDetailIndex=0,e.getPriceTable(e.currentDetailIndex);else{e.copyPriceDetailList=[];var t=e.priceDetailList&&e.priceDetailList.length?e.priceDetailList[0].id:"",i=!!t;e.getPriceTable(0,t,i)}},e.saveInfo=function(t){for(var i=["iInputPriceName","iInputGoodsType","iInputCurrency","iInputBeginTime","iInputEndTime","iInputWeight","iInputRegion"],a=0,n=i.length;a<n;a++)$.trim(e[i[a]])||e.infoForm[i[a]].$setDirty();if(e.viewButton.isSalesPrice?(e.type=2,e.iInputProduct||e.infoForm.iInputProduct.$setDirty(),e.iInputPriceType||e.infoForm.iInputPriceType.$setDirty(),1!=e.iInputPriceTypeValue||e.iInputPriceLevel?2!=e.iInputPriceTypeValue||e.iInputClient||e.infoForm.iInputClient.$setDirty():e.infoForm.iInputPriceLevel.$setDirty()):(e.type=1,e.iInputServices||e.infoForm.iInputServices.$setDirty()),!e.infoForm.$valid)return void scrollToErrorView($(".tab-content"));e.viewButton.isSaveInfoPrompt?$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:"修改重量段或分区内容，价格值将会被清空，确定继续？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),operationEvent:function(){$(document).promptBox("closePrompt"),e.saveInfoAction(t),e.$apply()}}]}):e.saveInfoAction(t)},e.saveInfoAction=function(i){var a={urlParams:{feeTypeId:e.iInputCostValue,name:e.iInputPriceName,startEffectTime:e.iInputBeginTime,endEffectTime:e.iInputEndTime,regionSchemaUid:e.iInputRegionValue,weightSchemaUid:e.iInputWeightValue,settlementTypeId:e.iInputAccountValue,cargoTypeCode:e.iInputGoodsTypeValue,currencyCode:e.iInputCurrencyValue,areas:e.areasData,description:e.iInputRemark}};if(e.viewButton.isSalesPrice?(a.urlParams.type=2,a.urlParams.bizUid=e.iInputProductValue,a.urlParams.gradeType=e.iInputPriceTypeValue,a.urlParams.grade=e.iInputPriceLevelValue,a.urlParams.customerId=e.iInputClientValue):(a.urlParams.type=1,a.urlParams.bizUid=e.iInputServicesValue),e.uid)if(a.seatParams={uid:e.uid},e.viewButton.isSalesPrice){var n=e.isOffline?"saveAuditSalesInfo":"saveSalesEditInfo";t[n](a,function(t){0===t.errorCode?(e.saveInfoCallback(t.data,i),i||$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}else{var r=e.isOffline?"saveAuditCostInfo":"saveCostEditInfo";t[r](a,function(t){0===t.errorCode?(e.saveInfoCallback(t.data,i),i||$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}else e.viewButton.isSalesPrice?t.saveSalesAddInfo(a,function(t){0===t.errorCode?e.saveInfoCallback(t.data,i,!0):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})}):t.saveCostAddInfo(a,function(t){0===t.errorCode?e.saveInfoCallback(t.data,i,!0):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},e.saveInfoCallback=function(t,i,a){"costPrice"==e.module&&(e.saveReturnCostRegionValue=t.regionSchemaUid,e.saveReturnCostWeightnValue=t.weightSchemaUid,e.saveReturnCostRegion=t.regionName,e.saveReturnCostWeightn=t.weightName),e.isCreatPrice=a,e.tabBox.enableAll(),e.viewButton.isCopy||(e.freightItems=[],e.freightWeightSettings=[]),e.iInputRegionValue=t.regionSchemaUid,e.iInputRegion=t.regionName,e.iInputWeightValue=t.weightSchemaUid,e.iInputWeight=t.weightName,e.uid=t.uid,e.iCode=t.code,e.isEdit=!1,e.creatorUserName=t.creatorUserName,e.createTime=t.createTime,e.viewButton.submitDisabled=!1,t.costSets.length>0?e.priceDetailList=t.costSets||[]:(e.serviceTypeList=t.saleSets||[],e.priceDetailList=e.serviceTypeList[0].sets||[]),e.currentServiceTypeIndex=0,e.currentDetailIndex=0,e.priceDetail=e.priceDetailList[0]||{},e.iCostType=e.iInputCostType=e.iInputCostTypeValue="",e.iCost=e.iInputCost=e.iInputCostValue="",e.viewButton.isShowCancelBtn=!0,e.getInfo(),e.viewButton.isCopy=!1,i&&(e.tabBox.selected(1),e.isEditPrice=!0,e.priceDetail.id=e.priceDetailList[0]&&e.priceDetailList[0].id,e.getPriceTable(0,e.priceDetail.id),e.priceDetailForm.$setPristine(),e.priceDetailForm.$setUntouched())},e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("common","common_thead_name"),Lang.getValByKey("common","common_code_code"),Lang.getValByKey("common","common_thead_type"),Lang.getValByKey("priceDetail","priceDetail_code_regionAndCountry"),Lang.getValByKey("common","common_page_remarks")],tableBody:[],restURL:"logistics.getRegionsByID",restData:{q:"",pageIndex:1,pageSize:10,schemaId:"",sort:"createTime"},selectNumber:0,selectFlag:!1},e.detail={},e.showDetails=function(i){e.mainInfo=!0,e.detail.isServices=e.detail.isRegions=e.detail.isWeights=!1;var a={seatParams:{uid:0}};if("services"==i){var n={module:e.parameter.module,q:e.parameter.q,uid:e.parameter.uid,type:e.parameter.type||""};window.location.href="#/services?priceData="+JSON.stringify(n)+"&uid="+e.iInputServicesValue+"&isfromprice=1"}else"regions"==i?(e.detail.isRegions=!0,a.seatParams.uid=e.iInputRegionValue,e.detail.title=Lang.getValByKey("priceDetail","priceDetail_code_regionDetail"),setTimeout(function(){e.getRegionTable(),e.$apply()},10)):"weights"==i&&(e.detail.isWeights=!0,a.seatParams.uid=e.iInputWeightValue,e.detail.title=Lang.getValByKey("priceDetail","priceDetail_code_weightDetail"),t.getWeightDetail(a,function(t){var i=t.data;e.detail.name=i.name,e.detail.code=i.code,e.detail.unit=i.unit,e.detail.weightSectionList=i.weightSectionList,e.detail.remark=i.remark,e.detail.createTime=i.createTime,e.detail.creator=i.creator}))},e.getRegionTable=function(){e.tableModel.restData.schemaId=e.iInputRegionValue;var t={urlParams:e.tableModel.restData};n.getTable(e.tableModel.restURL,t,function(i){if(0===i.errorCode){e.tableModel=n.table(e.tableModel,t,i),o();var a=r.height("table");setTimeout(function(){r.slimscroll(".table-container tbody",a),$(window).resize(function(){a=r.height("table"),r.slimscroll(".table-container tbody",a)})},10)}})},e.searchRegionTable=function(){e.tableModel.restData.pageIndex=1,e.q=e.tableModel.restData.q,e.getRegionTable()},e.$watch("tableModel",function(e,t){e!==t&&o()},!0),e.goBackToInfo=function(){e.mainInfo=!1},e.getRegionDetail=function(e){var i="",a=t.getRegionDetail(e.id).data;if(!a)return i;if(a.areas&&a.areas.length)for(var n=0,r=a.areas.length;n<r;n++)i+=i?"，"+g(a.areas[n].name):g(a.areas[n].name);else if(a.postcodes&&a.postcodes.length){for(var c="",n=0,r=a.postcodes.length;n<r;n++)c=c||a.postcodes[n].countryName,i+=i?"，"+a.postcodes[n].startPostcode+"-"+a.postcodes[n].endPostcode:a.postcodes[n].startPostcode+"-"+a.postcodes[n].endPostcode;i=c+"（"+i+"）"}return i},e.compare=function(){var e=$("#w-lock-table .table-content tbody tr");$("#w-lock-table .table-left tbody tr").each(function(t){var i=$(this).find(".u-price-edit").data();e.eq(t).find(".u-edit-input").each(function(){var e=$(this).data();i.calcType!=e.calcType?$(this).parent().addClass("u-edit-warn"):$(this).parent().removeClass("u-edit-warn")})})},e.getOnePriceDetails=function(i){var a={seatParams:{uid:e.uid,id:i}},n="";return e.viewButton.isSalesPrice?t.getOneSalesPriceDetail(a,function(e){0==e.errorCode&&(n=e.data)}):t.getOneCostPriceDetail(a,function(e){0==e.errorCode&&(n=e.data)}),n&&(e.iInputCostTypeValue=n.feeTypeIdx,e.iInputCostType=e.iCostType=n.feeTypeIdxName,e.iInputCostValue=n.feeTypeId,e.iInputCost=e.iCost=n.feeTypeName,"costPrice"!=e.module&&"costPriceApproval"!=e.module?(e.iDetailWeightValue=n.weightSchemaUid,e.iDetailWeight=n.weightSchemaUid+""!="-1"?n.weightName:"任意重量段",e.iDetailRegionValue=n.regionSchemaUid,e.iDetailRegion=n.regionSchemaUid+""!="-1"?n.regionName:"任意分区"):(e.iDetailWeightValue=e.saveReturnCostWeightnValue,e.iDetailRegionValue=e.saveReturnCostRegionValue),e.freightItems=n.freightItems,e.freightRegionSettings=n.freightRegionSettings,e.freightWeightSettings=n.freightWeightSettings,e.priceDetail.id=n.id,e.priceDetail.quotationId=n.quotationId,e.priceDetail.serviceUid=n.serviceUid,e.priceDetail.supplierId=n.supplierId),n},e.changeServiceType=function(t){if(e.currentServiceTypeIndex===t)return!1;e.currentServiceTypeIndex=t,e.currentDetailIndex=0,e.priceDetailList=e.serviceTypeList[t].sets||[],e.priceDetail=e.priceDetailList[0],e.iDetailRegionValue=e.priceDetail.regionSchemaUid,e.iDetailWeightValue=e.priceDetail.weightSchemaUid,e.getPriceTable(0,e.priceDetail.id)},e.getPriceTable=function(i,a,n){if(e.currentDetailIndex=i,e.freightItems=[],e.freightWeightSettings=[],e.priceDetailList.length>0&&(e.priceDetail=e.priceDetailList[i]||{}),e.viewButton.isSalesPrice&&e.savePriceDetailCache){var r=e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex];if(e.priceDetail={},e.priceDetail.id=r.id,e.priceDetail.quotationId=r.quotationId,e.priceDetail.serviceUid=r.serviceUid,e.priceDetail.supplierId=r.supplierId,e.iInputCostTypeValue=r.feeTypeIdx||"",e.iCostType=e.iInputCostType=r.feeTypeIdxName,e.iInputCostValue=r.feeTypeId,e.iCost=e.iInputCost=r.feeTypeName,e.iDetailRegion=r.regionName,e.iDetailRegionValue=r.regionSchemaUid,e.iDetailWeight=r.weightName,e.iDetailWeightValue=r.weightSchemaUid,!e.iDetailRegionValue||!e.iDetailWeightValue)var c=u(e.uid,e.priceDetail.serviceUid)||{};e.iDetailRegionValue||(c&&c.regionUid?(e.iDetailRegionValue=c.regionUid,e.iDetailRegion=c.regionName):(e.iDetailRegion=e.iInputRegion,e.iDetailRegionValue=e.iInputRegionValue),r.regionName=e.iDetailRegion,r.regionSchemaUid=e.iDetailRegionValue),e.iDetailWeightValue||(c&&c.weightUid?(e.iDetailWeightValue=c.weightUid,e.iDetailWeight=c.weightName):(e.iDetailWeight=e.iInputWeight,e.iDetailWeightValue=e.iInputWeightValue),r.weightName=e.iDetailWeight,r.weightSchemaUid=e.iDetailWeightValue),!e.iInputCostTypeValue&&c&&c.feeTypeIdx&&(r.feeTypeIdx=e.iInputCostTypeValue=c.feeTypeIdx||"",r.feeTypeIdxName=e.iCostType=e.iInputCostType=c.feeTypeIdxName),!e.iInputCostValue&&c&&c.feeTypeId&&(r.feeTypeId=e.iInputCostValue=c.feeTypeId,r.feeTypeName=e.iCost=e.iInputCost=c.feeTypeName),e.isEditPrice||r.id||(r.feeTypeIdx=e.iInputCostTypeValue="",r.feeTypeIdxName=e.iCostType=e.iInputCostType="",r.feeTypeId=e.iInputCostValue="",r.feeTypeName=e.iCost=e.iInputCost=""),$.extend(!0,e.freightWeightSettings,r.freightWeightSettings),$.extend(!0,e.freightItems,r.freightItems)}else if(a){var o=e.getOnePriceDetails(a);e.iDetailWeightValue=o.weightSchemaUid,e.iDetailRegionValue=o.regionSchemaUid}else{if(e.priceDetail.id=e.priceDetailList[i].id,e.priceDetail.quotationId=e.priceDetailList[i].quotationId,e.priceDetail.serviceUid=e.priceDetailList[i].serviceUid,e.priceDetail.supplierId=e.priceDetailList[i].supplierId,n||(e.iCostType=e.iInputCostType=e.iInputCostTypeValue="",e.iCost=e.iInputCost=e.iInputCostValue=""),e.viewButton.isSalesPrice){var c=u(e.uid,e.priceDetail.serviceUid)||{};c&&c.regionUid?(e.iDetailRegionValue=c.regionUid,e.iDetailRegion=c.regionName):(e.iDetailRegion=e.iInputRegion,e.iDetailRegionValue=e.iInputRegionValue),c&&c.weightUid?(e.iDetailWeightValue=c.weightUid,e.iDetailWeight=c.weightName):(e.iDetailWeight=e.iInputWeight,e.iDetailWeightValue=e.iInputWeightValue),c&&c.feeTypeId&&(e.iInputCostTypeValue=c.feeTypeIdx||"",e.iCostType=e.iInputCostType=c.feeTypeIdxName,e.iInputCostValue=c.feeTypeId,e.iCost=e.iInputCost=c.feeTypeName)}else e.iDetailRegionValue=e.saveReturnCostRegionValue,e.iDetailWeightValue=e.saveReturnCostWeightnValue,e.iDetailRegion=e.saveReturnCostRegion,e.iDetailWeight=e.saveReturnCostWeightn;if(e.copyPriceDetailList[e.currentServiceTypeIndex]){if(e.baseInfo.saleSets&&e.baseInfo.saleSets.length)var p=e.copyPriceDetailList[e.currentServiceTypeIndex][e.currentDetailIndex];else var p=e.copyPriceDetailList[i];angular.forEach(p.freightItems,function(t,i){e.freightItems[i]={},e.freightItems[i].baseUnitCode=t.baseUnitCode,e.freightItems[i].baseUnitName=t.baseUnitName,e.freightItems[i].baseValue=t.baseValue,e.freightItems[i].calcName=t.calcName,e.freightItems[i].calcType=t.calcType,e.freightItems[i].id=t.id,e.freightItems[i].idx=t.idx,e.freightItems[i].ordinal=t.ordinal,e.freightItems[i].price=t.price,e.freightItems[i].quotationId=t.quotationId,e.freightItems[i].quotationSetId=t.quotationSetId,e.freightItems[i].toRegionUid=t.toRegionUid}),e.iCostType=e.iInputCostType=p.feeTypeIdxName||"",e.iInputCostTypeValue=p.feeTypeIdx||"",e.iCost=e.iInputCost=p.feeTypeName||"",e.iInputCostValue=p.feeTypeId||"",e.iDetailWeight=p.weightName||c.weightName||e.iInputWeight,e.iDetailWeightValue=p.weightSchemaUid||c.weightUid||e.iInputWeightValue,e.iDetailRegion=p.regionName||c.regionName||e.iInputRegion,e.iDetailRegionValue=p.regionSchemaUid||c.regionUid||e.iInputRegionValue,angular.forEach(p.freightWeightSettings,function(t,i){var a={baseUnitCode:t.baseUnitCode,baseUnitName:t.baseUnitName,baseValue:t.baseValue,calcName:t.calcName,calcType:t.calcType,id:t.id,ordinal:t.ordinal,quotationId:t.quotationId,quotationSetId:t.quotationSetId};e.freightWeightSettings.push(a)})}}var d=e.iDetailWeightValue?e.iDetailWeightValue:"-1",g=e.iDetailRegionValue?e.iDetailRegionValue:"-1",m={seatParams:{regionSchemaUid:g,weightSchemaUid:d}},h=t.getWeightAndRegion(m).data;if(h){var y=h.weights,f=[];f=y?y&&y.weightSectionList:[{id:"",refId:"",startPoint:"0",endPoint:"任意"}];var D=h.regions,I=[];I=D?D&&D.regionlist:[{id:"",name:"任意",code:""}];for(var v=[[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("priceDetail","priceDetail_page_priceMethod"),Lang.getValByKey("priceDetail","priceDetail_code_weightOrRegion")]],P=0,T=f.length;P<T;P++){var C=[P+1,Lang.getValByKey("priceDetail","priceDetail_code_editPrice"),f[P].startPoint+"-"+f[P].endPoint];v.push(C)}for(var V=[],P=0;P<=T;P++){for(var C=[],b=0,S=I.length;b<S;b++)0==P?C.push(I[b].name):C.push("");V.push(C)}e.htable=$("#w-lock-table").htable({left:v,right:V},{}),$("#w-lock-table .table-top th").tootips({mouseoverfn:e.getRegionDetail}),$("#w-lock-table").find(".i-unit").html("("+h.weightUnit+")"),I&&$("#w-lock-table").find(".table-top").find("th").each(function(e){$(this).data(I[e])}),$("#w-lock-table").find(".u-price-edit").each(function(t){if(!e.freightWeightSettings[t]){var i={baseUnitCode:"kg",baseUnitName:Lang.getValByKey("priceDetail","priceDetail_code_unitKg"),baseValue:1,calcName:e.defatutPriceMethod.name,calcType:e.defatutPriceMethod.code};if(e.freightWeightSettings[t]=i,e.viewButton.isSalesPrice&&e.savePriceDetailCache){var a=e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex];a.freightWeightSettings=a.freightWeightSettings?a.freightWeightSettings:[],a.freightWeightSettings[t]=i}}$(this).data(e.freightWeightSettings[t]),$(this).text(e.freightWeightSettings[t].calcName);var n='<ul class="tootips-list">';n+="<li><span>"+Lang.getValByKey("priceDetail","priceDetail_page_priceMethod")+"：</span>"+e.freightWeightSettings[t].calcName+"</li>",e.freightWeightSettings[t].calcType!=e.sumPriceMethod.code&&(n+="<li><span>"+Lang.getValByKey("priceDetail","priceDetail_page_priceUnit")+"：</span>"+e.freightWeightSettings[t].baseValue+e.freightWeightSettings[t].baseUnitName+"</li>"),n+="</ul>",$(this).attr("data-tootips",n)});var x=$("#w-lock-table .table-top thead").find("th").length,B=0;$("#w-lock-table").find(".u-edit-input").each(function(t){var i={baseUnitCode:"kg",baseUnitName:Lang.getValByKey("priceDetail","priceDetail_code_unitKg"),baseValue:1,calcName:e.defatutPriceMethod.name,calcType:e.defatutPriceMethod.code,price:""},a=t+1-x*B;(t+1)%x==0&&++B,e.freightItems[t]&&e.freightItems[t].idx&&a==e.freightItems[t].idx||(e.freightItems[t]&&e.freightItems[t].idx!=a?(i.idx=a,e.freightItems.splice(t,0,i)):e.freightItems[t]||(i.idx=a,e.freightItems.splice(t,0,i))),e.freightItems[t]||(e.freightItems[t]=i),e.freightItems[t].price=-1==e.freightItems[t].price?"":e.freightItems[t].price,$(this).data(e.freightItems[t]),$(this).val(e.freightItems[t].price);var n='<ul class="tootips-list">';n+="<li><span>"+Lang.getValByKey("priceDetail","priceDetail_page_priceMethod")+"：</span>"+e.freightItems[t].calcName+"</li>",n+="<li><span>"+Lang.getValByKey("priceDetail","priceDetail_page_priceValue")+"：</span>"+e.freightItems[t].price+"</li>",e.freightItems[t].calcType!=e.sumPriceMethod.code&&(n+="<li><span>"+Lang.getValByKey("priceDetail","priceDetail_page_priceUnit")+"：</span>"+e.freightItems[t].baseValue+e.freightItems[t].baseUnitName+"</li>"),n+="</ul>",$(this).attr("data-tootips",n)}),e.viewButton.isSalesPrice&&e.savePriceDetailCache&&(e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex].freightItems=[],$.extend(!0,e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex].freightItems,e.freightItems)),e.compare(),e.isEditPrice?(e.htable.editCell(l,e.changeSavePriceDetailCacheVal),e.htable.editRow(s)):$("[data-tootips]").tootips()}},e.editPrice=function(){e.isEditPrice=!0,e.viewButton.submitDisabled=!0,e.htable.editCell(l,e.changeSavePriceDetailCacheVal),e.htable.editRow(s)},e.setCellData=function(){var t=e.priceMethodModel,i=e.priceMethodValue,a=e.priceValue,n=e.priceBaseUnit,r=e.priceUnit,c=e.priceUnitValue;if(t||e.priceForm.priceMethodModel.$setDirty(),a||e.priceForm.priceValue.$setDirty(),e.ePriceTotal||(n||e.priceForm.priceBaseUnit.$setDirty(),r||e.priceForm.priceUnit.$setDirty()),e.priceForm.$valid){var o=$("#w-lock-table").find(".u-edit-box.active"),l=o.parent("td").parent("tr").index();$("#w-lock-table .table-left tbody tr").eq(l).find(".u-price-edit").data().calcType==i?o.removeClass("u-edit-warn"):o.addClass("u-edit-warn"),o.removeClass("u-edit-error");var s={calcName:t,calcType:i,price:a,baseValue:n,baseUnitName:r,baseUnitCode:c};e.htable.setCellData(s,e.changeSavePriceDetailCacheVal),$(document).promptBox("closeFormPrompt")}},e.setRowData=function(){var t=e.priceMethodModel,i=e.priceMethodValue,a=e.priceBaseUnit,n=e.priceUnit,r=e.priceUnitValue;if(t||e.priceForm.priceMethodModel.$setDirty(),e.ePriceTotal||(a||e.priceForm.priceBaseUnit.$setDirty(),n||e.priceForm.priceUnit.$setDirty()),e.priceForm.$valid){var c=$("#w-lock-table").find(".u-price-edit.active"),o=c.parent("td").parent("tr").index();$("#w-lock-table .table-content tbody tr").eq(o).find(".u-edit-warn").each(function(){$(this).removeClass("u-edit-warn")});var l={calcName:t,calcType:i,baseValue:a,baseUnitName:n,baseUnitCode:r};e.htable.setRowData(l,e.changeSavePriceDetailCacheVal),$(document).promptBox("closeFormPrompt")}},e.changeSavePriceDetailCacheVal=function(t,i,a){if(e.savePriceDetailCache&&e.savePriceDetailCache[e.currentServiceTypeIndex]){var n=e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex];if("cell"==t){var r={baseUnitCode:"kg",baseUnitName:Lang.getValByKey("priceDetail","priceDetail_code_unitKg"),baseValue:1,calcName:e.defatutPriceMethod.name,calcType:e.defatutPriceMethod.code,price:""};n.freightItems[a]?n.freightItems[a]=$.extend(!0,{},r,n.freightItems[a],i):n.freightItems[a]=$.extend(!0,{},i)}else"row"==t&&(n.freightWeightSettings[a]=$.extend(!0,{},i))}},e.copyPriceDetail=function(){e.checkedArr=[],e.checkedOrCancelAll=function(t){"add"==(t.target.checked?"add":"remove")?(e.checkedArr=[],$.each(e.allPriceDetailList,function(t,i){i.serviceUid!=e.priceDetail.serviceUid&&e.checkedArr.push(i.serviceUid)})):e.checkedArr=[]},e.isCheckedAll=function(){return 1!==e.allPriceDetailList.length&&e.allPriceDetailList.length-1===e.checkedArr.length},e.checkedOne=function(t,i){var a=t.target,n=a.checked?"add":"remove";if("add"===n&&-1==e.checkedArr.indexOf(i)&&e.checkedArr.push(i),"remove"===n&&-1!=e.checkedArr.indexOf(i)){var r=e.checkedArr.indexOf(i);e.checkedArr.splice(r,1)}},e.isCheckedOne=function(t){return $.inArray(t,e.checkedArr)>-1},$(document).promptBox({title:Lang.getValByKey("priceDetail","priceDetail_copy_to"),isMiddle:!0,isNest:!0,content:{nest:$("#copyDetail")},loadData:function(){},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_save"),operationEvent:function(){var i={urlParams:{fromUid:e.priceDetail.serviceUid,toUids:e.checkedArr},seatParams:{uid:e.uid}};t.copyPriceDetail(i,function(t){$(document).promptBox("closeFormPrompt"),0===t.errorCode?(e.getInfo(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]})},e.savePrice=function(){if(e.viewButton.isSalesPrice&&e.savePriceDetailCache){if($("#w-lock-table .u-edit-error").length)return void $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("priceDetail","priceDetail_page_priceValueError"),type:"errer",manualClose:!0});for(var i=[],a=!0,n=0,r=e.savePriceDetailCache.length;n<r;n++)for(var c=0,o=e.savePriceDetailCache[n].length;c<o;c++)if(e.savePriceDetailCache[n][c].feeTypeIdx&&e.savePriceDetailCache[n][c].feeTypeId){if(e.savePriceDetailCache[n][c].freightItems.length){i.push(e.savePriceDetailCache[n][c]);for(var l=0,s=e.savePriceDetailCache[n][c].freightItems.length;l<s;l++)""===e.savePriceDetailCache[n][c].freightItems[l].price&&(e.savePriceDetailCache[n][c].freightItems[l].price=-1)}}else a=!1;if(!a)return void $(document).promptBox({isDelay:!0,contentDelay:"必填项不能为空！",type:"errer",manualClose:!0});var p={urlParams:i,seatParams:{uid:e.uid}},u=e.isOffline?"saveAllAuditSalesPrice":"saveAllSalesPrice";t[u](p,function(t){0==t.errorCode?(e.viewButton.submitDisabled=!1,e.isEditPrice=!1,e.htable.cancelEditCell(),e.getInfo(),
e.currentServiceTypeIndex=0,e.currentDetailIndex=0,e.getPriceTable(e.currentDetailIndex),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}else{if(e.iInputCostType||e.priceDetailForm.iInputCostType.$setDirty(),e.iInputCost||e.priceDetailForm.iInputCost.$setDirty(),!e.priceDetailForm.$valid)return;if($("#w-lock-table .u-edit-error").length)return void $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("priceDetail","priceDetail_page_priceValueError"),type:"errer",manualClose:!0});for(var d=$("#w-lock-table .table-left tbody").children("tr"),g=$("#w-lock-table .table-content tbody").children("tr"),m=d.length||g.length,h=(g.children("td").length,[]),y=[],f={},D=0;D<m;D++){var I=d.find("a.u-price-edit").eq(D).data();f={calcType:I.calcType||-1,baseValue:I.baseValue||1,baseUnitCode:I.baseUnitCode||""},h.push(f),g.eq(D).children("td").each(function(){var e=$(this).find(".u-edit-input").data();e.price=""===e.price?-1:e.price,f={calcType:e.calcType||-1,price:e.price,baseValue:e.baseValue||1,baseUnitCode:e.baseUnitCode||""},y.push(f)})}var p={urlParams:{freightItems:y,freightWeightSettings:h,weightSchemaUid:e.iDetailWeightValue,regionSchemaUid:e.iDetailRegionValue,feeTypeId:e.iInputCostValue,supplierId:e.priceDetail.supplierId,serviceUid:e.priceDetail.serviceUid,id:e.priceDetail.id,quotationId:e.priceDetail.quotationId},seatParams:{uid:e.uid}},v=e.isOffline?"saveAuditCostPrice":"saveCostPrice";t[v](p,function(t){0===t.errorCode?(e.viewButton.submitDisabled=!1,e.priceDetail.id=t.data.id,e.isEditPrice=!1,e.htable.cancelEditCell(),e.getPriceTable(e.currentDetailIndex,e.priceDetail.id),e.priceDetailList[e.currentDetailIndex].id=e.priceDetail.id,$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}},e.goBack=function(){var t=e.parameter.q,i=e.parameter.module,a=e.parameter.type||"",n=(e.parameter.action,"#/"+t+"?module="+i);a&&(n+="&type="+a),e.isEdit||e.isEditPrice?$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("common","common_back_confirm")},cancelDescription:Lang.getValByKey("common","common_back_no"),operation:[{type:"submit",application:"delete",description:Lang.getValByKey("common","common_back_yes"),operationEvent:function(){$(document).promptBox("closePrompt"),window.location.href=n}}]}):window.location.href=n};var m,h,y,f,D,I,v,P,T,C;e.getServicesData=function(e,i){i||(i=1),e=e||"";var a={urlParams:{q:e,pageIndex:i,pageSize:10,status:3,includeAllAudit:!0},seatParams:{serviceTypeId:-1}},n=t.getServices(a);return angular.forEach(n.data,function(e,t){e.name+="("+e.code+")"}),n},e.getServices=function(){e.servicesData=e.getServicesData(),m=selectFactory({data:e.servicesData,isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-service",searchPlaceHoder:Lang.getValByKey("common","common_select_search_tips"),showTextField:"name",attrTextField:{"ng-value":"uid"},closeLocalSearch:!0,pagination:!0,onSearchValueChange:function(t,i,a){e.servicesData=e.getServicesData(i,a),m.setData(e.servicesData)},attrTextId:function(t){"salesPrice"==e.module&&t!=e.iInputServicesValue&&(e.copyPriceDetailList=[]),e.iInputServicesValue=t,e.$apply()},attrTextModel:function(t){e.iInputServices=t,e.$apply()}}),m.open(),$("#select-service").val(e.iInputServices)},e.getCostType=function(){h||(e.costTypeData=t.getCostType(),h=selectFactory({data:e.costTypeData,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-cost-type",showTextField:"name",attrTextModel:function(t,i,a){if(e.iInputCostType=t,a.id?e.iInputCostTypeValue=a.id:(e.iInputCost=e.iInputCostValue="",e.iInputCostTypeValue="",y&&y.clearData()),e.viewButton.isSalesPrice&&e.savePriceDetailCache){var n=e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex];n.feeTypeIdxName=t||"",n.feeTypeIdx=a.id||""}e.$apply()}}),h.open(),$("#select-cost-type").val(e.iInputCostType))},e.getCostData=function(i,a){var n={urlParams:{q:i||"",pageIndex:a||1,pageSize:10,type:e.iInputCostTypeValue,sort:"code"}},r=t.getCost(n);return angular.forEach(r.data,function(e,t){e.name+="("+e.code+")"}),r},e.getCost=function(){e.iInputCostTypeValue&&!y&&(y=selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-cost",showTextField:"name",pagination:!0,isSaveInputVal:!0,closeLocalSearch:!0,onSearchValueChange:function(t,i,a){e.iInputCostType&&(e.costData=e.getCostData(i,a),t.setData(e.costData))},attrTextModel:function(t,i,a){if(e.iInputCost=t,e.iInputCostValue=a.id||"",e.viewButton.isSalesPrice&&e.savePriceDetailCache){var n=e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex];n.feeTypeName=t||"",n.feeTypeId=a.id||""}e.$apply()}}),y.open())},e.getGoods=function(){f||(e.goodsData=t.getGoods(),f=selectFactory({data:e.goodsData,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-goods",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.iInputGoodsTypeValue=t},attrTextModel:function(t){e.iInputGoodsType=t,e.$apply()}}),f.setData(e.goodsData),f.open(),$("#select-goods").val(e.iInputGoodsType))},e.getCurrency=function(){D||(D=selectFactory({data:[],isSearch:!0,closeLocalSearch:!0,pagination:!0,isSaveInputVal:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-currency",showTextField:"name",attrTextField:{"ng-value":"code"},searchPlaceHoder:Lang.getValByKey("priceDetail","priceDetail_page_currencyPlacer"),attrTextId:function(t){e.iInputCurrencyValue=t},attrTextModel:function(t){e.iInputCurrency=t,e.$apply()},onSearchValueChange:function(i,a,n){e.currencyData=t.getCurrency({urlParams:{q:a,pageSize:10,pageIndex:n||1}}),angular.forEach(e.currencyData.data,function(e,t){e.name+="("+e.code+")"}),i.setData(e.currencyData)}}),D.open())},e.getAccountData=function(e,i){i||(i=1),e=e||"";var a={urlParams:{q:e,pageIndex:i,pageSize:10}};return t.getAccount(a)},e.getAccount=function(){I=selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-account",showTextField:"name",closeLocalSearch:!0,isSaveInputVal:!0,pagination:!0,searchPlaceHoder:Lang.getValByKey("common","common_select_search_tips"),onSearchValueChange:function(t,i,a){e.accountData=e.getAccountData(i,a),angular.forEach(e.accountData.data,function(e,t){e.name+="("+e.code+")"}),t.setData(e.accountData)},attrTextField:{"ng-value":"id"},attrTextId:function(t){e.iInputAccountValue=t},attrTextModel:function(t){e.iInputAccount=t,e.$apply()}}),I.open()},e.getWeightData=function(e,i){i||(i=1),e=e||"";var a={urlParams:{q:e,pageIndex:i,pageSize:10,sort:"code",asc:!0}},n=t.getWeight(a);return angular.forEach(n.data,function(e,t){e.name+="("+e.code+")"}),n},e.getWeight=function(t){var i="";i="info"==t?"select-weight-info":"select-weight-detail",e.weightData=e.getWeightData(),v=selectFactory({data:e.weightData,isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:i,pagination:!0,searchPlaceHoder:Lang.getValByKey("common","common_select_search_tips"),showTextField:"name",closeLocalSearch:!0,onSearchValueChange:function(t,i,a){e.weightData=e.getWeightData(i,a),t.setData(e.weightData)},attrTextModel:function(i,a,n){if("info"==t)e.iInputWeight=i,e.iInputWeightValue=n.uid||"",("salesPrice"!=e.module||e.urlData&&2!=e.urlData.priceType)&&(e.uid||e.viewButton.isCopy)&&e.iInputWeightValue!=e.cacheWeightUid&&(e.viewButton.isSaveInfoPrompt=!0,e.copyPriceDetailList=[]);else{if(e.iDetailWeightValue=n.uid?n.uid:"-1",e.viewButton.isSalesPrice&&e.savePriceDetailCache){var r=e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex];r.weightName=i||"",r.weightSchemaUid=e.iDetailWeightValue,r.freightItems=null,r.freightWeightSettings=null}"-1"==e.iDetailWeightValue?e.iDetailWeight="任意重量段":e.iDetailWeight=i,e.getPriceTable(e.currentDetailIndex,"",!0)}e.$apply()}}),v.setData(e.weightData),v.open(),"info"==t?$("#select-weight-info").val(e.iInputWeight):$("#select-weight-detail").val(e.iDetailWeight)},e.getRegionData=function(e,i){i||(i=1),e=e||"";var a={urlParams:{q:e,type:1,pageIndex:i,pageSize:10,sort:"code",asc:!0}},n=t.getRegion(a);return angular.forEach(n.data,function(e,t){e.name+="("+e.code+")"}),n},e.getRegion=function(t){var i="";i="info"==t?"select-region-info":"select-region-detail",e.regionData=e.getRegionData(),P=selectFactory({data:e.regionData,isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:i,showTextField:"name",pagination:!0,searchPlaceHoder:Lang.getValByKey("common","common_select_search_tips"),closeLocalSearch:!0,onSearchValueChange:function(t,i,a){e.regionData=e.getRegionData(i,a),t.setData(e.regionData)},attrTextModel:function(i,a,n){if("info"==t)e.iInputRegion=i||"",e.iInputRegionValue=n.uid||"",("salesPrice"!=e.module||e.urlData&&2!=e.urlData.priceType)&&(e.uid||e.viewButton.isCopy)&&n.uid!=e.cacheRegionUid&&(e.viewButton.isSaveInfoPrompt=!0,e.copyPriceDetailList=[]);else{if(e.iDetailRegionValue=n.uid?n.uid:"-1",e.viewButton.isSalesPrice&&e.savePriceDetailCache){var r=e.savePriceDetailCache[e.currentServiceTypeIndex][e.currentDetailIndex];r.regionName=i||"",r.regionSchemaUid=e.iDetailRegionValue,r.freightItems=null,r.freightWeightSettings=null}"-1"==e.iDetailRegionValue?e.iDetailRegion="任意分区":e.iDetailRegion=i,e.getPriceTable(e.currentDetailIndex,"",!0)}e.$apply()}}),P.setData(e.regionData),P.open(),"info"==t?$("#select-region-info").val(e.iInputRegion):$("#select-region-detail").val(e.iDetailRegion)},e.getPriceType=function(){T||(T=selectFactory({data:e.priceTypeData,id:"select-price-type",defaultText:Lang.getValByKey("common","common_select_tips"),showTextField:"name",attrTextField:{"ng-value":"id"},attrTextId:function(t){e.iInputPriceTypeValue=t,e.$apply()},attrTextModel:function(t){e.iInputPriceType!=t&&(Select.sharePool["select-price-level"]="",Select.sharePool["select-client"]="",1==e.iInputPriceTypeValue?e.iInputPriceLevel=e.iInputPriceLevelValue="":2==e.iInputPriceTypeValue&&(e.iInputClient=e.iInputClientValue="")),e.iInputPriceType=t,e.$apply()}}),T.setData(e.priceTypeData),T.open(),$("#select-price-type").val(e.iInputPriceType))},e.getPriceLevel=function(){selectFactory({data:e.priceLevelData,id:"select-price-level",showTextField:"name",defaultText:Lang.getValByKey("common","common_select_tips"),attrTextField:{"ng-value":"id"},attrTextId:function(t){e.iInputPriceLevelValue=t,e.$apply()},attrTextModel:function(t){e.iInputPriceLevel=t,e.$apply()}})},e.getClientData=function(e,i){e=e||"";var a={urlParams:{q:e,userType:1,pageIndex:i||1,pageSize:10,sortName:"evaluateLeval",isAsc:!1}};return t.getClient(a)},e.getClient=function(){C=selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-client",showTextField:"nameCode",closeLocalSearch:!0,pagination:!0,searchPlaceHoder:"请输入账户名或编码",onSearchValueChange:function(t,i,a){e.clientData=e.getClientData(i,a),e.clientData.data.forEach(function(e){e.nameCode=e.userName+"("+e.code+")"}),t.setData(e.clientData)},attrTextField:{"ng-value":"id"},attrTextId:function(t){e.iInputClientValue=t,e.$apply()},attrTextModel:function(t){e.iInputClient=t,e.$apply()}}),C.open(),$("#select-client").val(e.iInputClient)};var V,b;e.showPriceMethod=function(){V||(e.priceMethod=t.getCalcTypeList(),V=selectFactory({data:e.priceMethod,isUsePinyin:!0,id:"select-price-method",showTextField:"name",defaultText:Lang.getValByKey("common","common_select_tips"),attrTextField:{"ng-value":"code"},attrTextId:function(t){e.priceMethodValue=t,t==e.sumPriceMethod.code?(e.ePriceTotal=!0,Select.sharePool["select-price-unit"]=""):e.ePriceTotal=!1,e.$apply()},attrTextModel:function(t){e.priceMethodModel=t,e.$apply()}}),V.setData(e.priceMethod),V.open(),$("#select-price-method").val(e.priceMethodModel))},e.showPriceUnit=function(){e.priceUnitData||(e.priceUnitData=t.getPriceUnit()),b=selectFactory({data:e.priceUnitData,id:"select-price-unit",showTextField:"name",direction:"up",defaultText:Lang.getValByKey("common","common_select_tips"),attrTextField:{"ng-value":"code"},attrTextId:function(t){e.priceUnitValue=t,e.$apply()},attrTextModel:function(t){e.priceUnit=t,e.$apply()}}),b.setData(e.priceUnitData),b.open(),$("#select-price-unit").val(e.priceUnit)};var S={unSelectedData:[],selectedData:[],candidateFlag:!1,selectedFlag:!1};e.loadRegionData=function(){S.unSelectedData=t.getCountry().data,S.selectedData=e.areasData,e.tab.selected(0),e.areaModel=a.initArea(S)},e.selectRegion=function(){e.initCtrl(),$(document).promptBox({title:Lang.getValByKey("priceDetail","priceDetail_code_addDeparture"),isHidden:!0,boxWidth:!0,isNest:!0,loadData:function(){e.loadRegionData()},content:{nest:$("#serviceZone")},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_confirm"),operationEvent:function(){$(document).promptBox("closeFormPrompt");var t="";angular.forEach(e.areaModel.selectedData,function(e,i){t+="，"+e.name.split("/")[e.name.split("/").length-1]}),t&&(t=t.slice(1)),e.iDeparture=e.iInputDeparture=t,e.areasData=[];var i={};angular.forEach(e.areaModel.selectedData,function(t,a){i={figureCode:t.interId,name:t.name.split("/")[t.name.split("/").length-1]},e.areasData.push(i)}),e.$apply()}}]})},controller.init(e,i)}])});