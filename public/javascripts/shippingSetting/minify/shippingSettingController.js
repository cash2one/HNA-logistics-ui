easySpa.require(["widget/slimscroll","public/common/tableController.js","widget/prompt","widget/select","public/common/calander.js","public/javascripts/shippingSetting/20161224/shippingSettingDetailController.js"],function(){app.controller("shippingSettingCtrl",["$scope","shippingSettingService","shippingSettingView","tableService",function(e,t,a,i){function n(e,a){if(a||(a=t.getShippingShort()),e){a=a.data;for(var i=0;i<a.length;i++){var n=a[i].name;if($.trim(n)==$.trim(e)||$.trim(a[i].name)==$.trim(e))return a[i].id}return"无匹配结果"}}e.shipSetting={id:0},e.getLanguage=function(){t.getLanguage(function(t){0===t.errorCode&&(e.language=t.data)})},e.getLanguage(),e.initCalander=function(){a.initCalander(e),e.clearStartTime=e.tableModel.restData.startTime,e.clearEndTime=e.tableModel.restData.endTime},e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("shippingSetting","shippingSetting_vessel_num"),Lang.getValByKey("shippingSetting","shippingSetting_vessel_departurePort"),Lang.getValByKey("shippingSetting","shippingSetting_vessel_arrivalPort"),Lang.getValByKey("shippingSetting","shippingSetting_vessel_departureTime"),Lang.getValByKey("shippingSetting","shippingSetting_vessel_arrivalTime"),Lang.getValByKey("shippingSetting","shippingSetting_vessel_name"),Lang.getValByKey("shippingSetting","shippingSetting_vessel_company"),Lang.getValByKey("shippingSetting","shippingSetting_vessel_totalTime")],tableBody:[],restURL:"logistics.getShipFlights",restData:{q:"",startPortId:"",endPortId:"",startTime:"",endTime:"",pageIndex:1,pageSize:10,sort:""},selectNumber:0,selectFlag:!1},e.getTable=function(t){e.q=e.tableModel.restData.q,e.tableModel.restData.startPortId=e.searchStartShipCode,e.tableModel.restData.endPortId=e.searchEndShipCode,t&&(e.tableModel.restData.pageIndex=1);var a={urlParams:e.tableModel.restData};i.getTable(e.tableModel.restURL,a,function(t){0===t.errorCode&&(e.tableModel=i.table(e.tableModel,a,t),e.nestShipSettingForm=!1,setTimeout(function(){var e=$(".shippingSetting-table-page").height()-330;$("#list .table-container tbody").slimscroll({height:e}),$(window).resize(function(){e=$(".shippingSetting-table-page").height()-330,$("#list .table-container tbody").slimscroll({height:e})})},10))})},e.initCalander(),e.getTable(),e.del=function(){var n={},r=[],s=i.getSelectTable(e.tableModel.tableBody);if(!s.length)return a.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;angular.forEach(s,function(e){r.push(e.id)}),n={urlParams:r};var l={title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("shippingSetting","shippingSetting_code_modelDelTips")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){t.del(n,function(t){a.promptBox("closePrompt"),0===t.errorCode?(a.promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.getTable(),e.$apply()):a.promptBox({isDelay:!0,contentDelay:t.msg,type:"error",manualClose:!0})})}}]};a.promptBox(l)},e.clearData=function(){e.tableModel.restData.q="",e.q="",e.tableModel.restData.startPortId="",e.tableModel.restData.endPortId="",e.tableModel.restData.startTime=e.clearStartTime,e.tableModel.restData.endTime=e.clearEndTime,e.searchStartShip="",e.searchEndShip="",e.searchStartShipCode="",e.searchEndShipCode="",e.getTable()};var r=/^([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})-(((0[13578]|1[02])-(0[1-9]|[12][0-9]|3[01]))|((0[469]|11)-(0[1-9]|[12][0-9]|30))|(02-(0[1-9]|[1][0-9]|2[0-8])))$/;e.checkStartTime=function(){r.test(e.tableModel.restData.startTime)||(e.tableModel.restData.startTime="")},e.checkEndTime=function(){r.test(e.tableModel.restData.endTime)||(e.tableModel.restData.endTime="")};var s,l;e.initSelectList=function(){var a={urlParams:{q:"",pageIndex:1,pageSize:10},isAsync:!0};e.searchStartShips=e.searchEndShips=t.getPortShort(a),s=selectFactory({data:e.searchStartShips,isSearch:!0,id:"search-start",pagination:!0,onSearchValueChange:function(t,a,i){e.searchStartShips=e.getShipPortData(a,i),angular.forEach(e.searchStartShips.data,function(e,t){e.name=e.name+"("+e.englishName+")"}),t.setData(e.searchStartShips)},attrTextModel:function(t,a){e.searchStartShipCode=n(t,a),e.searchStartShip=t,e.searchStartShip==e.searchEndShip&&($("#search-start").val(""),e.sarchStartShip=""),e.$apply()}}),l=selectFactory({data:e.searchEndShips,isSearch:!0,id:"search-end",pagination:!0,onSearchValueChange:function(t,a,i){e.searchEndShips=e.getShipPortData(a,i),angular.forEach(e.searchEndShips.data,function(e,t){e.name=e.name+"("+e.englishName+")"}),t.setData(e.searchEndShips)},attrTextModel:function(t,a){e.searchEndShipCode=n(t,a),e.searchEndShip=t,e.searchEndShip==e.searchStartShip&&($("#search-end").val(""),e.searchEndPort=""),e.$apply()}})},e.getShipPortData=function(e,a){a||(a=1),e=e||"";var i={urlParams:{q:e,pageIndex:a,pageSize:10,includeAllAudit:!0},isAsync:!0};return t.getPortShort(i)},e.add=function(){e.showDetail=!0,e.$broadcast("addshippingSettingDetail",{})},e.closeDetailPage=function(){e.showDetail=!1,e.clearData()},e.editShipSettingDetail=function(a){e.showDetail=!0;var i={seatParams:{id:a}};t.getShippingLine(i,function(t){0===t.errorCode&&e.$broadcast("editshippingSettingDetail",t.data)})}}])});