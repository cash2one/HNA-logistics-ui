easySpa.require(["widget/slimscroll","public/common/tableController.js","widget/prompt","widget/select","public/lib/pinyin.js","public/lib/pinyin-util.js"],function(){app.controller("currencyCtrl",["$scope","currencyService","currencyView","tableService",function(e,r,t,a){function n(e){r.delCurrency(e,function(e){0===e.errorCode?($(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),c()):$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})}function o(t){e.data=r.getCountryList({urlParams:{pageSize:1e3}});for(var a=e.data.data,n=t.split("，"),o=[],i=0;i<n.length;i++){var c=n[i];c.indexOf("(")>-1&&(c=c.substring(0,c.indexOf("(")));for(var l=0;l<a.length;l++)if(a[l].name.indexOf("(")>-1&&(a[l].name=a[l].name.substring(0,a[l].name.indexOf("("))),$.trim(c)==a[l].name){o.push(a[l].code);break}}return o.join("，")}function i(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-250})}function c(){var r={urlParams:e.tableModel.restData,seatParams:{language:"zh-CN"}};a.getTable(e.tableModel.restURL,r,function(t){e.q=e.tableModel.restData.q,0===t.errorCode&&(e.tableModel=a.table(e.tableModel,r,t),setTimeout(function(){i(),$(window).on("resize",i),e.$apply(),$(".table-box").focus()},100))})}e.isCreateNewCurrency=!0,e.oldCountryName="";var l=$("#nest-currencyFrom .label-text");!function(){barClick(l)}(),e.international=function(){window.location.href="#/international?q=currency"},e.initSelectList=function(){e.data=r.getCountryList();for(var t=0;t<e.data.data.length;t++)e.data.data[t].name=e.data.data[t].name+"("+e.data.data[t].code+")";selectFactory({data:e.data,id:"country-text",isSearch:!0,defaultText:"请选择",searchPlaceHoder:"请输入国家名称或二字码",multipleSign:",",pagination:!0,onSearchValueChange:function(r,t,a){e.data=e.getCountryData(t,a),r.setData(e.data)},attrTextModel:function(r,t){e.countryName=r,e.$apply()}})},e.getCountryData=function(e,t){t||(t=1),e=e||"";var a={urlParams:{q:e,pageIndex:t,pageSize:10,includeAllAudit:!0},isAsync:!0},n=r.getCountryList(a);return angular.forEach(n.data,function(e,r){e.name+="("+e.code+")"}),n},e.checkTriadCode=function(){return!(!e.triadCode||void 0===e.triadCode)&&(e.triadCode=e.triadCode.toLocaleUpperCase(),3!=$.trim(e.triadCode).length?(e.currencyFrom.triadCode.$setDirty(),e.currencyFrom.triadCode.errorTips=Lang.getValByKey("currency","currency_input_three_code_limit"),$("#triad-code-msg").removeClass("ng-hide"),!1):($("#triad-code-msg").addClass("ng-hide"),e.currencyFrom.triadCode.errorTips="",!0))},e.verifyCodeExist=function(){e.checkTriadCode()&&e.triadCode&&void 0!==e.triadCode&&e.triadCode&&e.triadCode!=e.oldTriadCode&&r.verifyCodeExist({seatParams:{code:e.triadCode}},function(r){0==r.errorCode&&r.data.length>0?(e.currencyFrom.triadCode.$setDirty(),e.currencyFrom.triadCode.errorTips="三字码已存在",$("#triad-code-msg").removeClass("ng-hide"),angular.element($(".check-triad-code").addClass("ng-invalid"))):($("#triad-code-msg").addClass("ng-hide"),e.currencyFrom.triadCode.errorTips="",angular.element($(".check-triad-code").removeClass("ng-invalid")))})},e.editCurrency=function(t){$("#nest-currencyFrom").css("display","table"),e.isCreateNewCurrency=!1,e.promptTitle=Lang.getValByKey("currency","currency_detail_title"),e.nestCurrencyFrom=!0,e.currencyName=t.name,e.countryName=t.organization,e.triadCode=t.code,e.mark=t.csymbol,e.oldTriadCode=t.code,e.oldCountryName=t.organization,e.id=t.id,r.verifyCodeExist({seatParams:{code:e.triadCode}},function(r){languages=r.data;for(var t=[],a=0;a<e.langList.length;a++)e.langList[a].val="",e.langList[a].refId="";if(languages&&languages.length>0){for(var a=0;a<e.langList.length;a++)t.push(e.langList[a].code);for(var a=0;a<languages.length;a++){var n=languages[a].language;t.indexOf(n)>-1&&(e.langList[t.indexOf(n)].val=$.trim(languages[a].localName),e.langList[t.indexOf(n)].refId=languages[a].refId)}}}),$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),loadBar(l),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.add=function(){e.promptTitle=Lang.getValByKey("currency","currency_create_title"),e.isCreateNewCurrency=!0,$("#nest-currencyFrom").css("display","table"),e.nestCurrencyFrom=!0,e.currencyName="",e.countryName="",e.triadCode="",e.mark="",e.oldTriadCode="",$(".input-text").removeClass("ng-dirty"),e.oldCountryName="",loadBar(l),$('button[name="prompt-save"]').addClass("save").removeClass("edit");for(var r=0;r<e.langList.length;r++)e.langList[r].val="",e.langList[r].refId=""},e.delete=function(){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var r=[],t=a.getSelectTable(e.tableModel.tableBody);if(!t.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("currency","currency_prompt_delay_tip"),type:"errer",manualClose:!0}),!1;angular.forEach(t,function(e){r.push(e.id)}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("currency","currency_prompt_delete_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){n(r)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("currency","currency_prompt_delay_tip"),type:"errer",manualClose:!0})},e.closePrompt=function(){e.nestCurrencyFrom=!1},e.savePrompt=function(){if(showErrorModel(l),e.verifyCodeExist(),e.countryName=$("#country-text").val(),e.currencyName||e.currencyFrom.currencyName.$setDirty(),e.countryName||e.currencyFrom.countryName.$setDirty(),e.triadCode||e.currencyFrom.triadCode.$setDirty(),e.mark||e.currencyFrom.mark.$setDirty(),e.currencyFrom.$valid){for(var t=$(".errors"),a=0;a<t.length;a++)if(!$(t[a]).hasClass("ng-hide"))return;for(var n=[],a=0;a<e.langList.length;a++)$.trim(e.langList[a].val)||(e.langList[a].val=""),n.push({language:e.langList[a].code,localName:e.langList[a].val,refId:e.langList[a].refId});var i=o(e.countryName);e.isCreateNewCurrency?r.createCurrency({name:e.currencyName,organization:i,code:e.triadCode,csymbol:e.mark,i18n:n},function(r){0!=r.errorCode?$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success",time:3e3}),c())}):r.updateCurrency({name:e.currencyName,organization:i,code:e.triadCode,csymbol:e.mark,i18n:n,id:e.id},function(r){0!=r.errorCode?$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success",time:3e3}),c())})}},e.searchCurrency=function(){e.tableModel.restData.pageIndex=1,c()},function(){e.langList=r.getInternational().data}(),function(){e.tableModel={tableHeader:[Lang.getValByKey("currency","currency_id"),Lang.getValByKey("currency","currency_name"),Lang.getValByKey("currency","currency_country"),Lang.getValByKey("currency","currency_three_code"),Lang.getValByKey("currency","currency_mark")],tableHeaderSize:["5%","27%","21%","21%","21%"],tableBody:[],restURL:"logistics.searchCurrencyList",restData:{q:"",pageIndex:1,pageSize:10,isAsc:!0,unfilled:!1},selectNumber:0,selectFlag:!1},c()}()}])});