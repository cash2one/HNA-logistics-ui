easySpa.require(["widget/slimscroll","widget/prompt","public/common/tableController.js","widget/parseUrl","public/common/calander.js","widget/select"],function(){app.controller("billDetailCtrl",["$scope","billDetailService","billDetailView","tableService",function(e,a,t,l){Calander.init({ele:["#begin-time","#end-time"],isClear:!0}),e.parameter=window.parseUrl.getParams(),e.module=e.parameter.module?e.parameter.module:"logistics",e.submodule=e.parameter.submodule,e.interType="trade"==e.module?"trd":"","trade"==e.module&&(e.subInterType=e.submodule),"logistics"==e.module&&(e.subInterType="pay"==e.submodule?"1":"2"),"trade"==e.module?("receive"==e.submodule?(e.tTheadCus="客户（付款方）",e.tTheadPla="平台实体（收款方）"):"pay"==e.submodule&&(e.tTheadCus="客户（收款方）",e.tTheadPla="平台实体（付款方）"),e.tTheadGoo="商品名",e.tTheadAcc="",e.tableClass=!0):(e.tTheadPro=Lang.getValByKey("billDetail","product_names"),e.tTheadAcc=Lang.getValByKey("billDetail","account_name")),e.title=Lang.getValByKey("billDetail","account_detail"),e.status=e.parameter.status,e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("billDetail","order_number"),e.tTheadCus,e.tTheadPla,e.tTheadAcc,e.tTheadGoo,e.tTheadPro,Lang.getValByKey("billDetail","billing_time"),Lang.getValByKey("billDetail","price_detail")+"（"+e.parameter.currency+"）"],tableBody:[],restURL:"logistics.getBillsOrders",restData:{billNo:e.parameter.billNo,q:"",pageIndex:1,pageSize:10,sort:"code",platformId:"",bizCompanyId:"",customerId:""},selectNumber:0,selectFlag:!1},"logistics"==e.module&&("receive"==e.submodule&&(e.tableModel.tableHeader=[Lang.getValByKey("common","common_thead_number"),"运单号","账号名","产品名称",Lang.getValByKey("billDetail","billing_time"),"计费重","汇率","总价","支付状态"]),"pay"==e.submodule&&(e.tableModel.tableHeader=[Lang.getValByKey("common","common_thead_number"),"运单号","服务名称",Lang.getValByKey("billDetail","billing_time"),"计费重","汇率","总价"])),e.getTable=function(){var a={urlParams:e.tableModel.restData,seatParams:{interType:e.interType,subInterType:e.subInterType}};l.getTable(e.tableModel.restURL,a,function(t){if(0===t.errorCode){e.tableModel=l.table(e.tableModel,a,t);var o=$(".m-content-box").height()-200;setTimeout(function(){$(".table-container tbody").slimscroll({height:o}),$(window).resize(function(){o=$(".m-content-box").height()-200,$(".table-container tbody").slimscroll({height:o})})},10)}})},e.getTable(),e.search=function(){e.tableModel.restData.pageIndex=1,e.tableModel.restData.orderNo=e.orderNum,e.tableModel.restData.waybillNo=e.orderNum,e.tableModel.restData.startEffectTime=e.startTime,e.tableModel.restData.endEffectTime=e.endTime,"trade"==e.module&&(e.tableModel.restData.platformId=e.platformValue,e.tableModel.restData.bizCompanyId=e.orderClientValue,e.q=e.tableModel.restData.goodsName=e.goodName),"logistics"==e.module&&("receive"==e.submodule&&(e.tableModel.restData.productUid=e.productValue,e.tableModel.restData.customerId=e.orderClientValue,e.tableModel.restData.payStatus=e.payStatus),"pay"==e.submodule&&(e.tableModel.restData.serviceUid=e.serviceValue)),e.getTable()},e.clearCondition=function(){e.orderNum="",e.orderClientName=e.orderClientValue="",e.payStatus="",e.payStatusName="全部",e.productName="",e.platform=e.platformValue="",e.goodName=e.goodValue="",e.productName=e.productValue="",e.serviceName=e.serviceValue="",e.startTime="",e.endTime="",e.search()},e.audit=function(){if(e.auditSubmitStatus=!0,e.auditRemark||e.auditForm.auditRemark.$setDirty(),e.auditForm.$valid&&e.auditStatus){var t={urlParams:{billNos:[e.parameter.billNo],type:e.auditStatus,msg:e.auditRemark},seatParams:{interType:e.interType,subInterType:e.subInterType}};a.audit(t,function(a){0===a.errorCode?($(document).promptBox({isDelay:!0,contentDelay:a.msg,type:"success"}),setTimeout(function(){e.goBack()},1e3)):$(document).promptBox({isDelay:!0,contentDelay:a.msg,type:"errer",manualClose:!0})})}},e.goBack=function(){var a=e.parameter.from,t=e.parameter.module,l=e.parameter.submodule;window.location.href="fundsAccount"==a?"#/"+a+"?thirdPayAccountId="+e.parameter.thirdPayAccountId+"&custName="+e.parameter.custName+"&currencyCode="+e.parameter.currency:"#/"+a+"?from="+a+"&module="+t+"&submodule="+l},e.getClientData=function(t,l){var o={seatParams:{costomerid:e.parameter.customerId},urlParams:{q:t?t.trim():"",pageIndex:l||1}};return a.getClient(o)},e.getClient=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),searchPlaceHoder:"请输入姓名或用户名",id:"select-client",showTextField:"fullName",attrTextField:{"ng-value":"id"},pagination:!0,closeLocalSearch:!0,onSearchValueChange:function(a,t,l){e.clientData=e.getClientData(t,l),angular.forEach(e.clientData.data,function(e,a){e.fullName+="("+e.userName+")"}),a.setData(e.clientData),e.$apply()},attrTextId:function(a){e.orderClientValue=a,e.$apply()},attrTextModel:function(a){e.orderClientName=a,e.$apply()}}).open(),$("#select-client").val(e.orderClientName)},e.getProductData=function(e,t){e=e||"";var l={urlParams:{q:e,pageIndex:t||1,pageSize:10,status:3,includeAllAudit:!0}},o=a.getProducts(l);return angular.forEach(o.data,function(e,a){e.name+="("+e.code+")"}),o},e.getProduct=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),searchPlaceHoder:"请输入产品名称或编码",id:"select-product",showTextField:"name",pagination:!0,attrTextField:{"ng-value":"uid"},closeLocalSearch:!0,onSearchValueChange:function(a,t,l){e.productsData=e.getProductData(t,l),a.setData(e.productsData)},attrTextId:function(a){e.productValue=a,e.$apply()},attrTextModel:function(a){e.productName=a,e.$apply()}}).open(),$("#select-product").val(e.productName)},e.getServiceData=function(e,t){e=e||"";var l={seatParams:{serviceTypeCode:-1},urlParams:{q:e,pageIndex:t||1,pageSize:10,status:4,includeAllAudit:!0}},o=a.getServices(l);return angular.forEach(o.data,function(e,a){e.name+="("+e.code+")"}),o},e.getService=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),searchPlaceHoder:"请输入服务名称或编码",id:"select-service",showTextField:"name",pagination:!0,attrTextField:{"ng-value":"uid"},closeLocalSearch:!0,onSearchValueChange:function(a,t,l){e.servicesData=e.getServiceData(t,l),a.setData(e.servicesData)},attrTextId:function(a){e.serviceValue=a,e.$apply()},attrTextModel:function(a){e.serviceName=a,e.$apply()}}).open(),$("#select-service").val(e.serviceName)};var o;e.getPlatform=function(){o||(e.platformData=a.getPlatformData(),o=selectFactory({data:e.platformData,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-platform",showTextField:"name",attrTextField:{"ng-value":"id"},attrTextId:function(a){e.platformValue=a,e.$apply()},attrTextModel:function(a){e.platform=a,e.$apply()}}),o.open(),$("#select-platform").val(e.platform))},e.getGoodData=function(e){e=e||"";var t={urlParams:{q:e,pageIndex:1,pageSize:10}},l=a.getGood(t);return angular.forEach(l.data,function(e,a){e.goodsName+="("+e.goodsCode+")"}),l};var r;e.getGood=function(){e.goodData=e.getGoodData(),r=selectFactory({data:e.goodData,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-good",showTextField:"goodsName",closeLocalSearch:!0,onSearchValueChange:function(a,t){e.goodData=e.getGoodData(t),a.setData(e.goodData)},attrTextField:{"ng-value":"goodsCode"},attrTextId:function(a){e.goodValue=a,e.$apply()},attrTextModel:function(a){e.goodName=a,e.$apply()}}),r.open(),$("#select-good").val(e.goodName)},e.getSupplierListData=function(t){t=t||"";var l={urlParams:{q:t},seatParams:{intertype:e.module}},o=a.getSupplierList(l);return angular.forEach(o.data,function(e,a){e.name+="("+e.code+")"}),o},e.getSupplier=function(){e.supplierData=e.getSupplierListData();var a=selectFactory({data:e.supplierData,isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-supplier",showTextField:"name",attrTextField:{"ng-value":"code"},closeLocalSearch:!0,onSearchValueChange:function(a,t){e.supplierData=e.getSupplierListData(t),a.setData(e.supplierData),e.$apply()},attrTextId:function(a){e.orderClientValue=a,e.$apply()},attrTextModel:function(a){e.orderClientName=a,e.$apply()}});a.setData(e.supplierData),a.open(),$("#select-supplier").val(e.orderClientName)};var i;e.getPayStatus=function(){i||(e.payStatusData=a.getPayStatusData(),i=selectFactory({data:e.payStatusData,defaultText:Lang.getValByKey("common","common_all_tips"),id:"pay-status",showTextField:"name",attrTextModel:function(a,t,l){a?(e.payStatusName=a,e.payStatus=l.code):e.payStatus="",e.$apply()}}),i.open())},e.getPriceDetail=function(a,t){e.priceDetailShow=!0,e.currencyDetail=t,e.priceDetailData=a}}])});