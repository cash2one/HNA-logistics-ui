easySpa.require(["public/common/tableController.js","widget/select","widget/prompt","public/common/calander.js","public/javascripts/tradeOrders/20161224/detailController.js","public/javascripts/tradeOrders/20161224/sdetailController.js","public/javascripts/tradeOrders/20161224/simulateController.js","public/common/uploadFile/uploadFile.js","public/javascripts/tradeOrders/20161224/sunRunConfirmOrderController.js","public/javascripts/tradeOrders/20161224/sunRunDeliveryConfirmController.js","public/javascripts/tradeOrders/20161224/normalConfirmOrderController.js","public/javascripts/tradeOrders/20161224/normalDeliveryConfirmController.js"],function(){function e(e,t,r,a,o,i){function d(e,t){if(void 0===$.fn.media){var r=document.createElement("script");r.src="public/lib/jquery.media.js",r.onload=function(r){n(e,t)},document.body.append(r)}else n(e,t)}function n(e,t){$("a.media").remove();var o=document.createElement("a");o.className="media","OUT"===e?e=1:"IN"===e&&(e=2),r.exportPDF(t,e).then(function(e){0==e.errorCode&&e.data?(o.href=u+e.data,document.body.append(o),$("a.media").media({width:800,height:600}),$(".closePDF").show().click(function(){$("div.media").remove(),$(this).remove()})):a.promptBox({msg:"尚未生成订单确认单!"})})}function l(e,t,r,a){return{system:"tradeOrder",edit:e,btnHandle:!1,orderStatus:a,append:t,orderNo:r,orderFileType:{url:"/api/v1/trd/order/file/type",type:"GET"},getOrderFile:{url:"/api/v1/trd/order/files",type:"GET",param:{pageIndex:1,pageSize:50,orderNo:r}},delOrderFile:{url:"",type:"POST",param:{orderNo:r}},addOrderFile:{url:"/api/v1/trd/order/files/"+r+"/orderFiles",type:"POST",param:{orderNo:r}},ckeckFileName:{url:"/api/v1/trd/order/files/files/name/check",type:"GET",param:{orderNo:r}}}}function s(){var t=[];return e.selectData.forEach(function(e){t.push(e.orderNo)}),t}"cockpit"===t.current.params.orderFrom&&(e.fromCockpit=!0);var c={};e.orderType=location.hash.split("?")[1].split("&")[1].split("=")[1].toUpperCase(),e.activeTab="DRAFT",e.activeTabs=function(t){return t===e.activeTab?"active":""},e.switch=function(t){t!==e.activeTab&&(e.activeTab=t,e.tableModel.restData.pageIndex=1,e.tableModel.restData.pageSize=10,e.clearSearch())},e.search={},e.tableModel={tableHeader:["序号","订单号","业务单号","商品信息","项目","销售方","采购方","创建时间","操作"],tableHeaderSize:["5%","12%","10%","10%","10%","13%","12%","13%","10%"],tableBody:[],restURL:"logistics.getTrdOrderList",restData:{q:"",refCombos:"",startTime:getBeforeDate(6)+" 00:00:00",endTime:(new Date).format("yyyy-MM-dd 23:59:59"),isAsc:!1,pageIndex:1,pageSize:10,customerId:e.search.customerId,goodsId:e.goodsId,orderType:e.orderType,orderStatus:e.activeTab},selectNumber:0,selectFlag:!1},e.closePDF=function(){$("div.media").remove(),$(".closePDF").hide()},e.orderGoodsMsg=function(e){var t="";return t+="名称: "+e.goodsName+"\n",e.goodsNum?t+="数量: "+e.goodsNum+" "+e.goodsUnit+"\n":t+="数量: "+e.minLimit+" - "+e.maxLimit+" "+e.goodsUnit+"\n",t+="单价: "+e.goodsPrice+" "+e.goodsCurrencyType},e.submitOrder=function(){var t=s();if(!t.length)return void a.promptBox({msg:"请先选择数据!"});a.promptMidBox("",{msg:"确定提交所选订单？"},"",function(){r.trdOrderListSubmit(t).then(function(t){a.promptBox(t),0==t.errorCode&&e.loadListData()})})},e.comfirmOrder=function(){var t=s();if(!t.length)return void a.promptBox({msg:"请先选择数据!"});a.promptMidBox("",{msg:"确定进行订单确认？"},"",function(){r.trdOrderListConfirms(t).then(function(t){a.promptBox(t),0==t.errorCode&&e.loadListData()})})},e.deliveryOrder=function(){var t=s();if(!t.length)return void a.promptBox({msg:"请先选择数据!"});a.promptMidBox("",{msg:"确认发货？"},"",function(){r.trdOrderListDeliverys(t).then(function(t){a.promptBox(t),0==t.errorCode&&e.loadListData()})})},e.$watch("tableModel",function(t,r){t!==r&&(e.canOutComfirmOrder=!1,e.selectData=o.getSelectTable(e.tableModel.tableBody),e.selectDataLen=e.selectData.length,angular.forEach(e.selectData,function(t,r){e.selectDataLen>1&&(e.canOutComfirmOrder=!0),"SALE"===e.orderType&&2!==t.sellerId&&(e.canOutComfirmOrder=!0),"PURCHASE"===e.orderType&&2!==t.purchaserId&&(e.canOutComfirmOrder=!0)}))},!0),e.outComfirmOrder=function(){var t=s();if(!t.length)return void a.promptBox({msg:"请先选择数据!"});var r=e.selectData[0].sellerId;"SALE"===e.orderType?2===r&&e.getDetail("sunRunOrderConfirm",t[0]):e.getDetail("simulate",t[0])},e.signedOrder=function(){var t=s();if(!t.length)return void a.promptBox({msg:"请先选择数据!"});var r=e.selectData[0].sellerId,o=e.selectData[0].purchaserId;if(e.selectDataLen>1)return void a.promptBox({msg:"不支持批量签收，请选择一条数据!"});"SALE"===e.orderType?2===r?e.getDetail("sunRunDeliveryConfirm",t[0]):e.getDetail("normalDeliveryConfirm",t[0]):2===o?e.getDetail("simulate",t[0]):e.getDetail("normalDeliveryConfirm",t[0])};var u=[location.protocol,"//",location.hostname,":",location.port].join("");e.outSignedOrder=function(){var e=s();return e.length?e.length>1?void a.promptBox({msg:"只能选择一条数据!"}):void d("IN",e[0]):void a.promptBox({msg:"请先选择数据!"})},e.loadListData=function(){var t=angular.copy(e.tableModel.restData);a.resetKeys(t,e.search),$.extend(t,e.search);for(var r in t)""===t[r]&&delete t[r];t.orderType=e.orderType,t.orderStatus=e.activeTab,t={urlParams:t},o.getTable(e.tableModel.restURL,t,function(r){e.tableModel=o.table(e.tableModel,t,r),e.$apply()})},setTimeout(function(){$("#sstartDate").val(getBeforeDate(6)+" 00:00:00"),$("#sendDate").val((new Date).format("yyyy-MM-dd 23:59:59")),e.loadListData()},0),e.search=function(){e.tableModel.restData.pageIndex=1,e.loadListData()},e.clearSearch=function(){for(var t in e.search)e.search[t]="",e[t]="";e.isEnabled="全部",e.purchaserLimit="全部",e.projectLimit="全部",e.goods="",e.search.startTime=getBeforeDate(6)+" 00:00:00",e.search.endTime=(new Date).format("yyyy-MM-dd 23:59:59"),$("#sstartDate").val(getBeforeDate(6)+" 00:00:00"),$("#sendDate").val((new Date).format("yyyy-MM-dd 23:59:59")),$("#goods").val(""),$("#supplierName").val(""),$("#likedusernamelist").val(""),e.tableModel.restData.pageIndex=1,e.loadListData()},e.enabledGoods=function(t){var o=s(),i="确定启用该商品?";if(!o.length)return void a.promptBox({msg:"请先选择数据!"});t||(i="确定停用该商品?"),a.promptMidBox("",{msg:i},"",function(){r.enabledGoods({ids:o,isEnabled:t}).then(function(t){a.promptBox(t),0==t.errorCode&&e.loadListData()})})},e.uploadFile=function(){$(".detail").html("");var t=s();if(1!==t.length)return a.promptBox({msg:"请先选择一条数据!"}),!1;e.showUploadFile=!0;var r=l(!0,"#tradeOrderUploadFileContent",t[0],"DRAFT");$(document).uploadBox(r)},e.detailTradeOrdersUploadfile=function(t,r,a,o){$("#tradeOrderUploadFileContent").html("");var i=l(t,r,a,o);e.result=$(document).uploadBox(i)},e.getDetail=function(t,r){a.getTpl(t).then(function(a){e.child=e.$new(),e.child.orderNo=r,e.presentOrderNo=r,$("#detail").html(i(a)(e.child)),"detail"===t&&(r?e.detailTradeOrdersUploadfile(!1,"#detailFileContent",r,""):e.detailTradeOrdersUploadfile(!0,"#detailFileContent","","")),"sdetail"===t&&e.detailTradeOrdersUploadfile(!1,"#sdetailFileContent",r)})},e.goBack=function(r){"cockpit"===t.current.params.orderFrom?window.location.href="#/cockpit?from=purchaseOrder":(e.child.$destroy(),$("#detail").html(""),r&&e.loadListData())},e.deleteOrder=function(t){var t=s();if(!t.length)return void a.promptBox({msg:"请先选择数据!"});a.promptMidBox("",{msg:"确定删除已选订单?"},Lang.getValByKey("common","common_page_delete"),function(){r.deleteTrdOneOrder(t,function(t){a.promptBox(t),0==t.errorCode&&e.loadListData()})},"warning","delete")},e.getAmoutTotal=function(e){var t=0;return e.forEach(function(e){var r=Number(e.amountDue);isNaN(r)||(t+=r)}),t.toFixed(2)},e.getSalesGoods=function(t,a){t=t||"";var o={q:t?t.trim():"",pageIndex:a||1,pageSize:10,isAsc:!1,orderType:e.orderType,sellId:"SALE"===e.orderType?void 0:e.search.customerId};return r.getTrdGoodsShortList(o)},e.initGoods=function(){c=selectFactory({data:[],isSearch:!0,isSaveInputVal:!0,pagination:!0,id:"goods",showTextField:"userName",defaultText:"请选择",searchPlaceHoder:"请输入名称或编码",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(t,r,a){e.Goods=e.getSalesGoods(r,a),angular.forEach(e.Goods.data,function(e,t){e.userName=e.name+"("+e.code+")"}),t.setData(e.Goods),e.$apply()},attrTextId:function(t){e.search.goodsId=t||"",e.$apply()},attrTextModel:function(t){e.goods=t,e.$apply()}}),c.open()},e.clearGoods=function(){c.allData&&(c.setData({}),$("#goods").val(""),e.goods="")},e.getProjectShortData=function(e,t){e=e||"";var a={project:e?e.trim():"",pageIndex:t||1,pageSize:10,isAsc:!1,includeClosed:!0};return r.trdProjectsShort(a)},e.initProjectShort=function(){selectFactory({data:[],isSearch:!0,isSaveInputVal:!0,pagination:!0,isUsePinyin:!0,id:"projectId",showTextField:"userName",defaultText:"请选择",searchPlaceHoder:"请输入名称或编码",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(t,r,a){e.customerData=e.getProjectShortData(r,a),angular.forEach(e.customerData.data,function(e,t){e.userName=e.name+"("+e.code+")"}),t.setData(e.customerData),e.$apply()},attrTextId:function(t){e.search.projectId=t||"",e.$apply()},attrTextModel:function(t){e.projectId=t,e.$apply()}}).open()},e.getCustomerIdData=function(e,t){e=e||"";var a={q:e?e.trim():"",pageIndex:t||1,pageSize:10,isAsc:!1,sortName:"",userType:"2"};return r.getEnterpriseNameTradeCustomer(a)},e.initCustomerId=function(){e.customerIdData=e.getCustomerIdData(),angular.forEach(e.customerIdData.data,function(e,t){e.userName=e.name+"("+e.code+")"});var t=selectFactory({data:e.customerIdData,isSearch:!0,isUsePinyin:!0,pagination:!0,id:"customerId",showTextField:"userName",defaultText:"请选择",searchPlaceHoder:"请输入账户名或编码",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(t,r,a){e.customerData=e.getCustomerIdData(r,a),angular.forEach(e.customerData.data,function(e,t){e.userName=e.name+"("+e.code+")"}),t.setData(e.customerData),e.$apply()},attrTextId:function(t){t?(e.search.customerId!=t&&(e.likedusernamelist=""),e.search.customerId=t):(e.search.customerId="",e.likedusernamelist=""),e.$apply()},attrTextModel:function(t){e.customerId=t,e.$apply()}});t.setData(e.customerIdData),t.open(),$("#customerId").val(e.customerId)};var p;if(e.initBusinessType=function(){p||(e.goodsTypeData=r.trdGoodTypeList(),p=selectFactory({data:e.goodsTypeData,id:"goodsType",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.statusValue=t||"AUDITING",e.$apply()},attrTextModel:function(t){e.status=t,e.$apply()}}),p.setData(e.goodsTypeData))},Calander.init({ele:["#sstartDate","#sendDate"],isClear:!0}),e.getSuppelierData=function(e,t){e=e||"";var a={q:e?e.trim():"",pageIndex:t||1,pageSize:10,isAsc:!1,sortName:""};return r.trdSuppelyList(a)},e.initSupplier=function(){selectFactory({data:[],isSearch:!0,defaultText:"请选择",pagination:!0,id:"supplierName",showTextField:"userName",attrTextField:{"ng-value":"id"},searchPlaceHoder:"请输入名称或编码",closeLocalSearch:!0,onSearchValueChange:function(t,r,a){e.suppelierData=e.getSuppelierData(r,a),angular.forEach(e.suppelierData.data,function(e,t){e.userName=e.name+" ("+e.code+")"}),t.setData(e.suppelierData),e.$apply()},attrTextId:function(t){e.search.customerId=t||"",e.clearGoods(),e.$apply()},attrTextModel:function(t,r,a){e.supplierName=t,e.$apply()}}).open()},e.getLikedusernamelistData=function(t,a){t=t||"";var o={q:t?t.trim():"",pageIndex:a||1,pageSize:10,isAsc:!1,sortName:"",userType:2,refCustomerId:e.search.customerId};return r.trdLikedusernamelist(o)},e.initLikedusernamelist=function(){e.suppelierData=e.getLikedusernamelistData(),angular.forEach(e.suppelierData.data,function(e,t){e.name=e.userName+" ("+e.fullName+")"});var t=selectFactory({data:e.suppelierData,isSearch:!0,isUsePinyin:!0,pagination:!0,defaultText:"请选择",searchPlaceHoder:"请输入姓名或用户名",id:"likedusernamelist",showTextField:"name",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(t,r,a){e.suppelierData=e.getLikedusernamelistData(r,a),angular.forEach(e.suppelierData.data,function(e,t){e.name=e.fullName+" ("+e.userName+")"}),t.setData(e.suppelierData),e.$apply()},attrTextId:function(t){e.search.cusUserId=t||"",e.$apply()},attrTextModel:function(t,r,a){e.likedusernamelist=t,e.$apply()}});t.setData(e.suppelierData),t.open(),$("#likedusernamelist").val(e.likedusernamelist)},e.checkConfirmOrderUrl=function(e){e.orderConfirmUrl?$("#confirmOrder-"+e.orderNo).attr("href",e.orderConfirmUrl):a.promptBox({msg:"尚未生成订单确认单!"})},e.checkDeliveryOrderUrl=function(e){e.orderDeliverUrl?$("#deliveryOrder-"+e.orderNo).attr("href",e.orderDeliverUrl):a.promptBox({msg:"尚未生成发货确认单!"})},"cockpit"===t.current.params.orderFrom){var m=t.current.params.cockpitPage,f=t.current.params.orderNo;e.getDetail(m,f)}}app.controller("tradeOrdersCtrl",["$scope","$route","tradeOrdersService","tradeOrdersView","tableService","$compile",e])});