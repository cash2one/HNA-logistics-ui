easySpa.require(["service/templateService"],function(){function e(e,t,o,a){function r(){var a="SALE"===e.orderType?1:2;t.getOrderStatusByOrderNo(e.orderNo,a).then(function(e){0==e.errorCode?s(e.data||{}):o.promptBox({msg:e.msg})})}function n(){setTimeout(function(){Calander.init({ele:"#createTime",isClear:!0}),Calander.init({ele:"#latestPayTime",isClear:!0}),Calander.init({ele:"#reachTime",isClear:!0})},0)}function d(){e.template.companyAddress="Sunrun Bunkering Limited\n4F HNA Tower\nNo. 898 Puming Road\nShanghai, China"}function c(){e.template.companyPhone="+862161759009",e.template.companyFax="+862161759000"}function i(){e.template.companyEmail="wang_ye@hnair.com",e.template.trader="YL"}function m(o,a){o=o||"",a||(a=1);var r={q:o?o.trim():"",pageIndex:a,pageSize:10,orderType:"SALE",businessType:2,projectId:e.projectId,purchaserId:e.purchaserId,sellId:e.sellerId};return t.getTrdGoodsShortList(r)}function l(){setTimeout(function(){e.goodsData=m(),e.goodsData.data.forEach(function(e){e.showName=e.goodsTypeName+": "+e.name+"("+e.code+")"}),selectFactory({data:e.goodsData,isSearch:!0,isUsePinyin:!0,id:"orderGood",isCreateNewSelect:!0,pagination:!0,defaultText:"请选择",searchPlaceHoder:"请输入名称或编码",showTextField:"showName",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(t,o,a){var r=m(o,a);r.data.forEach(function(e){e.showName=e.goodsTypeName+": "+e.name+"("+e.code+")"}),t.setData(r),e.$apply()},attrTextId:function(t){e.orderGoodId=t||"",e.$apply()},attrTextModel:function(t){e.orderGoodName=t,e.$apply()}}).setData(e.goodsData)},0)}function s(t){e.template=t,e.template.currencyUnit=e.template.orderGoods[0].goodsCurrencyType,e.template.InvoiceNo=(new Date).format("yyyyMMdd"),e.template.createTime=o.DataFormat((new Date).format("yyyy-MM-dd 00:00:00")),e.template.vat=0,e.template.purchaserCompanyName=t.purchaserCompanyName||t.purchaserCustomerName,e.template.purchaserCompanyName=o.StringInsertByInterval(e.template.purchaserCompanyName,"\n",30);for(var a=0;a<e.template.orderGoods.length;a++)e.template.orderGoods[a].goodsNum&&(e.template.orderGoods[a].goodsNum=e.template.orderGoods[a].goodsNum.toFixed(4)),e.template.orderGoods[a].goodsPrice&&(e.template.orderGoods[a].goodsPrice=e.template.orderGoods[a].goodsPrice.toFixed(2)),e.template.orderGoods[a].goodsName=o.StringInsertByInterval(e.template.orderGoods[a].goodsName,"\n",30);e.purchaserId="SALE"===t.orderType?t.purchaserCustomerId:t.purchaserId,e.projectId=t.projectId,e.sellerId=t.sellerId,d(),c(),i(),f=m()}function p(e,t){for(var o=1;t>0;o*=10,t--);for(;t<0;o/=10,t++);return Math.round(e*o)/o}function u(){var t=["custCompanyAddress","InvoiceNo","bankName","shipName","destinationPort","reachTime","trader","vat","latestPayTime","bankAddr","Swift","accountNo","holder","currencyUnit","companyAddress","companyPhone","companyFax","companyEmail","payCurrency"];for(t.forEach(function(t){e.template[t]||e.sunRunTemplate[t].$setDirty()}),a=0;a<e.template.orderGoods.length;a++)e.template.orderGoods[a].goodsNum||e.sunRunTemplate["goodsNum"+a].$setDirty();for(var o=$(".errors"),a=0;a<o.length;a++)if(!$(o[a]).hasClass("ng-hide"))return!1;return e.sunRunTemplate.$valid}e.IsEdit=!0,e.template={};var f={};e.addGoods=function(){function a(t){var o={goodsName:t.goodsName,goodsUnit:t.unit,goodsPrice:t.price.toFixed(2),goodsId:t.id,goodsCurrencyType:t.currencyType};e.template.orderGoods.push(o),e.template.currencyUnit=e.template.orderGoods[0].goodsCurrencyType}if(!e.orderGoodId)return void o.promptBox({msg:"请先选择商品!"});t.getGoodsOrderById(e.orderGoodId).then(function(e){0==e.errorCode&&a(e.data)})},e.initAccountNo=function(){e.sellerId&&(e.accountData=t.getAccountNoBySellId(e.sellerId),accountEle=selectFactory({data:{},id:"accountNo",showTextField:"accountNo",defaultText:"请选择",isCreateNewSelect:!0,isReadOnly:!1,attrTextModel:function(t,o,a){t?(e.template.accountNo=a.accountNo,e.template.bankName=a.bank,e.template.bankAddr=a.address,e.template.Swift=a.swift,e.template.holder=a.holder,e.template.payCurrency=a.currency):(e.template.accountNo="",e.template.bankName="",e.template.bankAddr="",e.template.Swift="",e.template.holder="",e.template.payCurrency=""),e.$apply()}}),setTimeout(function(){accountEle.setData(e.accountData),accountEle.open()},100))},function(){e.pageSize=1,n(),r(),l()}(),e.goodsToTal=function(e){var t=p(Number(e.goodsPrice*e.goodsNum),2);return isNaN(t)&&(t=0),e.amountDue=t.toFixed(2)},e.allGoodsToTal=function(t){if(!t)return e.template.noVat=0,e.template.noVat;var o=0;return t.forEach(function(e){var t=Number(e.amountDue);isNaN(t)||(o+=t)}),e.template.noVat=p(Number(o),2),e.template.noVat.toFixed(2)},e.totalAmount=function(){if(isNaN(e.template.vat)||!e.template.noVat)return void(e.totalWithVAT=0);var t=Number(e.template.noVat)+Number(e.template.vat);return e.totalWithVAT=p(Number(t),2),e.totalWithVAT.toFixed(2)},e.checkOne=function(t,o){t.checked=!t.checked;var a=!0;o.forEach(function(e){e.checked||(a=!1)}),e.isAllchecked=a},e.isAllchecked=!1,e.checkAll=function(t){e.isAllchecked=!e.isAllchecked,t.forEach(function(t){t.checked=e.isAllchecked})},e.deleteGoods=function(){var t=e.template.orderGoods;t.forEach(function(o,a){o.checked&&(t.splice(a,1),e.deleteGoods())}),e.isAllchecked&&(e.isAllchecked=!1)},e.goodsNum=function(e){return Number(e.goodsNum).toFixed(4)},e.Vat=function(e){return Number(e).toFixed(2)},e.goodsPrice=function(e){return Number(e.goodsPrice).toFixed(2)},e.template.remarkOne="",e.template.remarkTwo="",e.createTimeFormat=function(t){e.template.createTime=o.DataFormat(t)},e.reachTimeFormat=function(t){e.template.reachTime=o.DataFormat2(t)},e.latestPayTimeFormat=function(t){e.template.latestPayTime=o.DataFormat2(t)},e.confirm=function(){if(0==u())return void scrollToErrorView($("#form-content"));e.template.companyAddress=o.SectionBreakWord(e.template.companyAddress,40),e.template.custCompanyAddress=o.SectionBreakWord(e.template.custCompanyAddress,40),e.template.remarkOne=o.SectionBreakWord(e.template.remarkOne,100),e.template.remarkTwo=o.SectionBreakWord(e.template.remarkTwo,100),o.promptMidBox("",{msg:"确定提交信息？提交后不能修改！"},"",function(){var a={urlParams:encodeURIComponent($("#sunRunDeliverOrderConfirm").html()),seatParams:{orderNo:e.template.orderNo,type:2}};e.template.vat=Number(e.template.vat);var r=angular.copy(e.template);delete r.id,t.confirmTrdDeliveryOrder(r).then(function(r){0==r.errorCode?t.exportPDFByOrderNo(a,function(t){o.promptBox(t),e.fileUrl=t.data.fileUrl,e.pageSize=t.data.pageSize,e.IsEdit=!1,e.$apply()}):o.promptBox(r)})})}}app.controller("sunRunDeliveryConfirmController",["$scope","tradeOrdersService","tradeOrdersView","templateService",e])});