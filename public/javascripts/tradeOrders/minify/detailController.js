easySpa.require(["widget/select"],function(){app.controller("detail",["$scope","$route","tradeOrdersService","tradeOrdersView",function(e,r,o,t){function a(){"SALE"===e.data.orderType?(e.firstSelectName="销售方",e.secondSelectName="采购方"):"PURCHASE"===e.data.orderType&&(e.firstSelectName="采购方",e.secondSelectName="销售方")}function d(r){e.data.orderNo=r.orderNo,e.data.purchaserId=r.purchaserId,e.purchaserId=r.purchaserName+"("+r.purchaserUserName+")",e.purchaserCustomerId=r.purchaserCustomerId,e.data.projectId=r.projectId,e.projectId=r.projectName+"("+r.projectCode+")",e.data.orderStatusCode=r.orderStatusCode,e.data.orderStatus=r.orderStatus,e.orderChannel=r.orderChannel,e.data.projectId&&(e.orderGoodStatus=!1,e.projectIdStatus=!1),e.businessNo=r.businessNo,e.data.orderType=r.orderType,a(),e.data.sellerId=r.sellerId,e.sellerId=r.sellerName,"PURCHASE"===e.data.orderType&&(e.data.purchaserId=r.sellerId,e.purchaserId=r.sellerName+"("+r.sellerCode+")",e.data.sellerId=r.purchaserId,e.sellerId=r.purchaserName),e.data.customerNote=r.customerNote,r.orderGoods.forEach(function(e){e.name="goodsNum_"+e.goodsId}),e.data.orderGoods=r.orderGoods}function s(e){$("#orderDetail").animate({scrollTop:$("#"+e).offset().top},200)}function c(){var r=["sellerId","purchaserId","projectId"],o=!1;return r.forEach(function(r){e.data[r]||(e.form1[r].$setDirty(),o=!0)}),o?(s("baseInfo"),!0):(e.data.orderGoods.forEach(function(r){if(r.showError)return void(o=!0);var t=Number(r.minLimit),a=Number(r.maxLimit);if(!t&&!a)return r.showError="请输入起止范围 或 终止范围",void(o=!0);t&&!a?(isNaN(t)||t<=0||!/^\d+(?:\.\d{1,4})?$/.test(r.minLimit))&&(e.form3["goodsNum_"+r.goodsId+"minLimit"].$setDirty(),o=!0):!t&&a?(isNaN(a)||a<=0||!/^\d+(?:\.\d{1,4})?$/.test(r.maxLimit))&&(e.form3["goodsNum_"+r.goodsId+"maxLimit"].$setDirty(),o=!0):t&&a&&t>=a&&(o=!0);var d=Number(r.goodsPrice);!isNaN(d)&&0!==d&&/^\d+(?:\.\d{1,2})?$/.test(r.goodsPrice)||(e.form3[r.name+"_price"].$setDirty(),r.showPriceError="请输入数字，小数点后保留两位",o=!0)}),o?(s("goodsInfo"),!0):(0===e.data.orderGoods.length&&(t.promptBox({msg:"请添加商品!"}),o=!0),o))}function i(e,r){for(var o=1;r>0;o*=10,r--);for(;r<0;o/=10,r++);return Math.round(e*o)/o}function n(){e.data.projectId?e.orderGoodStatus=!1:e.orderGoodStatus=!0,e.orderGood="",e.data.orderGood="",e.data.orderGoods.length=0}function u(){e.data.sellerId&&e.data.purchaserId?e.projectIdStatus=!1:e.projectIdStatus=!0,e.projectId="",e.data.projectId="",n()}["projectId2","purchaserId","orderGood"].forEach(function(e){delete Select.sharePool[e]}),e.data={orderGoods:[],orderType:e.orderType};var m="";m="SALE"===e.orderType?1:2,e.orderGoodStatus=!0,e.projectIdStatus=!0,e.orderNo?o.getOneOrder(e.orderNo,m).then(function(r){0==r.errorCode&&(d(r.data),e.isInit=!0)}):a(),e.amountDue=function(e){var r=i(Number(e.goodsPrice*e.goodsNum),3);return isNaN(r)?0:e.amountDue=r},e.goComfirmBack=function(){if("cockpit"===r.current.params.from)window.location.href="#/cockpit?from=tradeOrder";else if(e.orderNo){var o=Lang.getValByKey("common","common_prompt_title"),a=Lang.getValByKey("common","common_back_confirm"),d=Lang.getValByKey("common","common_back_yes"),s=Lang.getValByKey("common","common_back_no");t.promptMidBox(o,{msg:a},d,function(){e.goBack(),$(document).promptBox("closePrompt")},"warning","delete",s)}else e.goBack()},e.validateGoodnum=function(r,o){r.showError="";var t=e.verOneGoodNum(r.minLimit),a=e.verOneGoodNum(r.maxLimit);t.result&&a.result||(r.showError=t.msg||a.msg),"min"==o?r.minLimit&&r.maxLimit&&Number(r.minLimit)>=Number(r.maxLimit)&&(r.showError="采购数量起始不能大于或等于终止"):"max"==o&&r.minLimit&&r.maxLimit&&Number(r.maxLimit)<=Number(r.minLimit)&&(r.showError="采购数量起始不能大于或等于终止")},e.verOneGoodNum=function(e){if(!$.trim(e))return{result:!0};var r=Number(e);if(!isNaN(r)&&r<=0)return{result:!1,msg:"必须大于零"};var o=e.toString().split(".");return o[0]&&o[o.length-1]?!/^(?:[-+]?(?:\d+))?(?:\.\d{1,4})?$/.test(r)||isNaN(e)?{result:!1,msg:"请输入数字，小数点后保留四位"}:{result:!0}:{result:!1,msg:"请输入数字，小数点后保留四位"}},e.validateGoodPrice=function(e){if(e.showPriceError="",""===e.goodsPrice)return void(e.showPriceError="不能为空");var r=Number(e.goodsPrice);return!isNaN(r)&&r<=0?void(e.showPriceError="必须大于零"):!/^(?:[-+]?(?:\d+))?(?:\.\d{1,2})?$/.test(e.goodsPrice)||isNaN(r)?void(e.showPriceError="请输入数字，小数点后保留两位"):void 0},e.cancel=function(){e.goBack("fresh")},e.save=function(r){if(!c()){var a=angular.copy(e.data);r&&(a.orderStatus=r);var d=[];a.orderGoods.forEach(function(e){d.push({amountDue:e.amountDue,goodsId:e.goodsId,minLimit:e.minLimit,maxLimit:e.maxLimit,goodsPrice:e.goodsPrice})}),a.orderGoods=d;for(var s=!1,i=0;i<d.length-1;i++)if(d[i].goodsCurrencyType!=d[i+1].goodsCurrencyType){s=!0;break}if(s)return void t.promptBox({msg:"所选商品币种不一致！"});var n;if("采购方"===e.firstSelectName&&(n=a.purchaserId,a.purchaserId=a.sellerId,a.sellerId=n),a.businessNo=e.businessNo,a.trdOrderFileRels=e.result,e.data.orderStatusCode&&"1"!=e.data.orderStatusCode)var u="确定保存修改？";else{var u="确定保存草稿？";r&&(u="确定提交订单?")}t.promptMidBox("",{msg:u},"",function(){e.orderNo?o.updateOrder(a).then(function(r){t.promptBox(r),0==r.errorCode&&setTimeout(function(){e.goBack("fresh")},500)}):o.saveOrder(a).then(function(r){t.promptBox(r),0==r.errorCode&&setTimeout(function(){e.goBack("fresh")},500)})})}},e.addGoods=function(){function r(r){var o={goodsName:r.goodsName,goodsType:r.goodsType,goodsHSCode:r.hsCode,goodsUnit:r.unit,goodsPrice:r.price,goodsId:e.data.orderGood,name:"goodsNum_"+e.data.orderGood,goodsCurrencyType:r.currencyType};e.data.orderGoods.push(o)}if(!e.data.orderGood)return void t.promptBox({msg:"请先选择商品!"});o.getGoodsOrderById(e.data.orderGood).then(function(e){0==e.errorCode&&r(e.data)})},e.deleteGoods=function(){var r=e.data.orderGoods;r.forEach(function(o,t){o.checked&&(r.splice(t,1),e.deleteGoods())}),e.isAllchecked&&(e.isAllchecked=!1)},e.getProjectShortData=function(r,t){r=r||"";var a={project:r?r.trim():"",pageIndex:t||1,pageSize:10,isAsc:!1,sortName:"",sellerId:e.data.sellerId,purchaserId:e.purchaserCustomerId,orderType:e.data.orderType};return"PURCHASE"===e.data.orderType&&(a.sellerId=e.purchaserCustomerId,a.purchaserId=e.data.sellerId),o.trdProjectsShort(a)},e.initProjectShort2=function(){selectFactory({data:[],isSearch:!0,isUsePinyin:!0,id:"projectId2",showTextField:"userName",defaultText:"请选择",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,pagination:!0,onSearchValueChange:function(r,o,t){e.customerData=e.getProjectShortData(o,t),angular.forEach(e.customerData.data,function(e,r){e.userName=e.name+"("+e.code+")"}),r.setData(e.customerData),e.$apply()},attrTextId:function(r){e.data.projectId!=r&&(e.data.projectId=r||"",n(),e.$apply())},attrTextModel:function(r){e.projectId=r,e.$apply()}}).open()},initSaleId=function(){o.platcompanys().then(function(r){t.initNgSelect(e,"#sellerId",r,function(r){e.data.sellerId!=r.id&&(e.sellerId=r.name,e.data.sellerId=r.id,u())})})},initSaleId(),initOrderType=function(){o.orderType().then(function(r){t.initNgSelect(e,"#ngOrderType",r,function(r){e.orderType=r.name,e.data.orderType=r.code,e.purchaserId="",e.data.purchaserId="","SALE"===e.data.orderType?(e.firstSelectName="销售方",e.secondSelectName="采购方"):"PURCHASE"===e.data.orderType&&(e.firstSelectName="采购方",e.secondSelectName="销售方")})}),e.data.orderType||(e.data.orderType="SALE",e.orderType="销售订单",e.firstSelectName="销售方",e.secondSelectName="采购方")},e.getOrderGoodsData=function(r,t){r=r||"";var a={q:r?r.trim():"",pageIndex:t||1,pageSize:10,isAsc:!1,sortName:"",orderType:e.orderType,businessType:"2"};return e.data.projectId?a.projectId=e.data.projectId:delete a.projectId,"PURCHASE"==e.orderType?(a.purchaserId=e.data.sellerId,a.sellId=e.data.purchaserId):(a.purchaserId=e.purchaserCustomerId,a.sellId=e.data.sellerId),o.getTrdGoodsShortList(a)},e.initOrderGood=function(){e.goodsData=e.getOrderGoodsData(),e.goodsData.data.forEach(function(e){e.showName=e.goodsTypeName+": "+e.name+"("+e.code+")"});var r=selectFactory({data:e.goodsData,isSearch:!0,isUsePinyin:!0,id:"orderGood",pagination:!0,defaultText:"请选择",searchPlaceHoder:"请输入名称或编码",showTextField:"showName",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(r,o,t){e.customerData=e.getOrderGoodsData(o,t),e.customerData.data.forEach(function(e){e.showName=e.goodsTypeName+": "+e.name+"("+e.code+")"}),r.setData(e.customerData),e.$apply()},attrTextId:function(r){e.data.orderGood=r||"",e.$apply()},attrTextModel:function(r){e.orderGood=r,e.$apply()}});r.setData(e.goodsData),r.open(),$("#purchaseCustomerIds").val(e.orderGood)},e.getPurchaserIdData=function(r,t){r=r||"";var a={q:r?r.trim():"",pageIndex:t||1,pageSize:10,isAsc:!1,sortName:"",userType:"2"};return"PURCHASE"===e.data.orderType?o.getEnterpriseNameTradeSupplier(a):"SALE"===e.data.orderType?o.getTradeCustomerUsernamelist(a):void 0},e.initPurchaserId=function(){var r="";"PURCHASE"===e.data.orderType?r="请输入名称或编码":"SALE"===e.data.orderType&&(r="请输入姓名或用户名"),selectFactory({data:[],isSearch:!0,id:"purchaserId",showTextField:"uiName",searchPlaceHoder:r,defaultText:"请选择",pagination:!0,attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(r,o,t){e.customerData=e.getPurchaserIdData(o,t),e.customerData.data.forEach(function(e){e.name?e.uiName=e.name+"("+e.code+")":e.uiName=e.fullName+"("+e.userName+")"}),r.setData(e.customerData),e.$apply()},attrTextId:function(r){e.data.purchaserId!=r&&(e.data.purchaserId=r||"",u(),e.$apply())},attrTextModel:function(r,o,t){e.purchaserId=r,e.purchaserCustomerId=t.customerId||t.id,e.$apply()}}).open()},e.checkOne=function(r,o){r.checked=!r.checked;var t=!0;o.forEach(function(e){e.checked||(t=!1)}),e.isAllchecked=t},e.isAllchecked=!1,e.checkAll=function(r){e.isAllchecked=!e.isAllchecked,r.forEach(function(r){r.checked=e.isAllchecked})}}])});