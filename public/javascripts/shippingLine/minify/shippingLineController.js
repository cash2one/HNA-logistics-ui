easySpa.require(["widget/slimscroll","widget/prompt","widget/select","public/common/tableController.js","widget/slides"],function(){app.controller("shippingLineCtrl",["$scope","shippingLineService","shippingLineView","tableService",function(t,e,a,r){function n(t){var e=t.next;if(null!=e)return e.clearData(),e.id=null,n(e)}function o(t,a){if(a||(a=e.getShippingPort()),t){a=a.data;for(var r=0;r<a.length;r++){var n=a[r].name;if($.trim(n)==$.trim(t)||$.trim(a[r].name)==$.trim(t))return a[r].id}return"无匹配结果"}}function i(){for(var e=0;e<t.attachPortList.length;e++){var a=e;Select.sharePool["attachPort-"+a]=null;selectFactory({data:t.addAttachPorts,id:"attachPort-"+a,isSearch:!0,pagination:!0,height:240,closeLocalSearch:!0,searchPlaceHoder:"请输入名称",defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(e,a,r){var n=t.getCurrentShippingData(a,r);p(n),e.setData(n)},attrTextModel:function(e,r,n){e?(t.attachPortList[a].attachPort=n.name,t.attachPortList[a].attachPortCode=o(e,r),t.$apply()):(t.attachPortList[a].attachPort="",t.attachPortList[a].attachPortCode="")}})}}function d(t,a,r){var n={seatParams:{countryId:r||"",pageIndex:a||1,pageSize:10,q:t?t.trim():""}};return e.getPortListByCountryId(n)}function p(t){for(var t=t.data,e=0;e<t.length;e++)t[e].name=t[e].name+"("+t[e].englishName+")"}t.shippingLine={id:0},t.getLanguage=function(){e.getLanguage(function(e){0===e.errorCode&&(t.language=e.data)})},t.getLanguage(),t.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("shippingLine","shippingLine_page_name"),Lang.getValByKey("shippingLine","shippingLine_page_code"),Lang.getValByKey("shippingLine","shippingLine_page_type"),Lang.getValByKey("shippingLine","shippingLine_page_starPort"),Lang.getValByKey("shippingLine","shippingLine_page_endPort"),Lang.getValByKey("shippingLine","shippingLine_page_line"),Lang.getValByKey("common","common_page_remarks")],tableBody:[],restURL:"logistics.getShippingLineTable",restData:{q:"",countryCodeFrom:"",codeStart:"",countryCodeTo:"",codeEnd:"",pageIndex:1,pageSize:10,sort:""},selectNumber:0,selectFlag:!1},t.getTable=function(e){t.q=t.tableModel.restData.q,t.tableModel.restData.countryCodeFrom=t.countryStartSearchCode,t.tableModel.restData.codeStart=t.codeStart,t.tableModel.restData.countryCodeTo=t.countryEndSearchCode,t.tableModel.restData.codeEnd=t.codeEnd,e&&(t.tableModel.restData.pageIndex=1);var a={urlParams:t.tableModel.restData};r.getTable(t.tableModel.restURL,a,function(e){if(0===e.errorCode){t.tableModel=r.table(t.tableModel,a,e);var n=$(".shipping-table-page").height()-330;setTimeout(function(){$(".table-container tbody").slimscroll({height:n}),$(window).resize(function(){n=$(".shipping-table-page").height()-330,$(".table-container tbody").slimscroll({height:n})})},10)}})},t.getTable(),t.clearData=function(){t.tableModel.restData.q="",t.q="",t.tableModel.restData.pageIndex=1,t.tableModel.restData.countryCodeFrom="",t.tableModel.restData.countryCodeTo="",t.tableModel.restData.codeStart="",t.tableModel.restData.codeEnd="",t.countryStartSearchCode="",t.countryStartSearch="",t.airportStartSearch="",t.codeStart="",t.countryEndSearchCode="",t.countryEndSearch="",t.airportEndSearch="",t.codeEnd="",t.getTable()};var c=$("#nest-ShippingLineForm .label-text");a.propmtCostEvent(c),t.add=function(){t.ShippingLineForm.$setPristine(),t.ShippingLineForm.$setUntouched(),t.nestShippingLineForm=!0,$("#nest-ShippingLineForm").attr("style","").find(".title").text(Lang.getValByKey("shippingLine","shippingLine_page_add")),$(".remote-invalid").removeClass("remote-invalid"),t.attachPortList=[{attachPort:"",attachPortCode:""}],t.shippingLineName="",t.shippingLineCode="",t.addShippingLineType="",t.addShippingLineTypeCode="",t.addStartPort="",t.addEndPort="",t.addStartPortCode="",t.addEndPortCode="",t.remark="",t.textareaNumber=140,setTimeout(function(){i(),t.$apply()},200),a.loadBarEvent(c),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},t.checkShippingLineCode=function(){var a={urlParams:{code:t.shippingLineCode,id:t.shippingLine.id}};t.shippingLineCode&&e.checkShippingLineCode(a,function(e){0!=e.errorCode?(t.ShippingLineForm.shippingLineCode.errorTips="编码已存在",$("#code-msg-code").removeClass("ng-hide").addClass("remote-invalid"),angular.element($(".validate-code").addClass("ng-invalid"))):($("#code-msg-code").addClass("ng-hide").removeClass("remote-invalid"),t.ShippingLineForm.shippingLineCode.errorTips="",angular.element($(".validate-code").removeClass("ng-invalid")))})},t.edit=function(r){t.shippingLine.id=r,t.addStartPort="",t.addEndPort="",t.addStartPortCode="",t.addEndPortCode="",$(".remote-invalid").removeClass("remote-invalid"),$("#nest-ShippingLineForm").attr("style","").find(".title").text("海运航线详情"),t.nestShippingLineForm=!0,a.loadBarEvent(c),$('button[name="prompt-save"]').addClass("save").removeClass("edit"),setTimeout(function(){i(),t.$apply()},200),e.getDetail({seatParams:{id:r}},function(e){if(e&&0===e.errorCode){var a=e.data.ports,r=a.length;t.shippingLineName=e.data.name,t.shippingLineCode=e.data.code,t.addShippingLineType=e.data.typeName,t.addShippingLineTypeCode=e.data.type,t.addStartPort=a[0].portName+"("+a[0].portEnglishName+")",t.addEndPort=a[r-1].portName+"("+a[r-1].portEnglishName+")",t.addStartPortCode=a[0].portId,t.addEndPortCode=a[r-1].portId,r>2&&(t.attachPortList=[],angular.forEach(a,function(e,n){if(0!=n&&n!=r-1){var o={attachPort:e.portName+"("+a[0].portEnglishName+")",attachPortCode:e.portId};t.attachPortList.push(o)}})),t.remark=e.data.description,t.textareaNumber=140-(t.remark?t.remark.length:0)}})},t.showTextNumber=function(){t.textareaNumber=140-t.remark.length},t.del=function(){var n={},o=[],i=r.getSelectTable(t.tableModel.tableBody);if(!i.length)return a.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;angular.forEach(i,function(t){o.push(t.id)}),n={urlParams:o};var d={title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("shippingLine","shippingLine_code_modelDelTips")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){e.del(n,function(e){a.promptBox("closePrompt"),0===e.errorCode?(a.promptBox({isDelay:!0,contentDelay:e.msg,type:"success"}),t.getTable(),t.$apply()):a.promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})}}]};a.promptBox(d)},t.cancel=function(){$("#add-startPort, #add-endPort").removeAttr("style"),t.nestShippingLineForm=!1,$("#code-msg-code").addClass("ng-hide").removeClass("remote-invalid"),t.ShippingLineForm.shippingLineCode.errorTips="",t.attachPortList=[{attachPort:"",attachPortCode:""}],t.shippingLine.id&&(t.shippingLine.id=0)},t.save=function(){if(t.shippingLineName=void 0===t.shippingLineName?"":t.shippingLineName,t.shippingLineCode=void 0===t.shippingLineCode?"":t.shippingLineCode,t.shippingLineName.trim()||t.ShippingLineForm.shippingLineName.$setDirty(),t.shippingLineCode.trim()||t.ShippingLineForm.shippingLineCode.$setDirty(),t.addShippingLineType||t.ShippingLineForm.addShippingLineType.$setDirty(),t.addStartPort||t.ShippingLineForm.addStartPort.$setDirty(),t.addEndPort||t.ShippingLineForm.addEndPort.$setDirty(),$("#code-msg").hasClass("remote-invalid")||$("#code-msg-code").hasClass("remote-invalid")||!t.ShippingLineForm.$valid||"rgb(250, 120, 126)"==$("#add-startPort").css("border-color")||"rgb(250, 120, 126)"==$("#add-endPort").css("border-color"))return scrollToErrorView($(".switch-list")),void a.displayErrorBox(c);var r=[];if(t.attachPortList[0].attachPort){var n={};r.push({portId:t.addStartPortCode}),angular.forEach(t.attachPortList,function(t,e){n={portId:t.attachPortCode},r.push(n)}),r.push({portId:t.addEndPortCode})}else r.push({portId:t.addStartPortCode}),r.push({portId:t.addEndPortCode});var o={urlParams:{name:t.shippingLineName.trim(),code:t.shippingLineCode.trim(),type:t.addShippingLineTypeCode,ports:r,description:t.remark}};t.shippingLine.id?(o.seatParams={id:t.shippingLine.id},e.saveEdit(o,function(e){e&&0===e.errorCode?(a.promptBox({isDelay:!0,contentDelay:e.msg,type:"success"}),t.nestShippingLineForm=!1,t.getTable(),t.shippingLine.id&&(t.shippingLine.id=0),t.attachPortList=[{attachPort:"",attachPortCode:""}]):a.promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})):e.save(o,function(e){e&&0===e.errorCode?(a.promptBox({isDelay:!0,contentDelay:e.msg,type:"success"}),t.nestShippingLineForm=!1,t.getTable(),t.attachPortList=[{attachPort:"",attachPortCode:""}]):a.promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})};var s,l,h,g,m,u,y;t.initSelectList=function(){var r={urlParams:{q:"",pageIndex:1,pageSize:10},isAsync:!0},i={urlParams:{catalog:"biz.linetype.base"}};t.countryStartSearchs=t.countryEndSearchs=e.getCountry(r),t.addShippingLineTypes=e.getShippingLineType(i),t.addStartPorts=t.addEndPorts=t.addAttachPorts=e.getShippingPort(r),s=selectFactory({data:t.countryStartSearchs,isSearch:!0,id:"countryStartSearch",pagination:!0,closeLocalSearch:!0,searchPlaceHoder:"请输入名称或二字码",onSearchValueChange:function(e,a,r){t.countryStartSearchs=t.getCountryData(a,r),e.setData(t.countryStartSearchs)},attrTextModel:function(e,a,r){t.countryStartSearchCode=r.figureCode,t.countryStartSearch=e,t.airportStartSearch="",t.codeStart="",t.$apply(),n(s)}}),l=selectFactory({data:[],isSearch:!0,id:"airportStartSearch",pagination:!0,closeLocalSearch:!0,searchPlaceHoder:"请输入名称",onSearchValueChange:function(e,a,r){t.airportStartSearchs=d(a,r,t.countryStartSearchCode),p(t.airportStartSearchs),e.setData(t.airportStartSearchs)},attrTextModel:function(e,a,r){t.airportStartSearch=r.name,t.codeStart=r.englishName,t.$apply()}}),h=selectFactory({data:t.countryEndSearchs,isSearch:!0,id:"countryEndSearch",pagination:!0,closeLocalSearch:!0,searchPlaceHoder:"请输入名称或二字码",onSearchValueChange:function(e,a,r){t.countryEndSearchs=t.getCountryData(a,r),e.setData(t.countryEndSearchs)},attrTextModel:function(e,a,r){t.countryEndSearchCode=r.figureCode,t.countryEndSearch=e,t.cityEndSearch="",t.cityEndSearchCode="",t.airportEndSearch="",t.codeEnd="",t.$apply(),n(h)}}),g=selectFactory({data:[],isSearch:!0,id:"airportEndSearch",pagination:!0,closeLocalSearch:!0,searchPlaceHoder:"请输入名称",onSearchValueChange:function(e,a,r){t.airportEndSearchs=d(a,r,t.countryEndSearchCode),p(t.airportEndSearchs),e.setData(t.airportEndSearchs)},attrTextModel:function(e,a,r){t.airportEndSearch=r.name,t.codeEnd=r.englishName,t.$apply()}}),m=selectFactory({data:t.addShippingLineTypes,id:"add-shippingLineType",defaultText:"",attrTextModel:function(e,a,r){t.addShippingLineType=r.name,t.addShippingLineTypeCode=r.code,t.$apply()}}),u=selectFactory({data:t.addStartPorts,isSearch:!0,id:"add-startPort",pagination:!0,height:240,closeLocalSearch:!0,searchPlaceHoder:"请输入名称",defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(e,a,r){t.addStartPorts=t.getCurrentShippingData(a,r),p(t.addStartPorts),e.setData(t.addStartPorts)},attrTextModel:function(e,r,n){null===n.cityId||null===n.countryId?(angular.element("#add-startPort").css("borderColor","#FA787E"),a.promptBox({isDelay:!0,contentDelay:"港口信息错误",type:"errer",manualClose:!1})):angular.element("#add-startPort").removeAttr("style"),t.addStartPortCode=o(e,r),t.addStartPort=n.name,t.addEndPort==t.addStartPort&&($("#add-startPort").val(""),t.addStartPort=""),t.$apply()}}),y=selectFactory({data:t.addEndPorts,id:"add-endPort",isSearch:!0,pagination:!0,height:240,closeLocalSearch:!0,searchPlaceHoder:"请输入名称",defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(e,a,r){t.addEndPorts=t.getCurrentShippingData(a,r),p(t.addEndPorts),e.setData(t.addEndPorts)},attrTextModel:function(e,r,n){null===n.cityId||null===n.countryId?(angular.element("#add-endPort").css("borderColor","#FA787E"),a.promptBox({isDelay:!0,contentDelay:"港口信息错误",type:"errer",manualClose:!1})):angular.element("#add-endPort").removeAttr("style"),t.addEndPortCode=o(e,r),t.addEndPort=n.name,t.addEndPort==t.addStartPort&&($("#add-endPort").val(""),t.addEndPort=""),t.$apply()}})},t.getCountryData=function(t,a){a||(a=1),t=t||"";var r={urlParams:{q:t,pageIndex:a,pageSize:10}},n=e.getCountry(r);return angular.forEach(n.data,function(t,e){t.name+="("+t.code+")"}),n},t.getCityList=function(t,a,r){a||(a=1);var n={urlParams:{countryCode:r,parentId:r,q:t?t.trim():"",pageIndex:a,pageSize:10}};return e.getCity(n)},t.getCurrentShippingData=function(t,a){a||(a=1),t=t||"";var r={urlParams:{q:t,pageIndex:a,pageSize:10,includeAllAudit:!0},isAsync:!0};return e.getShippingPort(r)},t.attachPortList=[{attachPort:"",attachPortCode:""}],t.setAttachPortList=function(e){var a="attachPort-"+e;Select.sharePool[a].setData(t.addAttachPorts)},t.addAttachPort=function(){for(var e=0;e<t.attachPortList.length;e++)if(""==$.trim(t.attachPortList[e].attachPort))return;t.attachPortList.push({attachPort:"",attachPortCode:""}),setTimeout(function(){i(),t.$apply()},200)},t.deleteAttachPort=function(){t.attachPortList.splice(t.attachPortList.length-1,1)}}])});