easySpa.require(["widget/prompt","widget/select","widget/calander"],function(){app.controller("logisticsCtrl",["$scope","logisticsService","logisticsView",function(e,t,i){e.showMsg=function(e,t){$(document).promptBox({isDelay:!0,contentDelay:e,type:t,time:3e3,manualClose:"errer"===t})},e.data={orderNumType:"1"};var o=function(){orderNumTypeEle=selectFactory({data:[],id:"typeList",isSaveInputVal:!1,maxHeight:160,isCreateNewSelect:!0,showTextField:"operTypeName",direction:"up",attrTextField:{"ng-value":"operType"},attrTextId:function(t,i){e.logisticsModel.typeCode=t},defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(t,i){e.logisticsModel.tplCode="",e.logisticsModel.tplName="",e.logisticsModel.params=null;var o=i.data.find(function(e){return e.operTypeName==t});if(e.logisticsModel.typeName=t,o){var a=o.codeDtoList;a&&a.map(function(e){-1==e.messageTemplate.indexOf("(")&&e.code&&(e.messageTemplate+="("+(e.code||"")+")")}),e.setTpl({data:a})}else e.setTpl({data:[]});e.formCheck(),e.$apply()}});var i={},o=function(t){0==t.errorCode?(t.data.map(function(e){e.operTypeName=e.operTypeName+"("+e.operType+")"}),orderNumTypeEle.setData(t)):e.showMsg(t.msg,"errer")};t.getType(i,o)},a=function(e){var t=e.next;if(null!=t)return t.clearData(),t.id=null,a(t)};e.setTpl=function(t){tplEle=selectFactory({data:[],id:"orderStatus",isSaveInputVal:!1,maxHeight:160,isCreateNewSelect:!1,attrTextField:{"ng-value":"code"},direction:"down",showTextField:"messageTemplate",attrTextId:function(t,i){e.logisticsModel.tplCode=t},defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(t,i){var o=i.data.find(function(e){return e.messageTemplate==t});e.logisticsModel.tplName=t,e.logisticsModel.params=o.params,e.logisticsModel.params=e.logisticsModel.params.map(function(e){;""}),e.formCheck(),a(tplEle),e.$apply()}}),tplEle.setData(t),orderNumTypeEle&&(orderNumTypeEle.next=tplEle)},e.formCheck=function(){if(e.formSubmit){var t=!1;$.trim($("#content").val())?$("#content").removeClass("error"):($("#content").addClass("error"),t=!0);for(var i=[{modelName:"updateTime",id:"updateTime"},{modelName:"tplName",id:"orderStatus"}],o=0,a=i.length;o<a;o++)""==e.logisticsModel[i[o].modelName]||void 0==e.logisticsModel[i[o].modelName]?($("#"+i[o].id).addClass("error"),t=!0):$("#"+i[o].id).removeClass("error");if(e.logisticsModel.params)for(var r=[{id:"placeA",verificationId:"placeAInvalidTip",reg:/^([\w\u4E00-\u9FA5_\-]+)+$/,errorTips:Lang.getValByKey("logistics","logistics_input_validation")},{id:"placeB",verificationId:"placeBInvalidTip",reg:/^([\w\u4E00-\u9FA5_\-]+)+$/,errorTips:Lang.getValByKey("logistics","logistics_input_validation")}],o=0,a=e.logisticsModel.params.length;o<a;o++)e.logisticsModel.params[o]?r[o].reg.test(e.logisticsModel.params[o])?($("#"+r[o].id).removeClass("error"),e[r[o].verificationId]=null):($("#"+r[o].id).addClass("error"),e[r[o].verificationId]=r[o].errorTips,t=!0):($("#"+r[o].id).addClass("error"),e[r[o].verificationId]=null,t=!0);return t}},e.delInvalid=function(t){var o=t||window.event;i.delInvalid(e,o)},e.reShowTextarea=function(){i.reShowTextarea(e)},e.isValid=function(t){var o=t||window.event;i.isValid(e,o),e.formCheck()},e.update=function(){e.formSubmit=!0;if(e.formCheck())return void scrollToErrorView($(".logistic"));var o=i.getOrderNumList(),a={urlParams:{type:Number(e.data.orderNumType),code:e.logisticsModel.tplCode,contentList:o,messageTime:e.logisticsModel.updateTime,params:e.logisticsModel.params}};t.addLogisticsInfo(a,function(t){0==t.errorCode?(e.showMsg(t.msg,"success"),e.init(!0,Number(e.data.orderNumType)),e.invalidList=t.data||[]):(e.showMsg(t.msg,"errer"),e.invalidList=t.data||[])})},e.init=function(t,a){e.textValue=$("#content").val();var r=this;$(".error").removeClass("error"),logisticsForm.reset(),e.logisticsForm&&e.logisticsForm.content&&e.logisticsForm.content.$setPristine(),e.formSubmit=!1,e.logisticsModel={updateTime:""},o(),t&&$("#content").val(e.textValue.trim()),e.data.orderNumType=a||1,e.showTextarea=!0,e.invalidList=[],e.$watchGroup(["logisticsModel.tplName","logisticsModel.updateTime","logisticsModel.params"],function(){r.formCheck()}),$("#updateTime")&&$("#updateTime").datetimepicker("destroy"),i.initCalander()},e.init()}])});