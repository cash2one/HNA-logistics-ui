easySpa.require(["public/common/pictureController.js","widget/prompt","widget/select","widget/parseUrl","widget/slimscroll/","widget/slides"],function(){app.controller("projectCheckCtrl",["$scope","projectCheckService","projectCheckView","pictureService",function(e,t,o,i){e.projectId=window.parseUrl.getParams().id,e.identityName=sessionStorage.getItem("identityName"),e.identity=sessionStorage.getItem("identity"),e.isPass=Number(sessionStorage.getItem("isPass")),e.projectAction=sessionStorage.getItem("projectAction"),e.qaFiles=[],e.checkResult="qa",e.showCheckInput=!1,e.questionId="",e.checkResultOpinion="",e.qaList=[],e.pictureModel={edit:!0,uploadShow:!0,picture:[],accept:"image/jpg,image/jpeg,image/png,image/bmp,image/tiff,application/pdf"};var n={data:[{name:"拒绝",code:"false"},{name:"同意",code:"true"}]};selectFactory({data:n,id:"checkResult",showTextField:"name",attrTextField:{"ng-value":"code"},defaultText:"",attrTextId:function(t){e.checkResultCode=t,e.$apply()},attrTextModel:function(t){e.checkResultName=t,e.$apply()}}),e.goback=function(){var e=sessionStorage.getItem("detailPath");top.location.href="http://"+location.host+e+"&tab=1"},e.getApprvoalInfo=function(){var o=sessionStorage.getItem("identityName");t.getApprvoalInfo({urlParams:{type:o},seatParams:{projectId:e.projectId}},function(t){e.approvalInfo=t.data,e.qaList=t.data.projectQuestionDtoList;for(var o=t.data.projectQuestionDtoList.map(function(e){return e.projectFileDtos}),i=0,n=o.length;i<n;i++)for(var a=0;a<o[i].length;a++)e.pictureModel.picture.push({name:o[i][a].fileName,picUrl:o[i][a].filePath,picUrlID:{id:o[i][a].fileId,path:o[i][a].filePath,type:o[i][a].contentType}});e.checkResultOpinion=t.data.msg,e.isPass=t.data.isPass,e.checkResult="null"===t.data.isPass?"qa":t.data.isPass.toString()})},e.getFile=function(t){for(var o=0;o<t.length;o++){var n=i.uploadFile(e.pictureModel,t[o]);if(!n)return;n.errorlocal?$(document).promptBox({isDelay:!0,contentDelay:n.errorlocal,type:"errer",manualClose:!0}):(e.uploadDisabled=!0,n.then(function(t){0===t.data.errorCode?(e.uploadDisabled=!1,e.pictureModel=i.updateModel(e.pictureModel,t.data.data),e.qaFiles.push(t.data.data),$(document).promptBox({isDelay:!0,contentDelay:t.data.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.data.msg,type:"errer",manualClose:!0})}))}},e.getPictureUrl=function(t){$("#slides").picturePreview({pictureId:t},e.pictureModel.picture)},e.delFile=function(t){$(document).promptBox({title:"提示",type:"success",content:{tip:"确认删除此文件?"},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),application:"confirm",operationEvent:function(){e.pictureModel.picture.splice(t,1),e.qaFiles.splice(t,1),$(document).promptBox("closePrompt"),$(document).promptBox({isDelay:!0,contentDelay:"删除成功！",type:"success",manualClose:!1}),e.$apply()}}]})},e.$watch("checkResult",function(t,o){"qa"!==t&&(e.opinionHolder="",e.formError=!1),"qa"!==t&&"qa"!==o||(e.checkResultOpinion="")}),e.$watch("checkResultOpinion",function(t){""!==t&&(e.formError=!1)}),e.answerQuestion=function(t,o){e.questionId=t,e.showCheckInput=!0;var i=e.qaList[o].content;i=-1!==i.indexOf("...")?i.substr(i.indexOf("...")+3):i,e.opinionHolder="回复主题："+i.substr(0,10)+"..."},e.cancelAnswer=function(){e.questionId="",e.opinionHolder="",e.checkResultOpinion="",e.showCheckInput=!1},e.postQuestion=function(){t.postQuestion({seatParams:{projectId:e.projectId},urlParams:{content:e.checkResultOpinion,type:e.identityName}},function(t){if(0===t.errorCode){e.questionId="",e.opinionHolder="",e.showCheckInput=!1,e.getApprvoalInfo();var o=$(window.frames.iframe.document).find(".check-qa");o.scrollTop(o[0].scrollHeight)}else $(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer"})})},e.postAnswer=function(){var o=[];e.qaFiles.length&&(o=e.qaFiles.map(function(e){return e.id})),t.postAnswer({seatParams:{projectId:e.projectId,questionId:e.questionId},urlParams:{questionId:e.questionId,content:e.opinionHolder+e.checkResultOpinion,type:e.identityName,fileIds:o.join(",")}},function(t){if(0===t.errorCode){e.questionId="",e.opinionHolder="",e.showCheckInput=!1,e.qaFiles=[],e.getApprvoalInfo();var o=$(window.frames.iframe.document).find(".check-qa");o.scrollTop(o[0].scrollHeight)}else $(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer"})})},e.checkDone=function(){if(!e.checkResultOpinion)return void(e.formError=!0);if(console.log(e.checkResult,e.projectAction),"qa"===e.checkResult)"2"===e.projectAction&&(e.questionId?e.postAnswer():e.postQuestion()),"1"===e.projectAction&&e.postAnswer();else{var o={type:e.identityName,msg:e.checkResultOpinion,isPass:e.checkResult};t.postOpinion({seatParams:{projectId:e.projectId},urlParams:o},function(t){0===t.errorCode&&($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),"true"===e.checkResult?e.goback():top.location.href="http://"+location.host+sessionStorage.getItem("managePath"))})}},e.getApprvoalInfo()}])});