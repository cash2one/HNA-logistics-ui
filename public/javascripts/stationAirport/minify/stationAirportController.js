easySpa.require(["widget/slimscroll","widget/nestable","widget/prompt","widget/tab","public/common/tableController.js","widget/tab","widget/select"],function(){app.controller("stationAirportCtrl",["$scope","stationAirportService","stationAirportView","tableService",function(t,e,a,r){function o(){function e(){$(".table-container tbody").slimscroll({height:$(".content-main").height()-270})}var a={urlParams:t.tableModel.restData};r.getTable(t.tableModel.restURL,a,function(e){0===e.errorCode&&(t.tableModel=r.table(t.tableModel,a,e))}),e(),$(window).on("resize",e)}function i(t){if(t)for(var e=0;e<t.length;e++)t[e].name=t[e].name+"("+t[e].code+")"}function n(a){var r={urlParams:{countryCode:t.countrySearchId,parentId:t.countrySearchId,q:a?a.trim():""},isAsync:!0};return e.getCity(r)}function c(t){var e=t.next;if(null!=e)return e.clearData(),e.id=null,c(e)}function l(t,e){for(var e=e.data,a=0;a<e.length;a++)if(e[a].name==t)return e[a]}function d(a){var r=[];for(var i in a)r.push(a[i].id);var n={urlParams:r};e.deleteAirports(n,function(t){0==t.errorCode?($(document).promptBox("closePrompt"),o(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})}),t.$apply()}t.tableModel={more:!1,userWord:"",tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("stationAirport","airport_table_name"),Lang.getValByKey("stationAirport","airport_table_triadCode"),Lang.getValByKey("stationAirport","airport_table_tetradCode"),Lang.getValByKey("stationAirport","airport_table_country"),Lang.getValByKey("stationAirport","airport_table_city"),Lang.getValByKey("stationAirport","airport_table_remark")],tableBody:[],restURL:"logistics.getAllAirports",restData:{q:"",locked:-1,pageIndex:1,pageSize:10,sort:"triadCode",asc:!0},seatData:{uid:""},selectNumber:0,selectFlag:!1},t.getLanguage=function(){e.getLanguage(function(e){0===e.errorCode&&(t.language=e.data)})},t.getLanguage(),t.$on("$viewContentLoaded",function(){o()}),t.getCountryData=function(t,a){a||(a=1),t=t||"";var r={urlParams:{q:t,pageIndex:a,pageSize:10}};return e.getCountry(r)};var s,p,u={};u=t.getCountryData(),i(u.data),s=selectFactory({data:u,id:"countrySearch",isSearch:!0,pagination:!0,searchPlaceHoder:"请输入国家名称或二字码",onSearchValueChange:function(e,a,r){var o=t.getCountryData(a,r);i(o.data),e.setData(o)},attrTextModel:function(e,a,r){t.countrySearch=e,t.countrySearchId=r.figureCode,t.citySearch="",t.citySearchId="";t.countrySearchId,t.countrySearchId;t.figureCode=r.figureCode,t.countryId=r.figureCode,t.$apply(),c(s)}}),p=selectFactory({data:[],isSearch:!0,pagination:!0,searchPlaceHoder:"请输入城市名称",id:"citySearch",isSaveInputVal:"true",closeLocalSearch:!0,onSearchValueChange:function(e,a,r){e.setData(y(a,r)),t.$apply()},attrTextModel:function(e,a,r){t.citySearch=e,t.citySearchId=r.id,t.$apply()}}),s.next=p,t.clearDate=function(){t.countrySearch="",t.countrySearchId="",t.citySearch="",t.citySearchId="",t.tableModel.restData.q="",t.q="",p.setData([]),t.retrievalAirport()};var m=$("#nest-AirportFrom .label-text");!function(){barClick(m)}(),t.resetCitySearchData=function(){Select.sharePool.citySearch&&(t.countrySearchId?Select.sharePool.citySearch.setData(n()):Select.sharePool.citySearch.setData({}))},t.addAirport=function(){$(".select-list-box").empty(),t.textNumber=140,t.showAirportName=!1,t.showTriadCode=!1,t.showTetradCode=!1,$("#nest-AirportFrom").css("display","table"),t.title=Lang.getValByKey("stationAirport","airport_prompt_new"),t.nestAirportFrom=!0,t.isEditCity=!0,t.airportName="",t.countryName="",t.cityName="",t.triadCode="",t.tetradCode="",t.remark="";var e=$(".language-international input");e.each(function(t){e.eq(t).val("")}),loadBar(m),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},t.closePrompt=function(){t.nestAirportFrom=!1,t.AirportFrom.$setPristine(),t.AirportFrom.$setUntouched()};var y=function(a,r){r||(r=1);var o={urlParams:{countryCode:t.countryId,parentId:t.countryId,q:a?a.trim():"",pageIndex:r,pageSize:10}};return e.getCity(o)};t.initSelectList=function(){var e;e=t.getCountryData(),i(e.data),s=selectFactory({data:e,id:"country",height:240,isSearch:!0,pagination:!0,defaultText:Lang.getValByKey("common","common_select_tips"),searchPlaceHoder:"请输入国家名称或二字码",onSearchValueChange:function(e,a,r){var o=t.getCountryData(a,r);i(o.data),e.setData(o)},attrTextModel:function(e,a){var r;r=e?l(e,a):{},t.countryId=r.figureCode,t.countryName=r.name,t.isEditCity=!1,t.cityName="",t.$apply(),c(s)}}),cityEle=selectFactory({data:[],id:"city",height:240,isSearch:!0,isSaveInputVal:"true",closeLocalSearch:!0,pagination:!0,searchPlaceHoder:"请输入城市名称",defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(e,a,r){e.setData(y(a,r)),t.$apply()},attrTextModel:function(e,a){var r;r=e?l(e,a):{},t.cityName=r.name,t.cityId=r.id,t.$apply(),c(cityEle)}}),s.next=cityEle},t.test=function(){cityEle&&(cityEle.clearData(),t.countryId?(cityEle.setData(y()),cityEle.inputElement.val(t.cityName)):cityEle.setData({}))},t.savePrompt=function(){t.airportName||t.AirportFrom.airportName.$setDirty(),t.countryName||t.AirportFrom.countryName.$setDirty(),t.cityName||t.AirportFrom.cityName.$setDirty(),t.triadCode||t.AirportFrom.triadCode.$setDirty(),t.tetradCode||t.AirportFrom.tetradCode.$setDirty();var a=$(".language-international input"),r=[],i=[];a.each(function(t){i[t]={},i[t].language=a.eq(t).data("code"),i[t].localName=a.eq(t).val(),i[t].refId=a.eq(t).data("id"),r.push(i[t])});var n="";if(void 0!==t.triadCode)for(var c=0;c<t.triadCode.length;c++)n+=t.triadCode[c].toLocaleUpperCase();var l="";if(void 0!==t.tetradCode)for(var c=0;c<t.tetradCode.length;c++)l+=t.tetradCode[c].toLocaleUpperCase();var d={urlParams:{name:t.airportName,countryId:t.countryId,cityId:t.cityId,triadCode:n.toUpperCase(),tetradCode:l.toUpperCase(),remark:t.remark,i18n:r}};if(showErrorModel(m),1==t.showTriadCode&&(t.AirportFrom.$valid=!1),!t.AirportFrom.$valid)return void scrollToErrorView($(".switch-list"));$('button[name="prompt-save"]').hasClass("save")?e.saveAirport(d,function(e){0==e.errorCode?(o(),t.nestAirportFrom=!1,t.AirportFrom.$setPristine(),t.AirportFrom.$setUntouched(),$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})}):(d=$.extend({},{seatParams:{id:t.clickTrId}},d),e.updateAirport(d,function(e){0==e.errorCode?(o(),t.nestAirportFrom=!1,t.AirportFrom.$setPristine(),t.AirportFrom.$setUntouched(),$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})}))},t.editAirportInfo=function(a){$(".select-list-box").empty(),$("#nest-AirportFrom").css("display","table"),t.showAirportName=!1,t.showTriadCode=!1,t.showTetradCode=!1,t.isEditCity=!1,loadBar(m),t.title=Lang.getValByKey("stationAirport","airport_prompt_edit"),t.nestAirportFrom=!0;var r="SPAN"==$(a.target)[0].nodeName?$(a.target).parent():$(a.target);t.clickTrId=r.parent().parent().data("id");var o={seatParams:{id:t.clickTrId}};e.getAirportDetail(o,function(e){if(0==e.errorCode){var a=e.data;t.airportName=a.name,t.countryName=a.countryName+"("+a.countryId+")",t.cityName=a.cityName,t.countryId=a.countryId,t.triadCode=a.triadCode,t.tetradCode=a.tetradCode,t.remark=$.trim(a.remark);var r=$(".language-international input");Array.isArray(a.i18n)&&0==a.i18n.length?r.each(function(t){r.eq(t).val("")}):r.each(function(t){for(var e in a.i18n)r.eq(t).data("code")==a.i18n[e].language&&(r.eq(t).data("id",a.i18n[e].refId),r.eq(t).data("code",a.i18n[e].language),r.eq(t).val($.trim(a.i18n[e].localName)))}),t.textNumber=140-t.remark.length}}),$('button[name="prompt-save"]').removeClass("save").addClass("edit")},t.deleteAirport=function(){if(0!=t.tableModel.selectNumber&&0!=$(".user-table tbody tr").length){var e=r.getSelectTable(t.tableModel.tableBody);$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("stationAirport","airport_prompt_delete")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){d(e)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("stationAirport","airport_prompt_delay_tip"),type:"errer",manualClose:!0})},t.retrievalAirport=function(){t.q=t.tableModel.restData.q,t.tableModel.restData.pageIndex=1,t.tableModel.restData.countryId=t.countrySearchId,t.tableModel.restData.cityId=t.citySearchId,o()},t.internationalization=function(){window.location.href="#/international?q=stationAirport"},t.removeValidateTriadCode=function(){t.showTriadCode=!1},t.validateTriadCode=function(){if(t.triadCode){if($('button[name="prompt-save"]').hasClass("save"))var a={urlParams:{triadCode:t.triadCode}};else var a={urlParams:{triadCode:t.triadCode,id:t.clickTrId}};e.validateAirportTriadCode(a,function(e){0==e.errorCode?t.showTriadCode=!1:(t.showTriadCode=!0,angular.element($(".validate-triad-code").addClass("ng-invalid")))})}},t.textNumber=140,t.showTextNumber=function(){t.textNumber=140-t.remark.length},t.valueTolocaleUpperCase=function(t,e){var a=$.trim($(t.target).val());a.length>e&&($(t.target).val(a.substr(0,e)),a=a.substr(0,e)),$(t.target).val($.trim(a.toLocaleUpperCase()))}}])});