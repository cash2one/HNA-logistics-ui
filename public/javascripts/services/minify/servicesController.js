easySpa.require(["widget/slimscroll","widget/prompt","widget/tab","widget/parseUrl","widget/select","public/common/tableController.js","public/common/pictureController.js","public/common/areaController.js","public/common/areaService.js","public/javascripts/fragment/supplier/supplierCtrl.js","public/javascripts/fragment/supplier/suppliersService.js","public/javascripts/fragment/selectTypes/selectTypesCtrl.js","public/javascripts/fragment/selectTypes/selectTypesService.js"],function(){app.controller("servicesCtrl",["$scope","servicesService","servicesView","tableService","areaService","suppliersService","pictureService","selectTypesService",function(e,t,i,a,r,o,s,n){function c(){$(".white-background .table-container tbody").slimscroll({height:$(".content-main").height()-250})}function l(){e.disabled=!1,angular.forEach(e.tableModel.tableBody,function(t,i){if(t.areas&&t.areas.length){e.tableModel.tableBody[i].serviceArea="";for(var a=0,r=t.areas.length;a<r;a++)e.tableModel.tableBody[i].serviceArea?e.tableModel.tableBody[i].serviceArea+="，"+g(t.areas[a].name,"/"):e.tableModel.tableBody[i].serviceArea+=g(t.areas[a].name,"/")}t.checkbox&&1!=t.status&&(e.disabled=!0)})}function d(){e.selectTypesModel.selectedGoods=[],t.getGoodTypes(function(t){if(0===t.errorCode){var i=e.listGoodsTypeIds;for(var a in t.data){t.data[a].id=t.data[a].code,t.data[a].checked=!1;for(var r in i)t.data[a].id==i[r]&&(t.data[a].checked=!0)}var o=[];for(var s in t.data)t.data[s].name&&o.push(t.data[s]);e.selectTypesModel.listGoodsTypes=o,e.selectTypesModel=n.init(e.selectTypesModel)}})}function m(){var t=$("#getUnGoodTypes input.active"),i=[],a="";t.each(function(e){i.push(t.eq(e).data("id")),e==t.length-1?a+=t.eq(e).parent().data("name"):a+=t.eq(e).parent().data("name")+"，"}),e.goodsTypeIdsInfo=a,e.listGoodsTypeIds=i,$(document).promptBox("closeFormPrompt"),e.$apply()}function p(e){var t=e.next;if(null!=t)return t.clearData(),t.id=null,p(t)}function u(e){if(e)for(var t=0;t<e.length;t++)e[t].name=e[t].name+"("+e[t].code+")"}function v(e){for(var t=e?e.length:0,i={},a=[],r=0;r<t;r++)i={picUrlID:e[r],delshow:!1},a.push(i);return a}function g(e,t){if(!e||!t)return"";var i=e.lastIndexOf(t);return-1!=i&&(e=e.slice(i+1)),e}function y(e,t){for(var i=t.data,a=0;a<i.length;a++)if(i[a].name==e)return i[a]}e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("services","services_table_name"),Lang.getValByKey("services","services_table_code"),Lang.getValByKey("services","services_table_content"),Lang.getValByKey("services","services_table_type"),Lang.getValByKey("services","services_table_state")],tableBody:[],restURL:"logistics.getServicesList",restData:{q:"",status:1,orderby:"createtime",pageIndex:1,pageSize:10},selectNumber:0,selectFlag:!1};var f=window.parseUrl.getParams();e.serviceTitle=Lang.getValByKey("services","services_title_add"),e.serviceStateInfo=Lang.getValByKey("services","services_state_draft"),e.states={data:[{id:-1,name:Lang.getValByKey("services","services_state_all")},{id:1,name:Lang.getValByKey("services","services_state_draft")},{id:2,name:Lang.getValByKey("services","services_state_unAudit")},{id:3,name:Lang.getValByKey("services","services_state_audit")},{id:4,name:Lang.getValByKey("services","services_status_online")},{id:5,name:Lang.getValByKey("services","services_status_offline")}]},e.mainBlock="list",e.setGrey=!1,e.showAuthor=!1,e.$on("$viewContentLoaded",function(){t.getServicesTypes(function(t){0===t.errorCode&&(e.types=t.data,e.typeId=-1,e.getTypeTable(e.typeId))})}),$(window).on("resize",c),e.checkEstimatedTime=function(){setTimeout(function(){$("#estimatedTime").hasClass("ng-invalid")?($("#estimatedTime").addClass("check-error"),e.validateEstimatedTimeError=!0):($("#estimatedTime").removeClass("check-error"),e.validateEstimatedTimeError=!1),e.$apply()},200)},e.checkWeightLimitMin=function(){var t=$("#weightLimitMin").val();t.indexOf(".")>-1&&(t=t.substring(0,t.indexOf(".")+4),e.weightLimitMin=$.trim(t)),setTimeout(function(){$("#weightLimitMin").hasClass("ng-invalid")?($("#weightLimitMin").addClass("check-error"),e.validateWeightError=!0,$("#validateWeightError").html("请输入数字和小数点，可精确到小数点后3位")):e.weightLimitMax&&!$("#weightLimitMax").hasClass("ng-invalid")&&parseFloat(e.weightLimitMin)>parseFloat(e.weightLimitMax)?($("#weightLimitMin").addClass("check-error"),e.validateWeightError=!0,$("#validateWeightError").html("下限必须小于等于上限值")):($("#weightLimitMin").removeClass("check-error"),e.validateWeightError=!1),e.$apply()},200)},e.checkWeightLimitMax=function(){var t=$("#weightLimitMax").val();t.indexOf(".")>-1&&(t=t.substring(0,t.indexOf(".")+4),e.weightLimitMax=$.trim(t)),setTimeout(function(){$("#weightLimitMax").hasClass("ng-invalid")?($("#weightLimitMin").addClass("check-error"),e.validateWeightError=!0,$("#validateWeightError").html("请输入数字和小数点，可精确到小数点后3位")):e.weightLimitMin&&!$("#weightLimitMin").hasClass("ng-invalid")&&parseFloat(e.weightLimitMin)>parseFloat(e.weightLimitMax)?($("#weightLimitMin").addClass("check-error"),e.validateWeightError=!0,$("#validateWeightError").html("下限必须小于等于上限值")):($("#weightLimitMin").removeClass("check-error"),e.validateWeightError=!1),e.$apply()},200)},e.getTypeTable=function(t,i){switch(t){case"ST001":e.currentTypeData={code:"ST001",name:"揽收"};break;case"ST002":e.currentTypeData={code:"ST002",name:"仓储"};break;case"ST003":e.currentTypeData={code:"ST003",name:"清关"};break;case"ST004":e.currentTypeData={code:"ST004",name:"干线"};break;case"ST005":e.currentTypeData={code:"ST005",name:"配送"};break;case"ST006":e.currentTypeData={code:"ST006",name:"综合"};break;default:e.currentTypeData={code:"",name:""}}i&&(e.seniorChecked=!1,e.showSenior=!1,e.tableModel.restData.status=1,e.tableModel.restData.pageIndex=1,e.q="",e.tableModel.restData.q="",e.serviceStateInfo=Lang.getValByKey("services","services_state_draft")),e.typeId=t;var r={seatParams:{serviceTypeId:e.typeId},urlParams:e.tableModel.restData};a.getTable(e.tableModel.restURL,r,function(t){0===t.errorCode&&(e.tableModel=a.table(e.tableModel,r,t),l(),c())})},e.$watch("tableModel",function(e,t){e!==t&&l()},!0),e.initStateSelectList=function(){var t=e.states;selectFactory({data:t,id:"serviceState",defaultText:"",attrTextModel:function(i){var a;a=i?y(i,t):{},e.serviceStateInfo=i,e.serviceStateId=a.id,e.tableModel.restData.pageIndex=1,e.tableModel.restData.status=e.serviceStateId,e.getTypeTable(e.typeId),e.$apply()}})},e.retrievalList=function(){e.q=e.tableModel.restData.q,e.tableModel.restData.pageIndex=1,e.getTypeTable(e.typeId)},e.showFlowProcess=function(i,a){if(i){e.mainBlock="process",e.processTitle=a;var r={seatParams:{uid:i}};t.getServiceProcess(r,function(t){0===t.errorCode&&(e.streamList=t.data)})}},e.addService=function(){e.serviceTitle=Lang.getValByKey("services","services_title_add"),e.validateCodeError=!1,e.mainBlock="detail",e.infoTab.exdisable(0),e.visible=!1,e.isVisibleDraft=!1,e.isVisible=!1,e.isVisibleEdit=!1,e.setGrey=!0,e.showAuthor=!1,e.nameInfo="",e.codeInfo="",e.serviceTypeName=e.currentTypeData.name,e.serviceTypeIds=[e.currentTypeData.code],e.subServiceTypeCode="",e.subServiceTypeName="",e.serviceContentInfo="",e.supplierName="",e.supplierCode="",e.supplierId="",e.descriptionInfo="",e.estimatedTime="",e.weightLimitMin="",e.weightLimitMax="",e.estimatedUnitValue="",e.estimatedUnit="",e.weightLimitUnitCode="kg",e.choosedData=[],e.regionZone="",e.listGoodsTypeIds=[],e.goodsTypeIdsInfo="",e.serviceForm.$setPristine(),e.serviceForm.$setUntouched(),setTimeout(function(){$(".from-box").scrollTop(0)},10)},e.goBack=function(){if(f.isfromprice){var t=JSON.parse(f.priceData);return void(window.location.href="#/priceDetail?module="+t.module+"&q="+t.q+"&uid="+t.uid+"&type="+t.type)}e.visible||"process"==e.mainBlock?(e.mainBlock="list",e.getTypeTable(e.typeId)):$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("common","common_back_confirm")},cancelDescription:Lang.getValByKey("common","common_back_no"),operation:[{type:"submit",application:"delete",description:Lang.getValByKey("common","common_back_yes"),operationEvent:function(){e.mainBlock="list",e.getTypeTable(e.typeId),e.$apply(),$(document).promptBox("closePrompt")}}]})},e.validateCode=function(){if(e.codeInfo){var i;i=0==e.isVisibleDraft?"":e.serviceId;var a={urlParams:{code:e.codeInfo,uid:i}};t.validateServiceCode(a,function(t){0===t.errorCode?e.validateCodeError=!1:e.validateCodeError=!0})}},e.removeValidateCode=function(){e.validateCodeError=!1},e.selectServiceTypes=function(){var i,a;i=t.getServicesTypeList(),i&&i.data.splice(0,1),a=selectFactory({data:i,id:"serviceType",isUsePinyin:!0,attrTextModel:function(t,i){var r;r=t?y(t,i):{},"ST004"===r.code&&(e.subServiceTypeCode="MAINLINEAIR",e.subServiceTypeName="空运"),e.serviceTypeIds=[r.code],e.serviceTypeName=r.name,e.$apply(),p(a)}})},e.selectTimeTypes=function(){t.getProductEstimated(null,function(t){e.estimatedList=t.data,selectFactory({data:t,id:"intenTimeType",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.estimatedUnit=t,e.$apply()},attrTextModel:function(t){e.estimatedUnitValue=t,e.$apply()}})})},e.selectGoodTypes=function(){$(document).promptBox({isHidden:!0,title:Lang.getValByKey("services","services_placeholder_goods_type"),isNest:!0,loadData:function(){d()},content:{nest:$("#getUnGoodTypes")},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_confirm"),operationEvent:function(){m()}}]})},e.selectTypesModel={selectedGoods:[],listGoodsTypes:e.listGoodsTypes},e.getSupplierListData=function(e,i){i||(i=1),e=e||"";var a={urlParams:{q:e,pageIndex:i,pageSize:10}};return t.serviceGetSupplier(a)},e.getSupplierList=function(){e.supplierDatas=t.serviceGetSupplier(),u(e.supplierDatas.data);var i=selectFactory({data:e.supplierDatas,id:"supplier",isSearch:!0,isUsePinyin:!0,searchPlaceHoder:"请输入名称或编码",defaultText:Lang.getValByKey("common","common_select_tips"),closeLocalSearch:!0,pagination:!0,onSearchValueChange:function(t,i,a){var r=e.getSupplierListData(i,a);u(r.data),t.setData(r)},attrTextModel:function(t,a){var r;r=t?y(t,a):{},e.supplierId=r.id,r.name?e.supplierName=r.name.split("，")[0]:e.supplierName="",$("#supplier").val(e.supplierName),e.$apply(),p(i)}});i.setData(e.supplierDatas),i.open(),$("#supplier").val(e.supplierName)},e.editServiceDetail=function(t){e.serviceTitle=Lang.getValByKey("services","services_title_detail"),e.validateCodeError=!1,e.mainBlock="detail",e.infoTab.selected(0),e.infoTab.enableAll(),e.visible=!0,e.isVisibleDraft=!0,e.isVisible=!1,e.showAuthor=!0,e.serviceId=t,e.serviceSpanInfo(t),e.serviceForm.$setPristine(),e.serviceForm.$setUntouched(),setTimeout(function(){$(".from-box").scrollTop(0)},10)},e.serviceSpanInfo=function(i){var a={seatParams:{uid:i}};t.getServiceById(a,function(t){if(0===t.errorCode){switch(e.serviceData=t.data,1!=e.serviceData.status?(e.setGrey=!0,e.isVisibleEdit=!1):(e.setGrey=!1,e.isVisibleEdit=!0),e.serviceStateId=e.serviceData.status,e.name=e.serviceData.name,e.code=e.serviceData.code,e.serviceTypeName=e.serviceData.serviceTypeName,e.serviceTypeIds=e.serviceData.serviceTypeCodes,e.subServiceTypeCode=e.serviceData.subServiceTypeCode,e.serviceData.subServiceTypeCode){case"MAINLINESHIP":e.subServiceTypeName="海运";break;case"MAINLINEAIR":e.subServiceTypeName="空运";break;case"MAINLINEOTHER":e.subServiceTypeName="其他"}e.id=e.serviceData.id,e.lineName=e.serviceData.lineName?e.serviceData.lineName+"("+e.serviceData.lineCode+")":"",e.lineId=e.serviceData.lineId,e.className=e.serviceData.className,e.classIds=e.serviceData.classId,e.serviceContent=$.trim(e.serviceData.serviceContent),e.supplierName=e.serviceData.supplierName,e.supplierId=e.serviceData.supplierId,e.supplierCode=e.serviceData.supplierCode,e.description=$.trim(e.serviceData.description),e.userName=$.trim(e.serviceData.userName),e.createTime=$.trim(e.serviceData.createTime),e.estimatedTime=e.serviceData.estimatedTime,e.estimatedUnit=e.serviceData.estimatedUnit,e.estimatedUnitValue=e.serviceData.estimatedUnitName,e.weightLimitMin=e.serviceData.weightLimitMin,e.weightLimitMax=e.serviceData.weightLimitMax,e.weightLimitUnitCode=e.serviceData.weightLimitUnitCode,e.getFlightsData(e.lineId,!1),e.choosedData=[];var i={};angular.forEach(e.serviceData.areas,function(t){i={figureCode:t.figureCode,name:t.name.split("/")[t.name.split("/").length-1]},e.choosedData.push(i)});var a="";angular.forEach(e.choosedData,function(e){a+="，"+e.name.split("/")[e.name.split("/").length-1]}),a&&(a=a.slice(1)),e.regionZone=a,e.listGoodsTypeIds=e.serviceData.cargoTypes,e.goodsTypeIdsInfo=e.serviceData.cargoTypeName}})},e.getWeightRule=function(i){var a={seatParams:{id:i}};t.getServiceWeightRule(a,function(t){if(0===t.errorCode){if(!t.data)return e.isVolume=!1,e.isremarkVolume="否",e.showVolumeDetail=!1,e.volumeFactor="",void(e.weightValueTye="");e.isVolume=t.data.isVolume?"true":"false",e.isremarkVolume=t.data.isVolume?"是":"否",e.showVolumeDetail=!!t.data.isVolume,e.volumeFactor=t.data.volumeFactor,e.weightValueTye=t.data.weightValueTye,"max"===t.data.weightValueTye?e.weightValueName="实重和体积重取最大":"min"===t.data.weightValueTye?e.weightValueName="实重和体积重取最小":e.weightValueName=""}})},e.editService=function(){e.serviceForm.$setPristine(),e.serviceForm.$setUntouched(),e.setGrey=!0,e.validateCodeError=!1,e.visible=!1,e.isVisible=!0,e.isVisibleEdit=!1;var i={seatParams:{uid:e.serviceId}};t.getServiceById(i,function(t){if(0===t.errorCode){e.serviceData=t.data,e.nameInfo=e.serviceData.name,e.codeInfo=e.serviceData.code,e.serviceTypeName=e.serviceData.serviceTypeName,e.serviceTypeIds=e.serviceData.serviceTypeCodes,e.serviceContentInfo=$.trim(e.serviceData.serviceContent),e.supplierName=e.serviceData.supplierName+"("+e.serviceData.supplierCode+")",e.supplierId=e.serviceData.supplierId,e.supplierCode=e.serviceData.supplierCode,e.descriptionInfo=$.trim(e.serviceData.description),e.getFlightsData(e.lineId,!0),e.choosedData=[];var i={};angular.forEach(e.serviceData.areas,function(t){i={figureCode:t.figureCode,name:t.name.split("/")[t.name.split("/").length-1]},e.choosedData.push(i)});var a="";angular.forEach(e.choosedData,function(e){a+="，"+e.name.split("/")[e.name.split("/").length-1]}),a&&(a=a.slice(1)),e.regionZone=a,e.listGoodsTypeIds=e.serviceData.cargoTypes,e.goodsTypeIdsInfo=e.serviceData.cargoTypeName}})},e.removeSpace=function(){if($.trim(e.serviceContentInfo).length)return!0;e.serviceContentInfo=$.trim(e.serviceContentInfo)},e.SetIsConsiderVolume=function(){"false"==e.isVolume?(e.isremarkVolume="否",e.showVolumeDetail=!1,e.volumeFactor="",e.weightValueTye=""):(e.isremarkVolume="是",e.showVolumeDetail=!0,e.volumeFactor="",e.weightValueTye="max",e.weightValueName="实重和体积重取最大"),e.ruleForm.$setPristine()},e.initSelect=function(){var i=t.getWeightValueMode();selectFactory({data:i,id:"type-select-input",defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(t,i,a){t?(e.weightValueTye=a.code,e.weightValueName=t,e.ruleForm.valueMode.$setPristine()):(e.weightValueTye="",e.weightValueName=""),e.$apply()}})},e.cancelService=function(){e.serviceForm.$setPristine(),e.serviceForm.$setUntouched(),e.setGrey=!1,e.visible=!0,e.isVisible=!1,e.isVisibleEdit=!0,e.validateCodeError=!1,e.serviceSpanInfo(e.serviceId)},e.cancelWeight=function(){e.ruleForm.$setPristine(),e.ruleForm.$setUntouched(),e.setGrey=!1,e.visible=!0,e.isVisible=!1,e.isVisibleEdit=!0,e.validateCodeError=!1,e.serviceSpanInfo(e.serviceId),e.getWeightRule(e.id)},e.submitWeight=function(){if("true"===e.isVolume&&!e.ruleForm.$valid)return e.volumeFactor||e.ruleForm.volumeFactor.$setDirty(),void(e.valueMode||e.ruleForm.valueMode.$setDirty());var i,a;i="true"===e.isVolume,a=e.volumeFactor?Number(e.volumeFactor):"";var r={seatParams:{uid:e.serviceId},urlParams:{isVolume:i,volumeFactor:a,weightValueTye:e.weightValueTye}};t.serviceWeightRule(r,function(t){0!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):(e.isVisible=!1,e.isVisibleEdit=!0,e.visible=!0,$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}))})},e.selectRegion=function(){e.initCtrl(),$(document).promptBox({title:Lang.getValByKey("services","services_prompt_title_area"),isHidden:!0,boxWidth:!0,isNest:!0,loadData:function(){e.loadRegionData()},content:{nest:$("#serviceZone")},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_confirm"),operationEvent:function(){$(document).promptBox("closeFormPrompt");var t="";angular.forEach(e.areaModel.selectedData,function(e){t+="，"+e.name.split("/")[e.name.split("/").length-1]}),t&&(t=t.slice(1)),e.regionZone=t,e.choosedData=[];var i={};angular.forEach(e.areaModel.selectedData,function(t){i={figureCode:t.interId,name:t.name.split("/")[t.name.split("/").length-1]},e.choosedData.push(i)}),e.$apply()}}]})};var b={unSelectedData:[],selectedData:[],candidateFlag:!1,selectedFlag:!1};e.loadRegionData=function(){b.unSelectedData=t.getCountry().data,b.selectedData=e.choosedData,e.tab.selected(0),e.areaModel=r.initArea(b)},e.saveDraftService=function(){if(e.nameInfo||e.serviceForm.nameInfo.$setDirty(),e.codeInfo||e.serviceForm.codeInfo.$setDirty(),e.serviceTypeName||e.serviceForm.serviceTypeName.$setDirty(),-1===e.serviceTypeIds.indexOf("ST004")||e.subServiceTypeName||e.serviceForm.subServiceTypeName.$setDirty(),e.serviceContentInfo||e.serviceForm.serviceContentInfo.$setDirty(),e.regionZone,!e.estimatedTime&&e.estimatedUnitValue&&e.serviceForm.estimatedTime.$setDirty(),e.estimatedTime&&!e.estimatedUnitValue&&e.serviceForm.estimatedUnit.$setDirty(),e.goodsTypeIdsInfo||e.serviceForm.goodsTypeIdsInfo.$setDirty(),e.goodsTypeIdsInfo||e.serviceForm.goodsTypeIdsInfo.$setDirty(),e.supplierName||e.serviceForm.supplierName.$setDirty(),!e.serviceForm.$valid)return void scrollToErrorView($(".form-box"));var i={urlParams:{name:e.nameInfo,code:e.codeInfo,serviceTypeCodes:e.serviceTypeIds,subServiceTypeCode:e.subServiceTypeCode,serviceContent:$.trim(e.serviceContentInfo),areas:[],cargoTypes:e.listGoodsTypeIds,supplierId:e.supplierId,estimatedTime:e.estimatedTime,estimatedUnit:e.estimatedUnit,weightLimitMin:e.weightLimitMin,weightLimitMax:e.weightLimitMax,weightLimitUnitCode:e.weightLimitUnitCode,description:$.trim(e.descriptionInfo)}},a={};angular.forEach(e.choosedData,function(e){a={figureCode:e.figureCode,name:e.name},i.urlParams.areas.push(a)}),t.addServices(i,function(t){0===t.errorCode?(e.infoTab.enableAll(),e.setGrey=!1,e.isVisibleDraft=!0,e.isVisible=!1,e.isVisibleEdit=!0,e.visible=!0,e.showAuthor=!0,e.id=t.id,e.isVolume=!1,e.serviceId=t.data,e.serviceSpanInfo(t.data),e.serviceForm.$setPristine(),e.serviceForm.$setUntouched(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},e.submitService=function(){if(e.nameInfo||e.serviceForm.nameInfo.$setDirty(),e.codeInfo||e.serviceForm.codeInfo.$setDirty(),e.serviceTypeName||e.serviceForm.serviceTypeName.$setDirty(),-1===e.serviceTypeIds.indexOf("ST004")||e.subServiceTypeName||e.serviceForm.subServiceTypeName.$setDirty(),!e.estimatedTime&&e.estimatedUnitValue&&e.serviceForm.estimatedTime.$setDirty(),e.estimatedTime&&!e.estimatedUnitValue&&e.serviceForm.estimatedUnit.$setDirty(),e.serviceContentInfo||e.serviceForm.serviceContentInfo.$setDirty(),e.goodsTypeIdsInfo||e.serviceForm.goodsTypeIdsInfo.$setDirty(),e.goodsTypeIdsInfo||e.serviceForm.goodsTypeIdsInfo.$setDirty(),e.supplierName||e.serviceForm.supplierName.$setDirty(),!e.serviceForm.$valid)return void scrollToErrorView($(".form-box"));if(e.weightLimitMsg)return e.serviceForm.weightLimitMin.$setDirty(),e.serviceForm.weightLimitMax.$setDirty(),!1;var i={seatParams:{uid:e.serviceId},urlParams:{name:e.nameInfo,code:e.codeInfo,serviceTypeCodes:e.serviceTypeIds,subServiceTypeCode:e.subServiceTypeCode,serviceContent:$.trim(e.serviceContentInfo),areas:[],cargoTypes:e.listGoodsTypeIds,supplierId:e.supplierId,estimatedTime:e.estimatedTime,estimatedUnit:e.estimatedUnit,weightLimitMin:e.weightLimitMin,weightLimitMax:e.weightLimitMax,weightLimitUnitCode:e.weightLimitUnitCode,description:$.trim(e.descriptionInfo)}},a={};angular.forEach(e.choosedData,function(e){a={figureCode:e.figureCode,name:e.name},i.urlParams.areas.push(a)}),t.editServices(i,function(t){0===t.errorCode?(e.setGrey=!1,e.isVisibleDraft=!0,e.isVisible=!1,e.isVisibleEdit=!0,e.visible=!0,e.serviceId=t.data,e.serviceSpanInfo(t.data),e.serviceForm.$setPristine(),e.serviceForm.$setUntouched(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},e.deleteService=function(){if(e.tableModel.selectNumber){var t=a.getSelectTable(e.tableModel.tableBody);$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("services","services_prompt_title_delete")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){e.submitDeleteService(t)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_prompt_delay_tip"),type:"errer",manualClose:!0})},e.submitDeleteService=function(i){var a=[],r="";for(var o in i)r+=i[o].status,a.push(i[o].uid);if(-1==r.indexOf("1"))return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("services","services_prompt_title_delete_tips"),type:"errer",manualClose:!0}),$(document).promptBox("closePrompt"),!1;if(-1!=r.indexOf("2"))return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("services","services_prompt_title_delete_tips"),type:"errer",manualClose:!0}),$(document).promptBox("closePrompt"),!1;if(-1!=r.indexOf("3"))return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("services","services_prompt_title_delete_tips"),type:"errer",manualClose:!0}),$(document).promptBox("closePrompt"),!1;var s={urlParams:a};t.deleteServices(s,function(t){0===t.errorCode?($(document).promptBox("closePrompt"),e.getTypeTable(e.typeId),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})}),e.$apply()},e.auditService=function(){if(e.tableModel.selectNumber){var t=a.getSelectTable(e.tableModel.tableBody);$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:Lang.getValByKey("services","services_prompt_title_audit")},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),operationEvent:function(){e.submitAuditService(t)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_prompt_delay_tip"),type:"errer",manualClose:!0})},e.submitAuditService=function(i){var a=[];for(var r in i)a.push(i[r].uid);var o={urlParams:a};t.toAuditServices(o,function(t){0===t.errorCode?($(document).promptBox("closePrompt"),e.getTypeTable(e.typeId),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})}),e.$apply()},e.auditSingleService=function(){$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:Lang.getValByKey("services","services_prompt_title_audit_tips")},operation:[{type:"submit",description:Lang.getValByKey("common","common_pagination_confirm"),operationEvent:function(){var i={urlParams:[e.serviceId]};t.toAuditServices(i,function(t){0===t.errorCode?(e.mainBlock="list",$(document).promptBox("closePrompt"),e.getTypeTable(e.typeId),e.$apply(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]})},e.supplierModel={supplierData:[]},e.pictureModel={edit:!0,uploadShow:!1,picture:[],accept:"image/jpg,image/jpeg,image/png,image/bmp,image/tiff"},e.getSupplier=function(i){e.tabs.selected(0),e.mainBlock="suppler";var a={seatParams:{sid:i,intertype:"logistics"}};t.getSupplierById(a,function(t){if(0===t.errorCode){e.supplierModel.supplierData=t.data;var i="";angular.forEach(e.supplierModel.supplierData.serviceTypes,function(t,a){a==e.supplierModel.supplierData.serviceTypes.length-1?i+=t.supplierTypeName:i+=t.supplierTypeName+","}),e.supplierModel.supplierData.serviceTypes=i,$("#stars").rating("update",parseInt(e.supplierModel.supplierData.rank)),$("#stars").rating("refresh",{min:0,max:5,step:1,size:"xs",animate:!0,displayOnly:!0,showClear:!1,showCaption:!1}),e.pictureModel.picture=v(e.supplierModel.supplierData.files),e.pictureModel=s.init(e.pictureModel),e.supplierModel=o.initSupplier(e.supplierModel)}})},e.goSupplerBack=function(){e.mainBlock="detail"},e.preventEvent=function(e){13==e.keyCode&&e.preventDefault()},e.regionDetail=function(t,i){var a="#/regionDetail?schemaId="+t+"&name="+i+"&q=services&uid="+e.serviceId+"&status="+e.serviceData.status;f.isfromprice&&(a+="&isfromprice=1&priceData="+f.priceData),window.location.href=a},e.infoTab=$("#info-tab").tab({callback:function(t){1===e.serviceData.status&&(e.isVisibleEdit=!0,e.setGrey=!1,e.validateCodeError=!1),1===t&&(e.getWeightRule(e.id),e.initSelect()),2===t&&e.getServiceRegion(),e.visible=!0,e.isVisible=!1,e.serviceSpanInfo(e.serviceId),e.$apply()}}),e.getServiceRegion=function(){e.serviceRangeTable={tableHeader:[Lang.getValByKey("common","common_thead_number"),"类型范围","编码","创建者","创建时间","分区详情",Lang.getValByKey("common","common_page_remarks")],tableBody:[],restURL:"logistics.getServiceRange",restData:{id:e.serviceData.id},selectNumber:0,selectFlag:!1};var t={seatParams:e.serviceRangeTable.restData};a.getTable(e.serviceRangeTable.restURL,t,function(i){if(0===i.errorCode){i.pagination={currentPage:1,currentResult:0,pageSize:10,totalPage:0,totalResult:0},e.serviceRangeTable=a.table(e.serviceRangeTable,t,i);var r=e.serviceRangeTable&&e.serviceRangeTable.tableBody;if(e.startDisabled=!1,e.endDisabled=!1,e.disabledAdd=!1,r){for(var o=0,s=r.length;o<s;o++)"s"===r[o].type?e.startDisabled=!0:"e"===r[o].type&&(e.endDisabled=!0);e.startDisabled&&e.endDisabled&&(e.disabledAdd=!0)}e.$apply()}})},e.add=function(){e.showCode=!1,e.startDisabled?e.rangeRadio="e":e.rangeRadio="s",e.regionForm.$setPristine(),e.regionForm.$setUntouched(),e.regionForm.$setUntouched(),e.isSaveNext=!0,e.proRegionID=0,e.code="",e.description="",$(document).promptBox({title:"添加分区方案",loadTitle:function(){return"添加分区方案"},isMiddle:!0,isNest:!0,content:{nest:$("#regionDetail")},loadData:function(){$('#nest-regionDetail .other-btn button[name="prompt-operation"]').addClass("save").removeClass("edit")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_save"),operationEvent:function(){e.saveSeriviceRegion(),$(document).promptBox("closeFormPrompt"),e.$apply()}}]})},e.editable=!0,e.edit=function(t){if(e.editable){e.startDisabled=!1,e.endDisabled=!1,e.showCode=!0;(e.serviceRangeTable&&e.serviceRangeTable.tableBody).length>=2&&(e.startDisabled=!0,e.endDisabled=!0),e.regionForm.$setPristine(),e.regionForm.$setUntouched(),e.regionForm.$setUntouched(),e.isSaveNext=!0,e.rangeRadio=t.type,e.code=t.code,e.description=t.remark,e.proRegionID=t.id,$(document).promptBox({title:"编辑分区方案",loadTitle:function(){return"编辑分区方案"},isMiddle:!0,isNest:!0,content:{nest:$("#regionDetail")},loadData:function(){$('#nest-regionDetail .other-btn button[name="prompt-operation"]').addClass("save").removeClass("edit")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_save"),operationEvent:function(){e.saveSeriviceRegion(),$(document).promptBox("closeFormPrompt"),e.$apply()}}]})}},e.saveSeriviceRegion=function(){if(e.rangeRadio&&(e.proRegionID&&!e.code&&e.regionForm.code.$setDirty(),!$("#code-msg").hasClass("remote-invalid")&&e.regionForm.$valid)){var i={urlParams:{serviceId:e.serviceData.id,type:e.rangeRadio,remark:$.trim(e.description)},seatParams:{}},a="s"===e.rangeRadio?"起点范围":"终点范围";e.proRegionID?(i.seatParams.id=e.proRegionID,t.editServicesRegion(i,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.isSaveNext?e.regionDetail(t.data,a):e.getServiceRegion()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})):t.saveServicesRegion(i,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.isSaveNext?e.regionDetail(t.data,a):e.getServiceRegion()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}},e.del=function(){var i=[],r=a.getSelectTable(e.serviceRangeTable.tableBody);if(!r.length)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;angular.forEach(r,function(e){i.push(e.id)});var o={urlParams:i,serviceId:e.serviceData.id},s={title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:"确定删除已选服务范围？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){t.deleteServicesRegion(o,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),$(document).promptBox("closePrompt"),e.getServiceRegion(),e.serviceRangeTable.restData.id=e.serviceData.id,e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]};$(document).promptBox(s)},e.initLineType=function(){var t={data:[{id:1,code:"MAINLINESHIP",name:"海运"},{id:2,code:"MAINLINEAIR",name:"空运"},{id:3,code:"MAINLINEOTHER",name:"其他"}]};selectFactory({data:t,defaultText:"",id:"initLineType",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.subServiceTypeCode=t,e.$apply()},attrTextModel:function(t){e.subServiceTypeName=t,e.$apply()}}).open()},e.initLineIds=function(){selectFactory({data:[],id:"lineId",defaultText:"请选择",showTextField:"nameCode",isSearch:!0,closeLocalSearch:!0,searchPlaceHoder:"请输入航线名称或编码",pagination:!0,onSearchValueChange:function(i,a,r){t.getLines({subServiceTypeCode:e.subServiceTypeCode,params:{q:a,pageIndex:r||1}},function(e){e.data.forEach(function(e){e.nameCode=e.name+"("+e.code+")"}),i.setData(e)})},attrTextField:{"ng-value":"id"},attrTextModel:function(t){if(!t)return e.lineName="",void e.$apply();e.lineName=t,e.$apply()},attrTextId:function(t){if(!t)return e.flightTable.tableBody=[],e.lineId="0",void e.$apply();e.lineId=t,e.getFlightsData(t,!0),e.$apply()}}).open()},e.flightTable={tableHeader:[Lang.getValByKey("common","common_thead_number"),"航班号","承运公司","出发时间","到达时间"],tableBody:[],selectNumber:0,selectFlag:!1},e.getFlightsData=function(t,i){if(!t||0===t)return void(e.flightTable.tableBody=[]);var r={urlParams:{lineId:t,pageSize:1e3}},o="MAINLINESHIP"===e.subServiceTypeCode?"logistics.getShipFlights":"logistics.getAirFlights";a.getTable(o,r,function(t){if(0===t.errorCode){var o=angular.copy(t),s=[];if(!i){if(e.serviceData.classId&&e.serviceData.classId.length)for(var n=0,c=e.serviceData.classId.length;n<c;n+=1)for(var l=0,d=o.data.length;l<d;l+=1)e.serviceData.classId[n]===o.data[l].id&&s.push(o.data[l]);o.data=s}if(e.flightTable=a.table(e.flightTable,r,o),i&&e.serviceData.classId&&e.serviceData.classId.length)for(var n=0,c=e.serviceData.classId.length;n<c;n+=1)for(var l=0,d=e.flightTable.tableBody.length;l<d;l+=1)e.serviceData.classId[n]===e.flightTable.tableBody[l].id&&(e.flightTable.tableBody[l].checkbox=!0)}})},e.submitFlights=function(){var i=a.getSelectTable(e.flightTable.tableBody);if(e.lineName&&!i.length)return void $(document).promptBox({isDelay:!0,contentDelay:"请至少选择一个航班！",type:"errer",manualClose:!0});e.classIds=i.map(function(e){return e.id});var r={seatParams:{uid:e.serviceId},urlParams:{lineId:e.lineId,classIds:e.classIds}};t.submitFlights(r,function(t){0===t.errorCode?(e.setGrey=!1,e.isVisibleDraft=!0,e.isVisible=!1,
e.isVisibleEdit=!0,e.visible=!0,e.serviceId=t.data,e.serviceSpanInfo(t.data),e.mainlineForm.$setPristine(),e.mainlineForm.$setUntouched(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},f.uid&&(e.serviceTitle=Lang.getValByKey("services","services_title_detail"),e.validateCodeError=!1,e.mainBlock="detail",e.infoTab.selected(0),e.infoTab.enableAll(),e.visible=!0,e.isVisibleDraft=!0,e.isVisible=!1,e.showAuthor=!0,e.serviceId=f.uid,e.serviceSpanInfo(f.uid),f.backfrom?(e.backfromRegion=!0,$(".base-info-tab").removeClass("active"),$(".base-info-pane").removeClass("active"),e.getServiceRegion()):e.backfromRegion=!1)}])});