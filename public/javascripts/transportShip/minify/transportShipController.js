easySpa.require(["widget/slimscroll","widget/prompt","widget/select","public/common/tableController.js","public/common/pictureController.js","widget/slides"],function(){app.controller("transportShipCtrl",["$scope","transportShipService","transportShipView","tableService","pictureService",function(a,t,e,r,o){function n(a,e){if(e||(e=t.getShippingCompany()),a){e=e.data;for(var r=0;r<e.length;r++){var o=e[r].name;if($.trim(o)==$.trim(a)||$.trim(e[r].name)==$.trim(a))return e[r].id}return"无匹配结果"}}function i(a,e){if(e||(e=t.getCountry()),a){e=e.data;for(var r=0;r<e.length;r++){var o=e[r].name;if($.trim(o)==$.trim(a)||$.trim(e[r].name)==$.trim(a))return e[r].code}return"无匹配结果"}}function p(a){for(var t=a?a.length:0,e=[],r=0;r<t;r++)a[r].picUrlID="object"==typeof a[r].picUrlID?a[r].picUrlID.id:a[r].picUrlID,e.push(a[r].picUrlID);return e}function s(a){for(var t=a?a.length:0,e={},r=[],o=0;o<t;o++)e={picUrlID:a[o],delshow:!1},r.push(e);return r}function l(a){var t=a?a.length:0;$("#globalization").children("li").each(function(){$(this).children("input").removeClass("lang-invalid ng-invalid ng-dirty").next(".verification").children("span").html("");for(var e=$(this).children("input").val("").attr("data-code"),r=0;r<t;r++)a[r].language.toLowerCase()==e.toLowerCase()&&$(this).children("input").val(a[r].localName)})}a.transport={id:0},a.getLanguage=function(){t.getLanguage(function(t){0===t.errorCode&&(a.language=t.data)})},a.getLanguage();var m,c,d,h;a.initSelectList=function(){var e={urlParams:{q:"",pageIndex:1,pageSize:10},isAsync:!0};a.seachCountryData=a.addCountryData=t.getCountry(e),a.seachCompanyData=a.addCompanyData=t.getShippingCompany(e),m=selectFactory({data:a.seachCountryData,isSearch:!0,id:"search-country",pagination:!0,searchPlaceHoder:"请输入国家名称或二字码",defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(t,e,r){a.seachCountryData=a.getProductData(e,r),t.setData(a.seachCountryData)},attrTextModel:function(t,e){a.countrySearchCode=i(t,e),a.countrySearch=t,a.$apply()}}),c=selectFactory({data:a.seachCompanyData,isSearch:!0,id:"search-company",pagination:!0,defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(t,e,r){a.seachCompanyData=a.getCurrentCompanyData(e,r),t.setData(a.seachCompanyData)},attrTextModel:function(t,e){a.searchCompanyId=n(t,e),a.searchCompanyName=t,a.$apply()}}),d=selectFactory({data:a.addCountryData,isSearch:!0,id:"add-country",pagination:!0,searchPlaceHoder:"请输入国家名称或二字码",defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(t,e,r){a.addCountryData=a.getProductData(e,r),t.setData(a.addCountryData)},attrTextModel:function(t,e){a.countryNameCode=i(t,e),a.countryName=t,a.$apply()}}),h=selectFactory({data:a.addCompanyData,isSearch:!0,id:"add-company",pagination:!0,defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(t,e,r){a.addCompanyData=a.getCurrentCompanyData(e,r),t.setData(a.addCompanyData)},attrTextModel:function(t,e){a.companyId=n(t,e),a.companyName=t,a.$apply()}})},a.getCurrentCompanyData=function(a,e){e||(e=1),a=a||"";var r={urlParams:{q:a,pageIndex:e,pageSize:10,includeAllAudit:!0},isAsync:!0};return t.getShippingCompany(r)},a.getProductData=function(a,e){e||(e=1),a=a||"";var r={urlParams:{q:a,pageIndex:e,pageSize:10,includeAllAudit:!0},isAsync:!0},o=t.getCountry(r);return angular.forEach(o.data,function(a,t){a.name+="("+a.code+")"}),o},a.clearDate=function(){a.tableModel.restData.countryId="",a.tableModel.restData.companyId="",a.tableModel.restData.q="",a.q="",a.countrySearchCode="",a.countrySearch="",a.searchCompanyName="",a.searchCompanyId="",a.getTable()},a.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("transportShip","transportShip_page_nameEn"),Lang.getValByKey("transportShip","transportShip_page_name"),Lang.getValByKey("transportShip","transportShip_page_country"),Lang.getValByKey("transportShip","transportShip_page_mmsi"),Lang.getValByKey("transportShip","transportShip_page_mio"),Lang.getValByKey("transportShip","transportShip_page_callSign"),Lang.getValByKey("transportShip","transportShip_page_company"),Lang.getValByKey("common","common_page_remarks")],tableBody:[],restURL:"logistics.getTransportShipTable",restData:{countryId:"",companyId:"",q:"",pageIndex:1,pageSize:10,sort:"nameen"},selectNumber:0,selectFlag:!1},a.getTable=function(t){a.q=a.tableModel.restData.q,a.tableModel.restData.countryId=a.countrySearchCode,a.tableModel.restData.companyId=a.searchCompanyId,t&&(a.tableModel.restData.pageIndex=1);var e={urlParams:a.tableModel.restData};r.getTable(a.tableModel.restURL,e,function(t){if(0===t.errorCode){a.tableModel=r.table(a.tableModel,e,t);var o=$(".ship-table-page").height()-255;setTimeout(function(){$(".table-container tbody").slimscroll({height:o}),$(window).resize(function(){o=$(".ship-table-page").height()-255,$(".table-container tbody").slimscroll({height:o})})},10)}})},a.getTable(),a.pictureModel={edit:!0,uploadShow:!0,picture:[],accept:"image/jpg,image/jpeg,image/png,image/bmp,image/tiff,image/JPG,image/JPEG,image/PNG,image/BMP,image/TIFF,application/pdf"},a.getPictureUrl=function(t){$("#slides").picturePreview({pictureId:t},a.pictureModel.picture)},a.getFile=function(t){var e=t.length;if(e+a.pictureModel.picture.length>o.maxUpload)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("transportShip","transportShip_code_maxUploadTIps")+o.maxUpload+Lang.getValByKey("transportAirplane","transportAirplane_code_maxUploadLastTIps"),type:"errer",manualClose:!0}),!1;for(var r=0;r<e;r++){var n=o.uploadFile(a.pictureModel,t[r]);if(!n)return!1;n.errorlocal?$(document).promptBox({isDelay:!0,contentDelay:n.errorlocal,type:"errer",manualClose:!0}):n.then(function(t){0===t.data.errorCode?(a.pictureModel=o.updateModel(a.pictureModel,t.data.data),$(document).promptBox({isDelay:!0,contentDelay:t.data.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.data.msg,type:"errer",manualClose:!0})})}};var u=$("#nest-TransportShipFrom .label-text");e.propmtCostEvent(u),a.add=function(){a.TransportShipForm.$setPristine(),a.TransportShipForm.$setUntouched(),a.nestTransportShipForm=!0,$("#nest-TransportShipFrom").attr("style","").find(".title").text(Lang.getValByKey("transportShip","transportShip_page_add")),$(".remote-invalid").removeClass("remote-invalid"),a.transportShipName="",a.transportShipNameEN="",a.countryName="",a.countryNameCode="",a.companyName="",a.companyId="",a.transportShipMmsi="",a.transportShipImo="",a.transportShipCallSign="",a.remark="",a.textareaNumber=140,a.pictureModel.picture=[],a.pictureModel=o.init(a.pictureModel),$("#globalization").find(".input-text").each(function(){$(this).val("").removeClass("lang-invalid ng-invalid ng-dirty"),$(this).next(".verification").children("span").html("")}),e.loadBarEvent(u),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},a.edit=function(r){a.transport.id=r,$(".remote-invalid").removeClass("remote-invalid"),$("#nest-TransportShipFrom").attr("style","").find(".title").text(Lang.getValByKey("transportShip","transportShip_code_modelDetail")),a.nestTransportShipForm=!0,e.loadBarEvent(u),$('button[name="prompt-save"]').addClass("save").removeClass("edit"),t.getDetail({seatParams:{id:r}},function(t){t&&0===t.errorCode&&(a.transportShipName=t.data.name,a.transportShipNameEN=t.data.nameEn,a.countryName=t.data.countryName+"("+t.data.countryId+")",a.countryNameCode=t.data.countryId,a.companyName=t.data.companyName,a.companyId=t.data.companyId,a.transportShipMmsi=t.data.mmsi,a.transportShipImo=t.data.imo,a.transportShipCallSign=t.data.callSign,a.remark=t.data.description,a.textareaNumber=140-(a.remark?a.remark.length:0),a.pictureModel.picture=s(t.data.files),a.pictureModel=o.init(a.pictureModel),l(t.data.i18n))})},a.showTextNumber=function(){a.textareaNumber=140-a.remark.length},a.del=function(){var o={},n=[],i=r.getSelectTable(a.tableModel.tableBody);if(!i.length)return e.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;angular.forEach(i,function(a){n.push(a.id)}),o={urlParams:n};var p={title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("transportShip","transportShip_code_modelDelTips")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){t.del(o,function(t){e.promptBox("closePrompt"),0===t.errorCode?(e.promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),a.getTable(),a.$apply()):e.promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]};e.promptBox(p)},a.international=function(){window.location.href="#/international?q=transportShip"},a.save=function(){a.transportShipNameEN||a.TransportShipForm.transportShipNameEN.$setDirty(),a.countryName||a.TransportShipForm.countryName.$setDirty(),a.companyName||a.TransportShipForm.companyName.$setDirty(),a.transportShipMmsi||a.TransportShipForm.transportShipMmsi.$setDirty(),a.transportShipImo||a.TransportShipForm.transportShipImo.$setDirty();var r=[];r=p(a.pictureModel.picture);var o=[];if($("#globalization").children("li").each(function(){if($.trim($(this).children("input").val())){var a={};a.language=$(this).children("input").attr("data-code"),a.localName=$.trim($(this).children("input").val()),o.push(a)}}),$("#code-msg-nameEn").hasClass("remote-invalid")||!a.TransportShipForm.$valid)return void e.displayErrorBox(u);if($("#code-msg-name").hasClass("remote-invalid")||!a.TransportShipForm.$valid)return void e.displayErrorBox(u);if($("#code-msg-mmsi").hasClass("remote-invalid")||!a.TransportShipForm.$valid)return void e.displayErrorBox(u);if($("#code-msg-imo").hasClass("remote-invalid")||!a.TransportShipForm.$valid)return void e.displayErrorBox(u);var n={urlParams:{name:a.transportShipName,nameEn:a.transportShipNameEN,countryId:a.countryNameCode,companyId:a.companyId,mmsi:a.transportShipMmsi,imo:a.transportShipImo,callSign:a.transportShipCallSign,description:a.remark,i18n:o,attachments:r}};a.transport.id?(n.seatParams={id:a.transport.id},t.saveEdit(n,function(t){t&&0===t.errorCode?(e.promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),a.nestTransportShipForm=!1,a.getTable(),a.transport.id&&(a.transport.id=0)):e.promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})):t.save(n,function(t){t&&0===t.errorCode?(e.promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),a.nestTransportShipForm=!1,a.getTable()):e.promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},a.cancel=function(){a.nestTransportShipForm=!1,a.TransportShipForm.transportShipNameEN.errorTips="",a.TransportShipForm.transportShipMmsi.errorTips="",a.transport.id&&(a.transport.id=0)},a.checkShipNameEn=function(){var e={urlParams:{nameen:a.transportShipNameEN,id:a.transport.id}};a.transportShipNameEN&&t.checkShipNameEn(e,function(t){0!=t.errorCode?(a.TransportShipForm.transportShipNameEN.errorTips=t.msg,$("#code-msg-nameEn").removeClass("ng-hide").addClass("remote-invalid")):($("#code-msg-nameEn").addClass("ng-hide").removeClass("remote-invalid"),a.TransportShipForm.transportShipNameEN.errorTips="")})},a.checkShipMmsi=function(){var e={urlParams:{mmsi:a.transportShipMmsi,id:a.transport.id}};a.transportShipMmsi&&t.checkShipMmsi(e,function(t){0!=t.errorCode?(a.TransportShipForm.transportShipMmsi.errorTips=t.msg,$("#code-msg-mmsi").removeClass("ng-hide").addClass("remote-invalid")):($("#code-msg-mmsi").addClass("ng-hide").removeClass("remote-invalid"),a.TransportShipForm.transportShipMmsi.errorTips="")})},a.checkShipImo=function(){var e={urlParams:{imo:a.transportShipImo,id:a.transport.id?a.transport.id:""}};a.transportShipImo&&t.checkShipImo(e,function(t){0!=t.errorCode?(a.TransportShipForm.transportShipImo.errorTips=t.msg,$("#code-msg-imo").removeClass("ng-hide").addClass("remote-invalid")):($("#code-msg-imo").addClass("ng-hide").removeClass("remote-invalid"),a.TransportShipForm.transportShipImo.errorTips="")})}}])});