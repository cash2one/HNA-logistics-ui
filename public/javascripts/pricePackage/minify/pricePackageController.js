easySpa.require(["widget/slimscroll","public/common/tableController.js","widget/prompt","widget/select"],function(){app.controller("pricePackageCtrl",["$scope","pricePackageService","pricePackageView","tableService",function(e,t,a,c){function i(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-250})}function o(){var t={urlParams:e.tableModel.restData};c.getTable(e.tableModel.restURL,t,function(a){e.q=e.tableModel.restData.q,0===a.errorCode&&(e.tableModel=c.table(e.tableModel,t,a),setTimeout(function(){i(),$(window).on("resize",i),e.$apply(),$(".table-box").focus()},100))})}function r(){e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("pricePackage","pricePackage_Name"),Lang.getValByKey("pricePackage","pricePackage_Code"),Lang.getValByKey("pricePackage","pricePackage_Creater"),Lang.getValByKey("pricePackage","pricePackage_CreateTime"),Lang.getValByKey("pricePackage","common_table_remark")],tableBody:[],tableHeaderSize:["5%","15%","10%","10%","15%","20%","20%"],restURL:"logistics.getPricePackage",restData:{q:"",sortName:"id",isAsc:!1,pageIndex:1,pageSize:10},selectNumber:0,selectFlag:!1},o()}function d(){var e={pageIndex:1,pageSize:10,status:3,includeAllAudit:!0};P=t.getProductsList(e),L(P)}function l(e,a){a||(a=1);var c={q:e||"",pageIndex:a,pageSize:10,status:3,includeAllAudit:!0};return t.getProductsList(c)}function p(){var a=P;N=[];for(var c=0;c<e.priceLevelList.length;c++){var i=selectFactory({data:[],showTextField:"gradeName",id:"productLevel-"+c,isSaveInputVal:!1,isCreateNewSelect:!0,defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(t,a,c,i){var o=i.index;t?(e.priceLevelList[o].productLevel=c.gradeName,e.priceLevelList[o].productLevelCode=c.grade):(e.priceLevelList[o].productLevel="",e.priceLevelList[o].productLevelCode=""),e.$apply()}});i.index=c,N.push(i);selectFactory({data:a,id:"productName-"+c,isSearch:!0,isSaveInputVal:!0,closeLocalSearch:!0,isCreateNewSelect:!0,defaultText:Lang.getValByKey("common","common_select_tips"),pagination:!0,searchPlaceHoder:Lang.getValByKey("common","common_select_search_tips"),onSearchValueChange:function(e,t,a){var c=l(t,a);L(c),e.setData(c)},attrTextModel:function(a,c,i,o){var r=o.priceElm.index;if(a){e.priceLevelList[r].productName=i.name,e.priceLevelList[r].productNameCode=i.code,e.priceLevelList[r].productNameUid=i.uid;for(var d=0;d<e.priceLevelList.length;d++)e.priceLevelList[d].productName==a&&d!=r&&($("#productName-"+r).val(""),e.priceLevelList[r].productName="",e.priceLevelList[r].productNameCode="",e.priceLevelList[r].productNameUid="");var l=t.getPriceLevelByProductUid(e.priceLevelList[r].productNameUid);e.priceLevelList[r].productLevel="",o.priceElm.setData(l)}else o.priceElm.setData({data:[]}),e.priceLevelList[r].productLevel="",e.priceLevelList[r].productLevelCode="",e.priceLevelList[r].productName="",e.priceLevelList[r].productNameCode="",e.priceLevelList[r].productNameUid="";e.$apply()}}).priceElm=i}}function s(){var a=P;N=[];for(var c=e.priceLevelList.length-1;c<e.priceLevelList.length;c++){var i=selectFactory({data:[],showTextField:"gradeName",id:"productLevel-"+c,isSaveInputVal:!1,isCreateNewSelect:!0,defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(t,a,c,i){var o=i.index;t?(e.priceLevelList[o].productLevel=c.gradeName,e.priceLevelList[o].productLevelCode=c.grade):(e.priceLevelList[o].productLevel="",e.priceLevelList[o].productLevelCode=""),e.$apply()}});i.index=c,N.push(i);selectFactory({data:a,id:"productName-"+c,isSearch:!0,isSaveInputVal:!0,closeLocalSearch:!0,isCreateNewSelect:!0,defaultText:Lang.getValByKey("common","common_select_tips"),pagination:!0,searchPlaceHoder:Lang.getValByKey("common","common_select_search_tips"),onSearchValueChange:function(e,t,a){var c=l(t,a);L(c),e.setData(c)},attrTextModel:function(a,c,i,o){var r=o.priceElm.index;if(a){e.priceLevelList[r].productName=i.name,e.priceLevelList[r].productNameCode=i.code,e.priceLevelList[r].productNameUid=i.uid;for(var d=0;d<e.priceLevelList.length;d++)e.priceLevelList[d].productName==a&&d!=r&&($("#productName-"+r).val(""),e.priceLevelList[r].productName="",e.priceLevelList[r].productNameCode="",e.priceLevelList[r].productNameUid="");var l=t.getPriceLevelByProductUid(e.priceLevelList[r].productNameUid);e.priceLevelList[r].productLevel="",o.priceElm.setData(l)}else o.priceElm.setData({data:[]}),e.priceLevelList[r].productLevel="",e.priceLevelList[r].productLevelCode="",e.priceLevelList[r].productName="",e.priceLevelList[r].productNameCode="",e.priceLevelList[r].productNameUid="";e.$apply()}}).priceElm=i}}function n(){e.data={pricePackageName:"",pricePackageCode:"",description:""},e.priceLevelList=[{productName:"",productNameCode:"",productLevel:"",productLevelCode:""}]}function u(t,a,c){a(t,function(t){0!=t.errorCode?(Select.sharePool["productName-0"]=null,Select.sharePool["productLevel-0"]=null,e.showPricePackage=!0,$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),c())})}function L(e){for(var e=e.data,t=0;t<e.length;t++)e[t].name=e[t].name+"("+e[t].code+")"}function m(){for(var t=!0,a=0;a<e.priceLevelList.length;a++)""==$.trim(e.priceLevelList[a].productName)&&(e.pricePackageFrom["productName"+a].$pending={},e.pricePackageFrom["productName"+a].$setDirty(),t=!1),""==$.trim(e.priceLevelList[a].productLevel)&&(e.pricePackageFrom["productLevel"+a].$pending={},e.pricePackageFrom["productLevel"+a].$setDirty(),t=!1);return console.log(t),t}function v(){e.data.pricePackageName||e.pricePackageFrom.pricePackageName.$setDirty(),e.data.pricePackageCode||e.pricePackageFrom.pricePackageCode.$setDirty();var t=m();return!(!e.pricePackageFrom.$valid||!t)}function g(t){console.log(t),e.data.pricePackageName=t.name,e.data.description=t.description,e.data.pricePackageCode=t.code,e.priceLevelList={};for(var a=[],c=0;c<t.comboQuotationDtoList.length;c++){var i={productName:t.comboQuotationDtoList[c].productName+"("+t.comboQuotationDtoList[c].productCode+")",productNameCode:t.comboQuotationDtoList[c].productCode,productNameUid:t.comboQuotationDtoList[c].productUid,productLevel:t.comboQuotationDtoList[c].priceQuotationGradeName,productLevelCode:t.comboQuotationDtoList[c].priceQuotationGrade};a.push(i)}e.priceLevelList=a,e.value=t}var P,N=[];e.deletePricePackage=function(){e.showPricePackage=!1;var a=Lang.getValByKey("pricePackage","pricePackage_DelTips");c.delTableListByUid(e.tableModel,a,t.deletePricePackage,o)},e.reSetProductList=function(e){var t="productName-"+e;Select.sharePool[t].setData(P)},e.addPricePackage=function(){e.IsEdit=!1,e.value={},e.pricePackageFrom.pricePackageCode.errorTips="",$("#code-msg").addClass("ng-hide"),e.showPricePackage=!0,n(),e.pricePackageFrom.$setPristine(),setTimeout(function(){p(),e.$apply()},200)},e.addPriceLevel=function(){m()&&(e.priceLevelList.push({productName:"",productNameCode:"",productLevel:"",productLevelCode:""}),setTimeout(function(){s(),e.$apply()},200))},e.closePrompt=function(){e.showPricePackage=!1,Select.sharePool["productName-0"]=null,Select.sharePool["productLevel-0"]=null},e.savePrompt=function(){if(v()){for(var a=$(".errors"),c=0;c<a.length;c++)if(!$(a[c]).hasClass("ng-hide"))return;if(e.IsEdit){for(var i={urlParams:{name:e.data.pricePackageName,code:e.data.pricePackageCode,description:e.data.description,comboQuotationDtoList:[]},seatParams:{uid:e.value.uid}},c=0;c<e.priceLevelList.length;c++){var r={priceQuotationGradeName:e.priceLevelList[c].productLevel,priceQuotationGrade:e.priceLevelList[c].productLevelCode,productName:e.priceLevelList[c].productName.split("(")[0],productUid:e.priceLevelList[c].productNameUid};i.urlParams.comboQuotationDtoList.push(r)}u(i,t.modifyPricePackage,o)}else{for(var i={name:e.data.pricePackageName,code:e.data.pricePackageCode,description:e.data.description,comboQuotationDtoList:[]},c=0;c<e.priceLevelList.length;c++){var r={priceQuotationGradeName:e.priceLevelList[c].productLevel,priceQuotationGrade:e.priceLevelList[c].productLevelCode,productName:e.priceLevelList[c].productName.split("(")[0],productUid:e.priceLevelList[c].productNameUid};i.comboQuotationDtoList.push(r)}u(i,t.addPricePackage,o)}}},e.deletePriceLevel=function(){e.priceLevelList.splice(e.priceLevelList.length-1,1),setTimeout(function(){0==$(".error").length&&($("#price-msg").addClass("ng-hide"),$("#price-msg").html(""))},10)},e.search=function(){e.tableModel.restData.pageIndex=1,o()},e.editPricePackage=function(a){g(a),$("#code-msg").addClass("ng-hide"),e.oldpricePackageCode=a.code,setTimeout(function(){p();for(var c=0;c<a.comboQuotationDtoList.length;c++){var i=t.getPriceLevelByProductUid(a.comboQuotationDtoList[c].productUid);N[c].setData(i),N[c].inputElement.val(a.comboQuotationDtoList[c].priceQuotationGradeName)}e.$apply()},200),e.showPricePackage=!0,e.IsEdit=!0},e.isExistedCode=function(){if(e.data.pricePackageCode&&!e.pricePackageFrom.pricePackageCode.$error.defined){e.value.id=e.value.id?e.value.id:"";0!=t.isExistedCode({id:e.value.id,code:e.data.pricePackageCode}).errorCode?(e.pricePackageFrom.pricePackageCode.errorTips="编码已存在",$("#code-msg").removeClass("ng-hide")):(e.pricePackageFrom.pricePackageCode.errorTips="",$("#code-msg").addClass("ng-hide"))}},function(){e.showPricePackage=!1,e.IsEdit=!1,r(),n(),d()}()}])});