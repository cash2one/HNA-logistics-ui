easySpa.require(["widget/slimscroll","widget/prompt","public/common/tableController.js","widget/select","widget/parseUrl","public/common/calander.js","public/common/eventService.js","public/javascripts/fundsAccount/20161224/fundsAccountService.js","public/javascripts/fragment/fundsAccount/payment.js","public/javascripts/fragment/fundsAccount/paymentResult.js","public/javascripts/fragment/fundsAccount/recharge.js","public/javascripts/fragment/fundsAccount/rechargeResult.js"],function(){app.controller("billApprovalCtrl",["$scope","billApprovalService","billApprovalView","tableService","eventServiceFactory",function(e,t,a,l,o){function r(){e.draftDisabled=!1,e.passedDisabled=!1,e.paidDisabled=!1,e.exportDisabled=!1,angular.forEach(e.tableModel.tableBody,function(t,a){t.checkbox&&"AUDITING"==t.status&&(e.paidDisabled=!0,e.exportDisabled=!0),t.checkbox&&"CHARGEOFF"==t.status&&(e.draftDisabled=!0,e.passedDisabled=!0),t.checkbox&&"PAID"==t.status&&(e.draftDisabled=!0,e.passedDisabled=!0,e.paidDisabled=!0)})}function s(e){for(var t={},a=[],l=0,o=e.length;l<o;l++)t[e[l]]||(t[e[l]]=1,a.push(e[l]));return a}var n=o.createEventService();Calander.init({ele:["#begin-time","#end-time"]});var u=a.getLastMonth();e.startTime=u.start,e.endTime=u.end,e.paramter=window.parseUrl.getParams(),e.module=e.paramter.module?e.paramter.module:"logistics",e.submodule=e.paramter.submodule,e.interType="trade"==e.module?"trd":"","trade"==e.module&&(e.subInterType=e.submodule),"logistics"==e.module&&(e.subInterType="pay"==e.submodule?"1":"2"),e.tableModel={tableBody:[],restURL:"logistics.getBillingList",restData:{billNo:"",waybillNo:"",orderNo:"",status:"AUDITING",includeAllAudit:!1,platformIds:"",bizCompanyIds:"",customerId:"",settlement:"",startEffectTime:u.start,endEffectTime:u.end,q:"",pageIndex:1,pageSize:10},selectNumber:0,selectFlag:!1},e.status=Lang.getValByKey("billApproval","pending_review"),e.statusValue="AUDITING",e.getBillList=function(){var t={urlParams:e.tableModel.restData,seatParams:{interType:e.interType,subInterType:e.subInterType}};l.getTable(e.tableModel.restURL,t,function(a){0===a.errorCode&&(e.tableModel=l.table(e.tableModel,t,a))})},e.getBillList(),n.on("billApprovalData",e.getBillList),e.search=function(){e.tableModel.restData.pageIndex=1,e.tableModel.restData.billNo=e.billNum,e.tableModel.restData.orderNo=e.orderNum,e.tableModel.restData.waybillNo=e.orderNum,e.tableModel.restData.status=e.statusValue,e.tableModel.restData.startEffectTime=e.startTime,e.tableModel.restData.endEffectTime=e.endTime,"trade"==e.module?(e.tableModel.restData.platformIds=e.platformValue,e.tableModel.restData.bizCompanyIds=e.customerValue):(e.customerValue&&(e.customerValue=s(e.customerValue.split(",")),e.customerValue=e.customerValue.join(",")),e.tableModel.restData.customerId=e.customerValue,e.tableModel.restData.settlement=e.payWay),e.getBillList()},e.$watch("tableModel",function(e,t){e!==t&&r()},!0),e.clearCondition=function(){e.billNum="",e.orderNum="",e.status=Lang.getValByKey("billApproval","pending_review"),e.statusValue="AUDITING",e.tableModel.restData.includeAllAudit=!1,e.customerName=e.customerValue="",e.platform=e.platformValue="",e.payWay="",e.startTime=u.start,e.endTime=u.end,e.search()},e.draft=function(){if(e.submitForm.$setPristine(),e.submitForm.$setUntouched(),!l.getSelectTable(e.tableModel.tableBody).length)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;e.popTitle=Lang.getValByKey("billApproval","to_draft"),e.popType="DRAFT",e.remark="",e.popBox=!0,$("#pop-box").css("display","table")},e.passed=function(){if(e.submitForm.$setPristine(),e.submitForm.$setUntouched(),!l.getSelectTable(e.tableModel.tableBody).length)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;e.popTitle=Lang.getValByKey("billApproval","aduit_passed"),e.popType="CHARGEOFF",e.remark="",e.popBox=!0,$("#pop-box").css("display","table")},e.paid=function(){e.submitForm.$setPristine(),e.submitForm.$setUntouched();var a=l.getSelectTable(e.tableModel.tableBody);if(!a.length)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;var o=[];angular.forEach(a,function(e){o.push(e.billNo)});var r={urlParams:o,seatParams:{type:2}};t.checkPopType(r,function(t){0===t.errorCode?(e.popTitle=Lang.getValByKey("billApproval","payed"),e.popType="PAID",e.remark="",e.popBox=!0,$("#pop-box").css("display","table")):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},e.exportExcel=function(){var a=l.getSelectTable(e.tableModel.tableBody);if(!a.length)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;var o={title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:"确定导出已选账单？"},operation:[{type:"submit",description:"确定",application:"",operationEvent:function(){var l=[];angular.forEach(a,function(e){l.push(e.billNo)});var o={urlParams:l,seatParams:{interType:e.interType,subInterType:e.subInterType}};t.exportExcel(o,function(e){if(0===e.errorCode){$(document).promptBox("closePrompt"),$(".download-file-box").html("");for(var t=0,a=e.data.length;t<a;t++)$(".download-file-box").append('<a target="download-iframe" href="'+e.data[t].url+'" class="download-file" >点击下载</a>');$(".download-file").each(function(e){var t=$(this);setTimeout(function(){t[0].click()},1e3*e)})}else $(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})}}]};$(document).promptBox(o)},e.submit=function(){if(!$.trim(e.remark))return void e.submitForm.remark.$setDirty();if("ADJUST"==e.popType){if(void 0==e.adjustVal||e.adjustValError)return;var a={urlParams:{billNo:e.billNos,adjustmentTypeCode:e.adjustTypeValue,adjustmentValue:e.adjustVal,adjustmentUnit:e.adjustUnitValue,adjustmentRemark:e.remark},seatParams:{interType:e.interType,subInterType:e.subInterType}};t.adjust(a,function(t){0===t.errorCode?(e.popBox=!1,$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.getBillList()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}else{var o=l.getSelectTable(e.tableModel.tableBody),r=[];angular.forEach(o,function(e){r.push(e.billNo)});var a={urlParams:{billNos:r,type:e.popType,msg:e.remark},seatParams:{interType:e.interType,subInterType:e.subInterType}};t.audit(a,function(t){0===t.errorCode?(e.popBox=!1,$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.getBillList()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}},e.adjust=function(t,a,l,o,r,s,n){e.submitForm.$setPristine(),e.submitForm.$setUntouched(),e.billNos=t,e.popTitle=Lang.getValByKey("billApproval","price_change"),e.popType="ADJUST",e.adjustValError=!1,e.adjustInfoShow=!1,"UPPER"==a?(e.adjustType=Lang.getValByKey("billApproval","to_up"),e.adjustTypeValue="UPPER"):(e.adjustType=Lang.getValByKey("billApproval","to_down"),e.adjustTypeValue="DOWN"),s&&(e.adjustTotal=s,e.adjustInfoShow=!0),n&&(e.adjustCurrencyType=n,e.adjustInfoShow=!0),e.adjustVal=l||0,"2"==o?(e.adjustUnit=Lang.getValByKey("billApproval","money"),e.adjustUnitValue="2"):(e.adjustUnit=Lang.getValByKey("billApproval","percent"),e.adjustUnitValue="1"),e.remark=r||"",Select.sharePool["adjust-type"]="",Select.sharePool["adjust-unit"]="",e.popBox=!0,$("#pop-box").css("display","table")},e.billsDetail=function(t,a,l,o){window.location.href="#/billDetail?billNo="+t+"&customerId="+a+"&from=billApproval&status="+l+"&currency="+o+"&module="+e.module+"&submodule="+e.submodule},e.flowProcess=function(t){window.location.href="#/billStream?billNo="+t+"&from=billApproval&module="+e.module+"&submodule="+e.submodule};var i;e.showStatus=function(){if(!i){var a={urlParams:{isAudit:1},seatParams:{interType:e.interType,subInterType:e.subInterType}};e.statusData=t.getStatus(a),i=selectFactory({data:e.statusData,defaultText:Lang.getValByKey("common","common_all_tips"),id:"select-status",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(t){t?(e.tableModel.restData.includeAllAudit=!1,e.statusValue=t):(e.tableModel.restData.includeAllAudit=!0,e.statusValue="AUDITING"),e.$apply()},attrTextModel:function(t){e.status=t,e.$apply()}}),i.setData(e.statusData),i.open(),$("#select-status").val(e.status)}},e.getCustomerData=function(a,l){e.userType=e.userType?e.userType:"trade"==e.paramter.module?2:1,l||(l=1),a=a||"";var o={urlParams:{q:a?a.trim():"",pageIndex:l,pageSize:10,isAsc:!1,sortName:"",userType:e.userType}};return t.getCustomer(o)},e.getCustomer=function(){e.customerData=e.getCustomerData(),angular.forEach(e.customerData.data,function(e,t){e.userName+="("+e.code+")"});var t=selectFactory({data:e.customerData,isSearch:!0,isUsePinyin:!0,multipleSign:",",defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-customer",pagination:!0,searchPlaceHoder:Lang.getValByKey("common","common_select_search_account_tips"),showTextField:"userName",attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(t,a,l){e.customerData=e.getCustomerData(a,l),angular.forEach(e.customerData.data,function(e,t){e.userName+="("+e.code+")"}),t.setData(e.customerData),e.$apply()},attrTextId:function(t){e.customerValue=e.customerValue?e.customerValue+","+t:t,e.$apply()},attrTextModel:function(t){e.customerName=t,e.$apply()}});t.setData(e.customerData),t.open(),$("#select-customer").val(e.customerName)},e.$watch("customerName",function(t,a){t!==a&&(t||(e.customerValue=""))},!0),e.getSupplierListData=function(a,l){a=a||"";var o={urlParams:{q:a,pageIndex:l||1,pageSize:10},seatParams:{intertype:e.module}},r=t.getSupplierList(o);return angular.forEach(r.data,function(e,t){e.name+="("+e.code+")"}),r},e.getSupplier=function(){e.supplierData=e.getSupplierListData(),selectFactory({data:[],isSearch:!0,isUsePinyin:!0,multipleSign:",",defaultText:Lang.getValByKey("common","common_select_tips"),id:"select-supplier",showTextField:"name",searchPlaceHoder:"请输入供应商名称或编码",pagination:!0,attrTextField:{"ng-value":"id"},closeLocalSearch:!0,onSearchValueChange:function(t,a,l){e.supplierData=e.getSupplierListData(a,l),t.setData(e.supplierData),e.$apply()},attrTextId:function(t){e.customerValue=e.customerValue?e.customerValue+","+t:t,e.$apply()},attrTextModel:function(t){e.customerName=t,e.$apply()}}).open()};var p;e.getPlatform=function(){p||(e.platformData=t.getPlatformData(),p=selectFactory({data:e.platformData,defaultText:"全部",id:"select-platform",multipleSign:",",showTextField:"name",attrTextField:{"ng-value":"id"},attrTextId:function(t){e.platformValue=t?e.platformValue?e.platformValue+","+t:t:"",e.$apply()},attrTextModel:function(t){e.platform=t,e.$apply()}}),p.open(),$("#select-platform").val(e.platform))},e.showAdjustType=function(){e.adjustTypeData={data:[{name:Lang.getValByKey("billApproval","to_up"),code:"UPPER"},{name:Lang.getValByKey("billApproval","to_down"),code:"DOWN"}]};var t=selectFactory({data:e.adjustTypeData,id:"adjust-type",defaultText:"",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.adjustTypeValue=t,e.$apply()},attrTextModel:function(t){e.adjustType=t,e.$apply()}});t.setData(e.adjustTypeData),t.open(),$("#adjust-type").val(e.adjustType)},e.showAdjustUnit=function(){e.adjustUnitData={data:[{name:Lang.getValByKey("billApproval","percent"),code:"1"},{name:Lang.getValByKey("billApproval","money"),code:"2"}]};var t=selectFactory({data:e.adjustUnitData,id:"adjust-unit",showTextField:"name",defaultText:"",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.adjustUnitValue!=t&&(e.adjustVal=0,e.adjustValError=!1),e.adjustUnitValue=t,e.$apply()},attrTextModel:function(t){e.adjustUnit=t,e.$apply()}});t.setData(e.adjustUnitData),t.open(),$("#adjust-unit").val(e.adjustUnit)},e.ngChange=function(){if(e.adjustVal){/^(\d{1}|[1-9][0-9]*)$|^(0{1}|[1-9][0-9]*)\.\d{1,3}$/.test(e.adjustVal)?e.adjustValError=!1:e.adjustValError=!0}},e.payment=function(a){var l={urlParams:{outCustomerId:a.platformId,inCustomerId:a.bizCompanyId}};t.getThirdPayAccountId(l,function(t){0===t.errorCode&&t.data?(e.block="payment",n.dispatch("paymentData",{billInfo:{billNo:a.billNo,platformName:a.platformName,platformCode:a.platformCode,platformId:a.platformId,startEffectTime:a.startEffectTime,endEffectTime:a.endEffectTime,bizCompanyName:a.bizCompanyName,total:a.total,actualTotal:a.actualTotal,currencyType:a.currencyType,bizCompanyId:a.bizCompanyId,outCustAcctId:"",outThirdCustId:"",outThirdPayName:"",inCustAcctId:"",inThirdCustId:"",inThirdPayName:""},thirdPayAccountId:t.data.Id||""})):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})};var d;e.showPayWay=function(){if(!d){var a={urlParams:{q:"",pageIndex:1,pageSize:100}};e.payWayData=t.getPayWayData(a),d=selectFactory({data:e.payWayData,defaultText:Lang.getValByKey("common","common_all_tips"),id:"select-payWay",attrTextModel:function(t,a,l){e.payWay=t||"",e.$apply()}}),d.open()}}}])});