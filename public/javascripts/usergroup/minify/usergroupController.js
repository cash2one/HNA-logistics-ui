easySpa.require(["widget/slimscroll","widget/nestable","widget/prompt","widget/tab","public/common/tableController.js"],function(){app.controller("usergroupCtrl",["$scope","usergroupService","usergroupView","tableService",function(e,r,o,t){function a(){$("#tree").nestable({isRoot:!1,iconOpen:"icon-usergroup-Open",iconClose:"icon-usergroup-Close",iconSeat:"icon-usergroup",addChildNodes:function(e){i(e)},deleteNodes:function(e,r,o,t){l(e,r,o,t)},childUrl:Interface.getUrlById("logistics.userTreeChildUrl"),newItemUid:$("input[name=newOrganizationId]"),searchUrl:Interface.getUrlById("logistics.userSearchTreeUrl"),resetNode:Interface.getUrlById("logistics.getGroupNode"),searchInput:$("input[name=organization]"),searchTip:Lang.getValByKey("usergroup","usergroup_tree_search"),searchKeyNodes:function(e){s(e),n(e)},clickNode:function(e){s(e,"clickNode"),n(e)},loadFirstNode:function(e){s(e)},treeScrollHeight:$(".tree-scroll-isAdd-box"),newNodeText:Lang.getValByKey("usergroup","usergroup_nestable_seat_tip"),maxDepthText:Lang.getValByKey("usergroup","usergroup_nestable_add_tip"),callback:function(r){r||e.userGroup.tab.exdisable(e.userGroup.tab.getIndex())}}).on("change",function(){var e=0==$(".moving").prev().length?0:$(".moving").prev().data("uid"),r=$(".moving").data("uid"),o=$("li[data-uid="+r+"]").parent().parent(".dd-item").data("uid");o=void 0==o?0:o,u(r,o,e)})}function u(e,o,t){var a={seatParams:{userGroupId:e},urlParams:{targetparentid:o,targetpreid:t}};r.moveGroup(a,function(r){0==r.errorCode?$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success"}):$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0}),$('input[name="newOrganizationId"]').data("value",e),$("#tree").nestable("resetSearchNode")})}function s(r,o){e.getUid=r,e.userGroup.tab.enableAll(),$(".new-nodes").remove(),d(r),e.$apply()}function n(r,o){function a(){$(".table-container tbody").slimscroll({height:$(".content-main").height()-340})}e.tableModel.restData.pageSize=10,e.tableModel.restData.isIncludeSubOrg=!0,"clickNode"==o&&(e.tableModel.restData.q="");var u={urlParams:e.tableModel.restData,seatParams:{uid:r}};t.getTable(e.tableModel.restURL,u,function(r){0===r.errorCode&&(e.tableModel=t.table(e.tableModel,u,r))}),a(),$(window).on("resize",a),e.$apply()}function d(o){r.getGroupDetail(o,function(r){if(0==r.errorCode&&null!=r.data){e.userGroup.edit=!1,e.userGroup.visible=!1,e.userGroup.validate=!1,e.userGroup.validateRequired=!1;var o=r.data;e.userGroup.getOrgName=o.shortName,e.userGroup.parentId=o.parentId,e.userGroup.orgId=o.id,e.userGroup.orgName=o.name,e.userGroup.orgShortName=o.shortName,e.userGroup.orgCode=o.code,e.userGroup.description=o.description}})}function i(r){e.userGroup.tab.exdisable(0),e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,$('button[name="userGroupEdit"]').addClass("save").removeClass("edit"),e.userGroup.edit=!0,e.userGroup.visible=!0,e.userGroup.validate=!0,e.userGroup.validateRequired=!0,e.userGroup.orgNameInfo="",e.userGroup.orgShortNameInfo="",e.userGroup.orgCodeInfo="",e.userGroup.descriptionInfo="",e.userGroup.orgId=r,e.textNumber=140,e.userGroup.form.$setPristine(),e.userGroup.form.$setUntouched(),e.$apply()}function l(r,o,t,a){s(r,"clickNode"),n(r),e.userGroup.tab.enableAll(),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("usergroup","usergroup_prompt_delete_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){c(r,a),e.$apply()}}]})}function c(o,t){r.deleteUserGroup(o,function(r){if(0==r.errorCode){$(document).promptBox("closePrompt"),a(),1==$("#tree .dd-item").length&&(e.disabledEdit=!0,e.userGroup.orgName="",e.userGroup.orgShortName="",e.userGroup.orgCode="",e.userGroup.description="");var t=$(".dd-item[data-uid="+r.data+"]").parent().parent().data("uid");$('input[name="newOrganizationId"]').data("value",t),void 0==t?$("#tree").nestable("resetTreeGroup"):$("#tree").nestable("resetDeleteGroup"),$('li[data-uid="'+o+'"]').remove(),e.userGroup.orgNameInfo="",e.userGroup.orgShortNameInfo="",e.userGroup.orgCodeInfo="",e.userGroup.descriptionInfo="",e.userGroup.orgName="",e.userGroup.orgShortName="",e.userGroup.orgCode="",e.userGroup.description="",e.userGroup.orgId="",$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success"})}else $(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})}function p(r,o,a){function u(){$(".selected-user").slimscroll({height:window.innerHeight-250})}e.tableModel.restData.pageSize=1e4,e.userGroup.selectOrgId=r;var s={urlParams:e.tableModel.restData,seatParams:{uid:r}};t.getTable(e.tableModel.searchNameAndIdURL,s,function(r){if(0===r.errorCode){var t=r.data;if("unselected"==o)if(void 0!=a)if("all"==a){for(var u in t)t[u].checked=!0;e.userGroup.tableUserGroup=t}else{for(var u in t)for(var s in a)a[s].userId==t[u].userId&&(t[u].checked=!0,t[u].disabled=!0);e.userGroup.tableUserGroup=t}else e.userGroup.tableUserGroup=t;else{e.userGroup.selectedUserGroup=t;for(var s in t)g.push(t[s])}}}),u(),$(window).on("resize",u)}function m(o){var t={seatParams:{},urlParams:o};r.deleteTableUser(t,function(r){if(0==r.errorCode){var o=e.getUid;$('input[name="newOrganizationId"]').data("value",o),$("#tree").nestable("resetSearchNode"),e.tableModel.restData.isIncludeSubOrg=!0,n(e.userGroup.orgId),$(document).promptBox("closePrompt"),$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success"})}else $(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})}e.userGroup={main:!1,edit:!1,visible:!1,validate:!1,validateRequired:!1,tableUserGroup:"",selectedUserGroup:"",selectOrgId:"",searchSelect:"",searchSelected:"",getOrgName:"",parentId:"",orgId:"",orgName:"",orgNameInfo:"",orgShortName:"",orgShortNameInfo:"",orgCode:"",orgCodeInfo:"",description:"",descriptionInfo:"",moveUser:{uncheckedAll:!1,unchecked:!1,checkedAll:!1,checked:!1,uncheckedOne:!1,checkedOne:!1,unSelectValue:"",selectValue:""}},e.tableModel={more:!1,userWord:"",tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("common","common_thead_full_name"),Lang.getValByKey("common","common_thead_only_code"),Lang.getValByKey("common","common_thead_user_org"),Lang.getValByKey("common","common_thead_job"),Lang.getValByKey("common","common_thead_phone")],tableBody:[],restURL:"logistics.userTableUrl",searchNameAndIdURL:"logistics.searchByNameAndId",restData:{q:"",locked:-1,pageIndex:1,pageSize:10},seatData:{uid:""},selectNumber:0,selectFlag:!1},e.swichEvent=function(r){$(".new-nodes").parent().parent().children(".dd3-content").addClass("active"),$(".new-nodes").remove(),1==r?n(e.userGroup.orgId):d(e.userGroup.orgId)},e.$on("$viewContentLoaded",function(){a()}),e.disabledEdit=!0,$.ajax({url:Interface.getUrlById("logistics.userTreeChildUrl")+0,type:"GET",async:!0,dataType:"json",success:function(r){0==r.errorCode&&(0==r.data.length?e.disabledEdit=!0:e.disabledEdit=!1)}}),e.editUserGroup=function(){e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,$('button[name="userGroupEdit"]').addClass("edit").removeClass("save"),e.userGroup.edit=!e.userGroup.edit,e.userGroup.visible=!e.userGroup.visible,e.userGroup.validate=!0,e.userGroup.validateRequired=!0,e.userGroup.orgNameInfo=e.userGroup.orgName,e.userGroup.orgShortNameInfo=e.userGroup.orgShortName,e.userGroup.orgCodeInfo=e.userGroup.orgCode,e.userGroup.descriptionInfo=$.trim(e.userGroup.description),e.textNumber=140-e.userGroup.descriptionInfo.length},e.closeUserGroup=function(){e.userGroup.tab.enableAll(),e.userGroup.edit=!1,e.userGroup.visible=!1,e.userGroup.validate=!1,e.userGroup.validateRequired=!1,$(".new-nodes").parent().parent().children(".dd3-content").addClass("active"),$(".new-nodes").remove();var r=$("#tree .dd3-content.active").parent().data("uid");void 0==r?($('.dd-item[data-uid="'+e.getUid+'"]').children(".dd3-content").addClass("active"),d(e.getUid)):d(r)},e.submitUserGroup=function(){if(e.userGroup.orgNameInfo||e.userGroup.form.orgNameInfo.$setDirty(),e.userGroup.orgShortNameInfo||e.userGroup.form.orgShortNameInfo.$setDirty(),e.userGroup.orgCodeInfo||e.userGroup.form.orgCodeInfo.$setDirty(),e.userGroup.form.$valid&&1!=e.validateOrgError&&1!=e.validateOrgShortError&&1!=e.validateCodeError){var o;o=$('button[name="userGroupEdit"]').hasClass("edit")?e.userGroup.parentId:e.userGroup.orgId;var t={parentId:o,name:e.userGroup.orgNameInfo,shortName:e.userGroup.orgShortNameInfo,code:e.userGroup.orgCodeInfo,description:e.userGroup.descriptionInfo};if($('button[name="userGroupEdit"]').hasClass("edit")){var a=e.userGroup.orgId,u={seatParams:{userGroupId:a},urlParams:t};r.saveEditUserGroup(u,function(r){0==r.errorCode?(e.disabledEdit=!1,e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,e.userGroup.edit=!e.userGroup.edit,e.userGroup.visible=!e.userGroup.visible,e.userGroup.validate=!1,e.userGroup.validateRequired=!1,$('input[name="newOrganizationId"]').data("value",r.data),$("#tree .active").attr("title",t.shortName),$("#tree .active").attr("data-name",t.shortName),$("#tree .active").attr("data-orgname",t.shortName),$(".dd3-content.active .item-text").html(t.shortName),d(r.data),$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})}else{var u={urlParams:t};r.saveAddUserGroup(u,function(o){if(0==o.errorCode){e.userGroup.tab.enableAll(),e.disabledEdit=!1,e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,e.userGroup.edit=!e.userGroup.edit,e.userGroup.visible=!e.userGroup.visible,e.userGroup.validate=!1,e.userGroup.validateRequired=!1,d(o.data);var t=o.data;e.getUid=t,r.getGroupDetail(t,function(e){0==e.errorCode&&null!=e.data&&(0==e.data.parentId?($('input[name="newOrganizationId"]').data("value",t),$("#tree").nestable("resetAllGroup")):($('input[name="newOrganizationId"]').data("value",t),$("#tree").nestable("resetGroup")))}),$('button[name="userGroupEdit"]').removeClass("save").addClass("edit"),$(document).promptBox({isDelay:!0,contentDelay:o.msg,type:"success"})}else $(document).promptBox({isDelay:!0,contentDelay:o.msg,type:"errer",manualClose:!0})})}}},e.addUsers=function(){e.userGroup.tab.exdisable(0),e.validateOrgError=!1,e.validateOrgShortError=!1,e.validateCodeError=!1,$(".seat-node").length>0&&$(".seat-node").remove(),$(".new-nodes").remove(),$("#tree .dd3-content").removeClass("active");var r=Lang.getValByKey("usergroup","usergroup_nestable_seat_tip");$("#tree").children("ol").after('<li class="seat-node new-nodes dd-item dd3-item"><div class="dd3-content active">'+r+"</div></li>"),$(".new-nodes").offset().top-40>$("#tree").height()?$("#tree").scrollTop(40*$("#tree .dd-item").length):$("#tree").scrollTop(0),$('button[name="userGroupEdit"]').addClass("save").removeClass("edit"),e.userGroup.edit=!0,e.userGroup.visible=!0,e.userGroup.validate=!0,e.userGroup.validateRequired=!0,e.userGroup.orgNameInfo="",e.userGroup.orgShortNameInfo="",e.userGroup.orgCodeInfo="",e.userGroup.descriptionInfo="",e.userGroup.orgId=0,e.textNumber=140,e.userGroup.form.$setPristine(),e.userGroup.form.$setUntouched()},e.addGroupUser=function(){function o(){function r(r){e.tableModel.restData.isIncludeSubOrg=!0,e.tableModel.restData.pageSize=1e4,e.userGroup.selectOrgId=r;var o={urlParams:e.tableModel.restData,seatParams:{uid:e.userGroup.orgId}};t.getTable(e.tableModel.restURL,o,function(o){if(0===o.errorCode){e.userGroup.moveUser.unchecked=!1,e.userGroup.moveUser.uncheckedAll=!1,e.userGroup.moveUser.checked=!1,e.userGroup.moveUser.checkedAll=!1;var t=[],a=[],u=$(".selected input");u.each(function(e){a[e]={},a[e].userId=u.eq(e).data("userid"),a[e].fullName=u.eq(e).data("name"),t.push(a[e])});var s;if(0!=t.length)for(var n in t)if(0!=o.data.length)for(var d in o.data)n==d&&o.data[n].userId!=t[n].userId&&(s=!0);else s=!0;else 0!=o.data.length&&(s=!0);s?p(r,"unselected",t):p(r,"unselected",o.data)}}),e.$apply()}e.userGroup.moveUser.unSelectValue="",e.userGroup.moveUser.selectValue="",e.tableModel.restData.isIncludeSubOrg=!1,p(e.userGroup.orgId,"selected"),1==$("#selectGroup").length&&($("#selectGroup").remove(),$("#userGroup .slimScrollDiv").length>0&&$("#userGroup .panel").first().find(".slimScrollDiv").remove(),$("#userGroup .panel").first().append('<div id="selectGroup"></div>')),$("#selectGroup").nestable({iconOpen:"icon-organization-Open",iconClose:"icon-organization-Close",iconSeat:"icon-organization",isMove:!0,isOperate:!0,isRoot:!0,childUrl:Interface.getUrlById("logistics.treeChildUrl"),searchUrl:Interface.getUrlById("logistics.searchTreeUrl"),searchInput:$("input[name=userOrganization]"),searchTip:Lang.getValByKey("usergroup","usergroup_tree_search"),searchKeyNodes:function(e){r(e)},clickNode:function(e){r(e)},loadFirstNode:function(e){r(e)},treeScrollHeight:$(".select-tree-box")})}g=[],$(document).promptBox({title:Lang.getValByKey("usergroup","usergroup_prompt_add_text_first")+'<span style="color: #42b0d8;">'+e.userGroup.getOrgName+"</span>"+Lang.getValByKey("usergroup","usergroup_prompt_add_text_last"),isHidden:!0,boxWidth:!0,isNest:!0,loadData:function(){o()},loadTitle:function(){return e.userGroup.getOrgName},content:{nest:$("#userGroup")},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_confirm"),operationEvent:function(){var o=[],t=$(".selected input");t.each(function(e){null!=t.eq(e).data("userid")&&o.push(t.eq(e).data("userid"))});var a={seatParams:{userGroupId:e.userGroup.orgId},urlParams:o};r.addTableUser(a,function(r){if(0==r.errorCode){var o=e.getUid;$('input[name="newOrganizationId"]').data("value",o),$("#tree").nestable("resetSearchNode"),$(document).promptBox("closeFormPrompt"),e.tableModel.restData.q="",$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success"})}else $(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})}}]})};var g=[];e.addUnselected=function(){var r=[],o=[],t=$('.unselect input[checked="checked"]');t.each(function(e){o[e]={},t.eq(e).is(":disabled")||(o[e].userId=t.eq(e).data("userid"),o[e].fullName=t.eq(e).data("name"),t.eq(e).attr("checked",!0),t.eq(e).attr("disabled",!0),t.eq(e).parent().parent().find("i").addClass("icon-disabled"),t.eq(e).parent().parent().addClass("icon-disabled"),r.push(o[e]),g.push(o[e]))});var a=[],u=$(".selected input");u.each(function(e){a[e]={},a[e].userId=u.eq(e).data("userid"),a[e].fullName=u.eq(e).data("name"),u.eq(e).attr("checked",!1)});var s=r.concat(a);e.userGroup.selectedUserGroup=s},e.cancelSelected=function(){var e=[],r=$(".unselect input");r.each(function(o){e[o]={},e[o].userId=r.eq(o).data("userid"),e[o].fullName=r.eq(o).data("name")});var o=[],t=$('.selected input[checked="checked"]');t.each(function(e){o[e]={},o[e].userId=t.eq(e).data("userid"),o[e].fullName=t.eq(e).data("name"),t.eq(e).parent().parent().remove(),g.removeByValue(o[e].userId,"userId")});var a=[];for(var u in o)for(var s in e)o[u].userId==e[s].userId&&a.push(e[s]);var n=$('.unselect input[checked="checked"]');n.each(function(e){for(var r in a)a[r].userId==n.eq(e).data("userid")&&(n.eq(e).removeAttr("checked"),n.eq(e).removeAttr("disabled"),n.eq(e).parent().parent().find("i").removeClass("icon-disabled"),n.eq(e).parent().parent().removeClass("icon-disabled"))})},Array.prototype.removeByValue=function(e,r){for(var o=0;o<this.length;o++)if(this[o][r]==e){this.splice(o,1);break}},e.getUnselect=function(r){$(r.target).is(":checked")?$(r.target).attr("checked","checked"):($(r.target).attr("checked",!1),e.userGroup.moveUser.uncheckedAll=!1)},e.getSelected=function(r){$(r.target).is(":checked")?$(r.target).attr("checked","checked"):($(r.target).attr("checked",!1),e.userGroup.moveUser.checkedAll=!1)},e.unSelectAll=function(){var r=[],o=$(".selected input");o.each(function(e){r[e]={},r[e].userId=o.eq(e).data("userid"),r[e].fullName=o.eq(e).data("name")}),1==e.userGroup.moveUser.uncheckedAll?(e.userGroup.moveUser.unchecked=!1,e.userGroup.moveUser.uncheckedAll=!1):(e.userGroup.moveUser.unchecked=!0,e.userGroup.moveUser.uncheckedAll=!0)},e.selectedAll=function(){1==e.userGroup.moveUser.checkedAll?(e.userGroup.moveUser.checked=!1,e.userGroup.moveUser.checkedAll=!1):(e.userGroup.moveUser.checked=!0,e.userGroup.moveUser.checkedAll=!0)},e.searchUnSelectUser=function(){e.tableModel.restData.q=e.userGroup.moveUser.unSelectValue,e.tableModel.restData.pageSize=1e4;var r={urlParams:e.tableModel.restData,seatParams:{uid:e.userGroup.orgId}};t.getTable(e.tableModel.searchNameAndIdURL,r,function(r){0===r.errorCode&&(e.userGroup.moveUser.unchecked=!1,e.userGroup.moveUser.uncheckedAll=!1,e.userGroup.moveUser.checked=!1,e.userGroup.moveUser.checkedAll=!1,p(e.userGroup.selectOrgId,"unselected",r.data),e.tableModel.restData.q="")})},e.searchSelectedUser=function(){var r=[],o=[],t=$(".selected");if(t.each(function(a){o[a]={},-1!=$.trim(t.find("span").eq(a).text()).indexOf($.trim(e.userGroup.moveUser.selectValue))&&(o[a].userId=t.find("input").eq(a).data("userid"),o[a].fullName=t.find("input").eq(a).data("name"),r.push(o[a]))}),e.userGroup.moveUser.selectValue.length)e.userGroup.selectedUserGroup=r;else{var a=[];for(var u in g)"function"!=typeof g[u]&&a.push(g[u]);e.userGroup.selectedUserGroup=a}},e.deleteGroupUser=function(){if(0!=e.tableModel.selectNumber){var r=[];$('.user-table tbody input[checked="checked"]').parents("tr").each(function(e,o){var t={};t.userId=$(o).data("id"),t.orgId=$(o).data("orgid"),r.push(t)}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("usergroup","usergroup_prompt_remove_tip")},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_remove"),application:"delete",operationEvent:function(){m(r)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_prompt_delay_tip"),type:"errer",manualClose:!0})},e.retrievalUser=function(){e.q=e.tableModel.restData.q,e.tableModel.restData.isIncludeSubOrg=!0,e.tableModel.restData.pageIndex=1;var r={urlParams:e.tableModel.restData,seatParams:{uid:e.userGroup.orgId}};t.getTable(e.tableModel.restURL,r,function(o){0===o.errorCode&&(e.tableModel=t.table(e.tableModel,r,o))})},e.focusOrgName=function(){e.validateOrgError=!1},e.validateOrgName=function(){var o,t,a=e.userGroup.orgNameInfo||"";if(a){0==$(".new-nodes").length?(t=e.userGroup.orgId,o=e.userGroup.parentId||0):(t="",o=e.userGroup.orgId);var u={urlParams:{name:a,parentId:o,userGroupId:t}};r.validateUserGroupName(u,function(r){0!=r.errorCode?e.validateOrgError=!0:e.validateOrgError=!1})}},e.focusOrgShortName=function(){e.validateOrgShortError=!1},e.validateOrgShortName=function(){var o,t,a=e.userGroup.orgShortNameInfo||"";if(a){0==$(".new-nodes").length?(t=e.userGroup.orgId,o=e.userGroup.parentId||0):(t="",o=e.userGroup.orgId);var u={urlParams:{shortName:a,parentId:o,userGroupId:t}};r.validateUserGroupShortName(u,function(r){0!=r.errorCode?e.validateOrgShortError=!0:e.validateOrgShortError=!1})}},e.focusOrgCode=function(){e.validateCodeError=!1},e.validateOrgCode=function(){var o,t=e.userGroup.orgCodeInfo;if(t){o=0==$(".new-nodes").length?e.userGroup.orgId:"";var a={urlParams:{code:t,userGroupId:o}};r.validateUserGroupCode(a,function(r){0!=r.errorCode?e.validateCodeError=!0:e.validateCodeError=!1})}},e.textNumber=140,e.showTextNumber=function(){e.textNumber=140-e.userGroup.descriptionInfo.length},e.visibleTextNumber=function(){e.textCountVisible=!0},e.hiddenTextNumber=function(){e.textCountVisible=!1},e.userGroup.tab=o.tab("#m-tab",e.swichEvent)}])});