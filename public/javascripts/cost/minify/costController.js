easySpa.require(["widget/slimscroll","widget/prompt","widget/select","public/common/tableController.js"],function(){app.controller("costCtrl",["$scope","costService","costView","tableService",function(e,t,o,a){function s(t){var o="";return angular.forEach(e.cost.bigType,function(e){e.code==t&&(o=e.name)}),o}function n(e){var t=e?e.length:0;$("#globalization").children("li").each(function(){$(this).children("input").next(".verification").children("span").html("");for(var o=$(this).children("input").val("").attr("data-code"),a=0;a<t;a++)e[a].language.toLowerCase()==o.toLowerCase()&&$(this).children("input").val(e[a].localName)})}e.cost={type:"",id:0,bigType:[]},e.tableCost={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("cost","cost_page_costname"),Lang.getValByKey("common","common_code_code"),Lang.getValByKey("common","common_thead_type"),Lang.getValByKey("common","common_page_remarks")],tableBody:[],restURL:"logistics.getCostTable",restData:{q:"",pageIndex:1,pageSize:10,type:"",sort:"code"},selectNumber:0,selectFlag:!1},e.getLanguage=function(){t.getLanguage(function(t){0===t.errorCode&&(e.language=t.data)})},e.getLanguage(),e.init=function(){var o=t.getBigType();selectFactory({data:o,defaultText:"",id:"type-select-input",showTextField:"name",attrTextField:{"ng-value":"code"},attrTextId:function(t){e.costTypeValue=t},attrTextModel:function(t){e.costTypeName=t,e.$apply()}})},e.getCostTable=function(t,s,n){void 0==t&&void 0==s||n?(e.q=e.tableCost.restData.q,e.cost.type=e.tableCost.restData.type,n&&(e.tableCost.restData.pageIndex=1)):(e.tableCost.restData.pageIndex=1,o.active(t),e.q=e.tableCost.restData.q="",e.cost.type=e.tableCost.restData.type=void 0==s?"":s);var r={urlParams:e.tableCost.restData};a.getTable(e.tableCost.restURL,r,function(t){if(0===t.errorCode){e.tableCost=a.table(e.tableCost,r,t);var s=o.height("table");setTimeout(function(){o.slimscroll(".table-container tbody",s),$(window).resize(function(){s=o.height("table"),o.slimscroll(".table-container tbody",s)})},10)}})},e.getBigType=function(){t.getBigType(function(t){if(0===t.errorCode){e.cost.bigType=t.data,e.getCostTable(0);var a=o.height("bigType");setTimeout(function(){o.slimscroll("#cost-block",a),$(window).resize(function(){a=o.height("bigType"),o.slimscroll("#cost-block",a)})},10)}})},e.getBigType(),e.delCost=function(){var s=[],n=a.getSelectTable(e.tableCost.tableBody);if(!n.length)return o.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;angular.forEach(n,function(e){s.push(e.id)});var r={title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("cost","cost_code_delCostType")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){t.delCost(s,function(t){0===t.errorCode?(o.promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),o.promptBox("closePrompt"),e.$apply(e.getCostTable())):o.promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]};o.promptBox(r)};var r=$("#nest-CostFrom .label-text");o.propmtCostEvent(r),e.addCost=function(){e.CostFrom.$setPristine(),e.CostFrom.$setUntouched(),$("#nest-CostFrom").find(".title").text(Lang.getValByKey("cost","cost_page_newcost")),e.nestCostFrom=!0,$("#nest-CostFrom").attr("style",""),e.costName="",e.costCode="",e.remark="",e.textareaNumber=140,e.cost.type?(e.costTypeName=s(e.cost.type),e.costTypeValue=e.cost.type):(e.costTypeName="",e.costTypeValue=""),$("#globalization").find(".input-text").each(function(){$(this).val(""),$(this).next(".verification").children("span").html("")}),o.loadBarEvent(r),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.cancelCost=function(){e.nestCostFrom=!1,e.cost.id&&(e.cost.id=0),$("#code-msg").removeClass("remote-invalid")},e.saveCost=function(){if(e.costName||e.CostFrom.costName.$setDirty(),e.costCode||e.CostFrom.costCode.$setDirty(),e.costTypeName||e.CostFrom.costTypeName.$setDirty(),$("#code-msg").hasClass("remote-invalid")||!e.CostFrom.$valid)return void o.displayErrorBox(r);var a=[];$("#globalization").children("li").each(function(){if($.trim($(this).children("input").val())){var e={};e.language=$(this).children("input").attr("data-code"),e.localName=$.trim($(this).children("input").val()),a.push(e)}});var s={urlParams:{name:e.costName,code:e.costCode,type:e.costTypeValue,description:e.remark,i18n:a}};e.cost.id?(s.seatParams={id:e.cost.id},t.saveEditCost(s,function(t){0===t.errorCode?(o.promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.nestCostFrom=!1,e.getCostTable(),e.cost.id&&(e.cost.id=0)):o.promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})):t.saveCost(s,function(t){0===t.errorCode?(o.promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.nestCostFrom=!1,e.getCostTable()):o.promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})},e.checkCode=function(){var o={urlParams:{code:e.costCode,sid:e.cost.id}};e.costCode&&t.checkCode(o,function(t){0!=t.errorCode?(e.CostFrom.costCode.errorTips=t.msg,$("#code-msg").removeClass("ng-hide").addClass("remote-invalid")):($("#code-msg").addClass("ng-hide").removeClass("remote-invalid"),e.CostFrom.costCode.errorTips="")})},e.editCost=function(a){e.cost.id=a,e.CostFrom.costCode.errorTips="",$("#nest-CostFrom").find(".title").text(Lang.getValByKey("cost","cost_code_costDetail")),e.nestCostFrom=!0,$("#nest-CostFrom").attr("style",""),o.loadBarEvent(r),$('button[name="prompt-save"]').addClass("save").removeClass("edit"),t.getCostDetail(a,function(t){t&&0===t.errorCode&&(e.costName=t.data.name,e.costCode=t.data.code,e.costTypeName=s(t.data.type),e.costTypeValue=t.data.type,n(t.data.i18n),e.remark=t.data.description,e.textareaNumber=140-(e.remark?e.remark.length:0))})},e.international=function(){window.location.href="#/international?q=cost"},e.showTextNumber=function(){e.textareaNumber=140-e.remark.length}}])});