easySpa.require(["public/lib/bmap.min.js"],function(){app.controller("staticsCtrl",["$scope","cockpitService",function(e,t){function a(){var t={data:[{name:"物流",code:"logistics"},{name:"贸易",code:"trade"}]};selectFactory({data:t,id:"rankState",defaultText:null,attrTextModel:function(t,a,r){if(r.code!==e.rankStateCode){switch(e.rankTabActive){case"amount":e.amountState=r.code;break;case"order":e.orderState=r.code;break;case"volume":e.volumeState=r.code}e.rankStateCode=r.code,e.rankStateName=r.name,i(r.code,e.rankTabActive),o(),e.$apply()}}})}function r(e,t){var a=document.createElement("script");a.type="text/javascript",a.src=e,document.getElementsByTagName("head")[0].appendChild(a),a.readyState?a.onreadystatechange=function(){"loaded"!=a.readyState&&"complete"!=a.readyState||(a.onreadystatechange=null,t())}:a.onload=function(){t()}}function o(){var t=e.mapData.data||[],a=[],r={};t.forEach(function(e,t){a.push({name:e.name,value:e.value,unit:e.unit}),r[e.name]=[],r[e.name].push(e.longitude),r[e.name].push(e.latitude)});var o={backgroundColor:"#fff",title:{text:"各地区"+e.rankTabName+e.mapData.periodType+"排行",left:"center",padding:[12,0,0,10],textStyle:{color:"#fff",fontSize:18}},tooltip:{trigger:"item",borderWidth:0,position:"top",backgroundColor:"transparent",formatter:function(e){return'<div style="margin-bottom:10px; background-color: #fff; text-align: center; padding: 10px 30px; border-radius: 2px; position: relative;"><em style="position: absolute; display: block; width: 0; height: 0; left: 50%; margin-left: -4px; bottom: -16px; border: 8px solid #fff; border-color: #fff transparent transparent transparent;"></em><p style="font-size: 18px; height: 28px; line-height: 28px; color: #F7A42C;">'+e.data.name+'</p><p style="font-size: 16px; color: #626262; height: 22px; line-height: 22px;">'+e.value[2]+e.data.unit+"</p></div>"}},bmap:{center:e.mapData.cityMap?[108.953,34.278]:[40.8470603561,-3.1640625],zoom:e.mapData.cityMap?5:1,roam:!0,mapStyle:{styleJson:[{featureType:"water",elementType:"all",stylers:{color:"#2E9FF4"}},{featureType:"land",elementType:"all",stylers:{color:"#0E82D9"}},{featureType:"boundary",elementType:"geometry",stylers:{color:"#064f85",visibility:"off"}},{featureType:"railway",elementType:"all",stylers:{visibility:"off"}},{featureType:"highway",elementType:"geometry",stylers:{color:"#004981",visibility:"off"}},{featureType:"highway",elementType:"geometry.fill",stylers:{color:"#005b96",lightness:1,visibility:"off"}},{featureType:"highway",elementType:"labels",stylers:{visibility:"off"}},{featureType:"arterial",elementType:"geometry",stylers:{color:"#004981",visibility:"off"}},{featureType:"arterial",elementType:"geometry.fill",stylers:{color:"#00508b",visibility:"off"}},{featureType:"poi",elementType:"all",stylers:{visibility:"off"}},{featureType:"green",elementType:"all",stylers:{color:"#056197",visibility:"off"}},{featureType:"subway",elementType:"all",stylers:{visibility:"off"}},{featureType:"manmade",elementType:"all",stylers:{visibility:"off"}},{featureType:"local",elementType:"all",stylers:{visibility:"off"}},{featureType:"arterial",elementType:"labels",stylers:{visibility:"off"}},{featureType:"boundary",elementType:"geometry.fill",stylers:{color:"#029fd4",visibility:"off"}},{featureType:"building",elementType:"all",stylers:{color:"#1a5787",visibility:"off"}},{featureType:"label",elementType:"all",stylers:{visibility:"off"}}]}},series:[{name:"Top 10",type:"effectScatter",coordinateSystem:"bmap",data:function(e){for(var t=[],a=0;a<e.length;a++){var o=18-1.9*a,i=r[e[a].name];i&&t.push({name:e[a].name,value:i.concat(e[a].value,o),unit:e[a].unit})}return t}(a.sort(function(e,t){return t.value-e.value}).slice(0,9)),symbolSize:function(e){return e[3]},showEffectOn:"render",rippleEffect:{brushType:"stroke",scale:2.5},hoverAnimation:!0,label:{normal:{formatter:"{b}",position:"right",fontSize:14,show:!0}},itemStyle:{normal:{color:"#87FFAE"}},zlevel:1}]};l.setOption(o)}function i(a,r){t.getStaticsRankDefault({seatParams:{biz:a,biztype:r}},function(t){if(0===t.errorCode){var a=[];a.push({type:"product",typeName:"产品销量",periodType:"月",data:n(t.data.product),isShowRankItem:!1}),a.push({type:"supplier",typeName:"供应商产值",periodType:"月",data:n(t.data.supplier),isShowRankItem:!1}),a.push({type:"customer",typeName:"客户活跃度",periodType:"月",data:n(t.data.customer),isShowRankItem:!1});var o={period:"month",periodType:"月",data:n(t.data.region),isShowRankItem:!1,cityMap:!0};switch(r){case"amount":e.amountLists=a,e.amountMap=o;break;case"order":e.orderLists=a,e.orderMap=o;break;case"volume":e.volumeLists=a,e.volumeMap=o}e.rankLists=a,e.mapData=o}})}function n(e){if(!e||!e.length)return e;e[0]._width=100;var t=e[0].value;return e.forEach(function(e,a){e.value=Math.round(e.value),0!==a&&(e._width=Math.ceil(100*e.value/t))}),e}var l;e.init=function(){e.rankTabActive="amount",e.rankTabName="交易额",e.rankStateName="物流",e.rankStateCode="logistics",e.defaultRankState="logistics",e.rankLists=[],e.mapData=[],e.amountLists=[],e.amountMap=[],e.orderLists=[],e.orderMap=[],e.volumeLists=[],e.volumeMap=[],e.amountState="logistics",e.orderState="logistics",e.volumeState="logistics",i("logistics","amount"),r("http://api.map.baidu.com/api?v=2.0&ak=HY3gctvPnQpT5BOFgzFcNxkDr37cnPj3&callback=init",function(){setTimeout(function(){l=echarts.init(document.getElementById("myMap")),o()},1e3)}),a()},e.init(),e.changeRankTab=function(t){if(t!==e.rankTabActive){switch(e.rankTabActive=t,t){case"amount":e.rankTabName="交易额",e.amountLists.length>0&&e.amountState==e.rankStateCode?(e.rankLists=e.amountLists,e.mapData=e.amountMap):(e.amountState=e.rankStateCode,i(e.rankStateCode,t));break;case"order":e.rankTabName="订单量",e.orderLists.length>0&&e.orderState==e.rankStateCode?(e.rankLists=e.orderLists,e.mapData=e.orderMap):(e.orderState=e.rankStateCode,i(e.rankStateCode,t));break;case"volume":e.rankTabName="货量",e.volumeLists.length>0&&e.volumeState==e.rankStateCode?(e.rankLists=e.volumeLists,e.mapData=e.volumeMap):(e.volumeState=e.rankStateCode,i(e.rankStateCode,t))}o()}},e.showRankItem=function(t){"map"===t?e.mapData.isShowRankItem=!0:e.rankLists.forEach(function(e,a){e.type===t&&(e.isShowRankItem=!0)})},e.getStaticsRankData=function(a,r,i){var l;l="region"===r?e.mapData.cityMap?"cn":"country":"",t.getStaticsRank({seatParams:{biz:e.rankStateCode,biztype:a,scope:r,period:i,regiontype:l}},function(t){var a;switch(i){case"year":a="年";break;case"month":a="月";break;case"quarter":a="季";break;case"week":a="周";break;default:a=""}0===t.errorCode&&("region"===r?(e.mapData.isShowRankItem=!1,e.mapData.period=i,e.mapData.periodType=a,e.mapData.data=n(t.data[r]),o()):e.rankLists.forEach(function(e,o){e.type===r&&(e.data=n(t.data[r]),e.periodType=a,e.isShowRankItem=!1)}))})},e.toggleMap=function(){e.mapData.cityMap=!e.mapData.cityMap,e.getStaticsRankData(e.rankTabActive,"region",e.mapData.period)}}])});