app.controller("paymentCtr",["$scope","eventServiceFactory","fundsAccountService",function(t,a,n){t.init=function(a){t.initData(a)};var o=a.createEventService();o.on("paymentData",t.init),t.initData=function(a){t.payMethod=1,t.thirdPayAccountId=a.thirdPayAccountId,t.billInfo=a.billInfo||{},t.billInfo.total=n.digital(a.billInfo.total),t.billInfo.actualTotal=n.digital(a.billInfo.actualTotal),t.billInfoTotal=n.dealNumber(a.billInfo.total),t.billInfoActualTotal=n.dealNumber(a.billInfo.actualTotal),t.accountInfo={},t.availableBalance=0,t.getAccountInfo()},t.getAccountInfo=function(){var a={seatParams:{thirdPayAccountId:t.thirdPayAccountId}};n.getAccountInfo(a,function(a){0===a.errorCode&&(t.accountInfo=a.data||{},t.availableBalance=n.dealNumber(t.accountInfo.totalBalance))})},t.confirmPayment=function(a){if(t.payMethod){if("1"==t.payMethod){var e=n.digital(t.accountInfo.totalBalance);if(n.digital(t.billInfo.actualTotal)>e)return a.preventDefault(),void $(document).promptBox({isDelay:!0,contentDelay:"余额不足！",type:"errer",manualClose:!0})}var l={urlParams:{ccyCode:t.billInfo.currencyType,funcFlag:"1",handFee:"0",inCustomerId:t.billInfo.bizCompanyId,note:"",outCustomerId:t.billInfo.platformId,thirdHtId:t.billInfo.billNo,tranAmount:t.billInfo.actualTotal.toFixed(2)}};n.paymentCallback(l,function(a){if(a.data)switch(a.data.status){case 0:a.data.statusValue="成功";break;case 1:a.data.statusValue="失败";break;case 2:a.data.statusValue="待确认";break;case 3:a.data.statusValue="处理中";break;default:a.data.statusValue="成功"}0===a.errorCode?($(document).promptBox({isDelay:!0,contentDelay:"支付成功!",type:"success",time:3e3}),t.$parent.block="paymentResult",o.dispatch("paymentResultData",{thirdPayAccountId:t.thirdPayAccountId,accountInfo:t.accountInfo,billInfo:t.billInfo,isSuccess:!0,paymentData:l.urlParams,paymentResult:a.data})):$(document).promptBox({isDelay:!0,contentDelay:a.msg,type:"errer",manualClose:!0})}),a.preventDefault()}},t.getSignature=function(){var a={urlParams:{ccyCode:t.accountInfo.currency,funcFlag:6,inCustAcctId:t.billInfo.inCustAcctId,inCustName:t.billInfo.inThirdPayName,inThirdCustId:t.billInfo.inThirdCustId,note:t.note,outCustAcctId:t.billInfo.outCustAcctId,outCustName:t.billInfo.outThirdPayName,outThirdCustId:t.billInfo.outThirdCustId,thirdHtId:t.billInfo.billNo,id:t.thirdPayAccountId,tranAmount:t.billInfo.actualTotal,tranFee:0}};return n.getPaymentSignature(a,function(a){t.signatureData=a.data||{}}),t.signatureData},t.getBankList=function(){var a={seatParams:{thirdPayAccountId:t.thirdPayAccountId}};n.getBankVerdCardList(a,function(a){t.bankListData=a.data,angular.forEach(t.bankListData,function(t,a){t.cardNo&&(t.name=t.bank+"（尾号"+t.cardNo.slice(-4)+"）")})}),t.bankListData&&selectFactory({data:{data:t.bankListData},defaultText:"请选择",id:"select-payment-bank",defaultCount:1e4,showTextField:"name",attrTextModel:function(a,n,o){t.subbranch=o.name||"",t.subbranchId=o.id||"",t.$apply()}}).open()},t.goBack=function(){t.$parent.block=""},t.goRechargePage=function(){t.$parent.block="recharge",t.overagePrompt=!1,o.dispatch("rechargeData",{thirdPayAccountId:t.thirdPayAccountId,accountInfo:t.accountInfo,billInfo:t.billInfo,from:"payment"})},t.paymentResult=function(a){t.paymentPrompt=!1}}]);