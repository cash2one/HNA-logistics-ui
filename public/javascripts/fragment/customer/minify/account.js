app.controller("accountCtr",["$scope","customerService","tableService",function(e,t,o){function n(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-250})}function r(){var t={urlParams:e.tableModel.restData};o.getTable(e.tableModel.restURL,t,function(r){e.q=e.tableModel.restData.q,0===r.errorCode&&(e.tableModel=o.table(e.tableModel,t,r),setTimeout(function(){n(),$(window).on("resize",n),$(".table-box").focus(),resizeTable(),e.$apply()},100))})}function c(){var t=[],n=o.getSelectTable(e.tableModel.tableBody);return n.length?(angular.forEach(n,function(e){t.push(e.id)}),t):(accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("customer","customer_prompt_delay_tip"),type:"errer",manualClose:!0}),!1)}function a(t){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var o=c();if(!o)return!1;t(o,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),r(),e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("customer","customer_prompt_delay_tip"),type:"errer",manualClose:!0})}function l(t,n,r,c){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var l=[],s=o.getSelectTable(e.tableModel.tableBody);if(!s.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_table_delTips"),type:"errer",manualClose:!0}),!1;angular.forEach(s,function(e){l.push(e[r])}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("customer",t)},operation:[{type:"submit",description:"confirm"==c?Lang.getValByKey("common","common_pagination_confirm"):Lang.getValByKey("common","common_page_delete"),application:"confirm"==c?"confirm":"delete",operationEvent:function(){$(document).promptBox("closePrompt"),a(n)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_table_delTips"),type:"errer",manualClose:!0})}function s(){e.closePrompt=function(){e.nestAccountFrom=!1},e.addAccount=function(){e.isEdit=!1,e.isCreateNewRate=!0,e.nestAccountFrom=!0,e.promptTitle=Lang.getValByKey("customer","account_create_title"),e.username="",e.name="",e.accountEmail="",e.oldEmail="",e.tel="",e.isSystem="",e.accountType="",$("#nest-accountFrom").css("display","table"),e.AccountFrom.$setPristine(),e.AccountFrom.$setUntouched(),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.checkUserExsist=function(){if(!e.username)return $("#account-user .errors").addClass("ng-hide"),void $("#account-user .errors").html("");t.checkUserExsist({userName:e.username},function(e){0!=e.errorCode?($("#account-user .errors").removeClass("ng-hide"),$("#account-user .errors").html(Lang.getValByKey("customer","customer_user_exsist")),$(".check-user-exist").css("borderColor","#FA787E")):($("#account-user .errors").addClass("ng-hide"),$(".check-user-exist").removeAttr("style"),$("#account-user .errors").html(""))})},e.clearEmailError=function(){$("#account-email .errors").addClass("ng-hide"),$("#account-email .errors").html("")},e.checkAccountEmail=function(){if(e.oldEmail==e.accountEmail||!e.accountEmail)return $("#account-email .errors").addClass("ng-hide"),void $("#account-email .errors").html("");t.checkAccountEmail({email:e.accountEmail,userId:e.isEdit?e.id:""},function(e){0!=e.errorCode?($("#account-email .errors").removeClass("ng-hide"),$("#account-email .errors").html(Lang.getValByKey("customer","customer_email_exsist"))):($("#account-email .errors").addClass("ng-hide"),$("#account-email .errors").html(""))})},e.hideMore=function(){e.tableModel.more=!1},e.showMore=function(){e.tableModel.more=!0},e.editChildAccount=function(t){e.isEdit=!0,$("#nest-accountFrom").css("display","table"),e.isCreateNewRate=!1,e.promptTitle=Lang.getValByKey("customer","account_detail_title"),e.nestAccountFrom=!0,e.username=t.userName,e.name=t.fullName,e.accountEmail=t.email,e.oldEmail=t.email,e.tel=t.mobilePhone,e.telOld=t.mobilePhone,e.id=t.id,e.isSystem=t.isSystem,e.AccountFrom.$setPristine(),e.AccountFrom.$setUntouched(),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.deleteAccount=function(){l("account_prompt_delete_tip",t.deleteCustomerChildAccount,"id","delete")},e.lockAccount=function(){l("account_prompt_lock_tip",t.lockCustomerChildAccount,"id","confirm")},e.unlockAccount=function(){l("account_prompt_unlock_tip",t.unlockCustomerChildAccount,"id","confirm")},e.resetPassword=function(){l("account_prompt_reset_tip",t.resetCustomerChildPassword,"id","confirm")},e.savePrompt=function(){var o=!1;if(e.username||(e.AccountFrom.username.$setDirty(),o=!0),e.name?/^([A-Za-z\s\u4E00-\u9FA5]+)+$/.test(e.name)||($("input[name='name']").addClass("ng-dirty"),e.AccountFrom.name.$error.defined=!0,e.AccountFrom.name.$dirty=!0,o=!0):(e.AccountFrom.name.$setDirty(),o=!0),e.accountEmail||(e.AccountFrom.accountEmail.$setDirty(),o=!0),e.tel?/^([\d\s\-\+\(\)]+)+$/.test(e.tel)||($("input[name='tel']").addClass("ng-dirty"),e.AccountFrom.tel.$error.defined=!0,e.AccountFrom.tel.$dirty=!0,o=!0):(e.AccountFrom.tel.$setDirty(),o=!0),!o){for(var n=$(".errors"),c=0;c<n.length;c++)if(!$(n[c]).hasClass("ng-hide"))return;e.isEdit?t.updateCustomerChildAccount({userName:e.username,email:e.accountEmail,fullName:e.name,mobilePhone:e.tel,id:e.id,isSystem:e.isSystem,refCustomerId:e.customerId},function(t){0!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),r())}):t.addCustomerChildAccount({userName:e.username,email:e.accountEmail,fullName:e.name,mobilePhone:e.tel,refCustomerId:e.customerId},function(t){0!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),r())})}}}e.$on("accountEvent",function(){e.init(),e.$apply()}),e.initTable=function(){e.tableModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("customer","account_user_name"),Lang.getValByKey("customer","account_name"),Lang.getValByKey("customer","account_email"),Lang.getValByKey("customer","account_tel"),Lang.getValByKey("customer","account_type")],tableHeaderSize:["5%","22%","24%","22%","12%","10%"],tableBody:[],restURL:"logistics.searchChildAccount",restData:{refCustomerId:e.customerId,isAsc:!1,pageIndex:1,pageSize:10,sortName:"isSystem"},selectNumber:0,selectFlag:!1},r()},e.closePrompt=function(){e.nestAccountFrom=!1},e.checkPhoneExist=function(){if(e.tel){var o={seatParams:{mobilePhone:e.tel,userId:e.isEdit?e.id:""}};t.checkUserPhoneExist(o,function(t){0==t.errorCode&&1==t.data?(e.AccountFrom.tel.errorTips="手机号已经存在，请重新输入！",e.AccountFrom.tel.$error.defined=!0,e.AccountFrom.tel.$dirty=!0):e.AccountFrom.tel.errorTips=""})}},e.init=function(){e.initTable(),e.resetStyle(133),s()}}]);