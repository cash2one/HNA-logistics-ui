var userInfoCtrl;easySpa.require(["widget/starRating"],function(){userInfoCtrl={$scope:null,service:null,userInfo:null,getAccountData:function(e,t){e=e||"";var r={q:e?e.trim():"",pageIndex:t||1,pageSize:10};return this.service.getAccount(r)},getCurrencyList:function(e,t){e=e||"";var r={q:e?e.trim():"",pageIndex:t||1,pageSize:10};return this.service.getCurrencyList(r)},rebuildData:function(e){for(var t=e.data,r=0;r<t.length;r++)t[r].fullname=t[r].name+" ("+t[r].code+")";return e},initSelect:function(){var e=this;$scope=this.$scope,selectFactory({isSearch:!0,data:[],id:"account-type",closeLocalSearch:!0,pagination:!0,offset:-300,defaultText:"请选择",showTextField:"fullname",searchPlaceHoder:"请输入名称或编码",onSearchValueChange:function(t,r,s){var a=e.getAccountData(r,s);a=e.rebuildData(a),t.setData(a),$scope.$apply()},attrTextModel:function(e,t,r){e?($scope.refSettlementName=e,$scope.refSettlementNameCode=r.code,$scope.refSettlementId=r.id):($scope.refSettlementName="",$scope.refSettlementNameCode="",$scope.refSettlementId=""),$scope.$apply()}}),selectFactory({data:[],id:"trading-currency",defaultText:Lang.getValByKey("common","common_select_tips"),isSearch:!0,searchPlaceHoder:"请输入货币名称或三字码",closeLocalSearch:!0,pagination:!0,offset:-300,showTextField:"fullname",defaultText:"请选择",onSearchValueChange:function(t,r,s){var a=e.getCurrencyList(r,s);a.data&&a.data.length?(a=e.rebuildData(a),t.setData(a)):t.setData({data:[]}),$scope.$apply()},attrTextModel:function(e,t,r){r.code?($scope.tradingCurrency=e,$scope.tradingCurrencyId=r.code):($scope.tradingCurrency="",$scope.tradingCurrencyId=""),$scope.$apply()}});var t=this.service.getCombos(),r=[];angular.forEach(t.data,function(e){r.push({code:e.code,preName:e.name,name:e.name+"("+e.code+")"})}),t.data=r,selectFactory({data:t,id:"price-combos",isSearch:!0,defaultCount:100,defaultText:"请选择",offset:-300,attrTextModel:function(e,t,r){$scope.refCombos=r.preName,$scope.refCombosId=r.code,e||($scope.refCombosId=0),$scope.$apply()}})},bindEvent:function(){var e=this,t=this.$scope;t.cancelCustomer=function(){e.userInfo?e.showUserInfo():e.resetData(),t.setSingleCustomerAuditBtn()},t.saveCustomer=function(){var r=t.cusUserTypeLogs&&t.cusUserTypeTrd?3:t.cusUserTypeTrd?2:t.cusUserTypeLogs?1:"";if(t.cusUserTypeSupplier&&(r=256),t.userNameInfo||t.customerForm.userNameInfo.$setDirty(),t.codeInfo||t.customerForm.codeInfo.$setDirty(),!r)return void $(document).promptBox({isDelay:!0,contentDelay:"至少保留一个业务类型",type:"errer",manualClose:!0});if(t.email||t.customerForm.email.$setDirty(),t.refSettlementName||t.customerForm.refSettlementName.$setDirty(),t.tradingCurrency||t.customerForm.tradingCurrency.$setDirty(),!t.customerForm.$valid||1==t.validateRankError)return void scrollToErrorView($(".tab-content"));for(var s=$(".errors"),a=0;a<s.length;a++)if(!$(s[a]).hasClass("ng-hide"))return void scrollToErrorView($(".tab-content"));t.isAdd?e.service.addCustomer({userName:t.userNameInfo,code:t.codeInfo,refSettlementId:t.refSettlementId,tradingCurrency:t.tradingCurrencyId,refCombos:t.refCombosId,description:t.descriptionInfo,email:t.email,evaluateLeval:t.rankInfo,userType:r,shipBooking:t.shipBooking},function(r){0!=r.errorCode?$(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0}):($(document).promptBox({isDelay:!0,contentDelay:r.msg,type:"success",time:3e3}),t.setCustomerId(r.data.id),t.creator=r.data.creator,t.createDate=r.data.createTime,e.userInfo={},e.userInfo.id=r.data.id,t.tab.enableAll(),t.disableUserInfo(),e.changeRateStat(!0))}):e.service.updateCustomer({userName:t.userNameInfo,code:t.codeInfo,refSettlementId:t.refSettlementId,tradingCurrency:t.tradingCurrencyId,refCombos:t.refCombosId,description:t.descriptionInfo,email:t.email,id:t.customerId,evaluateLeval:t.rankInfo,userType:r,shipBooking:t.shipBooking},function(s){0!=s.errorCode?$(document).promptBox({isDelay:!0,contentDelay:s.msg,type:"errer",manualClose:!0}):($(document).promptBox({isDelay:!0,contentDelay:s.msg,type:"success",time:3e3}),t.userType===r||3===r?(t.disableUserInfo(),e.changeRateStat(!0)):location.reload())}),t.setSingleCustomerAuditBtn()},t.editUser=function(){t.isEdit=!1,t.isCanEdit=!1,t.isAdd=!1,$("#email .errors").html(""),$("#stars").rating("update",parseInt(t.rankInfo)),e.changeRateStat(!1),$("#singleCustomerAudit").attr("disabled","true"),$("#singleCustomerAudit").addClass("disabled")},t.disableUserInfo=function(){t.isEdit=!0,t.isCanEdit=!0,t.isAdd=!0},t.checkCode=function(){e.service.checkCustomerCode({code:t.codeInfo},function(e){e.data?($("#code-error-box .errors").removeClass("ng-hide"),$("#code-error-box .errors").html(Lang.getValByKey("customer","customer_code_exsist_tips")),$(".check-codes").css("borderColor","#FA787E")):($("#code-error-box .errors").addClass("ng-hide"),$("#code-error-box .errors").html(""),$(".check-codes").removeAttr("style"))})},t.clearEmailErrorMsg=function(){$("#email .errors").addClass("ng-hide"),$("#email .errors").html("")},t.checkEmail=function(){(t.isEdit||t.oldEmail!=t.email)&&e.service.checkUserInfoEmail({email:t.email},function(e){e.data?($("#email .errors").removeClass("ng-hide"),$("#email .errors").html(Lang.getValByKey("customer","customer_email_exsist")),$(".check-emails").css("borderColor","#FA787E")):($("#email .errors").addClass("ng-hide"),$("#email .errors").html(""),$(".check-emails").removeAttr("style"))})}},resetData:function(){var e=this.$scope;e.userNameInfo="",e.codeInfo="",e.businessTypeInfo="",e.businessCodeInfo="",e.refSettlementName=Lang.getValByKey("customer","customer_refSettlementName")+"(SYS-MONTH)",e.refSettlementNameCode="SYS-MONTH",e.refSettlementId=1,e.tradingCurrencyId="CNY",e.tradingCurrency=Lang.getValByKey("customer","customer_tradingCurrency")+"(CNY)",e.refCombos="",e.refCombosId="",e.descriptionInfo="",e.oldEmail="",e.email="",e.cusUserTypeTrd=!1,e.cusUserTypeLogs=!1,e.cusUserTypeSupplier=!1,e.typeAll=!1,"trade"==e.paramter.module?(e.cusUserTypeTrd=!0,e.cusUserTypeName="贸易"):(e.cusUserTypeLogs=!0,e.cusUserTypeName="物流"),e.customerForm.$setPristine(),e.customerForm.$setUntouched(),$(".tip-box").remove(),$(".errors").addClass("ng-hide")},showUserInfo:function(){var e=this.$scope,t=this;e.tab.enableAll(),this.service.getCustomerInfo({id:this.userInfo.id},function(r){var r=r.data;e.creator=r.creator,e.createDate=r.createTime,e.userNameInfo=r.userName,e.codeInfo=r.code,e.cusUserTypeLogs=1===r.userType,e.cusUserTypeTrd=2===r.userType,1===r.userType&&(e.cusUserTypeLogs=!0,e.cusUserTypeName="物流"),2===r.userType&&(e.cusUserTypeTrd=!0,e.cusUserTypeName="贸易"),3===r.userType&&(e.cusUserTypeLogs=!0,e.cusUserTypeTrd=!0,e.typeAll=!0,e.cusUserTypeName="物流/贸易"),256==r.userType&&(e.cusUserTypeTrd=!0,e.cusUserTypeName="贸易",e.cusUserTypeSupplier=!0),e.email=r.email,e.oldEmail=r.email,e.refSettlementName=r.settlementCode?r.settlementName+"("+r.settlementCode+")":"",e.refSettlementNameCode=r.settlementCode,e.refSettlementId=r.refSettlementId,e.refCombos=r.combosName,e.refCombosId=r.refCombos,e.descriptionInfo=r.description,e.tradingCurrencyId=r.tradingCurrency,e.tradingCurrency=r.tradingCurrency?r.currencyName+"("+r.tradingCurrency+")":"",e.rankInfo=r.evaluateLeval,setTimeout(function(){e.isEdit=!0,e.isCanEdit=!0,e.isAdd=!0,e.$apply(),$("#userInfo").css({display:"block"})},10),$("#stars").rating("update",parseInt(e.rankInfo)),e.shipBooking=r.shipBooking,e.auidtMessage=r.auidtMessage,e.authStatus=r.authStatus,e.auidtMessage?$(".from-box").css("top","234px"):$(".from-box").css("top","116px"),e.isShowAudit=2==r.authStatus&&window.location.href.indexOf("customerApproval")>-1,t.changeRateStat(!0)})},initStar:function(){$("#stars").rating("update",0),$("#stars").rating("refresh",{min:0,max:5,step:1,size:"xs",animate:!0,displayOnly:!1,showClear:!1,showCaption:!1})},changeRateStat:function(e){var t=this.$scope;$("#stars").rating("refresh",{min:0,max:5,step:1,size:"xs",animate:!0,displayOnly:e,showClear:!1,showCaption:!1}),$("#stars").on("rating.change",function(e,r,s){t.rankInfo=$(e.target).val(),t.rankInfo?t.validateRankError=!1:t.validateRankError=!0,t.$apply()})},clearError:function(){for(var e=$(".errors"),t=0;t<e.length;t++)$(e[t]).addClass("ng-hide")},init:function(e,t,r){this.userInfo=r,this.$scope=e,this.service=t,this.$scope.resetStyle(3),this.resetData(),this.initSelect(),this.bindEvent(),this.initStar(),this.clearError(),this.userInfo?this.showUserInfo():(e.isCanEdit=!0,e.rankInfo=1,$("#stars").rating("update",1),this.changeRateStat(!1)),e.getCombosData=function(){var r=t.getCombos(),s=[];angular.forEach(r.data,function(e){s.push({code:e.code,preName:e.name,name:e.name+"("+e.code+")"})}),r.data=s,selectFactory({data:r,id:"price-combos",isSearch:!0,defaultCount:100,defaultText:"请选择",offset:-300,isCreateNewSelect:!0,attrTextModel:function(t,r,s){e.refCombos=s.preName,e.refCombosId=s.code,t||(e.refCombosId=0),e.$apply()}})}}}});