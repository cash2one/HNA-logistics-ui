easySpa.require(["widget/prompt","widget/tab","public/javascripts/customer/20161224/customerService.js"],function(){app.controller("productSettingCtrl",["$scope","customerService",function(e,t){var c={isPublic:!0,isPublicOrigin:!0,showLayer:!1,editSetting:!1,isUpdate:!1,tabActive:1,productGroupData:[],productData:[],selectedItem:"",selectedItemId:1,selectedItemOriginStr:"",selectedItemStr:"",productSelecting:[],productSelectingOrigin:[],productSelected:[],productSelectedOrigin:[],searchSelecting:"",checkedAllSelecting:!1,checkedAllSelected:!1,productGroupIds:[],productUids:[]},i={getProductVisiblity:function(){t.getProductVisiblity({customerId:e.customerId},function(t){0===t.errorCode&&"number"==typeof t.data.wbFlag?(e.isUpdate=!0,e.isPublic=!+t.data.wbFlag,e.isPublicOrigin=!+t.data.wbFlag,t.data.products.length?(e.selectedItemStr=t.data.products.map(function(e){return e.name}).join(","),e.selectedItemOriginStr=e.selectedItemStr,e.productSelecting=JSON.parse(JSON.stringify(t.data.products)),e.productSelected=JSON.parse(JSON.stringify(t.data.products)),e.productSelecting.forEach(function(e){e.disabled=!0,e.checked=!0}),e.productSelected.forEach(function(t){t.checked=!1,t.disabled=!1,t.uid&&e.productUids.push(t.uid),t.uid||e.productGroupIds.push(t.id)}),e.productSelectingOrigin=JSON.parse(JSON.stringify(e.productSelecting)),e.productSelectedOrigin=JSON.parse(JSON.stringify(e.productSelected))):(e.selectedItemStr="",e.productSelecting=[],e.productSelected=[],e.productSelectedOrigin=[])):(e.isUpdate=!1,e.selectedItemStr="",e.productSelecting=[],e.productSelected=[],e.productSelectedOrigin=[])})},showProductLayer:function(){e.tabActive=1,t.getProductVisiblity({customerId:e.customerId},function(t){t.data.products.length&&(e.selectedItemOriginStr=t.data.products.map(function(e){return e.name}).join(","),e.productSelecting=[],e.productSelected=JSON.parse(JSON.stringify(t.data.products)),e.productSelected.forEach(function(e){e.checked=!1}),e.productSelectingOrigin=[],e.productSelectedOrigin=JSON.parse(JSON.stringify(e.productSelected)))});var c={title:"添加可见范围",isHidden:!0,boxWidth:!0,isNest:!0,loadData:function(){e.getAllProductGroup(!1)},content:{nest:$("#productLayer")},operation:[{type:"submit",description:"确定",operationEvent:function(){e.productUids=[],e.productGroupIds=[],e.productSelected.forEach(function(t){t.uid&&e.productUids.push(t.uid),t.uid||e.productGroupIds.push(t.id)}),e.selectedItemStr=e.productSelected.map(function(e){return e.name}).join(","),e.tabActive=1,$(document).promptBox("closeSlideBox"),e.$apply()}}]};$(document).promptBox(c)},getAllProductGroup:function(c){t.getAllProductGroup({isShowAll:c},function(t){0===t.errorCode&&(e.productGroupData=t.data)})},getAllProduct:function(){t.getAllProduct("",function(t){0===t.errorCode&&(e.productData=t.data)})},selectAction:function(c){var i=e.productSelecting.some(function(e){return e.id===c.id});if(!(1===e.tabActive&&c.isPublic||i)&&(e.selectedItem=c,e.selectedItemId=c.id,e.productSelecting=[],1===e.tabActive&&(e.productSelecting.push(c),e.productSelectingOrigin=JSON.parse(JSON.stringify(e.productSelecting)),e.productSelecting.forEach(function(t){if(e.productSelected.length)for(var c=0,i=e.productSelected.length;c<i;c++)t.id===e.productSelected[c].id&&(t.checked=!0,t.disabled=!0)})),2===e.tabActive)){var r=c.id;t.getAllProduct({groupId:r},function(t){e.productSelected.forEach(function(e){t.data.forEach(function(t){e.uid===t.uid&&(t.checked=!0,t.disabled=!0)})}),e.productSelecting=t.data,e.productSelectingOrigin=JSON.parse(JSON.stringify(e.productSelecting))})}},toggleData:function(c){if(e.tabActive!==c){if(e.tabActive=c,e.selectedItem="",e.selectedItemId="",e.productSelecting=[],1===c&&(e.getAllProductGroup(!1),e.selectedItem&&(e.productSelecting.push(e.selectedItem),e.productSelectingOrigin=JSON.parse(JSON.stringify(e.productSelecting)))),2===c){e.getAllProductGroup(!0);var i=e.selectedItem.id;t.getAllProduct({groupId:i},function(t){e.productSelecting=t.data,e.productSelectingOrigin=JSON.parse(JSON.stringify(e.productSelecting))})}e.productSelecting.forEach(function(t){if(e.productSelected.length)for(var c=0,i=e.productSelected.length;c<i;c++)t.id===e.productSelected[c].id&&(t.checked=!0,t.disabled=!0)})}},searchLocale:function(t){1===t&&(e.searchSelecting?e.productSelecting=e.productSelectingOrigin.filter(function(t){if(t.name.includes(e.searchSelecting))return t}):e.productSelecting=e.productSelectingOrigin),2===t&&(e.searchSelected?e.productSelected=e.productSelectedOrigin.filter(function(t){if(t.name.includes(e.searchSelected))return t}):e.productSelected=e.productSelectedOrigin)},moveRight:function(){var t=e.productSelecting.filter(function(e){if(e.checked&&!e.disabled)return e.disabled=!0,e});e.productSelected=JSON.parse(JSON.stringify(e.productSelected.concat(t))),e.productSelected.forEach(function(e){e.checked=!1}),e.productSelectedOrigin=JSON.parse(JSON.stringify(e.productSelected))},moveLeft:function(){for(var t=0,c=e.productSelecting.length;t<c;t++)for(var i=0,r=e.productSelectedOrigin.length;i<r;i++)e.productSelected[i]&&e.productSelected[i].checked&&e.productSelecting[t].id===e.productSelected[i].id&&(e.productSelecting[t].disabled=!1,e.productSelecting[t].checked=!1);e.productSelected=e.productSelected.filter(function(e){if(!e.checked)return e}),e.productSelectedOrigin=e.productSelectedOrigin.filter(function(e){if(!e.checked)return e})},submitVisiblity:function(){var c={customerId:e.customerId,productGroupIds:$.unique(e.productGroupIds),productUids:$.unique(e.productUids),wbFlag:+!e.isPublic,isUpdate:e.isUpdate};t.saveProductVisiblity(c,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.editSetting=!1,e.getProductVisiblity()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manual:!0})})},cancelVisiblity:function(){e.editSetting=!1,e.getProductVisiblity()}};e.$watch("checkedAllSelecting",function(t){t?e.productSelecting.forEach(function(e){e.checked=!0}):e.productSelecting.forEach(function(e){e.checked=!1})}),e.$watch("checkedAllSelected",function(t){t?e.productSelected.forEach(function(e){e.checked=!0}):e.productSelected.forEach(function(e){e.checked=!1})}),e.$on("productSettingEvent",function(){$.extend(e,c,i),e.getProductVisiblity(),e.isPublic=e.isPublicOrigin,e.selectedItemStr=e.selectedItemOriginStr,e.$apply()})}])}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null===this)throw new TypeError('"this" is null or not defined');var c=Object(this),i=c.length>>>0;if(0===i)return!1;for(var r=0|t,d=Math.max(r>=0?r:i-Math.abs(r),0);d<i;){if(c[d]===e)return!0;d++}return!1}});