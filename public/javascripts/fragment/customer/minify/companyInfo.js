easySpa.require(["widget/starRating","public/common/pictureController.js","widget/slides"],function(){app.controller("companyCtr",["$scope","customerService","tableService","pictureService",function(e,t,o,a){function i(e){var t=e.next;if(null!=t)return t.clearData(),t.id=null,i(t)}function r(e){for(var t=e?e.length:0,o=[],a=0;a<t;a++)e[a].picUrlID="object"==typeof e[a].picUrlID?e[a].picUrlID.id:e[a].picUrlID,o.push(e[a].picUrlID);return o}function n(e){for(var t=e?e.length:0,o={},a=[],i=0;i<t;i++)o={picUrlID:e[i],delshow:!1},a.push(o);return a}function c(){e.getPictureUrl=function(t){$("#slides").picturePreview({pictureId:t},e.pictureModel.picture)},e.getFile=function(t){var o=t.length;if(o+e.pictureModel.picture.length>a.maxUpload)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("supplier","supplier_prompt_tip_picture_one")+a.maxUpload+Lang.getValByKey("supplier","supplier_prompt_tip_picture_two"),type:"errer",manualClose:!0}),!1;for(var i=0;i<o;i++){var r=a.uploadFile(e.pictureModel,t[i]);if(!r)return!1;r.errorlocal?$(document).promptBox({isDelay:!0,contentDelay:r.errorlocal,type:"errer",manualClose:!0}):r.then(function(t){0===t.data.errorCode?(e.validatePictureError=!1,e.pictureModel=a.updateModel(e.pictureModel,t.data.data),$(document).promptBox({isDelay:!0,contentDelay:t.data.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:t.data.msg,type:"errer",manualClose:!0})})}},e.cancelCustomer=function(){e.initPage(function(){e.isEdit=!0,e.isCanEdit=!1,e.pictureModel.edit=!1,e.pictureModel.uploadShow=!1})},e.saveCompany=function(){var o=r(e.pictureModel.picture);if(o.length?e.validatePictureError=!1:e.validatePictureError=!0,e.companyFullName||e.companyForm.companyFullName.$setDirty(),e.country||e.companyForm.country.$setDirty(),e.city||e.companyForm.city.$setDirty(),e.home||e.companyForm.home.$setDirty(),e.legalPerson||e.companyForm.legalPerson.$setDirty(),e.creditCode||e.companyForm.creditCode.$setDirty(),e.companyBank||e.companyForm.companyBank.$setDirty(),e.companyBankId||e.companyForm.companyBankId.$setDirty(),e.companyTel||e.companyForm.companyTel.$setDirty(),!e.companyForm.$valid||e.validatePictureError)return void scrollToErrorView($(".tab-content"));t.submitCompany({attachFileIds:o,mainBusiness:e.mainBiz,fullName:e.companyFullName,locationCountryCode:e.figureCode,locationCityCode:e.cityId,webUrl:e.website,depositBank:e.companyBank,bankAccountNo:e.companyBankId,taxCode:e.creditCode,legalPerson:e.legalPerson,residence:e.home,telNo:e.companyTel,refCustomerId:e.customerId,id:e.id?e.id:0},function(t){0!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),e.id=t.data.id),e.creator=t.data.creator,e.createDate=t.data.createTime,e.isEdit=!0,e.pictureModel.edit=!1,e.pictureModel.uploadShow=!1,e.initPage()}),e.setSingleCustomerAuditBtn()},e.editCompany=function(){e.isCanEdit=!1,e.isEdit=!1,e.pictureModel.edit=!0,e.pictureModel.uploadShow=!0},e.$watch("isEdit",function(t,o){e.$parent.isEdit=t})}var l,d;e.pictureModel={edit:!0,uploadShow:!1,picture:[],accept:"image/jpg,image/jpeg,image/png,image/bmp,image/tiff,application/pdf"},e.$on("companyEvent",function(){e.init(),e.$apply()}),e.initSelect=function(){l=selectFactory({data:{data:[]},id:"country",isSearch:!0,isUsePinyin:!0,defaultText:Lang.getValByKey("common","common_select_tips"),defaultCount:11,pagination:!0,closeLocalSearch:!0,maxHeight:170,onSearchValueChange:function(e,o,a){o=t.getCountry({urlParams:{pageIndex:a,q:o}}),angular.forEach(o.data,function(e,t){e.name+="("+e.figureCode+")"}),e.setData(o)},attrTextModel:function(o,a,r){e.country=o,e.countryId=r.figureCode,e.city="",e.cityId="";var n={urlParams:{countryCode:e.countryId,q:""},isAsync:!0};e.figureCode=r.figureCode,e.$apply(),i(l);var c=t.getCity(n);c.data.length?d.setData(c):d.setData({data:[]})}}),d=selectFactory({data:{data:[]},id:"city",isSearch:!0,pagination:!0,closeLocalSearch:!0,isSearch:!0,maxHeight:170,onSearchValueChange:function(o,a,i){var r=t.getCity({urlParams:{countryCode:e.countryId||e.figureCode,pageIndex:i,q:a}});o.setData(r)},attrTextModel:function(t,o,a){e.city=t,e.cityId=a.id,e.$apply()}}),l.next=d},e.initStar=function(){$("#stars").rating("update",0),$("#stars").rating("refresh",{min:0,max:5,step:1,size:"xs",animate:!0,displayOnly:!1,showClear:!1,showCaption:!1})},e.initPage=function(o){e.validatePictureError=!1,e.companyForm.$setPristine(),e.companyForm.$setUntouched(),t.getCompanyInfo({costomerid:e.customerId},function(t){var o=t.data;o?(e.id=o.id,e.isEdit=!0,e.companyFullName=o.fullName,e.country=o.locationCountryName,e.city=o.locationCityName,e.figureCode=o.locationCountryCode,e.cityId=o.locationCityCode,e.home=o.residence,e.legalPerson=o.legalPerson,e.creditCode=o.taxCode,e.companyBank=o.depositBank,e.companyBankId=o.bankAccountNo,e.companyTel=o.telNo,e.website=o.webUrl,e.mainBiz=o.mainBusiness,e.pictureModel.edit=!1,e.pictureModel.uploadShow=!1,e.pictureModel.picture=n(o.files),e.creator=o.creator,e.createDate=o.createTime,e.pictureModel=a.init(e.pictureModel)):(e.id=0,e.isEdit=!1,e.companyFullName="",e.country="",e.city="",e.figureCode="",e.cityId="",e.home="",e.legalPerson="",e.creditCode="",e.companyBank="",e.companyBankId="",e.companyTel="",e.website="",e.mainBiz="",e.pictureModel.edit=!0,e.pictureModel.uploadShow=!0,e.pictureModel.picture=n([]),e.pictureModel=a.init(e.pictureModel),$("#stars").rating("update",0))})},e.init=function(){e.isEdit=!1,e.initSelect(),e.initPage(),c()}}])});