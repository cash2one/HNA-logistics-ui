app.controller("accountCtrl",["$scope","supplierService","tableService",function(e,t,o){function r(){$(".table-container tbody").slimScroll({height:$(".content-main").height()-250})}function n(){var t={urlParams:e.tableAccountModel.restData};o.getTable(e.tableAccountModel.restURL,t,function(n){e.q=e.tableAccountModel.restData.q,0===n.errorCode&&(e.tableAccountModel=o.table(e.tableAccountModel,t,n),setTimeout(function(){r(),$(window).on("resize",r),$(".table-box").focus(),resizeTable(),e.$apply()},100))})}function l(){var t=[],r=o.getSelectTable(e.tableAccountModel.tableBody);return r.length?(angular.forEach(r,function(e){t.push(e.id)}),t):(accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("supplier","supplier_prompt_delay_tip"),type:"errer",manualClose:!0}),!1)}function a(t){if(0!=e.tableAccountModel.selectNumber&&0!=$(".table-box tbody tr").length){var o=l();if(!o)return!1;t(o,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),n(),e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("supplier","supplier_prompt_delay_tip"),type:"errer",manualClose:!0})}function c(t,r,n,l){if(0!=e.tableAccountModel.selectNumber&&0!=$(".table-box tbody tr").length){var c=[],i=o.getSelectTable(e.tableAccountModel.tableBody);if(!i.length)return accountView.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_table_delTips"),type:"errer",manualClose:!0}),!1;angular.forEach(i,function(e){c.push(e[n])}),$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("supplier",t)},operation:[{type:"submit",description:"confirm"==l?Lang.getValByKey("common","common_pagination_confirm"):Lang.getValByKey("common","common_page_delete"),application:"confirm"==l?"confirm":"delete",operationEvent:function(){$(document).promptBox("closePrompt"),a(r)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_table_delTips"),type:"errer",manualClose:!0})}function i(){e.closePrompt=function(){e.nestAccountFrom=!1},e.addAccount=function(){e.isEdit=!1,e.isCreateNewRate=!0,e.nestAccountFrom=!0,e.promptTitle=Lang.getValByKey("supplier","supplier_create_title"),e.username="",e.name="",e.accountEmail="",e.oldEmail="",e.tel="",e.telOld="",e.isSystem="",e.accountType="",$("#nest-accountFrom").css("display","table"),e.AccountFrom.$setPristine(),e.AccountFrom.$setUntouched(),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.checkUserExsist=function(){if(!e.username)return $("#account-user .errors").addClass("ng-hide"),void $("#account-user .errors").html("");var o={userName:e.username};t.checkSupplierUserExsist(o,function(e){0!=e.errorCode?($("#account-user .errors").removeClass("ng-hide"),$("#account-user .errors").html(Lang.getValByKey("supplier","supplier_user_exsist")),$(".check-user-exist").css("borderColor","#FA787E")):($("#account-user .errors").addClass("ng-hide"),$(".check-user-exist").removeAttr("style"),$("#account-user .errors").html(""))})},e.checkPhoneExist=function(){if(e.tel&&e.tel!=e.telOld){var o={seatParams:{mobilePhone:e.tel,userId:e.isEdit?e.id:""}};t.checkSupplierUserPhoneExist(o,function(t){0!=t.errorCode?(e.AccountFrom.tel.errorTips=Lang.getValByKey("supplier","supplier_phone_exsist"),e.AccountFrom.tel.$error.defined=!0,e.AccountFrom.tel.$dirty=!0):e.AccountFrom.tel.errorTips=""})}},e.checkAccountEmail=function(){if(!e.accountEmail||e.oldEmail==e.accountEmail)return $("#account-email .errors").addClass("ng-hide"),void $("#account-email .errors").html("");var o={email:e.accountEmail,userId:e.isEdit?e.id:""};t.checkSupplierAccountEmail(o,function(e){0!=e.errorCode?($("#account-email .errors").removeClass("ng-hide"),$("#account-email .errors").html(Lang.getValByKey("supplier","supplier_email_exsist"))):($("#account-email .errors").addClass("ng-hide"),$("#account-email .errors").html(""))})},e.clearEmailError=function(){$("#account-email .errors").addClass("ng-hide"),$("#account-email .errors").html("")},e.hideMore=function(){e.tableAccountModel.more=!1},e.showMore=function(){e.tableAccountModel.more=!0},e.editChildAccount=function(t){e.isEdit=!0,$("#nest-accountFrom").css("display","table"),e.isCreateNewRate=!1,e.promptTitle=Lang.getValByKey("supplier","supplier_detail_title"),e.nestAccountFrom=!0,e.username=t.userName,e.name=t.fullName,e.accountEmail=t.email,e.oldEmail=t.email,e.tel=t.mobilePhone,e.telOld=t.mobilePhone,e.id=t.id,e.isSystem=t.isSystem,e.AccountFrom.$setPristine(),e.AccountFrom.$setUntouched(),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.deleteAccount=function(){c("supplier_prompt_delete_tip",t.deleteSupplierChildAccount,"id","delete")},e.lockAccount=function(){c("supplier_prompt_lock_tip",t.lockSupplierChildAccount,"id","confirm")},e.unlockAccount=function(){c("supplier_prompt_unlock_tip",t.unlockSupplierChildAccount,"id","confirm")},e.resetPassword=function(){c("supplier_prompt_reset_tip",t.resetSupplierChildPassword,"id","confirm")},e.savePrompt=function(){var o=!1;if(e.username||(e.AccountFrom.username.$setDirty(),o=!0),e.name?/^([A-Za-z\s\u4E00-\u9FA5]+)+$/.test(e.name)||($("input[name='name']").addClass("ng-dirty"),e.AccountFrom.name.errorTips=Lang.getValByKey("supplier","supplier_validate_name"),e.AccountFrom.name.$error.defined=!0,e.AccountFrom.name.$dirty=!0,o=!0):(e.AccountFrom.name.$setDirty(),o=!0),e.accountEmail||(e.AccountFrom.accountEmail.$setDirty(),o=!0),e.tel?/^1[356789]\d{9}$/.test(e.tel)||($("input[name='tel']").addClass("ng-dirty"),e.AccountFrom.tel.errorTips=Lang.getValByKey("supplier","supplier_validate_phone"),e.AccountFrom.tel.$error.defined=!0,e.AccountFrom.tel.$dirty=!0,o=!0):(e.AccountFrom.tel.$setDirty(),o=!0),!o){for(var r=$(".errors"),l=0;l<r.length;l++)if(!$(r[l]).hasClass("ng-hide"))return;e.isEdit?t.updateSupplierChildAccount({userName:e.username,email:e.accountEmail,fullName:e.name,mobilePhone:e.tel,id:e.id,isSystem:e.isSystem,refSupplier:e.supplierId},function(t){0!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),n())}):t.addSupplierChildAccount({userName:e.username,email:e.accountEmail,fullName:e.name,mobilePhone:e.tel,refSupplier:e.supplierId},function(t){0!=t.errorCode?$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0}):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),n())})}}}e.$on("accountEvent",function(){e.init(),e.$apply()}),e.initTable=function(){e.tableAccount=[],e.tableAccountModel={tableHeader:[Lang.getValByKey("common","common_thead_number"),Lang.getValByKey("supplier","supplier_user_name"),Lang.getValByKey("supplier","supplier_name"),Lang.getValByKey("supplier","supplier_email"),Lang.getValByKey("supplier","supplier_tel"),Lang.getValByKey("supplier","supplier_type")],tableHeaderSize:["5%","22%","24%","22%","12%","10%"],tableBody:[],restURL:"logistics.searchSupplierChildAccount",restData:{refSupplier:e.supplierId,isAsc:!1,pageIndex:1,pageSize:10,sortName:"isSystem"},selectNumber:0,selectFlag:!1},n()},e.closePrompt=function(){e.nestAccountFrom=!1},e.init=function(){e.initTable(),i()}}]);