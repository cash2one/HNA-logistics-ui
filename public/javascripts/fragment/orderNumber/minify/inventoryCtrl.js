easySpa.require(["public/common/calander.js"],function(){app.controller("inventoryCtrl",["$scope","orderNumberService","orderNumberView","tableService",function(e,r,t,a){t.initCalander(),e.invertoryBeginTime=getBeforeDate(6)+" 00:00:00",e.invertoryEndTime=(new Date).format("yyyy-MM-dd 23:59:59"),e.inventoryInfo={id:0};var o,n,d;"channelNumber"===e.module?(o=[Lang.getValByKey("orderNumber","orderNumber_table_batchNumber"),Lang.getValByKey("orderNumber","orderNumber_table_service"),Lang.getValByKey("orderNumber","orderNumber_table_supplier"),Lang.getValByKey("orderNumber","orderNumber_table_starNumber"),Lang.getValByKey("orderNumber","orderNumber_table_endNumber"),Lang.getValByKey("orderNumber","orderNumber_table_used"),Lang.getValByKey("orderNumber","orderNumber_table_createTime")],n=["13%","12%","15%","15%","15%","14%","16%"],d="logistics.getChannelNumberBatch"):(o=[Lang.getValByKey("orderNumber","orderNumber_table_batchNumber"),Lang.getValByKey("orderNumber","orderNumber_table_clientele"),Lang.getValByKey("orderNumber","orderNumber_table_productTeam"),Lang.getValByKey("orderNumber","orderNumber_add_product"),Lang.getValByKey("orderNumber","orderNumber_table_starNumber"),Lang.getValByKey("orderNumber","orderNumber_table_endNumber"),Lang.getValByKey("orderNumber","orderNumber_table_used"),Lang.getValByKey("orderNumber","orderNumber_table_createTime")],n=["12%","12%","12%","12%","13%","13%","12%","14%"],d="logistics.getWaybillNumberBatch"),e.tableModel={tableHeader:o,tableHeaderSize:n,tableBody:[],restURL:d,restData:{q:"",batchNumber:"",waybillNumber:"",channelNumber:"",serviceUid:"",productUid:"",refParentGroupId:"",productGroupId:"",startTime:getBeforeDate(6)+" 00:00:00",endTime:(new Date).format("yyyy-MM-dd 23:59:59"),pageIndex:1,pageSize:10,sort:""},selectNumber:0,selectFlag:!1},e.getTable=function(r){e.tableModel.restData.startTime=e.invertoryBeginTime,e.tableModel.restData.endTime=e.invertoryEndTime,e.tableModel.restData.serviceUid=e.serviceUid,e.tableModel.restData.productUid=e.productUid,e.tableModel.restData.refParentGroupId=e.inventoryInfoProductTeamFirstId,e.tableModel.restData.productGroupId=e.inventoryInfoProductTeamLeafId,e.tableModel.restData.batchNumber=e.searchBatchNumber,(e.tableModel.restData.channelNumber||e.tableModel.restData.waybillNumber)&&(e.tableModel.restData.batchNumber="",e.tableModel.restData.startTime="",e.tableModel.restData.endTime="",e.tableModel.restData.serviceUid="",e.tableModel.restData.productUid="",e.tableModel.restData.refParentGroupId="",e.tableModel.restData.productGroupId=""),r&&(e.tableModel.restData.pageIndex=1);var t,o={urlParams:e.tableModel.restData};a.getTable(e.tableModel.restURL,o,function(r){0===r.errorCode&&(e.tableModel=a.table(e.tableModel,o,r),t="channelNumber"===e.module?$(".order-table-inventory").height()-304:$(".order-table-inventory").height()-353,setTimeout(function(){$(".table-container tbody").slimscroll({height:t}),$(window).resize(function(){t="channelNumber"===e.module?$(".order-table-inventory").height()-304:$(".order-table-inventory").height()-353,$(".table-container tbody").slimscroll({height:t})})},10))})},e.getTable(),e.resetData=function(){e.tableModel.restData.batchNumber="",e.searchBatchNumber="",e.tableModel.restData.waybillNumber="",e.tableModel.restData.channelNumber="",e.tableModel.restData.serviceUid="",e.tableModel.restData.productUid="",e.tableModel.restData.refParentGroupId="",e.tableModel.restData.productGroupId="",e.service="",e.serviceUid="",e.product="",e.productUid="",e.inventoryInfoProductTeamFirst="",e.inventoryInfoProductTeamFirstId="",e.inventoryInfoProductTeamLeaf="",e.inventoryInfoProductTeamLeafId="",e.tableModel.restData.pageIndex=1,u&&u.clearData(),e.invertoryBeginTime=getBeforeDate(6)+" 00:00:00",e.invertoryEndTime=(new Date).format("yyyy-MM-dd 23:59:59"),e.tableModel.restData.startTime=getBeforeDate(6)+" 00:00:00",e.tableModel.restData.endTime=(new Date).format("yyyy-MM-dd 23:59:59"),e.getTable()},e.createNumber=function(){e.inventoryInfoFrom.$setPristine(),e.inventoryInfoFrom.$setUntouched(),"channelNumber"===e.module?(e.serviceInventoryRequired=!0,e.clienteleInventoryRequired=!1):(e.serviceInventoryRequired=!1,e.clienteleInventoryRequired=!0),e.serviceInventory="",e.serviceInventoryUid="",e.createAllInventory="",e.nestInventoryInfoFrom=!0,e.productInventoryDisabled=!0,$("#nest-inventoryInfoFrom").css("display","table"),$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.editNumber=function(t){e.inventoryInfo.id=t,e.editInventoryInfo=!0,$("#nest-editInventoryInfoFrom").css("display","table"),$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit"),r.orderNumberGetInventoryDetail({seatParams:{batchNo:t}},function(r){r&&0===r.errorCode&&(e.createWayInventory=r.data.generateMethodName,e.operatorInventory=r.data.createUserName+" "+r.data.createUserCode)})},e.closeInventory=function(){e.serviceInventory="",e.serviceInventoryUid="",e.clienteleInventory="",e.clienteleInventoryId="",e.productTeamInventory="",e.productTeamInventoryId="",e.productInventory="",e.productInventoryUid="",e.createAllInventory="",$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),e.nestInventoryInfoFrom=!1,e.editInventoryInfo=!1,e.addInventoryInfo=!1},e.saveInventory=function(){if(e.serviceInventory||"channelNumber"!==e.module||e.inventoryInfoFrom.serviceInventory.$setDirty(),e.productTeamInventory||"waybillNumber"!==e.module||e.inventoryInfoFrom.productTeamInventory.$setDirty(),e.createAllInventory||e.inventoryInfoFrom.createAllInventory.$setDirty(),!e.inventoryInfoFrom.$valid)return void scrollToErrorView($(".switch-list"));var a;"channelNumber"===e.module?a=e.serviceInventoryUid:"waybillNumber"===e.module&&(a=e.productInventoryUid);var o={urlParams:{refUid:a,numbers:e.createAllInventory}};"waybillNumber"===e.module&&(o.urlParams.customerId=e.clienteleInventoryId,o.urlParams.refId=e.productTeamInventoryId);var n={title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:Lang.getValByKey("orderNumber","orderNumber_title_inventory")},operation:[{type:"submit",description:Lang.getValByKey("orderNumber","orderNumber_button_ok"),application:"",operationEvent:function(){r.orderNumberInventorySave(o,function(r){t.promptBox("closePrompt"),r&&0===r.errorCode&&0!==r.data?(t.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("orderNumber","orderNumber_new_success")+r.data,type:"success",time:3e3}),e.closeInventory(),e.getTable(),e.$apply()):t.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("orderNumber","orderNumber_new_lose"),type:"errer",manualClose:!0,time:3e3})})}}]};t.promptBox(n)};var l;e.getSearchInventoryServiceData=function(){var a={urlParams:{q:"",pageIndex:1,pageSize:10,status:3},seatParams:{serviceTypeCode:-1},isAsync:!0};e.searchInventoryServics=r.getServiceShort(a),t.rebuildServiceName(e.searchInventoryServics),l&&l.destroy(),l=selectFactory({data:e.searchInventoryServics,id:"search-inventoryService",isSearch:!0,pagination:!0,isCreateNewSelect:!0,closeLocalSearch:!0,searchPlaceHoder:Lang.getValByKey("orderNumber","orderNumber_service_placeholder"),onSearchValueChange:function(o,n,d){(n||d)&&(a={urlParams:{q:n,pageIndex:d||1,pageSize:10,status:3},seatParams:{serviceTypeCode:-1},isAsync:!0},e.searchInventoryServics=r.getServiceShort(a),t.rebuildServiceName(e.searchInventoryServics),o.setData(e.searchInventoryServics))},attrTextModel:function(r,t,a){e.serviceUid=a.uid,e.service=a.name,e.$apply()}}),l.open()};var i;e.getSearchInventoryProductData=function(){var a={urlParams:{q:"",pageIndex:1,pageSize:10,status:3,includeAllAudit:!0,topGrade:e.inventoryInfoProductTeamFirstId||"",secondGrade:e.inventoryInfoProductTeamLeafId||""}};e.searchInventoryProducts=r.getProductRuleShort(a),t.rebuildServiceName(e.searchInventoryProducts),i&&i.destroy(),i=selectFactory({data:e.searchInventoryProducts,id:"search-inventoryProduct",isSearch:!0,pagination:!0,isCreateNewSelect:!0,closeLocalSearch:!0,searchPlaceHoder:Lang.getValByKey("orderNumber","orderNumber_service_placeholder"),onSearchValueChange:function(o,n,d){(n||d)&&(a={urlParams:{q:n,pageIndex:d||1,pageSize:10,status:3,includeAllAudit:!0,topGrade:e.inventoryInfoProductTeamFirstId||"",secondGrade:e.inventoryInfoProductTeamLeafId||""}},e.searchInventoryProducts=r.getProductRuleShort(a),t.rebuildServiceName(e.searchInventoryProducts),o.setData(e.searchInventoryProducts))},attrTextModel:function(r,t,a){e.productUid=a.uid,e.product=a.name,e.$apply()}}),i.open()};var c;e.getSearchProductTeamFirstData=function(){e.searchProductTeamRules=r.getProductTeamLeafRuleShort(null),c&&c.destroy(),c=selectFactory({data:e.searchProductTeamRules,id:"search-inventoryProductTeam-first",isCreateNewSelect:!0,defaultText:Lang.getValByKey("orderNumber","orderNumber_select_all"),attrTextModel:function(r,t,a){$.isEmptyObject(a)&&(e.inventoryInfoProductTeamFirst="",e.inventoryInfoProductTeamFirstId="",e.searchProductTeamLeafRules=[],u.clearData()),e.productUid="",e.product="",e.inventoryInfoProductTeamFirst=a.name,e.inventoryInfoProductTeamFirstId=a.id,delete e.inventoryInfoProductTeamLeafId,delete e.inventoryInfoProductTeamLeaf,e.$apply()}}),c.open()};var u=null;e.getSearchProductTeamLeafData=function(){e.inventoryInfoProductTeamFirstId&&(e.searchProductTeamLeafRules=r.getProductTeamLeafRuleShort(e.inventoryInfoProductTeamFirstId),u&&u.destroy(),u=selectFactory({data:e.searchProductTeamLeafRules,id:"search-inventoryProductTeam-leaf",isCreateNewSelect:!0,defaultText:Lang.getValByKey("orderNumber","orderNumber_select_all"),attrTextModel:function(r,t,a){e.productUid="",e.product="",e.inventoryInfoProductTeamLeafId=a.id,e.inventoryInfoProductTeamLeaf=a.name,e.$apply()}}),u.open())};var s;e.getServiceInventoryData=function(){var a={urlParams:{q:"",pageIndex:1,pageSize:10}};e.addServiceInventorys=r.getServiceLoadShort(a),t.rebuildServiceName(e.addServiceInventorys),s&&s.destroy(),s=selectFactory({data:e.addServiceInventorys,id:"service-inventory",isSearch:!0,isCreateNewSelect:!0,pagination:!0,height:240,closeLocalSearch:!0,searchPlaceHoder:Lang.getValByKey("orderNumber","orderNumber_service_placeholder"),defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(o,n,d){(n||d)&&(a={urlParams:{q:n,pageIndex:d||1,pageSize:10}},e.addServiceInventorys=r.getServiceLoadShort(a),t.rebuildServiceName(e.addServiceInventorys),o.setData(e.addServiceInventorys))},attrTextModel:function(r,t,a){e.serviceInventoryUid=a.uid,e.serviceInventory=a.name,e.$apply()}}),s.open()};var m;e.getProductTeamInventoryData=function(){e.addProductTeamRules=r.getProductTeamRuleShort(),m&&m.destroy(),m=selectFactory({data:e.addProductTeamRules,id:"productTeam-inventory",isCreateNewSelect:!0,height:240,defaultCount:100,defaultText:Lang.getValByKey("orderNumber","orderNumber_select_tips"),attrTextModel:function(r,t,a){$.isEmptyObject(a)?(e.productInventoryUid="",e.productInventory="",e.productInventoryDisabled=!0):e.productInventoryDisabled=!1,e.productInventoryUid="",e.productInventory="",e.productTeamInventoryId=a.id,e.productTeamInventory=a.name,e.topGrade=a.parentId,e.$apply()}}),m.open()};var y;e.getProductInventoryData=function(){var a={urlParams:{q:"",pageIndex:1,pageSize:10,productGroupId:e.productTeamInventoryId||""}};e.addProductInventorys=r.getProductInventoryShort(a),t.rebuildServiceName(e.addProductInventorys),y&&y.destroy(),y=selectFactory({data:e.addProductInventorys,id:"product-inventory",isSearch:!0,pagination:!0,isCreateNewSelect:!0,height:240,closeLocalSearch:!0,searchPlaceHoder:Lang.getValByKey("orderNumber","orderNumber_service_placeholder"),defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(o,n,d){(n||d)&&(a={urlParams:{q:n,pageIndex:d||1,pageSize:10,productGroupId:e.productTeamInventoryId||""}},e.addProductInventorys=r.getProductInventoryShort(a),t.rebuildServiceName(e.addProductInventorys),o.setData(e.addProductInventorys))},attrTextModel:function(r,t,a){e.productInventoryUid=a.uid,e.productInventory=a.name,e.$apply()}}),y.open()};var v;e.getClienteleInventoryData=function(){var a={urlParams:{q:"",pageIndex:1,pageSize:10,userType:1}};e.addClienteleInventorys=r.getClienteleShort(a),t.rebuildClienteleName(e.addClienteleInventorys),v&&v.destroy(),v=selectFactory({data:e.addClienteleInventorys,showTextField:"userName",id:"clientele-inventory",isSearch:!0,pagination:!0,isCreateNewSelect:!0,height:240,closeLocalSearch:!0,searchPlaceHoder:Lang.getValByKey("orderNumber","orderNumber_clientele_placeholder"),defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(o,n,d){(n||d)&&(a={urlParams:{q:n||"",pageIndex:d||1,pageSize:10,userType:1}},e.addClienteleInventorys=r.getClienteleShort(a),t.rebuildClienteleName(e.addClienteleInventorys),o.setData(e.addClienteleInventorys))},attrTextModel:function(r,t,a){e.clienteleInventoryId=a.id,e.clienteleInventory=a.userName,e.$apply()}}),v.open()};var b;e.getServiceLoadNumberData=function(){var a={urlParams:{q:"",pageIndex:1,pageSize:10,status:-1},seatParams:{serviceTypeCode:-1},isAsync:!0};e.addServiceLoadNumbers=r.getServiceShort(a),t.rebuildServiceName(e.addServiceLoadNumbers),b&&b.destroy(),b=selectFactory({data:e.addServiceLoadNumbers,id:"service-loadNumber",isSearch:!0,pagination:!0,isCreateNewSelect:!0,height:240,closeLocalSearch:!0,searchPlaceHoder:Lang.getValByKey("orderNumber","orderNumber_service_placeholder"),defaultText:Lang.getValByKey("common","common_select_tips"),onSearchValueChange:function(o,n,d){(n||d)&&(a={urlParams:{q:n,pageIndex:d||1,pageSize:10,status:-1},seatParams:{serviceTypeCode:-1},isAsync:!0},e.addServiceLoadNumbers=r.getServiceShort(a),t.rebuildServiceName(e.addServiceLoadNumbers),o.setData(e.addServiceLoadNumbers))},attrTextModel:function(r,t,a){$('input[type="file"]').val(""),$(".serviceLoadNumberInput").css("border-color","#BDBDBD"),e.serviceLoadNumberUid=a.uid,e.serviceLoadNumber=a.name,e.$apply()}}),b.open()},e.loadNumber=function(){e.loadNumberFrom.$setPristine(),e.loadNumberFrom.$setUntouched(),e.nestLoadNumber=!0,e.uploadNumbering=!1,e.canLoadNumber=!0,$("#nest-loadNumber").css("display","table"),$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),$('button[name="prompt-save"]').addClass("save").removeClass("edit")},e.getFile=function(a){if(e.serviceLoadNumber?$(".serviceLoadNumberInput").css("border-color","#BDBDBD"):($(".serviceLoadNumberInput").css("border-color","#FA787E"),e.loadNumberFrom.serviceLoadNumber.$setDirty()),e.loadNumberFrom.$valid){var o=r.uploadInventoryData(e.avatarFile,e.serviceLoadNumberUid);if(!o)return $('input[type="file"]').val(""),!1;o.errorlocal?($('input[type="file"]').val(""),t.promptBox({isDelay:!0,contentDelay:Lang.getValByKey("orderNumber",o.errorlocal),type:"errer",manualClose:!0})):o.then(function(r){0===r.data.errorCode?(e.canLoadNumber=!1,e.uploadNumbering=!0,e.errorNumber=r.data.data.errorNumber,e.total=r.data.data.total,e.successNumber=r.data.data.successNumber,e.uploadResultTrue=r.data.data.success,e.uploadResult=r.data.data.result,r.data.data.result.length?e.hasUploadResultData=!0:e.hasUploadResultData=!1):t.promptBox({isDelay:!0,contentDelay:r.data.msg,type:"errer",manualClose:!0})}),e.$apply()}},e.closeLoadNumber=function(){e.serviceLoadNumber="",$('input[type="file"]').val(""),$(".input-text").removeClass("ng-dirty"),$(".errors").addClass("ng-hide"),e.nestLoadNumber=!1,e.uploadNumbering=!1},e.saveLoadNumber=function(){if(e.serviceLoadNumber?$(".serviceLoadNumberInput").css("border-color","#BDBDBD"):($(".serviceLoadNumberInput").css("border-color","#FA787E"),e.loadNumberFrom.serviceLoadNumber.$setDirty()),e.loadNumberFrom.$valid){var a={urlParams:e.uploadResultTrue,seatParams:{serviceUid:e.serviceLoadNumberUid}},o=Lang.getValByKey("orderNumber","orderNumber_content_gong");e.errorNumber?o+=e.total+Lang.getValByKey("orderNumber","orderNumber_content_bar")+e.errorNumber+Lang.getValByKey("orderNumber","orderNumber_content_abr"):o+=e.total+Lang.getValByKey("orderNumber","orderNumber_content_rab");var n={title:Lang.getValByKey("common","common_prompt_title"),type:"success",content:{tip:o},operation:[{type:"submit",description:Lang.getValByKey("orderNumber","orderNumber_button_ok"),application:"",operationEvent:function(){r.orderNumberInventoryLoadSave(a,function(r){t.promptBox("closePrompt"),r&&0===r.errorCode?(t.promptBox({isDelay:!0,contentDelay:r.msg,type:"success"}),e.closeLoadNumber(),e.getTable(),e.$apply()):t.promptBox({isDelay:!0,contentDelay:r.msg,type:"errer",manualClose:!0})})}}]};t.promptBox(n)}}}])});