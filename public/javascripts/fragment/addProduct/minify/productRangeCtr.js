easySpa.require(["widget/slimscroll","public/common/tableController.js","widget/prompt","widget/parseUrl","widget/select"],function(){app.controller("productRangeCtr",["$scope","addProductService","tableService",function(e,t,o){function r(o){t.getProductBaseInfo(o,function(t){e.productGroupFirstId=t.data.productGroupRootId,e.status=t.data.status})}e.$on("productRangeEvent",function(t,o){e.productGroupFirstId=o.productGroupFirstId||"",e.init(),e.$apply()}),e.init=function(){var a=sessionStorage.getItem("backPricePath");e.parameter=window.parseUrl.getParams(),e.id=e.id||e.parameter.id,e.uid=e.uid||e.parameter.uid,a?e.canEditRange=!1:e.isAudit?(e.IsDraftStatus||e.isOffline)&&(e.canEditRange=!0):e.IsDraftStatus&&(e.canEditRange=!0),r(e.uid),e.productTable={tableHeader:[Lang.getValByKey("common","common_thead_number"),"类型范围","编码","创建者","创建时间","分区详情",Lang.getValByKey("common","common_page_remarks")],tableBody:[],restURL:"logistics.getProductRegion",restData:{q:"",pageIndex:1,pageSize:10,sort:"code"},selectNumber:0,selectFlag:!1},e.getProductTable=function(){var t={urlParams:e.productTable.restData,seatParams:{id:e.id}};o.getTable(e.productTable.restURL,t,function(r){if(0===r.errorCode){r.pagination={currentPage:1,currentResult:0,pageSize:10,totalPage:0,totalResult:0},e.productTable=o.table(e.productTable,t,r);var r=e.productTable&&e.productTable.tableBody;r.length>=2?e.disabledAdd=!0:e.disabledAdd=!1;var a=$(".tab-content").height()-120;setTimeout(function(){$(".table-container tbody").slimscroll({height:a}),$(window).resize(function(){a=$(".tab-content").height()-120,$(".table-container tbody").slimscroll({height:a})})},10)}})},e.getProductTable(),e.add=function(){e.eDisabled=!1,e.sDisabled=!1,e.showCode=!1;var t=e.productTable&&e.productTable.tableBody;if(t)for(var o=0,r=t.length;o<r;o++)"s"==t[o].type?e.sDisabled=!0:"e"==t[o].type&&(e.eDisabled=!0);e.sDisabled&&e.eDisabled?e.rangeRadio="":e.sDisabled?e.rangeRadio="e":e.rangeRadio="s",e.regionForm.$setPristine(),e.regionForm.$setUntouched(),e.regionForm.$setUntouched(),e.isSaveNext=!0,e.proRegionID=0,e.code="",e.description="",$(document).promptBox({title:"添加分区方案",loadTitle:function(){return"添加分区方案"},isMiddle:!0,isNest:!0,content:{nest:$("#regionDetail")},loadData:function(){$('#nest-regionDetail .other-btn button[name="prompt-operation"]').addClass("save").removeClass("edit")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_save"),operationEvent:function(){e.saveProductRegion(),$(document).promptBox("closeFormPrompt"),e.$apply()}}]})},e.edit=function(t){if(e.$parent.IsDraftStatus||e.$parent.isOffline){e.eDisabled=!1,e.sDisabled=!1,e.showCode=!0;(e.productTable&&e.productTable.tableBody).length>=2&&(e.sDisabled=!0,e.eDisabled=!0),e.regionForm.$setPristine(),e.regionForm.$setUntouched(),e.regionForm.$setUntouched(),e.isSaveNext=!0,e.rangeRadio=t.type,e.code=t.code,e.description=t.remark,e.proRegionID=t.id,$(document).promptBox({title:"编辑分区方案",loadTitle:function(){return"编辑分区方案"},isMiddle:!0,isNest:!0,content:{nest:$("#regionDetail")},loadData:function(){$('#nest-regionDetail .other-btn button[name="prompt-operation"]').addClass("save").removeClass("edit")},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_save"),operationEvent:function(){e.saveProductRegion(),e.$apply(),$(document).promptBox("closeFormPrompt")}}]})}},e.saveProductRegion=function(){if(e.rangeRadio&&(e.proRegionID&&!e.code&&e.regionForm.code.$setDirty(),!$("#code-msg").hasClass("remote-invalid")&&e.regionForm.$valid)){var o=1==e.productGroupFirstId?1:6==e.productGroupFirstId?6:11,r={urlParams:{type:e.rangeRadio,productId:e.id,code:e.code,addressType:o,remark:$.trim(e.description)},seatParams:{}},a="s"==e.rangeRadio?"起点范围":"终点范围";e.proRegionID?(r.seatParams.id=e.proRegionID,t.putProductRegion(r,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.isSaveNext?e.regionDetail(t.data,a):e.getProductTable()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})):t.saveProductRegion(r,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),e.isSaveNext?e.regionDetail(t.data,a):e.getProductTable()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}},e.regionDetail=function(t,o){e.topParameter=window.parseUrl.getTopParams(),e.parameter.workId=e.topParameter.workId,e.parameter.isJustShow=e.topParameter.isJustShow;var r="";r="approval"==e.parameter.from&&3==e.status&&e.canEditRange?1:e.status,"undefined"!=e.parameter.orderNo&&e.parameter.orderNo||(e.parameter.orderNo=""),window.location.href="#/regionDetail?schemaId="+t+"&name="+o+"&uid="+e.uid+"&id="+e.id+"&status="+r+"&q=addProduct&from="+e.parameter.from+"&type="+e.parameter.type+"&index=3&orderNo="+(e.parameter.orderNo||"")+"&workId="+e.parameter.workId+"&isJustShow="+e.parameter.isJustShow+"&productGroupId="+e.productGroupFirstId+"&origin="+e.topParameter.origin},e.del=function(){var r=[],a=o.getSelectTable(e.productTable.tableBody);if(!a.length)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("common","common_code_noSelected"),type:"errer",manualClose:!0}),!1;angular.forEach(a,function(e){r.push(e.id)});var n={urlParams:r},i={title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:"确定删除已选产品范围？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){t.delProductRegion(n,function(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success"}),$(document).promptBox("closePrompt"),e.getProductTable(),e.$apply()):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})})}}]};$(document).promptBox(i)},e.checkCode=function(){var o={urlParams:{code:e.code,id:e.proRegionID}};e.code&&t.checkRegionCode(o,function(t){0!=t.errorCode?(e.regionForm.code.errorTips=t.msg,$("#code-msg").removeClass("ng-hide").addClass("remote-invalid")):($("#code-msg").addClass("ng-hide").removeClass("remote-invalid"),e.regionForm.code.errorTips="")})}}}])});