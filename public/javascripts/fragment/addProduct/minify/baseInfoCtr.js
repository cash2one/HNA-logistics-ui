easySpa.require(["widget/prompt","public/javascripts/fragment/selectTypes/selectTypesCtrl.js","public/javascripts/fragment/selectTypes/selectTypesService.js","public/common/pictureController.js"],function(){app.controller("baseInfoCtr",["$scope","addProductService","$route","pictureService",function(t,e,o,a){function r(){var e={};for(var o in t)-1===o.indexOf("$")&&"object"!=typeof t[o]&&"function"!=typeof t[o]&&(e[o]=t[o]);return e.cargos=t.cargoTypeCode,delete e.cargoTypeCode,e}function i(){var e=!0;return t.auditStatus||(t.customerForm.auditStatus.$setDirty(),e=!1),t.auditRemark||(t.customerForm.auditRemark.$setDirty(),e=!1),e}function d(t){0===t.errorCode?($(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt")):$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})}function n(o){e.getProductBaseInfo(o,function(e){$.extend(t,e.data),e.data.image?(t.hasUpload=!0,t.imgUrl=e.data.image):t.hasUpload=!1,t.oldCode=t.code,"boolean"==typeof e.data.isOnline?t.isOffline=!e.data.isOnline:t.isOffline=e.data.isOnline,t.$parent.status=e.data.status,t.$parent.IsDraftStatus=1===e.data.status,t.setProductInfo(e.data,t.isNew),T?t.canEditBase=!1:t.isAudit?(t.$parent.IsDraftStatus||t.isOffline)&&(t.canEditBase=!0):t.$parent.IsDraftStatus&&(t.canEditBase=!0),t.tab.enableAll(),c(t.createUserId)})}function c(o){e.getUserDetail(o,function(e){e.data&&(t.creator=e.data.fullName+" "+e.data.userName)})}function u(){var e=t.cargos;t.cargoTypeCode=[],t.cargoTypeCodeIndex=[],e&&e.length>0&&(t.cargoTypeCodeName=[],e.forEach(function(e){t.cargoTypeCodeName.push(e.cargoTypeName),t.cargoTypeCode.push({cargoTypeCode:e.cargoTypeCode}),t.cargoTypeCodeIndex.push(e.cargoTypeCode)}),t.cargoTypeCodeName=t.cargoTypeCodeName.join("，"))}function s(){var e=["name","code","productGroupFirst","productGroupLeaf","introduction","cargoTypeCodeName"],o=!0;return e.forEach(function(e){t[e]||(t.customerForm[e].$setDirty(),o=!1)}),!0!==t.codeError&&void 0!==t.codeError&&(o=!1),!t.estimatedTime&&t.estimatedUnitName&&(t.customerForm.estimatedTime.$setDirty(),o=!1),t.estimatedTime&&!t.estimatedUnitName&&(t.customerForm.estimatedUnitName.$setDirty(),o=!1),o&&t.canSubmit}function p(){var e=$("#getUnGoodTypes input.active"),o=[],a="";e.each(function(t){o.push(e.eq(t).data("id")),t===e.length-1?a+=e.eq(t).parent().data("name"):a+=e.eq(t).parent().data("name")+"，"}),t.cargoTypeCodeName=a,t.cargoTypeCodeIndex=[],t.cargoTypeCode=o.map(function(e){return t.cargoTypeCodeIndex.push(e),{cargoTypeCode:e}}),$(document).promptBox("closeFormPrompt"),t.$apply()}function m(){t.selectTypesModel.selectedGoods=[],e.getGoodTypes(null,function(e){if(0===e.errorCode){var o=t.cargoTypeCodeIndex;for(var a in e.data)if(e.data.hasOwnProperty(a)){e.data[a].id=e.data[a].code,e.data[a].checked=!1;for(var r in o)e.data[a].id===o[r]&&(e.data[a].checked=!0)}var i=[];for(var d in e.data)e.data[d].name&&i.push(e.data[d]);t.selectTypesModel.listGoodsTypes=i}})}function l(){var o=t.$watch(function(){return!(!t.estimatedUnit||!t.estimatedList)},function(e,a){e&&(t.estimatedList.forEach(function(e){t.estimatedUnit===e.code&&(t.estimatedUnitName=e.name)}),o())}),a=t.$watch(function(){return!(!t.productGroupList||!t.productGroupLeafId)},function(o,r){o&&(e.searchProductGroup(t.productGroupLeafId,function(e){t.productGroupPublic=e.data.childProductGroup[0].public,t.productGroupFirst=e.data.name,t.productGroupFirstId=e.data.id}),a())})}function f(){e.getProductEstimated(null,function(e){t.estimatedList=e.data,selectFactory({data:e,id:"estimated-unit-name",offset:-300,attrTextModel:function(e,o,a){t.estimatedUnit=a.code,t.estimatedUnitName=e,t.$apply()}})})}function g(){t.weightLimitUnitCode="kg",t.weightLimitUnitName="千克"}function y(){function o(o,r){o&&e.getProductGroup(o,function(e){t.productGroupLeafData=e,t.productGroupLeafId&&e.data.forEach(function(e){e.id===t.productGroupLeafId&&(t.productGroupLeaf=e.name)}),a||(a=selectFactory({data:{},id:"product-group-leaf",offset:-300,attrTextModel:function(e,o,a){t.productGroupLeaf=e,e&&(t.productGroupLeafId=a.id,t.productGroupPublic=a.public,a.public||(t.isPublic=a.public)),t.$apply()}})),a.setData(e),$("#product-group-leaf").val(t.productGroupLeaf)})}e.getProductGroup(null,function(e){t.productGroupList=e.data,selectFactory({data:e,id:"product-group-first",offset:-300,attrTextModel:function(e,o,r){e||a.setData({data:[]}),t.productGroupFirst=e,t.productGroupFirstId=r.id,delete t.productGroupLeafId,delete t.productGroupLeaf,t.$apply()}})});var a=null;t.$watch("productGroupFirstId",o)}var T=sessionStorage.getItem("backPricePath");t.$on("baseInfoEvent",function(){t.isEdit=!1,t.baseInfoForm={},t.isPublic=!0,t.acceptType=1,t.productGroupPublic=!0,o.current.params&&"new"===o.current.params.from?(t.isAudit=!1,t.uid||(t.isEdit=!0)):t.isAudit=!0,t.init(),t.$apply()}),t.init=function(){t.uid?n(t.uid):(t.setPageTitle(Lang.getValByKey("addProduct","product_add_title")),t.isNew=!0),f(),y(),g(),u(),t.uid&&t.id&&l()},t.editBaseInfo=function(){t.isEdit=!0,t.$parent.isEdit=!0,sessionStorage.setItem("isEdit",1),t.canEditBase=!1},t.cancel=function(){C&&angular.extend(t,C),t.isEdit=!1,t.$parent.isEdit=!1,sessionStorage.setItem("isEdit",0),t.canEditBase=!0};var C;t.$watch("isEdit",function(t,e){t&&(C=r())}),t.delshow=!1,t.pictureModel={edit:!0,uploadShow:!1,picture:[],accept:"image/jpg,image/jpeg,image/png,image/bmp,image/tiff"},t.getFile=function(e){var o=a.uploadFile(t.pictureModel,e[0]);if(!o)return!1;o.errorlocal?$(document).promptBox({isDelay:!0,contentDelay:o.errorlocal,type:"errer",manualClose:!0}):o.then(function(e){0===e.data.errorCode?(t.validatePictureError=!1,t.image=e.data.data.path,t.imgUrl=e.data.data.path,t.hasUpload=!0,$(document).promptBox({isDelay:!0,contentDelay:e.data.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:e.data.msg,type:"errer",manualClose:!0})})},t.delPic=function(){t.imgUrl="",t.hasUpload=!1},t.saveCustomer=function(){if(!s())return void scrollToErrorView($(".tab-content"));t.isEdit=!1,t.$parent.isEdit=!1,sessionStorage.setItem("isEdit",""),t.canEditBase=!0;var o=r();t.uid?e.modifyProductBaseInfo(t.uid,o,d):e.saveCustomer(o,function(e){0===e.errorCode&&(t.$parent.uid=t.uid=e.data.uid,t.$parent.id=t.id=e.data.id,n(e.data.uid)),d(e)})},t.$watch("isEdit",function(){t.checkCode(1)}),t.checkCode=function(o){if(!o)return t.code===t.oldCode?void(t.codeError=!0):void(t.code&&e.productCheckCode(t.code,function(e){0!==e.errorCode?(t.customerForm.code.$setDirty(),t.codeErrorMsg=e.msg,t.codeError=!1):0===e.errorCode&&(t.codeError=!0,t.customerForm.code.$setPristine(),t.codeErrorMsg=""),t.$degist()}))},t.submitAudit=function(){i()&&e.auditAndRejections(t.auditStatus,t.uid,t.auditRemark,function(e){d(e),0===e.errorCode&&setTimeout(function(){t.goBackProduct()},1e3)})},t.$watch("estimatedTime",function(e,o){e||t.customerForm.estimatedUnitName.$setPristine()}),t.selectGoodTypes=function(){$(document).promptBox({isHidden:!0,title:"请选择货物类型",isNest:!0,loadData:function(){m()},content:{nest:$("#getUnGoodTypes")},operation:[{type:"submit",description:Lang.getValByKey("common","common_prompt_confirm"),operationEvent:function(){p()}}]})},t.selectTypesModel={selectedGoods:[],listGoodsTypes:t.listGoodsTypes}}])}),window.onbeforeunload=function(){sessionStorage.setItem("isEdit","")};