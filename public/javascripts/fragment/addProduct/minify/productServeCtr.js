easySpa.require(["public/javascripts/product/20161224/productRoute.js","widget/slimscroll","public/common/tableController.js","widget/prompt","widget/select","widget/starRating"],function(){app.controller("productServeCtr",["$scope","addProductService","tableService",function(e,t,i){function r(){var t={urlParams:e.tableModel.restData};i.getTable(e.tableModel.restURL,t,function(r){0===r.errorCode&&(r.pagination={pageSize:10,totalPage:1,totalResult:r.data.length,currentResult:0,currentPage:1},e.tableModel=i.table(e.tableModel,t,r),setTimeout(function(){$(".table-box").focus(),e.$apply()},100))})}function o(){e.tableModel={tableHeader:[Lang.getValByKey("addProduct","product_service_point"),Lang.getValByKey("addProduct","product_service_attr"),Lang.getValByKey("addProduct","product_service_type"),Lang.getValByKey("common","common_table_remark")],tableBody:[],tableHeaderSize:["25%","25%","25%","25%"],restURL:"logistics.getProduct",restData:{q:"",isAsc:!1,pageIndex:1,pageSize:10,id:e.$parent.id},selectNumber:0,selectFlag:!1},r()}function n(e){if(e)for(var t=0;t<e.length;t++)e[t].name=e[t].name+"("+e[t].code+")"}function a(){t.IsMainServiceExist(e.id,function(e){0===e.errorCode?e.data?y.setData(I):y.setData(R):y.setData(I)})}function c(){y=selectFactory({data:[],id:"proprety",isCreateNewSelect:!0,defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(t,i,r){t?(e.data.servicePropertyName=t,e.data.serviceProperty=r.code,e.IsMainExist="MAIN"==r.code):(e.data.servicePropertyName="",e.data.serviceProperty=""),e.$apply()}})}function s(i,r,o){t.getProductService({seatParams:{uid:e.$parent.uid,type:i,ordinal:r},urlParams:{hasDisabled:!0}},function(t){0===t.errorCode&&(e.data=angular.copy(t.data))})}function d(e){t.delProductService({urlParams:e},function(e){0===e.errorCode?($(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"success",time:3e3}),$(document).promptBox("closePrompt"),r()):$(document).promptBox({isDelay:!0,contentDelay:e.msg,type:"errer",manualClose:!0})})}function l(t,i,r){i(t,function(t){0!=t.errorCode?(e.showPricePackage=!0,$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"errer",manualClose:!0})):(e.closePrompt(),$(document).promptBox({isDelay:!0,contentDelay:t.msg,type:"success",time:3e3}),r())})}function m(){e.data={agingWeighting:1,description:"",id:"",isEnable:!0,ordinal:0,priceWeighting:1,productId:e.$parent.id,productName:"",productServiceRelInfos:[],productUid:e.$parent.uid,serviceProperty:"",servicePropertyName:"",serviceTypeCode:"",serviceTypeName:""},e.serviceRelInfo={customerLevel:"",customerLevelName:"",customerLevelExt:"",customerLevelExtName:"",declaredValueMax:"",declaredValueMin:"",orderQuantity:"",orderQuantityUnit:"%",regionsStart:[],regionsEnd:[],cargos:[],serviceContent:"",serviceName:"",serviceUid:"",weightLimitMax:"",weightLimitMin:""},e.showPrompt=!1,e.modifyPrompt=!1,e.IsMainExist=!1,e.showServiceExist=!1}function v(e,t,i){$(e).rating("update",t),$(e).rating("refresh",{min:0,max:5,step:1,size:"xs",animate:!0,displayOnly:i,showClear:!1,showCaption:!1})}function g(i){t.getProductServiceRegions({seatParams:{uid:i}},function(t){if(0===t.errorCode){var i=angular.copy(t.data);if(e.showServicesRegions=i.starts.length||i.ends.length,e.serviceRelInfo.regionsStart||(e.serviceRelInfo.regionsStart=[]),e.serviceRelInfo.regionsEnd||(e.serviceRelInfo.regionsEnd=[]),e.serviceRelInfo.regionsStart.length)for(var r=0,o=e.serviceRelInfo.regionsStart.length;r<o;r+=1)for(var n=0,a=i.starts.length;n<a;n+=1)e.serviceRelInfo.regionsStart[r].id===i.starts[n].id&&(i.starts[n].checked=!0);else i.starts.forEach(function(e){e.checked=!0});if(e.serviceRelInfo.regionsEnd.length)for(var c=0,s=e.serviceRelInfo.regionsEnd.length;c<s;c+=1)for(var d=0,l=i.ends.length;d<l;d+=1)e.serviceRelInfo.regionsEnd[c].id===i.ends[d].id&&(i.ends[d].checked=!0);else i.ends.forEach(function(e){e.checked=!0});e.regionsSelected=angular.copy(i.starts),e.regionsSelectedEnd=angular.copy(i.ends),e.serviceRelInfo.regionsStart=e.regionsSelected.filter(function(e){return e.checked}),e.serviceRelInfo.regionsEnd=e.regionsSelectedEnd.filter(function(e){return e.checked});var m=e.serviceRelInfo.regionsStart?e.serviceRelInfo.regionsStart.map(function(e){return e.name.substr(0,e.name.indexOf("("))}).join(","):"",v=e.serviceRelInfo.regionsEnd?e.serviceRelInfo.regionsEnd.map(function(e){return e.name.substr(0,e.name.indexOf("("))}).join(","):"";e.selectedRegionsStr=v?m+","+v:m}})}function u(i){t.getProductServiceCargos({seatParams:{uid:i}},function(t){if(0===t.errorCode){var i=angular.copy(t.data);if(e.serviceRelInfo.cargos.length)for(var r=0,o=e.serviceRelInfo.cargos.length;r<o;r+=1)for(var n=0,a=i.length;n<a;n+=1)e.serviceRelInfo.cargos[r].cargoTypeCode===i[n].cargoTypeCode&&(i[n].checked=!0);else i.forEach(function(e){e.checked=!0});e.cargosSelected=i,e.serviceRelInfo.cargos=e.cargosSelected.filter(function(e){return e.checked}),e.selectedCargosStr=e.serviceRelInfo.cargos.map(function(e){return e.cargoTypeName}).join(",")}})}function p(i){var r={seatParams:{productId:i}};t.getCurrencyUnit(r,function(t){0===t.errorCode&&(e.currencyName=t.data&&t.data.currencyCode?t.data.currencyCode:"CNY")})}e.$on("productServeEvent",function(){e.isEdit=!1,e.init(),e.$apply()});var f={},y={},h={},I={},R={};e.SetServiceByServiceType=function(){f=selectFactory({data:[],id:"serviceName",showTextField:"name",defaultText:Lang.getValByKey("common","common_select_tips"),isSearch:!0,closeLocalSearch:!0,isSaveInputVal:!0,searchPlaceHoder:"请输入名称或编码",pagination:!0,onSearchValueChange:function(i,r,o){if(e.data.serviceTypeCode){var a={urlParams:{status:3,includeAllAudit:!0,q:r||"",pageIndex:o||1,pageSize:10},seatParams:{serviceTypeCode:e.data.serviceTypeCode}},c=t.getServicebyServiceType(a);n(c.data),i.setData(c)}},attrTextModel:function(t,i,r){if(e.serviceRelInfo.orderQuantity="",$("#orderQuantity").val(""),e.showServiceExist=!1,t){-1===(e.data.productServiceRelInfos.length?e.data.productServiceRelInfos.map(function(e){return e.serviceUid}):[]).indexOf(r.uid)?(e.serviceRelInfo.serviceName=t.split("(")[0],e.serviceRelInfo.serviceUid=r.uid,e.serviceRelInfo.regionsStart=[],e.serviceRelInfo.regionsEnd=[],e.serviceRelInfo.cargos=[],e.serviceRelInfo.weightLimitMin=r.weightLimitMin,e.serviceRelInfo.weightLimitMax=r.weightLimitMax,e.weightLimitMin=r.weightLimitMin,e.weightLimitMax=r.weightLimitMax,$("#modifyPrompt .border-red").removeClass("border-red"),r.weightLimitMin||0==r.weightLimitMin?$("#weightLimitBegin, #weightLimitEnd").attr("min",r.weightLimitMin):$("#weightLimitBegin, #weightLimitEnd").removeAttr("min"),r.weightLimitMax||0==r.weightLimitMax?$("#weightLimitBegin, #weightLimitEnd").attr("max",r.weightLimitMax):$("#weightLimitBegin, #weightLimitEnd").removeAttr("max"),g(r.uid),u(r.uid)):e.showServiceExist=!0}else e.serviceRelInfo.serviceName="",e.serviceRelInfo.serviceUid="";e.$apply()}}).open()},e.InitServiceTypeSelect=function(){var i=t.getAvailableTypes({seatParams:{productId:e.$parent.id}});i.data.splice(0,1),h=selectFactory({data:{data:[]},id:"service-type",height:140,defaultText:Lang.getValByKey("common","common_select_tips"),attrTextModel:function(t,i,r){e.showServiceExist=!1,t?(e.data.serviceTypeName=t,e.data.serviceTypeCode=r.code):(e.data.serviceTypeName="",e.data.serviceTypeCode=""),e.$apply()}}),h.setData(i),h.open()},e.newService=!0,e.addServiceConfig=function(t,i){if(i)e.ordinal=t+1,e.newService=!1,s(i.serviceProperty,i.ordinal,t);else{m();var r=e.tableModel.tableBody;e.ordinal=e.tableModel.pagination.totalResult+1,e.data.ordinal=r.length?r[r.length-1].ordinal+1:1}e.canEditService||e.$parent.isNew||(v("#starsPrice",e.data.priceWeighting,!0),v("#starsTime",e.data.agingWeighting,!0)),(e.canEditService||e.$parent.isNew)&&(v("#starsPrice",e.data.priceWeighting,!1),v("#starsTime",e.data.agingWeighting,!1)),a(),e.showPrompt=!0,$("#showPrompt").css("display","table"),e.serviceForm.$setPristine()},e.deleteServiceConfig=function(){if(0!=e.tableModel.selectNumber&&0!=$(".table-box tbody tr").length){var t=i.getSelectTable(e.tableModel.tableBody);if(!t.length)return accountView.promptBox({isDelay:!0,contentDelay:"请先选择服务",type:"errer",manualClose:!0}),!1;var r={productUid:e.$parent.uid,serviceProperties:t.map(function(e){return{ordinal:e.ordinal,serviceProperty:e.serviceProperty}})};$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:"确定删除已选服务？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){d(r)}}]})}else $(document).promptBox({isDelay:!0,contentDelay:"请先选择服务",type:"errer",manualClose:!0})},e.closePrompt=function(){e.showPrompt=!1},e.savePrompt=function(){if(""==e.data.servicePropertyName&&e.serviceForm.servicePropertyName.$setDirty(),""==e.data.serviceTypeName&&e.serviceForm.serviceTypeName.$setDirty(),""!=e.data.servicePropertyName&&""!=e.data.serviceTypeName){if(!e.data.productServiceRelInfos.length)return $(document).promptBox({isDelay:!0,contentDelay:"请至少选择一个服务",type:"errer",manualClose:!0}),e.modifyPrompt=!0,void $("#modifyPrompt").css("display","table");var i=null;e.data.id?(i={urlParams:e.data,seatParams:{id:e.data.id}},l(i,t.modifyProductService,r)):l(e.data,t.addProductService,r)}},e.showModifyPrompt=function(t){if(e.editIndex=t,""==e.data.servicePropertyName&&e.serviceForm.servicePropertyName.$setDirty(),""==e.data.serviceTypeName&&e.serviceForm.serviceTypeName.$setDirty(),""!=e.data.servicePropertyName&&""!=e.data.serviceTypeName){if($("#modifyPrompt .border-red").removeClass("border-red"),$("#weight-msg").html(""),e.serviceRelInfo.orderQuantity="",$("#orderQuantity").val(""),"number"==typeof t){e.data.productServiceRelInfos[t].serviceWeightLimitMin||0==e.data.productServiceRelInfos[t].serviceWeightLimitMin?$("#weightLimitBegin, #weightLimitEnd").attr("min",e.data.productServiceRelInfos[t].serviceWeightLimitMin):$("#weightLimitBegin, #weightLimitEnd").removeAttr("min"),e.data.productServiceRelInfos[t].serviceWeightLimitMax||0==e.data.productServiceRelInfos[t].serviceWeightLimitMin?$("#weightLimitBegin, #weightLimitEnd").attr("max",e.data.productServiceRelInfos[t].serviceWeightLimitMax):$("#weightLimitBegin, #weightLimitEnd").removeAttr("max"),e.serviceRelInfo=angular.copy(e.data.productServiceRelInfos[t]),e.showServicesRegions=e.serviceRelInfo.regionsStart?e.serviceRelInfo.regionsStart.length:e.serviceRelInfo.regionsEnd?e.serviceRelInfo.regionsEnd.length:"";var i=e.serviceRelInfo.regionsStart?e.serviceRelInfo.regionsStart.map(function(e){return e.name.substr(0,e.name.indexOf("("))}).join(","):"",r=e.serviceRelInfo.regionsEnd?e.serviceRelInfo.regionsEnd.map(function(e){return e.name.substr(0,e.name.indexOf("("))}).join(","):"";e.selectedRegionsStr=r?i+","+r:i,e.selectedCargosStr=e.serviceRelInfo.cargos?e.serviceRelInfo.cargos.map(function(e){return e.cargoTypeName}).join(","):"",e.isEdit=!e.isEdit,e.serviceRelInfo.orderQuantity=e.data.productServiceRelInfos[t].orderQuantity,e.serviceRelInfo.orderQuantity&&$("#orderQuantity").val(e.data.productServiceRelInfos[t].orderQuantity+e.data.productServiceRelInfos[t].orderQuantityUnit)}e.modifyPrompt=!0,$("#modifyPrompt").css("display","table")}},e.tabActive=1,e.toggleData=function(t){e.tabActive=t},e.showCargos=function(){if(!e.serviceRelInfo.serviceName||e.showServiceExist)return void e.serviceItemForm.serviceName.$setDirty();var t={title:"货物类型",isHidden:!0,isNest:!0,loadData:function(){u(e.serviceRelInfo.serviceUid)},content:{nest:$("#cargos")},operation:[{type:"submit",description:"确定",operationEvent:function(){var t=e.serviceRelInfo.cargos;if(e.serviceRelInfo.cargos=e.cargosSelected.filter(function(e){return e.checked}),!e.serviceRelInfo.cargos.length)return $(document).promptBox({isDelay:!0,contentDelay:"请至少选择一项",type:"errer",manualClose:!0}),void(e.serviceRelInfo.cargos=t);e.selectedCargosStr=e.serviceRelInfo.cargos.map(function(e){return e.cargoTypeName}).join(","),e.serviceRelInfo.cargos.forEach(function(e){e.hasOwnProperty("checked")&&delete e.checked}),$(document).promptBox("closeSlideBox"),e.$apply()}}]};$(document).promptBox(t)},e.showRegions=function(){if(!e.serviceRelInfo.serviceName||e.showServiceExist)return void e.serviceItemForm.serviceName.$setDirty();e.tabActive=1;var t={title:"服务范围",isHidden:!0,isNest:!0,loadData:function(){g(e.serviceRelInfo.serviceUid)},content:{nest:$("#regions")},operation:[{type:"submit",description:"确定",operationEvent:function(){if(e.serviceRelInfo.regionsStart=e.regionsSelected.filter(function(e){return e.checked}),e.serviceRelInfo.regionsEnd=e.regionsSelectedEnd.filter(function(e){return e.checked}),!e.serviceRelInfo.regionsStart.length&&!e.serviceRelInfo.regionsEnd.length)return void $(document).promptBox({isDelay:!0,contentDelay:"请至少选择一项",type:"errer",manualClose:!0});var t=e.serviceRelInfo.regionsStart.map(function(e){return e.name.substr(0,e.name.indexOf("("))}).join(","),i=e.serviceRelInfo.regionsEnd.map(function(e){return e.name.substr(0,e.name.indexOf("("))}).join(",");e.selectedRegionsStr=i?t+","+i:t,$(document).promptBox("closeSlideBox"),e.$apply()}}]};$(document).promptBox(t)},e.arrToString=function(e,t){var i=e.map(function(e){return-1!==e[t].indexOf("(")?e[t].substr(0,e[t].indexOf("(")):e[t]}).join(",");return i=i.length>30?i.substr(0,29)+"...":i},e.minMax=function(e,t,i){var r="";return e&&t&&(r=e+"~"+t+i),e&&!t&&(r="大于"+e+i),!e&&t&&(r="小于"+t+i),e||t||(r="/"),r},e.initCustomerLevel=function(){selectFactory({data:{data:[{name:"一级",code:1},{name:"二级",code:2},{name:"三级",code:3},{name:"四级",code:4},{name:"五级",code:5}]},id:"customerLevel",attrTextModel:function(t,i,r){e.serviceRelInfo.customerLevelName=r.name,e.serviceRelInfo.customerLevel=r.code,e.serviceRelInfo.customerLevelExtName="",e.serviceRelInfo.customerLevelExt="",e.$apply()}}).open()},e.initCustomerLevelRange=function(){var t=[{name:"及以上",code:"above"},{name:"及以下",code:"below"}],i=selectFactory({data:{},id:"customerLevelRange",attrTextModel:function(t,i,r){t&&(e.serviceRelInfo.customerLevelExtName=r.name,e.serviceRelInfo.customerLevelExt=r.code,e.$apply())}});i.setData({data:t}),i.open()},e.initOrderQuantity=function(){var t=[{name:"10%",code:"10"},{name:"20%",code:"20"},{name:"30%",code:"30"},{name:"40%",code:"40"},{name:"50%",code:"50"},{name:"60%",code:"60"},{name:"70%",code:"70"},{name:"80%",code:"80"},{name:"90%",code:"90"},{name:"100%",code:"100"}],i=selectFactory({data:{},id:"orderQuantity",height:120,direction:"up",attrTextModel:function(t,i,r){t&&(e.serviceRelInfo.orderQuantity=r.code,e.$apply())}});i.setData({data:t}),i.open()},e.closeModifyPrompt=function(){e.showServiceExist=!1,e.serviceRelInfo={customerLevel:"",customerLevelName:"",customerLevelExt:"",customerLevelExtName:"",declaredValueMax:"",declaredValueMin:"",orderQuantity:"",orderQuantityUnit:"%",regions:[],cargos:[],serviceContent:"",serviceName:"",serviceUid:"",weightLimitMax:"",weightLimitMin:""},e.selectedRegionsStr="",e.selectedCargosStr="",e.serviceItemForm.serviceName.$setPristine(),e.serviceItemForm.serviceName.$setUntouched(),e.modifyPrompt=!1,e.isEdit=!1,$("#modifyPrompt").hide()},e.saveModifyPrompt=function(){if(!e.serviceRelInfo.serviceName)return void e.serviceItemForm.serviceName.$setDirty();if(!e.showServiceExist&&e.serviceItemForm.$valid)if(0!=e.serviceRelInfo.weightLimitMin&&!e.serviceRelInfo.weightLimitMin&&e.serviceRelInfo.weightLimitMax?$("#weightLimitBegin").addClass("border-red"):e.serviceRelInfo.weightLimitMin&&0!=e.serviceRelInfo.weightLimitMax&&!e.serviceRelInfo.weightLimitMax?$("#weightLimitEnd").addClass("border-red"):0==e.serviceRelInfo.weightLimitMin||e.serviceRelInfo.weightLimitMin||0==e.serviceRelInfo.weightLimitMax||e.serviceRelInfo.weightLimitMax||($("#weightLimitBegin, #weightLimitEnd").removeClass("border-red"),$("#weight-msg").html("")),$("#modifyPrompt").find(".border-red").length){var t=$("#weightLimitBegin").attr("min"),i=$("#weightLimitBegin").attr("max");if(t&&i){var r="数值不在有效范围内("+t+"-"+i+")";$("#weight-msg").html(r)}}else{if(e.serviceRelInfo.weightLimitMin>e.serviceRelInfo.weightLimitMax)return void $("#weight-msg").html("下限值必须小于上限值");e.serviceRelInfo.weightLimitMin||e.serviceRelInfo.weightLimitMax||(e.serviceRelInfo.weightLimitMin=e.serviceRelInfo.serviceWeightLimitMin,e.serviceRelInfo.weightLimitMax=e.serviceRelInfo.serviceWeightLimitMax);var o=angular.copy(e.data.productServiceRelInfos),n=(o.map(function(e){return e.serviceUid}),e.editIndex);e.isEdit?e.data.productServiceRelInfos.splice(n,1,e.serviceRelInfo):e.data.productServiceRelInfos.push(e.serviceRelInfo),e.closeModifyPrompt()}},e.delOneServiceRelInfo=function(t,i){$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:"确定删除已选服务？"},operation:[{type:"submit",description:Lang.getValByKey("common","common_page_delete"),application:"delete",operationEvent:function(){e.data.productServiceRelInfos.splice(t,1),$(document).promptBox({isDelay:!0,contentDelay:"删除成功",type:"success",time:3e3}),$(document).promptBox("closePrompt"),e.$apply()}}]})},e.init=function(){p(e.$parent.id),m(),o(),c(),sessionStorage.getItem("backPricePath")?e.canEditService=!1:e.isAudit?(e.IsDraftStatus||e.isOffline)&&(e.canEditService=!0):e.IsDraftStatus&&(e.canEditService=!0),R=t.getProductPropertyType(),I=$.extend(!0,I,R),I.data.splice(0,1)},e.checkWeightLimit=function(e,t){if(!/^(\d{1}|[1-9][0-9]*)$|^(0{1}|[1-9][0-9]*)\.\d{1,3}$/.test(e))return void $("#weight-msg").html("");var i=$("#"+t).attr("min"),r=$("#"+t).attr("max");e<i||e>r?$("#"+t).addClass("border-red"):$("#"+t).removeClass("border-red")}}])});