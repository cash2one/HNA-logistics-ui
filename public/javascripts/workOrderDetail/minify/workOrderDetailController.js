easySpa.require(["widget/select","widget/prompt","public/common/pictureController.js","widget/slides"],function(){app.controller("workOrderDetailCtrl",["$scope","workOrderDetailService","workOrderDetailView","$route",function(e,r,o,a){var d=function(e,r){$(document).promptBox({isDelay:!0,contentDelay:e,type:r,time:3e3,manualClose:"errer"===r})};$.extend(e,{workOrderDetailModel:{},blockOrder:!1,workOrderPriority:{2:Lang.getValByKey("workOrderDetail","workOrderDetail_label_veryUrgent"),1:Lang.getValByKey("workOrderDetail","workOrderDetail_label_urgent"),0:Lang.getValByKey("workOrderDetail","workOrderDetail_label_normal")},flowMenu:{0:Lang.getValByKey("workOrderDetail","workOrderDetail_flow_0"),1:Lang.getValByKey("workOrderDetail","workOrderDetail_flow_1"),2:Lang.getValByKey("workOrderDetail","workOrderDetail_flow_2"),3:Lang.getValByKey("workOrderDetail","workOrderDetail_flow_3"),4:Lang.getValByKey("workOrderDetail","workOrderDetail_flow_4"),5:Lang.getValByKey("workOrderDetail","workOrderDetail_flow_5")},contentRemainWords:1e3,suggestRemainWords:140,goBack:function(e){o.goBack(e)},initWorkOrderTypeSelect:function(){var a={},t=function(r){0===r.errorCode?o.initWorkOrderTypeSelect(e,r):d(r.msg,"errer")};r.getWorkOrderTypeList(a,t)},checkWorkOrder:function(){if(a.current.params.refCustomerCode&&(e.workOrderDetailModel.refAskBoardId=a.current.params.refCustomerCode),a.current.params.waybillNo&&(e.workOrderDetailModel.waybillNo=a.current.params.waybillNo),e.workOrderDetailModel.type&&(e.workOrderDetailModel.refAskBoardId||e.workOrderDetailModel.waybillNo)){var o={},d=null;e.workOrderDetailModel.refAskBoardId?(o={seatParams:{code:e.workOrderDetailModel.refAskBoardId}},d=function(r){0===r.errorCode?(e.workOrderDetailModel.anonymity=r.data.customerFullName||r.data.anonymity,e.workOrderDetailModel.anonyTel=r.data.customerTelNo||r.data.anonyTel,e.workOrderDetailModel.leaveMsgId=r.data.id,$("#anonymity").attr("disabled","disabled"),$("#anonyTel").attr("disabled","disabled"),setTimeout(function(){$("#anonymity").attr("disabled","disabled"),$("#anonyTel").attr("disabled","disabled")},500),$("#refAskBoardId").removeClass("error"),e.refAskBoardIdInvalidTip="",e.orderNoInvalidTip=""):(e.workOrderDetailModel.anonymity="",e.workOrderDetailModel.anonyTel="",e.refAskBoardIdInvalidTip=r.msg,e.orderNoInvalidTip="",$("#refAskBoardId").addClass("error"))},r.checkWorkOrder(o,d)):(o={seatParams:{waybillNo:e.workOrderDetailModel.waybillNo}},d=function(r){0===r.errorCode?(e.workOrderDetailModel.anonymity=r.data.cusFullName,e.workOrderDetailModel.anonyTel=r.data.mobilePhone,$("#anonymity").attr("disabled","disabled"),$("#anonyTel").attr("disabled","disabled"),setTimeout(function(){$("#anonymity").attr("disabled","disabled"),$("#anonyTel").attr("disabled","disabled")},500),$("#orderNo").removeClass("error"),e.refAskBoardIdInvalidTip="",e.orderNoInvalidTip=""):(e.workOrderDetailModel.anonymity="",e.workOrderDetailModel.anonyTel="",e.refAskBoardIdInvalidTip="",e.orderNoInvalidTip=r.msg,$("#orderNo").addClass("error"))},r.checkorderNo(o,d))}},initStaffSelect:function(){o.initStaffSelect(e)},getInfoByWorkOrderId:function(){var a={seatParams:{id:easySpa.queryUrlValByKey("id")}},t=function(r){0===r.errorCode?o.setWorkOrderDetail(e,r):d(r.msg,"errer")};r.getWorkOrderDetailById(a,t)},uploadFile:function(){o.uploadFile(e)},checkWorkOrderInfo:function(r){var o=!1;if(!e.createWorkOrderSubmit)return!1;for(var a=[{id:"type",modelName:"typeName"},{id:"title",modelName:"title"},{id:"content",modelName:"content"},{id:"transactor",modelName:"transactor"}],d=0,t=a.length;d<t;d++)e.workOrderDetailModel[a[d].modelName]?$("#"+a[d].id).removeClass("error"):($("#"+a[d].id).addClass("error"),o=!0);for(var l=[{id:"anonymity",modelName:"anonymity",reg:/^([\w\u4E00-\u9FA5_\-]+)+$/,key:"anonymityErrorTips",tip:Lang.getValByKey("common","common_code_tipsOne")},{id:"anonyTel",reg:/^([\d_\-\+]+)+$/,modelName:"anonyTel",key:"anonyTelErrorTips",tip:Lang.getValByKey("common","common_code_tipsThree")}],i=0,n=l.length;i<n;i++)e.workOrderDetailModel[l[i].modelName]&&!l[i].reg.test(e.workOrderDetailModel[l[i].modelName])?($("#"+l[i].id).addClass("error").removeClass("notError"),e[l[i].key]=l[i].tip,o=!0):(e[l[i].key]=null,$("#"+l[i].id).removeClass("error").addClass("notError"));return 1==e.workOrderDetailModel.type||0==e.workOrderDetailModel.type?!e.workOrderDetailModel.refAskBoardId||e.refAskBoardIdInvalidTip?($("#refAskBoardId").addClass("error"),o=!0):$("#refAskBoardId").removeClass("error"):2==e.workOrderDetailModel.type&&(!e.workOrderDetailModel.waybillNo||e.orderNoInvalidTip?($("#orderNo").addClass("error"),o=!0):$("#orderNo").removeClass("error")),void 0!=e.workOrderDetailModel.priority||r||(e.priorityError=!0,o=!0),o},createWorkOrder:function(){if(e.createWorkOrderSubmit=!0,this.checkWorkOrderInfo())return void scrollToErrorView($(".wod-main"));var a=this,t={urlParams:o.collectData(e)},l=function(e){0===e.errorCode?(d(e.msg||Lang.getValByKey("workOrderDetail","workOrderDetail_msg_createOk"),"success"),setTimeout(function(){a.goBack(!0)},3e3)):d(e.msg,"errer")};r.createWorkOrder(t,l)},closeOrDispatch:function(){3===e.workOrderDetailModel.action?(e.workOrderDetailModel.sendTo=e.workOrderDetailModel.creator,e.workOrderDetailModel.transactorName=e.workOrderDetailModel.creatorFullName):0===e.workOrderDetailModel.action&&(e.workOrderDetailModel.transactor="",e.workOrderDetailModel.transactorName="")},changeBlockOrder:function(){e.blockOrder=!e.blockOrder},checkHandleInfo:function(r){var o=!1;if(!e.handleWorkOrderSubmit)return!1;for(var a=(e.workOrderDetailModel.action,[{id:"infoType",modelName:"action"},{id:"content",modelName:"suggest"}]),d=0,t=a.length;d<t;d++)void 0==e.workOrderDetailModel[a[d].modelName]?($("#"+a[d].id).addClass("error"),o=!0):$("#"+a[d].id).removeClass("error");return void 0!=e.workOrderDetailModel.action||r||(e.actionError=!0,o=!0),4==e.workOrderDetailModel.action||3==e.workOrderDetailModel.action||e.workOrderDetailModel.transactorName||($("#transactor").addClass("error"),o=!0),o},handleWorkOrder:function(){var a=!1;if(2!=e.workOrderDetailModel.action&&(e.handleWorkOrderSubmit=!0,a=this.checkHandleInfo()),!a){var t=this,l=o.collectHandleData(e),i={urlParams:l},n=function(e){"0"==e.errorCode?(d(e.msg||Lang.getValByKey("workOrderDetail","workOrderDetail_msg_HandleOk"),"success"),2==l.action?t.init(!0):t.goBack()):d(e.msg,"errer")};r.handleWorkOrder(i,n)}},jumpTo:function(r){var o="",a=e.workOrderDetailModel.customerUserId<1?"anony":"login";switch(r){case 1:o="#/customerMessageDetail?id="+e.workOrderDetailModel.refAskBoardId+"&status=true&userName="+e.workOrderDetailModel.customerUserFullName+"&workOrderId="+e.workOrderDetailModel.id+"&fromMenu=workOrderDetail&refCustomerId="+e.workOrderDetailModel.customerUserId+"&customerType="+a+"&anonymity="+e.workOrderDetailModel.anonymity+"&anonyTel="+e.workOrderDetailModel.anonyTel+"&refCustomerCode="+e.workOrderDetailModel.refCustomerCode+"&isJustShow="+!0;break;case 2:o="#/confirmOrder?orderNum="+e.workOrderDetailModel.orderNo+"&id="+e.workOrderDetailModel.id+"&isJustShow="+!0}top.location.href="http://"+location.host+o},init:function(o){var a=this;o||(e.initWorkOrderTypeSelect(),r.getWorkOrderTypeList({},function(r){"0"==r.errorCode?(easySpa.queryUrlValByKey("fromMenu")&&(e.workOrderDetailModel.typeName=r.data[0].name,e.workOrderDetailModel.type=r.data[0].code,e.checkWorkOrder()),easySpa.queryUrlValByKey("waybillNo")&&(e.workOrderDetailModel.typeName=r.data[2].name,e.workOrderDetailModel.type=r.data[2].code,e.checkWorkOrder())):d(r.msg,"errer")}),e.uploadFile(),reSetMenuCssStatus("#/workOrder")),easySpa.queryUrlValByKey("id")&&e.getInfoByWorkOrderId(),e.$watchGroup(["workOrderDetailModel.title","workOrderDetailModel.anonymity","workOrderDetailModel.anonyTel","workOrderDetailModel.content","workOrderDetailModel.transactor","workOrderDetailModel.type","workOrderDetailModel.priority"],function(){a.checkWorkOrderInfo(!0)}),e.$watchGroup(["workOrderDetailModel.action","workOrderDetailModel.suggest","workOrderDetailModel.transactorName"],function(){a.checkHandleInfo(!0)}),$(".error").removeClass("error")},resetRemainWords:function(r,o){1==o?e.contentRemainWords=r-e.workOrderDetailModel.content.length:e.suggestRemainWords=r-e.workOrderDetailModel.suggest.length}}),e.init()}])});