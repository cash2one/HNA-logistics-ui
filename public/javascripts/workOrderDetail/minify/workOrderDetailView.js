app.factory("workOrderDetailView",["pictureService","workOrderDetailService",function(e,r){return{maxUpload:9,goBack:function(e){easySpa.queryUrlValByKey("id")||e?(easySpa.queryUrlValByKey("fromMenu")&&(top.location.href="http://"+location.host+"/#/customerMessageDetail?id="+easySpa.queryUrlValByKey("askboradid")+"&status="+easySpa.queryUrlValByKey("status")+"&userName="+easySpa.queryUrlValByKey("userName")+"&customerType="+easySpa.queryUrlValByKey("customerType")+"&refCustomerId="+easySpa.queryUrlValByKey("refCustomerId")+"&refCustomerCode="+easySpa.queryUrlValByKey("refCustomerCode")),easySpa.queryUrlValByKey("orderNo")?top.location.href="http://"+location.host+"/#/confirmOrder?orderNum="+easySpa.queryUrlValByKey("orderNo"):location.href="#/workOrder"):$(document).promptBox({title:Lang.getValByKey("common","common_prompt_title"),type:"warning",content:{tip:Lang.getValByKey("common","common_back_confirm")},cancelDescription:Lang.getValByKey("common","common_back_no"),operation:[{type:"submit",application:"delete",description:Lang.getValByKey("common","common_back_yes"),operationEvent:function(){$(document).promptBox("closePrompt"),easySpa.queryUrlValByKey("fromMenu")&&("anony"==easySpa.queryUrlValByKey("customerType")?top.location.href="http://"+location.host+"/#/customerMessageDetail?id="+easySpa.queryUrlValByKey("askboradid")+"&status="+easySpa.queryUrlValByKey("status")+"&userName="+easySpa.queryUrlValByKey("userName")+"&customerType="+easySpa.queryUrlValByKey("customerType")+"&anonyTel="+easySpa.queryUrlValByKey("anonyTel")+"&anonymity="+easySpa.queryUrlValByKey("anonymity")+"&refCustomerCode="+easySpa.queryUrlValByKey("refCustomerCode"):"login"==easySpa.queryUrlValByKey("customerType")&&(top.location.href="http://"+location.host+"/#/customerMessageDetail?id="+easySpa.queryUrlValByKey("askboradid")+"&status="+easySpa.queryUrlValByKey("status")+"&userName="+easySpa.queryUrlValByKey("userName")+"&customerType="+easySpa.queryUrlValByKey("customerType")+"&refCustomerId="+easySpa.queryUrlValByKey("refCustomerId")+"&refCustomerCode="+easySpa.queryUrlValByKey("refCustomerCode"))),easySpa.queryUrlValByKey("orderNo")?top.location.href="http://"+location.host+"/#/confirmOrder?orderNum="+easySpa.queryUrlValByKey("orderNo"):location.href="#/workOrder"}}]})},initWorkOrderTypeSelect:function(e,r){setTimeout(function(){selectFactory({data:r,id:"type",showTextField:"name",attrTextField:{"ng-value":"code"},defaultText:Lang.getValByKey("common","common_select_tips"),maxHeight:160,attrTextModel:function(r){e.workOrderDetailModel.typeName=r,r&&(e.refAskBoardIdInvalidTip="",e.orderNoInvalidTip="",e.workOrderDetailModel.anonyTel="",e.workOrderDetailModel.anonymity="",$("#anonymity").removeAttr("disabled"),$("#anonyTel").removeAttr("disabled"),$("#type").removeClass("error").removeClass("ng-dirty"),$("#refAskBoardId").removeClass("error").removeClass("ng-dirty"),$("#orderNo").removeClass("error").removeClass("ng-dirty")),e.$apply()},attrTextId:function(r){e.workOrderDetailModel.type=r,e.workOrderDetailModel.orderNo="",e.workOrderDetailModel.refAskBoardId="",e.workOrderDetailModel.waybillNo="",e.$apply()}})},1)},initStaffSelect:function(e){var a=function(e,a){var t={urlParams:{q:e||"",pageIndex:a||1,pageSize:10}},o=r.getStaffList(t);return angular.forEach(o.data,function(e,r){e.fullName+="("+e.code+")"}),o};selectFactory({data:[],id:"transactor",isSearch:!0,showTextField:"fullName",defaultText:Lang.getValByKey("common","common_select_tips"),maxHeight:160,isNotUseFilter:!0,closeLocalSearch:!0,isSaveInputVal:!0,searchPlaceHoder:"请输入姓名或工号",defaultCount:10,pagination:!0,onSearchValueChange:function(e,r,t){var o=a(r,t);e.setData(o)},attrTextModel:function(r,a){if(r){var t=a.data.find(function(e){return e.fullName==r});e.workOrderDetailModel.transactor=t.id,e.workOrderDetailModel.transactorName=t.fullName}else e.workOrderDetailModel.transactor="",e.workOrderDetailModel.transactorName="";e.$apply()}}).open()},setWorkOrderStatus:function(e,r){e.workOrderDetailModel.workOrderStauts=r[0].action,e.workOrderDetailModel.workOrderStautsName=r[0].actionName,e.workOrderDetailModel.workOrderStauts%5==0&&(e.workOrderDetailModel.action="2")},setWorkOrderDetail:function(e,r){e.workOrderDetailModel=r.data,e.workOrderDetailModel.flowList=r.data.csrWorkOrderTransactionDtos,this.setWorkOrderStatus(e,r.data.csrWorkOrderTransactionDtos)},uploadFile:function(r){r.pictureModel={edit:!0,uploadShow:!0,picture:[],accept:"image/jpg,image/jpeg,image/png,image/bmp,image/tiff"},r.getFile=function(a){var t=a.length;if(t+r.pictureModel.picture.length>e.maxUpload)return $(document).promptBox({isDelay:!0,contentDelay:Lang.getValByKey("workOrderDetail","supplier_prompt_tip_picture_one")+e.maxUpload+Lang.getValByKey("workOrderDetail","supplier_prompt_tip_picture_two"),type:"errer",manualClose:!0}),!1;for(var o=0;o<t;o++){var l=e.uploadFile(r.pictureModel,a[o]);if(!l)return!1;l.errorlocal?$(document).promptBox({isDelay:!0,contentDelay:l.errorlocal,type:"errer",manualClose:!0}):l.then(function(a){0===a.data.errorCode?(r.validatePictureError=!1,r.pictureModel=e.updateModel(r.pictureModel,a.data.data),$(document).promptBox({isDelay:!0,contentDelay:a.data.msg,type:"success"})):$(document).promptBox({isDelay:!0,contentDelay:a.data.msg,type:"errer",manualClose:!0})})}}},collectData:function(e){var r=e.pictureModel.picture.map(function(e){return e.picUrlID.id});return e.blockOrder&&(e.workOrderDetailModel.type=4),{type:e.workOrderDetailModel.type,refAskBoardId:e.workOrderDetailModel.leaveMsgId,waybillNo:e.workOrderDetailModel.waybillNo,anonymity:e.workOrderDetailModel.anonymity,anonyTel:e.workOrderDetailModel.anonyTel,title:e.workOrderDetailModel.title,content:e.workOrderDetailModel.content,attachFileIds:r,priority:e.workOrderDetailModel.priority,transactor:e.workOrderDetailModel.transactor,creator:0,customerUserId:0,fileGroupId:"",id:e.workOrderDetailModel.id,status:e.workOrderDetailModel.status,workOrderCode:e.workOrderDetailModel.workOrderCode}},collectHandleData:function(e){var r=e.pictureModel.picture.map(function(e){return e.picUrlID.id});return{action:e.workOrderDetailModel.action,refWorkorderId:e.workOrderDetailModel.id,sendTo:e.workOrderDetailModel.sendTo||e.workOrderDetailModel.transactor,attachFileIds:r,suggest:e.workOrderDetailModel.suggest}},unlockInput:function(){$("#anonymity").removeAttr("disabled"),$("#anonyTel").removeAttr("disabled")},lockInput:function(){$("#anonymity").attr("disabled","true"),$("#anonyTel").attr("disabled","true")}}}]);